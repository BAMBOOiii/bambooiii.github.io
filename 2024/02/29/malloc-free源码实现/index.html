<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    malloc/free源码实现
  </title>
  <meta name="description" content="">
  <meta name="keywords" content="">
  <meta name="author" content="sheep">
  <link rel="canonical" href="http://example.com/2024/02/29/malloc-free%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0/">
  
  
  <link rel="icon" href='/img/favicon.ico'>
  
  
  
<link rel="stylesheet" href="/css/b4c95347.css">

  <script>window.i18n = {"tip-status-done":"完成","tip-status-default":"全部","tip-status-todo":"计划","tip-status-doing":"进行","tip-status-other":"其他","text-select":"选择","text-move":"移动","text-esc":"退出","January":"一月","February":"二月","March":"三月","April":"四月","May":"五月","June":"六月","July":"七月","August":"八月","September":"九月","October":"十月","November":"十一月","December":"十二月"}</script>
<meta name="generator" content="Hexo 7.0.0"></head>

<body id="app">
  <aside id="aside-box" class="left-aside">
    <div class="header">
      
<link rel="stylesheet" href="/css/61875ce9.css">

<div class="profile">
  <a class="badge" href="/">
    <span>Hi</span>
    <span>sheep</span>
  </a>
  <cosy-tooltip id="left-aside-button" placement="right">
    <span slot="content">
      <span>显示 / 隐藏 左侧导航</span>
      <cosy-short-key>[</cosy-short-key>
    </span>
    <cosy-icon>
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20">
        <g fill="none">
          <path d="M16 4c1.104-.019 2 .896 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h12zm1 2a1 1 0 0 0-1-1h-2.995v10H16a1 1 0 0 0 1-1V6zm-4.995 9V5H4.001a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8.004z" fill="currentColor"></path>
        </g>
      </svg>
    </cosy-icon>
  </cosy-tooltip>
</div>

<script src="/js/a66044b6.js"></script>

      


<cosy-search id="post-search" placeholder="搜索">
  <div slot="short-key">
    <cosy-short-key>⌘</cosy-short-key>
    <cosy-short-key>K</cosy-short-key>
  </div>
</cosy-search>


<script>
  window.algolia = {
    appId: "R34LY1BBPU",
    SearchOnlyAPIKey: "4fd025154505a4b00fb416f52993d700"
  }
</script>


<script src="/js/5f00f278.js"></script>

    </div>
    <div class="aside-category">
      
<link rel="stylesheet" href="/css/db04a759.css">


<nav class="category-nav cosy-scrollbar">
  <ul><li data-path="archives">
        <a href="/archives">
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20"><g fill="none"><path d="M3.5 3A1.5 1.5 0 0 0 2 4.5v4A1.5 1.5 0 0 0 3.5 10h9A1.5 1.5 0 0 0 14 8.5v-4A1.5 1.5 0 0 0 12.5 3h-9zM3 4.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5v-4zm.5 6.5A1.5 1.5 0 0 0 2 12.5v4A1.5 1.5 0 0 0 3.5 18h9a1.5 1.5 0 0 0 1.5-1.5v-4a1.5 1.5 0 0 0-1.5-1.5h-9zM3 12.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5v-4zm14-.063a2.003 2.003 0 0 1-2.5-1.937A2 2 0 0 1 16 8.563a2.005 2.005 0 0 1 1 0a2 2 0 0 1 0 3.874zM16.5 3a.5.5 0 0 1 .5.5v4.041a3.02 3.02 0 0 0-1 0V3.5a.5.5 0 0 1 .5-.5zm0 10.5c-.17 0-.337-.014-.5-.041V17.5a.5.5 0 0 0 1 0v-4.041c-.163.027-.33.041-.5.041z" fill="currentColor"></path></g></svg>
          <div class="ellipsis">归档</div>
        </a>
      </li><li data-path="cosy-roadmap">
        <a href="/cosy-roadmap">
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20"><g fill="none"><path d="M9.384 2a1 1 0 0 0-.966.742L4.616 17H2.5a.5.5 0 0 0 0 1h15a.5.5 0 0 0 0-1h-2.116L11.582 2.742A1 1 0 0 0 10.616 2H9.384zM5.651 17l.8-3H11.5a.5.5 0 0 0 0-1H6.717l.534-2H10.5a.5.5 0 0 0 0-1H7.517l1.867-7h1.232l3.733 14H5.651z" fill="currentColor"></path></g></svg>
          <div class="ellipsis">路线图</div>
        </a>
      </li><li data-path="cosy-resume">
        <a href="/cosy-resume">
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20"><g fill="none"><path d="M8.5 4.498a1.5 1.5 0 1 1 3 0a1.5 1.5 0 0 1-3 0zm1.5-2.5a2.5 2.5 0 0 0-2.43 3.086L5.471 4.15a1.761 1.761 0 0 0-2.317.88c-.4.882-.008 1.917.877 2.31L7 8.662v2.287l-1.877 4.645a1.75 1.75 0 0 0 3.245 1.311l1.556-3.849a.073.073 0 0 1 .028-.038a.086.086 0 0 1 .046-.012c.02 0 .035.005.046.012a.074.074 0 0 1 .028.038l1.555 3.849a1.75 1.75 0 0 0 3.245-1.311L13 10.96V8.662l2.968-1.322a1.74 1.74 0 0 0 .877-2.31a1.761 1.761 0 0 0-2.317-.88l-2.097.934a2.5 2.5 0 0 0-2.43-3.086zM4.065 5.444a.761.761 0 0 1 1-.38l3.918 1.744a2.5 2.5 0 0 0 2.034 0l3.918-1.744a.761.761 0 0 1 1 .38a.739.739 0 0 1-.373.983l-2.969 1.321a1 1 0 0 0-.593.914v2.298a1 1 0 0 0 .073.375l1.872 4.633a.75.75 0 0 1-1.39.562l-1.556-3.849c-.364-.9-1.639-.9-2.003 0l-1.555 3.85a.75.75 0 1 1-1.39-.562l1.876-4.646A1 1 0 0 0 8 10.95V8.662a1 1 0 0 0-.593-.914L4.438 6.427a.739.739 0 0 1-.373-.983z" fill="currentColor"></path></g></svg>
          <div class="ellipsis">简历</div>
        </a>
      </li><li data-path="link">
        <a href="/link">
          <svg t="1705378180027" class="icon" viewBox="-250 -250 1400 1400" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1450" width="200" height="200"><path d="M593.94368 715.648a10.688 10.688 0 0 0-14.976 0L424.21568 870.4c-71.68 71.68-192.576 79.232-271.68 0-79.232-79.232-71.616-200 0-271.616l154.752-154.752a10.688 10.688 0 0 0 0-15.04l-52.992-52.992a10.688 10.688 0 0 0-15.04 0L84.50368 530.688a287.872 287.872 0 0 0 0 407.488 288 288 0 0 0 407.488 0l154.752-154.752a10.688 10.688 0 0 0 0-15.04l-52.736-52.736z m344.384-631.168a288.256 288.256 0 0 1 0 407.616l-154.752 154.752a10.688 10.688 0 0 1-15.04 0l-52.992-52.992a10.688 10.688 0 0 1 0-15.104l154.752-154.688c71.68-71.68 79.232-192.448 0-271.68-79.104-79.232-200-71.68-271.68 0L443.92768 307.2a10.688 10.688 0 0 1-15.04 0l-52.864-52.864a10.688 10.688 0 0 1 0-15.04l154.88-154.752a287.872 287.872 0 0 1 407.424 0z m-296.32 240.896l52.672 52.736a10.688 10.688 0 0 1 0 15.04l-301.504 301.44a10.688 10.688 0 0 1-15.04 0l-52.736-52.672a10.688 10.688 0 0 1 0-15.04l301.632-301.504a10.688 10.688 0 0 1 15.04 0z" fill="currentColor" p-id="1451"></path></svg>
          <div class="ellipsis">友链</div>
        </a>
      </li></ul>
  <ul><li class="">
        <a href="/categories/2024ROIS%E5%86%AC%E4%BB%A4%E8%90%A5/">
          
          <div class="ellipsis">
            <span>2024ROIS冬令营</span>
          </div>
        </a>
      </li><li class="active">
        <a href="/categories/Pwn%E7%9F%A5%E8%AF%86/">
          
          <div class="ellipsis">
            <span>Pwn知识</span>
          </div>
        </a>
      </li><li class="">
        <a href="/categories/%E5%B0%8F%E6%AF%94%E8%B5%9B/">
          
          <div class="ellipsis">
            <span>小比赛</span>
          </div>
        </a>
      </li><li class="">
        <a href="/categories/%E6%80%BB%E7%BB%93/">
          
          <div class="ellipsis">
            <span>总结</span>
          </div>
        </a>
      </li></ul>
</nav>


<script src="/js/118098c2.js"></script>

    </div>
    <div class="bottom">
      <cosy-tooltip id="button-preference" placement="right">
        <span slot="content">
          <span>偏好</span>
          <cosy-short-key>⌘</cosy-short-key>
          <cosy-short-key>p</cosy-short-key>
        </span>
        <cosy-icon bordered id="button-about-cosy-theme">
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 16 16">
            <g fill="none">
              <path d="M8 6a2 2 0 1 0 0 4a2 2 0 0 0 0-4zM7 8a1 1 0 1 1 2 0a1 1 0 0 1-2 0zm3.618-3.602a.708.708 0 0 1-.824-.567l-.26-1.416a.354.354 0 0 0-.275-.282a6.072 6.072 0 0 0-2.519 0a.354.354 0 0 0-.275.282l-.259 1.416a.71.71 0 0 1-.936.538l-1.359-.484a.355.355 0 0 0-.382.095c-.569.627-1 1.367-1.262 2.173a.352.352 0 0 0 .108.378l1.102.931a.704.704 0 0 1 0 1.076l-1.102.931a.352.352 0 0 0-.108.378A5.986 5.986 0 0 0 3.53 12.02a.355.355 0 0 0 .382.095l1.36-.484a.708.708 0 0 1 .936.538l.258 1.416c.026.14.135.252.275.281a6.075 6.075 0 0 0 2.52 0a.353.353 0 0 0 .274-.281l.26-1.416a.71.71 0 0 1 .936-.538l1.359.484c.135.048.286.01.382-.095c.569-.627 1-1.367 1.262-2.173a.352.352 0 0 0-.108-.378l-1.102-.931a.703.703 0 0 1 0-1.076l1.102-.931a.352.352 0 0 0 .108-.378A5.985 5.985 0 0 0 12.47 3.98a.355.355 0 0 0-.382-.095l-1.36.484a.71.71 0 0 1-.111.03zm-6.62.58l.937.333a1.71 1.71 0 0 0 2.255-1.3l.177-.97a5.105 5.105 0 0 1 1.265 0l.178.97a1.708 1.708 0 0 0 2.255 1.3L12 4.977c.255.334.467.698.63 1.084l-.754.637a1.704 1.704 0 0 0 0 2.604l.755.637a4.99 4.99 0 0 1-.63 1.084l-.937-.334a1.71 1.71 0 0 0-2.255 1.3l-.178.97a5.099 5.099 0 0 1-1.265 0l-.177-.97a1.708 1.708 0 0 0-2.255-1.3L4 11.023a4.987 4.987 0 0 1-.63-1.084l.754-.638a1.704 1.704 0 0 0 0-2.603l-.755-.637c.164-.386.376-.75.63-1.084z" fill="currentColor"></path>
            </g>
          </svg>
        </cosy-icon>
      </cosy-tooltip>
    </div>
  </aside>
  <main>
    
<link rel="stylesheet" href="/css/9bb9a539.css">


<div class="post-container">
  <header>
    <div class="left">
      
<link rel="stylesheet" href="/css/7d333f9e.css">

<nav class="breadcrumb">
  <section>
    <cosy-tooltip placement="bottom-left">
      <span slot="content"><span>首页</span>
        <cosy-short-key>⌘</cosy-short-key>
        <cosy-short-key>H</cosy-short-key>
      </span>
      <cosy-icon href="/">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20">
          <g fill="none">
            <path d="M8.998 2.388a1.5 1.5 0 0 1 2.005 0l5.5 4.942A1.5 1.5 0 0 1 17 8.445V15.5a1.5 1.5 0 0 1-1.5 1.5H13a1.5 1.5 0 0 1-1.5-1.5V12a.5.5 0 0 0-.5-.5H9a.5.5 0 0 0-.5.5v3.5A1.5 1.5 0 0 1 7 17H4.5A1.5 1.5 0 0 1 3 15.5V8.445c0-.425.18-.83.498-1.115l5.5-4.942zm1.336.744a.5.5 0 0 0-.668 0l-5.5 4.942A.5.5 0 0 0 4 8.445V15.5a.5.5 0 0 0 .5.5H7a.5.5 0 0 0 .5-.5V12A1.5 1.5 0 0 1 9 10.5h2a1.5 1.5 0 0 1 1.5 1.5v3.5a.5.5 0 0 0 .5.5h2.5a.5.5 0 0 0 .5-.5V8.445a.5.5 0 0 0-.166-.371l-5.5-4.942z" fill="currentColor"></path>
          </g>
        </svg>
      </cosy-icon>
    </cosy-tooltip>
    
    
    <svg class="arrow" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20">
      <g fill="none">
        <path d="M7.733 4.207a.75.75 0 0 1 1.06.026l5.001 5.25a.75.75 0 0 1 0 1.035l-5 5.25a.75.75 0 1 1-1.087-1.034L12.216 10l-4.51-4.734a.75.75 0 0 1 .027-1.06z" fill="currentColor"></path>
      </g>
    </svg>
    <a class="ellipsis" href="/categories/Pwn%E7%9F%A5%E8%AF%86/">
      Pwn知识
    </a>
    
    
    
    <svg class="arrow" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20">
      <g fill="none">
        <path d="M7.733 4.207a.75.75 0 0 1 1.06.026l5.001 5.25a.75.75 0 0 1 0 1.035l-5 5.25a.75.75 0 1 1-1.087-1.034L12.216 10l-4.51-4.734a.75.75 0 0 1 .027-1.06z" fill="currentColor"></path>
      </g>
    </svg>
    <span class="ellipsis">
      malloc/free源码实现
    </span>
    
  </section>
</nav>


<script src="/js/31d6cfe0.js"></script>

    </div>
    <div class="right">
      
      <cosy-tooltip id="toc-show-button" placement="left">
        <span slot="content">
          <span>显示 / 隐藏 文章目录</span>
          <cosy-short-key>]</cosy-short-key>
        </span>
        <cosy-icon>
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20">
            <g fill="none">
              <path d="M4 4c-1.104-.019-2 .896-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2H4zM3 6a1 1 0 0 1 1-1h2.995v10H4a1 1 0 0 1-1-1V6zm4.995 9V5h8.004a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H7.995z" fill="currentColor"></path>
            </g>
          </svg>
        </cosy-icon>
      </cosy-tooltip>
      
    </div>
  </header>
  <div class="content">
    <main class="cosy-scrollbar">
      <div class="article-container">
        <!-- 渲染文章内容 -->
        <article>
          <!-- 文章标题 -->
          <h1 class="post-title">malloc/free源码实现</h1>
          <div class="last-updated">
            上次更新: 2024-02-29 18:18:56
          </div>
          <!-- 文章 -->
          <h1 id="细读源码"><a href="#细读源码" class="headerlink" title="细读源码"></a>细读源码</h1><p>“Public wrappers”（公共包装器）通常指的是在软件开发中用于封装和提供对外部（公共）接口的函数或类。这些包装器函数或类可以隐藏底层实现的细节，提供更简单、更易用的接口，以方便其他开发人员使用。</p>
<h1 id="glibc-2-23"><a href="#glibc-2-23" class="headerlink" title="glibc-2.23"></a>glibc-2.23</h1><p>首先在读源码前要先了解一些核心结构</p>
<p>mchunkptr是chunk的指针</p>
<h2 id="malloc-state"><a href="#malloc-state" class="headerlink" title="malloc_state"></a>malloc_state</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">malloc_state</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">/* Serialize access.  */</span>
  <span class="token comment">/* 序列化访问 */</span>
  <span class="token function">__libc_lock_define</span> <span class="token punctuation">(</span><span class="token punctuation">,</span> mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Flags (formerly in max_fast).  */</span>
  <span class="token comment">/* 标志位（以前在 max_fast 中） */</span>
  <span class="token keyword">int</span> flags<span class="token punctuation">;</span>

  <span class="token comment">/* Set if the fastbin chunks contain recently inserted free blocks.  */</span>
  <span class="token comment">/* Note this is a bool but not all targets support atomics on booleans.  */</span>
  <span class="token comment">/* 如果 fastbin 块包含最近插入的空闲块，则设置为 1 */</span>
  <span class="token comment">/* 注意，这是一个布尔值，但并非所有目标平台都支持对布尔值的原子操作 */</span>
  <span class="token keyword">int</span> have_fastchunks<span class="token punctuation">;</span>

  <span class="token comment">/* Fastbins */</span>
  mfastbinptr fastbinsY<span class="token punctuation">[</span>NFASTBINS<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">/* Base of the topmost chunk -- not otherwise kept in a bin */</span>
  <span class="token comment">/* 最顶层块的基址 -- 不在任何 bin 中 */</span>
  mchunkptr top<span class="token punctuation">;</span>

  <span class="token comment">/* The remainder from the most recent split of a small request */</span>
  <span class="token comment">/* 最近一次拆分小型请求产生的剩余块 */</span>
  mchunkptr last_remainder<span class="token punctuation">;</span>

  <span class="token comment">/* Normal bins packed as described above */</span>
  <span class="token comment">/* 正常 bins，按照上述描述进行打包 */</span>
  mchunkptr bins<span class="token punctuation">[</span>NBINS <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">/* Bitmap of bins */</span>
  <span class="token comment">/* bins 的位图 */</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> binmap<span class="token punctuation">[</span>BINMAPSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">/* Linked list */</span>
  <span class="token comment">/* 链表 */</span>
  <span class="token keyword">struct</span> <span class="token class-name">malloc_state</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>

  <span class="token comment">/* Linked list for free arenas.  Access to this field is serialized
     by free_list_lock in arena.c.  */</span>
  <span class="token comment">/* 用于空闲 arenas 的链表。访问该字段由 arena.c 中的 free_list_lock 进行序列化 */</span>
  <span class="token keyword">struct</span> <span class="token class-name">malloc_state</span> <span class="token operator">*</span>next_free<span class="token punctuation">;</span>

  <span class="token comment">/* Number of threads attached to this arena.  0 if the arena is on
     the free list.  Access to this field is serialized by
     free_list_lock in arena.c.  */</span>
   <span class="token comment">/* 附加到该 arena 的线程数。如果该 arena 在空闲列表中，则为 0。访问该字段由 arena.c 中的              free_list_lock 进行序列化 */</span>
  INTERNAL_SIZE_T attached_threads<span class="token punctuation">;</span>

  <span class="token comment">/* Memory allocated from the system in this arena.  */</span>
  <span class="token comment">/* 在该 arena 中从系统分配的内存 */</span>
  INTERNAL_SIZE_T system_mem<span class="token punctuation">;</span>
  INTERNAL_SIZE_T max_system_mem<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>mstate是arena的指针</p>
<p>Linux中提供一把<strong>互斥锁mutex</strong>（<strong>也称之为互斥量</strong>）。</p>
<p>每个线程在对资源操作前都尝试先加锁，成功加锁才能操作，操作结束解锁。</p>
<p>但通过“锁”就将资源的访问变成互斥操作，而后与时间有关的错误也不会再产生了。</p>
<h2 id="libc-malloc"><a href="#libc-malloc" class="headerlink" title="__libc_malloc"></a>__libc_malloc</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span>
<span class="token function">__libc_malloc</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> bytes<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  mstate ar_ptr<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>victim<span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>hook<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>
    <span class="token operator">=</span> <span class="token function">atomic_forced_read</span> <span class="token punctuation">(</span>__malloc_hook<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>hook <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">*</span>hook<span class="token punctuation">)</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> <span class="token function">RETURN_ADDRESS</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">arena_get</span> <span class="token punctuation">(</span>ar_ptr<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

  victim <span class="token operator">=</span> <span class="token function">_int_malloc</span> <span class="token punctuation">(</span>ar_ptr<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* Retry with another arena only if we were able to find a usable arena
     before.  */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>victim <span class="token operator">&amp;&amp;</span> ar_ptr <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">LIBC_PROBE</span> <span class="token punctuation">(</span>memory_malloc_retry<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      ar_ptr <span class="token operator">=</span> <span class="token function">arena_get_retry</span> <span class="token punctuation">(</span>ar_ptr<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      victim <span class="token operator">=</span> <span class="token function">_int_malloc</span> <span class="token punctuation">(</span>ar_ptr<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>ar_ptr <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token function">mutex_unlock</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>ar_ptr<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token operator">!</span>victim <span class="token operator">||</span> <span class="token function">chunk_is_mmapped</span> <span class="token punctuation">(</span><span class="token function">mem2chunk</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
          ar_ptr <span class="token operator">==</span> <span class="token function">arena_for_chunk</span> <span class="token punctuation">(</span><span class="token function">mem2chunk</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> victim<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>__libc_malloc<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> 可以分为三个主要部分：主要包含<strong>callback、arena_get、_int_malloc</strong>，我们把<strong>callback和arena_get当作初始化</strong>的过程，_<strong>int_malloc作为实际分配</strong>的过程，接下来就一步一步分析</p>
<h3 id="callback"><a href="#callback" class="headerlink" title="callback"></a>callback</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>hook<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>
  <span class="token operator">=</span> <span class="token function">atomic_forced_read</span> <span class="token punctuation">(</span>__malloc_hook<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>hook <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">*</span>hook<span class="token punctuation">)</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> <span class="token function">RETURN_ADDRESS</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中的<code>atomic_forced_read(__malloc_hook)</code>的宏定义是</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">define</span> <span class="token macro-name function">atomic_forced_read</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token function">__typeof</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> __x<span class="token punctuation">;</span> <span class="token function">__asm</span> <span class="token punctuation">(</span></span><span class="token string">""</span> <span class="token expression"><span class="token operator">:</span> </span><span class="token string">"=r"</span> <span class="token expression"><span class="token punctuation">(</span>__x<span class="token punctuation">)</span> <span class="token operator">:</span> </span><span class="token string">"0"</span> <span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> __x<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这样的，主要是用内联汇编的手段，来使得该段用的是强制读取的原子操作，能够避免多线程的干扰</p>
<p>而<code>__builtin_expect(x,y)</code>这个语句的参数x是一个式子，而y表示期望值，能够使得编译器编译出更加效率的文件，而y&#x3D;0表示这个式子x基本不可能发生，但是也是有可能发生的</p>
<p>hook是一个函数指针变量，被赋值成了__malloc_hook，后者定义如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">weak_variable</span> <span class="token punctuation">(</span><span class="token operator">*</span>__malloc_hook<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token class-name">size_t</span> __size<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span> malloc_hook_ini<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>__malloc_hook被初始化成了malloc_hook_ini，后者定义如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">malloc_hook_ini</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> sz<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>caller<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  __malloc_hook <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token function">ptmalloc_init</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">__libc_malloc</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里<strong>malloc_hook又被赋值成了NULL，然后再重新调用</strong>libc_malloc，这样就可以保证在多次调用__libc_malloc的情况下，代码1中的hook回调函数只会被调用一次，如下图所示：</p>
<p><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/2023-03-18_170117.png"><img src="https://cdn.jsdelivr.net/gh/ixout/picture@main/img/2023-03-18_170117.png" alt="img"></a></p>
<p>而其中<code>ptmalloc_init</code>的精简定义如下</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">ptmalloc_init</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__malloc_initialized <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  __malloc_initialized <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  
  thread_arena <span class="token operator">=</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">;</span>
  
  __malloc_initialized <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>通过__malloc_initialized这个全局flag来检测是不是已经初始化过，如果没有，则把main_arena设成当前的thread_arena，这是因为初始化肯定是主线程在做，而主线程用的是main_arena，然后再回到<code>malloc_hook_ini</code>执行<code>__libc_malloc</code>回到函数中继续执行调用malloc</p>
<p>第一次调用 malloc 函数时函数调用路径如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">malloc <span class="token operator">-></span> __libc_malloc <span class="token operator">-></span> <span class="token function">__malloc_hook</span><span class="token punctuation">(</span>即malloc_hook_ini<span class="token punctuation">)</span> <span class="token operator">-></span> ptmalloc_init <span class="token operator">-></span> __libc_malloc <span class="token operator">-></span> _int_malloc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>以后用户再调用 malloc 函数的时候，路径将是这样的：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">malloc <span class="token operator">-></span> __libc_malloc <span class="token operator">-></span> _int_mallocc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="arena-get"><a href="#arena-get" class="headerlink" title="arena_get"></a>arena_get</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span>
<span class="token function">__libc_malloc</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> bytes<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  mstate ar_ptr<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>victim<span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>hook<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>
    <span class="token operator">=</span> <span class="token function">atomic_forced_read</span> <span class="token punctuation">(</span>__malloc_hook<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>hook <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">*</span>hook<span class="token punctuation">)</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> <span class="token function">RETURN_ADDRESS</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//over</span>

  <span class="token function">arena_get</span> <span class="token punctuation">(</span>ar_ptr<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>下一个执行的便是<code>arena_get</code>宏</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* arena_get() acquires an arena and locks the corresponding mutex.
   First, try the one last locked successfully by this thread.  (This
   is the common case and handled with a macro for speed.)  Then, loop
   once over the circularly linked list of arenas.  If no arena is
   readily available, create a new one.  In this latter case, `size'
   is just a hint as to how much memory will be required immediately
   in the new arena. */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">arena_get</span><span class="token expression"><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> size<span class="token punctuation">)</span> <span class="token keyword">do</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span>
      <span class="token expression">ptr <span class="token operator">=</span> thread_arena<span class="token punctuation">;</span>						      </span><span class="token punctuation">\</span>
      <span class="token expression"><span class="token function">arena_lock</span> <span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>						      </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">arena_lock</span><span class="token expression"><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> size<span class="token punctuation">)</span> <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>					      </span><span class="token punctuation">\</span>
      <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>ptr <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">arena_is_corrupt</span> <span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">)</span>				      </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token function">mutex_lock</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>ptr<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>				      </span><span class="token punctuation">\</span>
      <span class="token expression"><span class="token keyword">else</span>								      </span><span class="token punctuation">\</span>
        <span class="token expression">ptr <span class="token operator">=</span> <span class="token function">arena_get2</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				      </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这上面的注释是一段解释说明它首先尝试获取上次由该线程成功锁定的arena，这是一种常见情况，并且使用宏来提高速度。如果没有可用的arena，就会循环遍历arena的循环链表，直到找到一个可用的arena。如果仍然没有可用的arena，则会创建一个新的arena，其中的<code>size</code>参数只是一个关于新arena所需内存量的提示。</p>
<p>该过程大致如下，其中arena_get2函数的作用是最重要的，包含了三个重要的函数<code>get_free_list</code>，<code>_int_new_arena</code>，<code>reused_arena</code></p>
<img src="https://img.hijwei.top/2/24/65e059ebb9cca.png" alt="image-20240226192907334" style="zoom:50%;" />

<p>做题只会遇到main_arena(libc自带的)，而main_arena没有heap_info对应着不用新创建一个arena</p>
<h2 id="int-malloc"><a href="#int-malloc" class="headerlink" title="_int_malloc"></a>_int_malloc</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span>
<span class="token function">__libc_malloc</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> bytes<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  mstate ar_ptr<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>victim<span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>hook<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>
    <span class="token operator">=</span> <span class="token function">atomic_forced_read</span> <span class="token punctuation">(</span>__malloc_hook<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>hook <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">*</span>hook<span class="token punctuation">)</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> <span class="token function">RETURN_ADDRESS</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">arena_get</span> <span class="token punctuation">(</span>ar_ptr<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

  victim <span class="token operator">=</span> <span class="token function">_int_malloc</span> <span class="token punctuation">(</span>ar_ptr<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>之后便是调用<code>_int_malloc</code>了</p>
<p>先是初始化</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span>
<span class="token function">_int_malloc</span> <span class="token punctuation">(</span>mstate av<span class="token punctuation">,</span> <span class="token class-name">size_t</span> bytes<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  INTERNAL_SIZE_T nb<span class="token punctuation">;</span>               <span class="token comment">/* 规范化的请求大小 */</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> idx<span class="token punctuation">;</span>                 <span class="token comment">/* 关联的bin索引 */</span>
  mbinptr bin<span class="token punctuation">;</span>                      <span class="token comment">/* 关联的bin */</span>

  mchunkptr victim<span class="token punctuation">;</span>                 <span class="token comment">/* 检查/选中的块 */</span>
  INTERNAL_SIZE_T size<span class="token punctuation">;</span>             <span class="token comment">/* 块的大小 */</span>
  <span class="token keyword">int</span> victim_index<span class="token punctuation">;</span>                 <span class="token comment">/* 块的bin索引 */</span>

  mchunkptr remainder<span class="token punctuation">;</span>              <span class="token comment">/* 拆分后的剩余块 */</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> remainder_size<span class="token punctuation">;</span>     <span class="token comment">/* 剩余块的大小 */</span>

  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> block<span class="token punctuation">;</span>               <span class="token comment">/* 位图遍历器 */</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> bit<span class="token punctuation">;</span>                 <span class="token comment">/* 位图遍历器 */</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> map<span class="token punctuation">;</span>                 <span class="token comment">/* 当前binmap的字 */</span>

  mchunkptr fwd<span class="token punctuation">;</span>                    <span class="token comment">/* 链接的临时变量 */</span>
  mchunkptr bck<span class="token punctuation">;</span>                    <span class="token comment">/* 链接的临时变量 */</span>

  <span class="token keyword">const</span> <span class="token keyword">char</span> errstr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>之后便是修改bytes使其合法化，nb就是转换后的大小</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
   通过添加SIZE_SZ字节的开销以及可能的额外开销，将请求大小转换为内部形式，以获得必要的对齐和/或至少为MINSIZE（最小可分配大小）的大小。同时，checked_request2size函数会检测并返回0，对于那些在填充和对齐后会导致溢出到零的请求大小。
*/</span>
<span class="token function">checked_request2size</span> <span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>之后如果没有arena即没有分配区可用直接调用sysmalloc一个chunk</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* There are no usable arenas.  Fall back to sysmalloc to get a chunk from
 mmap.  */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>av <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">sysmalloc</span> <span class="token punctuation">(</span>nb<span class="token punctuation">,</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
<span class="token function">alloc_perturb</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> p<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="malloc-consolidate-整理堆块"><a href="#malloc-consolidate-整理堆块" class="headerlink" title="malloc_consolidate(整理堆块)"></a>malloc_consolidate(整理堆块)</h3><p><strong>总结</strong></p>
<ol>
<li><strong>若 get_max_fast() 返回 0，则进行堆的初始化工作，然后进入第 7 步</strong></li>
<li><strong>从 fastbin 中获取一个空闲 chunk</strong></li>
<li><strong>尝试向后合并</strong></li>
<li><strong>若向前相邻 top_chunk，则直接合并到 top_chunk，然后进入第 6 步</strong></li>
<li><strong>否则尝试向前合并后，插入到 unsorted_bin 中</strong></li>
<li><strong>获取下一个空闲 chunk，回到第 2 步，直到所有 fastbin 清空后进入第 7 步</strong></li>
<li><strong>退出函数</strong></li>
</ol>
<h3 id="fastbin（FILO）"><a href="#fastbin（FILO）" class="headerlink" title="fastbin（FILO）"></a>fastbin（FILO）</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
   If the size qualifies as a fastbin, first check corresponding bin.
   This code is safe to execute even if av is not yet initialized, so we
   can try it without checking, which saves some time on this fast path.
 */</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">get_max_fast</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    idx <span class="token operator">=</span> <span class="token function">fastbin_index</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mfastbinptr <span class="token operator">*</span>fb <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">fastbin</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mchunkptr pp <span class="token operator">=</span> <span class="token operator">*</span>fb<span class="token punctuation">;</span>
    <span class="token keyword">do</span>
      <span class="token punctuation">&#123;</span>
        victim <span class="token operator">=</span> pp<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>victim <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pp <span class="token operator">=</span> <span class="token function">catomic_compare_and_exchange_val_acq</span> <span class="token punctuation">(</span>fb<span class="token punctuation">,</span> victim<span class="token operator">-></span>fd<span class="token punctuation">,</span> victim<span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token operator">!=</span> victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>victim <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">fastbin_index</span> <span class="token punctuation">(</span><span class="token function">chunksize</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> idx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">&#123;</span>
            errstr <span class="token operator">=</span> <span class="token string">"malloc(): memory corruption (fast)"</span><span class="token punctuation">;</span>
          errout<span class="token operator">:</span>
            <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span>check_action<span class="token punctuation">,</span> errstr<span class="token punctuation">,</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">,</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token function">check_remalloced_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">alloc_perturb</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> p<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">do</span>
    <span class="token punctuation">&#123;</span>
      victim <span class="token operator">=</span> pp<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>victim <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pp <span class="token operator">=</span> <span class="token function">catomic_compare_and_exchange_val_acq</span> <span class="token punctuation">(</span>fb<span class="token punctuation">,</span> victim<span class="token operator">-></span>fd<span class="token punctuation">,</span> victim<span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token operator">!=</span> victim<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中用到的原子操作</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">atomic_compare_and_exchange_val_acq</span><span class="token expression"><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> newval<span class="token punctuation">,</span> oldval<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token function">__typeof</span> <span class="token punctuation">(</span>mem<span class="token punctuation">)</span> __gmemp <span class="token operator">=</span> <span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>				      </span><span class="token punctuation">\</span>
     <span class="token expression"><span class="token function">__typeof</span> <span class="token punctuation">(</span><span class="token operator">*</span>mem<span class="token punctuation">)</span> __gret <span class="token operator">=</span> <span class="token operator">*</span>__gmemp<span class="token punctuation">;</span>				      </span><span class="token punctuation">\</span>
     <span class="token expression"><span class="token function">__typeof</span> <span class="token punctuation">(</span><span class="token operator">*</span>mem<span class="token punctuation">)</span> __gnewval <span class="token operator">=</span> <span class="token punctuation">(</span>newval<span class="token punctuation">)</span><span class="token punctuation">;</span>			      </span><span class="token punctuation">\</span>
								      <span class="token punctuation">\</span>
     <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>__gret <span class="token operator">==</span> <span class="token punctuation">(</span>oldval<span class="token punctuation">)</span><span class="token punctuation">)</span>					      </span><span class="token punctuation">\</span>
       <span class="token expression"><span class="token operator">*</span>__gmemp <span class="token operator">=</span> __gnewval<span class="token punctuation">;</span>					      </span><span class="token punctuation">\</span>
     <span class="token expression">__gret<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>就是比较mem指向的值是否等于oldval,如果等于则将mem指向的值变为newval,并返回oldval</p>
<p>如果victim不为NULL,检查其大小计算得出的索引是否符合当前索引链</p>
<p>最后有个检查调用<code>check_remalloced_chunk (av, victim, nb);</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">fastbin_index</span> <span class="token punctuation">(</span><span class="token function">chunksize</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> idx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
          errstr <span class="token operator">=</span> <span class="token string">"malloc(): memory corruption (fast)"</span><span class="token punctuation">;</span>
        errout<span class="token operator">:</span>
          <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span>check_action<span class="token punctuation">,</span> errstr<span class="token punctuation">,</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">,</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个就是第一个检查，<strong>该fastbin的size要合法</strong></p>
<p>第二个检查就是<code>check_remalloced_chunk (av, victim, nb);</code>一般是空函数</p>
<p>其中的检查如下：</p>
<ul>
<li>保证x的size合法即可</li>
</ul>
<h3 id="do-check-remalloced-chunk"><a href="#do-check-remalloced-chunk" class="headerlink" title="do_check_remalloced_chunk"></a>do_check_remalloced_chunk</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">do_check_remalloced_chunk <span class="token operator">-></span> do_check_inuse_chunk <span class="token operator">-></span> do_check_chunk <span class="token operator">-></span> do_check_free_chunk<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>而下面的<code>do_check_remalloced_chunk</code>并不是这个因为</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">MALLOC_DEBUG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MALLOC_DEBUG</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>MALLOC_DEBUG&#x3D;0</p>
<p>而</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span>MALLOC_DEBUG</span></span>

<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">define</span> <span class="token macro-name function">check_chunk</span><span class="token expression"><span class="token punctuation">(</span>A<span class="token punctuation">,</span> P<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">define</span> <span class="token macro-name function">check_free_chunk</span><span class="token expression"><span class="token punctuation">(</span>A<span class="token punctuation">,</span> P<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">define</span> <span class="token macro-name function">check_inuse_chunk</span><span class="token expression"><span class="token punctuation">(</span>A<span class="token punctuation">,</span> P<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">define</span> <span class="token macro-name function">check_remalloced_chunk</span><span class="token expression"><span class="token punctuation">(</span>A<span class="token punctuation">,</span> P<span class="token punctuation">,</span> N<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">define</span> <span class="token macro-name function">check_malloced_chunk</span><span class="token expression"><span class="token punctuation">(</span>A<span class="token punctuation">,</span> P<span class="token punctuation">,</span> N<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">define</span> <span class="token macro-name function">check_malloc_state</span><span class="token expression"><span class="token punctuation">(</span>A<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>

<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">define</span> <span class="token macro-name function">check_chunk</span><span class="token expression"><span class="token punctuation">(</span>A<span class="token punctuation">,</span> P<span class="token punctuation">)</span>              <span class="token function">do_check_chunk</span> <span class="token punctuation">(</span>A<span class="token punctuation">,</span> P<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">define</span> <span class="token macro-name function">check_free_chunk</span><span class="token expression"><span class="token punctuation">(</span>A<span class="token punctuation">,</span> P<span class="token punctuation">)</span>         <span class="token function">do_check_free_chunk</span> <span class="token punctuation">(</span>A<span class="token punctuation">,</span> P<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">define</span> <span class="token macro-name function">check_inuse_chunk</span><span class="token expression"><span class="token punctuation">(</span>A<span class="token punctuation">,</span> P<span class="token punctuation">)</span>        <span class="token function">do_check_inuse_chunk</span> <span class="token punctuation">(</span>A<span class="token punctuation">,</span> P<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">define</span> <span class="token macro-name function">check_remalloced_chunk</span><span class="token expression"><span class="token punctuation">(</span>A<span class="token punctuation">,</span> P<span class="token punctuation">,</span> N<span class="token punctuation">)</span> <span class="token function">do_check_remalloced_chunk</span> <span class="token punctuation">(</span>A<span class="token punctuation">,</span> P<span class="token punctuation">,</span> N<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">define</span> <span class="token macro-name function">check_malloced_chunk</span><span class="token expression"><span class="token punctuation">(</span>A<span class="token punctuation">,</span> P<span class="token punctuation">,</span> N<span class="token punctuation">)</span>   <span class="token function">do_check_malloced_chunk</span> <span class="token punctuation">(</span>A<span class="token punctuation">,</span> P<span class="token punctuation">,</span> N<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">define</span> <span class="token macro-name function">check_malloc_state</span><span class="token expression"><span class="token punctuation">(</span>A<span class="token punctuation">)</span>         <span class="token function">do_check_malloc_state</span> <span class="token punctuation">(</span>A<span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个的先决条件便是要满足debug&#x3D;1所以我以下的分析都是多次一举</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">do_check_remalloced_chunk</span> <span class="token punctuation">(</span>mstate av<span class="token punctuation">,</span> mchunkptr p<span class="token punctuation">,</span> INTERNAL_SIZE_T s<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  INTERNAL_SIZE_T sz <span class="token operator">=</span> p<span class="token operator">-></span>size <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span>PREV_INUSE <span class="token operator">|</span> NON_MAIN_ARENA<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">chunk_is_mmapped</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">assert</span> <span class="token punctuation">(</span>av <span class="token operator">==</span> <span class="token function">arena_for_chunk</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//确保内存块所属的堆区域正确</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">chunk_non_main_arena</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">assert</span> <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">else</span>
        <span class="token function">assert</span> <span class="token punctuation">(</span>av <span class="token operator">==</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//进一步确定，一般只要标志位正确</span>
    <span class="token punctuation">&#125;</span>

  <span class="token function">do_check_inuse_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Legal size ... */</span>
  <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sz <span class="token operator">&amp;</span> MALLOC_ALIGN_MASK<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//检查内存对齐</span>
  <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span> <span class="token operator">>=</span> MINSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//检查size>=minsize</span>
  <span class="token comment">/* ... and alignment */</span>
  <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">aligned_OK</span> <span class="token punctuation">(</span><span class="token function">chunk2mem</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//检查起始地址满足对齐条件</span>
  <span class="token comment">/* chunk is less than MINSIZE more than request */</span>
  <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//检查要分配的size>=要求的size</span>
  <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>s <span class="token operator">+</span> MINSIZE<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//检查要分配的size&lt;要求的size+minsize</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中的<code>do_check_inuse_chunk (av, p);</code>这个就对p进行更加细节的检查</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">do_check_inuse_chunk</span> <span class="token punctuation">(</span>mstate av<span class="token punctuation">,</span> mchunkptr p<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  mchunkptr next<span class="token punctuation">;</span>

  <span class="token function">do_check_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//调用在下方</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">chunk_is_mmapped</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">/* mmapped chunks have no next/prev */</span>  <span class="token comment">//如果是mmap的heap直接退出检查</span>

  <span class="token comment">/* Check whether it claims to be in use ... */</span>
  <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">inuse</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">//通过p的地址+size来指向下一个chunk判断本chunk是否正在使用，如果为空闲则退出//fastbin的特性，释放但不置0</span>

  next <span class="token operator">=</span> <span class="token function">next_chunk</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* ... and is surrounded by OK chunks.
     Since more things can be checked with free chunks than inuse ones,
     if an inuse chunk borders them and debug is on, it's worth doing them.
   */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">prev_inuse</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span>   
    <span class="token punctuation">&#123;</span>
      <span class="token comment">/* Note that we cannot even look at prev unless it is not inuse */</span>
      mchunkptr prv <span class="token operator">=</span> <span class="token function">prev_chunk</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">next_chunk</span> <span class="token punctuation">(</span>prv<span class="token punctuation">)</span> <span class="token operator">==</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//如果前一个chunk为空闲块则检查其next_chunk是不是本chunk</span>
      <span class="token function">do_check_free_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> prv<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//调用在下方</span>
    <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">==</span> av<span class="token operator">-></span>top<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">prev_inuse</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//如果next为top则检查topchunk的pre位和size>=minsize</span>
      <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">chunksize</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token operator">>=</span> MINSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">inuse</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">//如果下一个chunk为空闲块则调用检查</span>
    <span class="token function">do_check_free_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">do_check_chunk</span> <span class="token punctuation">(</span>mstate av<span class="token punctuation">,</span> mchunkptr p<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> sz <span class="token operator">=</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* min and max possible addresses assuming contiguous allocation */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>max_address <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>av<span class="token operator">-></span>top<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span>av<span class="token operator">-></span>top<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>min_address <span class="token operator">=</span> max_address <span class="token operator">-</span> av<span class="token operator">-></span>system_mem<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">chunk_is_mmapped</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token comment">/* Has legal address ... */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> av<span class="token operator">-></span>top<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">contiguous</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
              <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> p<span class="token punctuation">)</span> <span class="token operator">>=</span> min_address<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> p <span class="token operator">+</span> sz<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>av<span class="token operator">-></span>top<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token keyword">else</span>
        <span class="token punctuation">&#123;</span>
          <span class="token comment">/* top size is always at least MINSIZE */</span>
          <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span> <span class="token operator">>=</span> MINSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">/* top predecessor always marked inuse */</span>
          <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">prev_inuse</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span>
    <span class="token punctuation">&#123;</span>
      <span class="token comment">/* address is outside main heap  */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">contiguous</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> av<span class="token operator">-></span>top <span class="token operator">!=</span> <span class="token function">initial_top</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
          <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> p<span class="token punctuation">)</span> <span class="token operator">&lt;</span> min_address <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> p<span class="token punctuation">)</span> <span class="token operator">>=</span> max_address<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token comment">/* chunk is page-aligned */</span>
      <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token operator">-></span>prev_size <span class="token operator">+</span> sz<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token function">GLRO</span> <span class="token punctuation">(</span>dl_pagesize<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">/* mem is aligned */</span>
      <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">aligned_OK</span> <span class="token punctuation">(</span><span class="token function">chunk2mem</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>fastbin只需要注意<code>if (p != av-&gt;top)</code>这部分即可</p>
<ul>
<li>断言内存块的地址大于等于最小地址范围。</li>
<li>断言内存块的结束地址小于等于堆的顶部块的地址。</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">do_check_free_chunk</span> <span class="token punctuation">(</span>mstate av<span class="token punctuation">,</span> mchunkptr p<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  INTERNAL_SIZE_T sz <span class="token operator">=</span> p<span class="token operator">-></span>size <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span>PREV_INUSE <span class="token operator">|</span> NON_MAIN_ARENA<span class="token punctuation">)</span><span class="token punctuation">;</span>
  mchunkptr next <span class="token operator">=</span> <span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">do_check_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Chunk must claim to be free ... */</span>
  <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">inuse</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//必须为空闲</span>
  <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">chunk_is_mmapped</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//必须为非mmap</span>

  <span class="token comment">/* Unless a special marker, must have OK fields */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span> <span class="token operator">>=</span> MINSIZE<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sz <span class="token operator">&amp;</span> MALLOC_ALIGN_MASK<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//内存块大小对齐</span>
      <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">aligned_OK</span> <span class="token punctuation">(</span><span class="token function">chunk2mem</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//内存对齐</span>
      <span class="token comment">/* ... matching footer field */</span>
      <span class="token function">assert</span> <span class="token punctuation">(</span>next<span class="token operator">-></span>prev_size <span class="token operator">==</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//next_chunk的pre_size==size</span>
      <span class="token comment">/* ... and is fully consolidated */</span>
      
      <span class="token comment">//前一个chunk被标记为已使用</span>
      <span class="token function">assert</span> <span class="token punctuation">(</span>next <span class="token operator">==</span> av<span class="token operator">-></span>top <span class="token operator">||</span> <span class="token function">inuse</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//next_chunk为top或者next_chunk要为非空闲的</span>

      <span class="token comment">/* ... and has minimally sane links */</span>
      <span class="token function">assert</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>fd<span class="token operator">-></span>bk <span class="token operator">==</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//fd和bk正常检查</span>
      <span class="token function">assert</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>bk<span class="token operator">-></span>fd <span class="token operator">==</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span> <span class="token comment">/* markers are always of size SIZE_SZ */</span>
    <span class="token function">assert</span> <span class="token punctuation">(</span>sz <span class="token operator">==</span> SIZE_SZ<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>MALLOC_DEBUG的作用是用于开发者在发现内存错误的时候，修改其值能够更快的定位错误</p>
<p>正常时候MALLOC_DEBUG&#x3D;0</p>
<h3 id="smallbin（FIFO）"><a href="#smallbin（FIFO）" class="headerlink" title="smallbin（FIFO）"></a>smallbin（FIFO）</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      idx <span class="token operator">=</span> <span class="token function">smallbin_index</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
      bin <span class="token operator">=</span> <span class="token function">bin_at</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>victim <span class="token operator">=</span> <span class="token function">last</span> <span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> bin<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>victim <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">/* initialization check */</span>
            <span class="token function">malloc_consolidate</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">else</span>
            <span class="token punctuation">&#123;</span>
              bck <span class="token operator">=</span> victim<span class="token operator">-></span>bk<span class="token punctuation">;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>bck<span class="token operator">-></span>fd <span class="token operator">!=</span> victim<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                  errstr <span class="token operator">=</span> <span class="token string">"malloc(): smallbin double linked list corrupted"</span><span class="token punctuation">;</span>
                  <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
              <span class="token function">set_inuse_bit_at_offset</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//设置pre位为1</span>
              bin<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
              bck<span class="token operator">-></span>fd <span class="token operator">=</span> bin<span class="token punctuation">;</span>

              <span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span>
                victim<span class="token operator">-></span>size <span class="token operator">|=</span> NON_MAIN_ARENA<span class="token punctuation">;</span>
              <span class="token function">check_malloced_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">alloc_perturb</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">return</span> p<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>符合smallbin的范围的话，就会判定</p>
<ul>
<li>如果链表不为空的话<ul>
<li>如果是由于未初始化导致的就调用<code>malloc_consolidate (av);</code></li>
<li>如果不是则取出</li>
</ul>
</li>
</ul>
<p>其中有着两个检查，第一个是</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">bck <span class="token operator">=</span> victim<span class="token operator">-></span>bk<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>bck<span class="token operator">-></span>fd <span class="token operator">!=</span> victim<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  errstr <span class="token operator">=</span> <span class="token string">"malloc(): smallbin double linked list corrupted"</span><span class="token punctuation">;</span>
  <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>就要满足要分配的victim-&gt;bk-&gt;fd&#x3D;&#x3D;victim，而fd没有这个要求</p>
<p>第二个检查就是<code> check_malloced_chunk (av, victim, nb);</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">do_check_malloced_chunk</span> <span class="token punctuation">(</span>mstate av<span class="token punctuation">,</span> mchunkptr p<span class="token punctuation">,</span> INTERNAL_SIZE_T s<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">/* same as recycled case ... */</span>
  <span class="token function">do_check_remalloced_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> p<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/*
     ... plus,  must obey implementation invariant that prev_inuse is
     always true of any allocated chunk; i.e., that each allocated
     chunk borders either a previously allocated and still in-use
     chunk, or the base of its memory arena. This is ensured
     by making all allocations from the `lowest' part of any found
     chunk.  This does not necessarily hold however for chunks
     recycled via fastbins.
 */</span>
 <span class="token comment">/*
   ... 另外，必须遵守实现不变式，即任何分配的内存块的prev_inuse始终为真；
   换句话说，每个分配的内存块要么与先前分配且仍在使用的内存块相邻，
   要么与其内存区域的基址相邻。通过从任何找到的内存块的“最低”部分进行所有分配，
   可以确保这一点。然而，通过快速链表回收的内存块不一定满足这个条件。
*/</span>

  <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">prev_inuse</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中包含的<code>do_check_remalloc_chunk</code>在上面也有过了</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">do_check_remalloced_chunk</span> <span class="token punctuation">(</span>mstate av<span class="token punctuation">,</span> mchunkptr p<span class="token punctuation">,</span> INTERNAL_SIZE_T s<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  INTERNAL_SIZE_T sz <span class="token operator">=</span> p<span class="token operator">-></span>size <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span>PREV_INUSE <span class="token operator">|</span> NON_MAIN_ARENA<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">chunk_is_mmapped</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">assert</span> <span class="token punctuation">(</span>av <span class="token operator">==</span> <span class="token function">arena_for_chunk</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//确保内存块所属的堆区域正确</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">chunk_non_main_arena</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">assert</span> <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">else</span>
        <span class="token function">assert</span> <span class="token punctuation">(</span>av <span class="token operator">==</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//进一步确定，一般只要标志位正确</span>
    <span class="token punctuation">&#125;</span>

  <span class="token function">do_check_inuse_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Legal size ... */</span>
  <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sz <span class="token operator">&amp;</span> MALLOC_ALIGN_MASK<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//检查内存对齐</span>
  <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span> <span class="token operator">>=</span> MINSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//检查size>=minsize</span>
  <span class="token comment">/* ... and alignment */</span>
  <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">aligned_OK</span> <span class="token punctuation">(</span><span class="token function">chunk2mem</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//检查起始地址满足对齐条件</span>
  <span class="token comment">/* chunk is less than MINSIZE more than request */</span>
  <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//检查要分配的size>=要求的size</span>
  <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>s <span class="token operator">+</span> MINSIZE<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//检查要分配的size&lt;要求的size+minsize</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>而其中包含的<code>do_check_inuse_chunk (av, p);</code>概括来说是首先确保本chunk为非空闲状态，然后前后的chunk如果有空闲的则进行合法的检查</p>
<p>而<code>do_check_inuse_chunk (av, p);</code>其中包含的<code>do_check_chunk</code>，概括来说就是确保本chunk的地址在合法的范围</p>
<p>而<code>assert (prev_inuse (p));</code>这个语句 是由于如果free的时候前方为空闲则会合并，那么必须为非空闲</p>
<h3 id="largebin-FIFO"><a href="#largebin-FIFO" class="headerlink" title="largebin(FIFO)"></a>largebin(FIFO)</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">else</span>
<span class="token punctuation">&#123;</span>
  idx <span class="token operator">=</span> <span class="token function">largebin_index</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">have_fastchunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">malloc_consolidate</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>判断是否有fastchunk,是则触发malloc_consolidate (av);</li>
<li>进入unsortedbin遍历循环,找到则返回</li>
<li>进入largebin分配</li>
</ol>
<h3 id="大循环"><a href="#大循环" class="headerlink" title="大循环"></a>大循环</h3><p>接下来就是大众所知的大循环了，接下来的几个部分都是大循环的</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token punctuation">)</span>       <span class="token comment">//大循环</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> iters <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="unsortedbin-FIFO-遍历"><a href="#unsortedbin-FIFO-遍历" class="headerlink" title="unsortedbin(FIFO)遍历"></a>unsortedbin(FIFO)遍历</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>victim <span class="token operator">=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-></span>bk<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">//unsortedbin中有chunk</span>
        <span class="token punctuation">&#123;</span>
          bck <span class="token operator">=</span> victim<span class="token operator">-></span>bk<span class="token punctuation">;</span>       <span class="token comment">//bck是第一个unsorted chunk的bk</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>victim<span class="token operator">-></span>size <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
              <span class="token operator">||</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>victim<span class="token operator">-></span>size <span class="token operator">></span> av<span class="token operator">-></span>system_mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">//first check</span>
            <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span>check_action<span class="token punctuation">,</span> <span class="token string">"malloc(): memory corruption"</span><span class="token punctuation">,</span>
                             <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">,</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>
          size <span class="token operator">=</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>         

          <span class="token comment">/*
             If a small request, try to use last remainder if it is the
             only chunk in unsorted bin.  This helps promote locality for
             runs of consecutive small requests. This is the only
             exception to best-fit, and applies only when there is
             no exact fit for a small chunk.
           */</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
              bck <span class="token operator">==</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
              victim <span class="token operator">==</span> av<span class="token operator">-></span>last_remainder <span class="token operator">&amp;&amp;</span>
              <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb <span class="token operator">+</span> MINSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">//如果要申请的chunk处于smallbin的范围内，并且大小合适</span>
            <span class="token punctuation">&#123;</span>                                                  <span class="token comment">//victim为unsortedbin的唯一一个chunk，也是切割剩余的chunk</span>
              <span class="token comment">/* split and reattach remainder */</span>                    <span class="token comment">//采用last_remainder分配方式</span>
              remainder_size <span class="token operator">=</span> size <span class="token operator">-</span> nb<span class="token punctuation">;</span>             
              remainder <span class="token operator">=</span> <span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-></span>bk <span class="token operator">=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-></span>fd <span class="token operator">=</span> remainder<span class="token punctuation">;</span>
              av<span class="token operator">-></span>last_remainder <span class="token operator">=</span> remainder<span class="token punctuation">;</span>
              remainder<span class="token operator">-></span>bk <span class="token operator">=</span> remainder<span class="token operator">-></span>fd <span class="token operator">=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>remainder_size<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                  remainder<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                  remainder<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>

              <span class="token function">set_head</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb <span class="token operator">|</span> PREV_INUSE <span class="token operator">|</span>
                        <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena <span class="token operator">?</span> NON_MAIN_ARENA <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">set_head</span> <span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">set_foot</span> <span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token function">check_malloced_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">alloc_perturb</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">return</span> p<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

          <span class="token comment">/* remove from unsorted list */</span>
          <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
          bck<span class="token operator">-></span>fd <span class="token operator">=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//初始取出</span>

          <span class="token comment">/* Take now instead of binning if exact fit */</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> nb<span class="token punctuation">)</span>      <span class="token comment">//大小相等直接取出</span>
            <span class="token punctuation">&#123;</span> 
              <span class="token function">set_inuse_bit_at_offset</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span>
                victim<span class="token operator">-></span>size <span class="token operator">|=</span> NON_MAIN_ARENA<span class="token punctuation">;</span>
              <span class="token function">check_malloced_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">alloc_perturb</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">return</span> p<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

          <span class="token comment">/* place chunk in bin */</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token comment">//如果在smallbin的范围</span>
            <span class="token punctuation">&#123;</span>
              victim_index <span class="token operator">=</span> <span class="token function">smallbin_index</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
              bck <span class="token operator">=</span> <span class="token function">bin_at</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
              fwd <span class="token operator">=</span> bck<span class="token operator">-></span>fd<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
          <span class="token keyword">else</span>       <span class="token comment">//如果不在smallbin即largebin的范围</span>
            <span class="token punctuation">&#123;</span>
              victim_index <span class="token operator">=</span> <span class="token function">largebin_index</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
              bck <span class="token operator">=</span> <span class="token function">bin_at</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
              fwd <span class="token operator">=</span> bck<span class="token operator">-></span>fd<span class="token punctuation">;</span>

              <span class="token comment">/* maintain large bins in sorted order */</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>fwd <span class="token operator">!=</span> bck<span class="token punctuation">)</span>                                 <span class="token comment">//largebin本身有chunk</span>
                <span class="token punctuation">&#123;</span>
                  <span class="token comment">/* Or with inuse bit to speed comparisons */</span>
                  size <span class="token operator">|=</span> PREV_INUSE<span class="token punctuation">;</span>          
                  <span class="token comment">/* if smaller than smallest, bypass loop below */</span>
                  <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bck<span class="token operator">-></span>bk<span class="token operator">-></span>size <span class="token operator">&amp;</span> NON_MAIN_ARENA<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>bck<span class="token operator">-></span>bk<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//小于最小的size</span>
                    <span class="token punctuation">&#123;</span>
                      fwd <span class="token operator">=</span> bck<span class="token punctuation">;</span>
                      bck <span class="token operator">=</span> bck<span class="token operator">-></span>bk<span class="token punctuation">;</span>

                      victim<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> fwd<span class="token operator">-></span>fd<span class="token punctuation">;</span>
                      victim<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> fwd<span class="token operator">-></span>fd<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>
                      fwd<span class="token operator">-></span>fd<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> victim<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                  <span class="token keyword">else</span>
                    <span class="token punctuation">&#123;</span>
                      <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fwd<span class="token operator">-></span>size <span class="token operator">&amp;</span> NON_MAIN_ARENA<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> size <span class="token operator">&lt;</span> fwd<span class="token operator">-></span>size<span class="token punctuation">)</span> 
                        <span class="token punctuation">&#123;</span>
                          fwd <span class="token operator">=</span> fwd<span class="token operator">-></span>fd_nextsize<span class="token punctuation">;</span>
                          <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fwd<span class="token operator">-></span>size <span class="token operator">&amp;</span> NON_MAIN_ARENA<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>

                      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> size <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> fwd<span class="token operator">-></span>size<span class="token punctuation">)</span>
                        <span class="token comment">/* Always insert in the second position.  */</span>
                        fwd <span class="token operator">=</span> fwd<span class="token operator">-></span>fd<span class="token punctuation">;</span>   
                      <span class="token keyword">else</span>
                        <span class="token punctuation">&#123;</span>
                          victim<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
                          victim<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> fwd<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>
                          fwd<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
                          victim<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                      bck <span class="token operator">=</span> fwd<span class="token operator">-></span>bk<span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
              <span class="token keyword">else</span>
                victim<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> victim<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

          <span class="token function">mark_bin</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//标记相应binmap</span>
          victim<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
          victim<span class="token operator">-></span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
          fwd<span class="token operator">-></span>bk <span class="token operator">=</span> victim<span class="token punctuation">;</span>
          bck<span class="token operator">-></span>fd <span class="token operator">=</span> victim<span class="token punctuation">;</span>    <span class="token comment">//插入</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_ITERS</span>       <span class="token expression"><span class="token number">10000</span></span></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>iters <span class="token operator">>=</span> MAX_ITERS<span class="token punctuation">)</span>   <span class="token comment">//最多循环1000次</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>过程</p>
<ul>
<li>对victim的size进行检查</li>
<li>当申请大小处于smallbin范围&amp;&amp;victim为unsortedbin中最后一个chunk&amp;&amp;victim为last_remainer&amp;&amp;size大于申请大小+min_size,采用last_remainer分配</li>
<li>将victim移除unsorted</li>
<li>如果size刚好则直接返回</li>
<li>否则进行进入bin的成链准备</li>
<li>标志binmap,并彻底成链,unsorted遍历也是唯一一会mark_bin处</li>
</ul>
<h3 id="编译后largebin的分配"><a href="#编译后largebin的分配" class="headerlink" title="编译后largebin的分配"></a>编译后largebin的分配</h3><p>​	同一个largebin的size的大小是不一定相等的，而largebin的链表头-&gt;bk是最小的size，链表头-&gt;fd是最大的size，在除了链表头以外指向bk越来越大，指向fd越来越小；而bk_nextsize和fd_nextsize是指向下一个不同大小的chunk，同一个大小的chunk只有第一个chunk有nextsize，其他的nextsize位置为垃圾数据，bk_nextsize指向下一个更大的chunk，fd_nextsize指向上一个更小的chunk</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  bin <span class="token operator">=</span> <span class="token function">bin_at</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* skip scan if empty or largest chunk is too small */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>victim <span class="token operator">=</span> <span class="token function">first</span> <span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> bin <span class="token operator">&amp;&amp;</span>                           <span class="token comment">//victim初始是本bin最大的chunk</span>
      <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>victim<span class="token operator">-></span>size<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">//largebin非空且要分配的size小于largebin最大的size</span>
    <span class="token punctuation">&#123;</span>
      victim <span class="token operator">=</span> victim<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>                    
      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size <span class="token operator">=</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span>    <span class="token comment">//找到size恰好大于等于要分配size的chunk</span>
              <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        victim <span class="token operator">=</span> victim<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>

      <span class="token comment">/* Avoid removing the first entry for a size so that the skip
         list does not have to be rerouted.  */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>victim <span class="token operator">!=</span> <span class="token function">last</span> <span class="token punctuation">(</span>bin<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> victim<span class="token operator">-></span>size <span class="token operator">==</span> victim<span class="token operator">-></span>fd<span class="token operator">-></span>size<span class="token punctuation">)</span>
        victim <span class="token operator">=</span> victim<span class="token operator">-></span>fd<span class="token punctuation">;</span>    <span class="token comment">//尽量不取带有nextsize的chunk</span>

      remainder_size <span class="token operator">=</span> size <span class="token operator">-</span> nb<span class="token punctuation">;</span>
      <span class="token function">unlink</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> bck<span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//取出victim，同时也有设置nextsize的功能</span>

      <span class="token comment">/* Exhaust */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>remainder_size <span class="token operator">&lt;</span> MINSIZE<span class="token punctuation">)</span>  
        <span class="token punctuation">&#123;</span>
          <span class="token function">set_inuse_bit_at_offset</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span>
            victim<span class="token operator">-></span>size <span class="token operator">|=</span> NON_MAIN_ARENA<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token comment">/* Split */</span>
      <span class="token keyword">else</span>
        <span class="token punctuation">&#123;</span>
          remainder <span class="token operator">=</span> <span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">/* We cannot assume the unsorted list is empty and therefore
             have to perform a complete insert here.  */</span>
          bck <span class="token operator">=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
          fwd <span class="token operator">=</span> bck<span class="token operator">-></span>fd<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>fwd<span class="token operator">-></span>bk <span class="token operator">!=</span> bck<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">//检查unsorted bin</span>
            <span class="token punctuation">&#123;</span>
              errstr <span class="token operator">=</span> <span class="token string">"malloc(): corrupted unsorted chunks"</span><span class="token punctuation">;</span>
              <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
          remainder<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>    <span class="token comment">//将剩余的块放到unsorted bin里</span>
          remainder<span class="token operator">-></span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
          bck<span class="token operator">-></span>fd <span class="token operator">=</span> remainder<span class="token punctuation">;</span>
          fwd<span class="token operator">-></span>bk <span class="token operator">=</span> remainder<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>remainder_size<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
              remainder<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
              remainder<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
          <span class="token function">set_head</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb <span class="token operator">|</span> PREV_INUSE <span class="token operator">|</span>
                    <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena <span class="token operator">?</span> NON_MAIN_ARENA <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">set_head</span> <span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">set_foot</span> <span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token function">check_malloced_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">alloc_perturb</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> p<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>过程：</p>
<ul>
<li>首先先前条件是largebin不为空，要分配的size小于索引的最大size</li>
<li>之后找到size恰好大于要分配的size的chunk</li>
<li>如果该chunk不唯一，则取其fd指针指向的(尽量不取nextsize)</li>
<li>之后取出本chunk，得到remainder</li>
<li>如果remainder较小则保持原样，仍然在该chunk上即部分个</li>
<li>如果remainder&gt;&#x3D;MINSIZE，就取出然后放入unsortedbin里，在放入前会有一个check，即unsortedbin里的表头-&gt;fd-&gt;bk&#x3D;&#x3D;表头</li>
<li>之后分配返回该chunk</li>
</ul>
<h3 id="binmap情况"><a href="#binmap情况" class="headerlink" title="binmap情况"></a>binmap情况</h3><p>当在smallbin和largebin没有找到恰恰刚刚好的chunk的时候(bin里没有chunk)，就会进行到这一步</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
   通过扫描存储桶来搜索内存块，从下一个较大的存储桶开始。这个搜索严格按照最佳适配的原则进行，也就是选择最小的（如果有多个大小相同的内存块，则选择近似最近使用的）适合的内存块。

   位图的使用避免了需要检查大多数块是否非空的情况。在还没有返回任何内存块的热身阶段跳过所有存储桶的特殊情况比看起来要快。
*/</span>

<span class="token comment">/*
 	Search for a chunk by scanning bins, starting with next largest
 bin. This search is strictly by best-fit; i.e., the smallest
 (with ties going to approximately the least recently used) chunk
 that fits is selected.

 	The bitmap avoids needing to check that most blocks are nonempty.
 The particular case of skipping all bins during warm-up phases
 when no chunks have been returned yet is faster than it might look.
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c">   <span class="token operator">++</span>idx<span class="token punctuation">;</span>            <span class="token comment">//此时必然没有合适的chunk，那么就++开始找</span>
   bin <span class="token operator">=</span> <span class="token function">bin_at</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
   block <span class="token operator">=</span> <span class="token function">idx2block</span> <span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//block表示对应的idx属于哪一个block</span>
   map <span class="token operator">=</span> av<span class="token operator">-></span>binmap<span class="token punctuation">[</span>block<span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">//map就表示block对应的bit组成的二进制数字</span>
   bit <span class="token operator">=</span> <span class="token function">idx2bit</span> <span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//idx的bit</span>

   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token punctuation">)</span>
     <span class="token punctuation">&#123;</span>
       <span class="token comment">/* Skip rest of block if there are no more set bits in this block.  */</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>bit <span class="token operator">></span> map <span class="token operator">||</span> bit <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>      <span class="token comment">//该map没有相应的chunk</span>
         <span class="token punctuation">&#123;</span>
           <span class="token keyword">do</span>
             <span class="token punctuation">&#123;</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>block <span class="token operator">>=</span> BINMAPSIZE<span class="token punctuation">)</span> <span class="token comment">/* out of bins */</span>
                 <span class="token keyword">goto</span> use_top<span class="token punctuation">;</span>
             <span class="token punctuation">&#125;</span>
           <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>map <span class="token operator">=</span> av<span class="token operator">-></span>binmap<span class="token punctuation">[</span>block<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//如果能不满足说明该map对应的block肯定有满足条件的chunk</span>

           bin <span class="token operator">=</span> <span class="token function">bin_at</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> <span class="token punctuation">(</span>block <span class="token operator">&lt;&lt;</span> BINMAPSHIFT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           bit <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
         <span class="token punctuation">&#125;</span>

       <span class="token comment">/* Advance to bin with set bit. There must be one. */</span> 
       <span class="token comment">/* 前进到具有设置位的存储桶。必须存在一个存储桶。 */</span>
       <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bit <span class="token operator">&amp;</span> map<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>   <span class="token comment">//找到对应的bin</span>
         <span class="token punctuation">&#123;</span>
           bin <span class="token operator">=</span> <span class="token function">next_bin</span> <span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token punctuation">;</span>
           bit <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
           <span class="token function">assert</span> <span class="token punctuation">(</span>bit <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//bit!=0</span>
         <span class="token punctuation">&#125;</span>

       <span class="token comment">/* Inspect the bin. It is likely to be non-empty */</span>
       victim <span class="token operator">=</span> <span class="token function">last</span> <span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">/*  If a false alarm (empty bin), clear the bit. */</span>
       <span class="token comment">/* 如果是误报（空的存储桶），则清除该位。 */</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>victim <span class="token operator">==</span> bin<span class="token punctuation">)</span>    
         <span class="token punctuation">&#123;</span>
           av<span class="token operator">-></span>binmap<span class="token punctuation">[</span>block<span class="token punctuation">]</span> <span class="token operator">=</span> map <span class="token operator">&amp;=</span> <span class="token operator">~</span>bit<span class="token punctuation">;</span> <span class="token comment">/* Write through */</span>
           bin <span class="token operator">=</span> <span class="token function">next_bin</span> <span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token punctuation">;</span>
           bit <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
         <span class="token punctuation">&#125;</span>

       <span class="token keyword">else</span><span class="token comment">//接下来就是常规分割了</span>
         <span class="token punctuation">&#123;</span>
           size <span class="token operator">=</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>

           <span class="token comment">/*  We know the first chunk in this bin is big enough to use. */</span>
           <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

           remainder_size <span class="token operator">=</span> size <span class="token operator">-</span> nb<span class="token punctuation">;</span>

           <span class="token comment">/* unlink */</span>
           <span class="token function">unlink</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> bck<span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>

           <span class="token comment">/* Exhaust */</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>remainder_size <span class="token operator">&lt;</span> MINSIZE<span class="token punctuation">)</span>
             <span class="token punctuation">&#123;</span>
               <span class="token function">set_inuse_bit_at_offset</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span>
                 victim<span class="token operator">-></span>size <span class="token operator">|=</span> NON_MAIN_ARENA<span class="token punctuation">;</span>
             <span class="token punctuation">&#125;</span>

           <span class="token comment">/* Split */</span>
           <span class="token keyword">else</span>
             <span class="token punctuation">&#123;</span>
               remainder <span class="token operator">=</span> <span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>

               <span class="token comment">/* We cannot assume the unsorted list is empty and therefore
                  have to perform a complete insert here.  */</span>
               bck <span class="token operator">=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
               fwd <span class="token operator">=</span> bck<span class="token operator">-></span>fd<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>fwd<span class="token operator">-></span>bk <span class="token operator">!=</span> bck<span class="token punctuation">)</span><span class="token punctuation">)</span>
                 <span class="token punctuation">&#123;</span>
                   errstr <span class="token operator">=</span> <span class="token string">"malloc(): corrupted unsorted chunks 2"</span><span class="token punctuation">;</span>
                   <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>
                 <span class="token punctuation">&#125;</span>
               remainder<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
               remainder<span class="token operator">-></span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
               bck<span class="token operator">-></span>fd <span class="token operator">=</span> remainder<span class="token punctuation">;</span>
               fwd<span class="token operator">-></span>bk <span class="token operator">=</span> remainder<span class="token punctuation">;</span>

               <span class="token comment">/* advertise as last remainder */</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span>
                 av<span class="token operator">-></span>last_remainder <span class="token operator">=</span> remainder<span class="token punctuation">;</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>remainder_size<span class="token punctuation">)</span><span class="token punctuation">)</span>
                 <span class="token punctuation">&#123;</span>
                   remainder<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                   remainder<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                 <span class="token punctuation">&#125;</span>
               <span class="token function">set_head</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb <span class="token operator">|</span> PREV_INUSE <span class="token operator">|</span>
                         <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena <span class="token operator">?</span> NON_MAIN_ARENA <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token function">set_head</span> <span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token function">set_foot</span> <span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token punctuation">&#125;</span>
           <span class="token function">check_malloced_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token function">alloc_perturb</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">return</span> p<span class="token punctuation">;</span>
         <span class="token punctuation">&#125;</span>
     <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>过程：</p>
<ul>
<li>首先先++idx，因为此时必然没有合适的chunk，那么就++开始找，然后赋值block map bit那些的</li>
<li>之后判定<code>bit&gt;map</code>(该map没有对应的chunk) <code>|| bit==0</code>(出界)，如果判定成功就会往下一个block找，如果<code>block&gt;=BINMAPSIZE</code>说明超出界限，那么直接进行<code>use top</code>，但是如果找到了对应的block则该block一定存在空闲的chunk</li>
<li>接下来就是在这个map里一位一位找，直到找到对应的bin</li>
<li>然后判定如果该bin为空(被用完了但是没有置零)，就会置零然后重头开始</li>
<li>之后满足所有条件就是分割chunk的常规操作</li>
</ul>
<h3 id="use-top"><a href="#use-top" class="headerlink" title="use_top"></a>use_top</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">victim <span class="token operator">=</span> av<span class="token operator">-></span>top<span class="token punctuation">;</span>
      size <span class="token operator">=</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb <span class="token operator">+</span> MINSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
          remainder_size <span class="token operator">=</span> size <span class="token operator">-</span> nb<span class="token punctuation">;</span>
          remainder <span class="token operator">=</span> <span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
          av<span class="token operator">-></span>top <span class="token operator">=</span> remainder<span class="token punctuation">;</span>
          <span class="token function">set_head</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb <span class="token operator">|</span> PREV_INUSE <span class="token operator">|</span>
                    <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena <span class="token operator">?</span> NON_MAIN_ARENA <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">set_head</span> <span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token function">check_malloced_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">alloc_perturb</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> p<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

      <span class="token comment">/* When we are using atomic ops to free fast chunks we can get
         here for all block sizes.  */</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">have_fastchunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
          <span class="token function">malloc_consolidate</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">/* restore original bin index */</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span>
            idx <span class="token operator">=</span> <span class="token function">smallbin_index</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">else</span>
            idx <span class="token operator">=</span> <span class="token function">largebin_index</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>如果topchunk的size足够分配,那么从topchunk中进行切割</li>
<li>若不够,如果有fast chunk则进行malloc_consolidate,并再次计算idx,回到大循环起始,一般是申请small chunk进入大循环才有可能会触发这个选项</li>
<li>若不够,且没有fast chunk,采用sysmalloc</li>
</ul>
<h3 id="sysmalloc"><a href="#sysmalloc" class="headerlink" title="sysmalloc"></a>sysmalloc</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">else</span>
        <span class="token punctuation">&#123;</span>
          <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">sysmalloc</span> <span class="token punctuation">(</span>nb<span class="token punctuation">,</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
            <span class="token function">alloc_perturb</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> p<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="libc-free"><a href="#libc-free" class="headerlink" title="__libc_free"></a>__libc_free</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">__libc_free</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>mem<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  mstate ar_ptr<span class="token punctuation">;</span>
  mchunkptr p<span class="token punctuation">;</span>                          <span class="token comment">/* chunk corresponding to mem */</span>

  <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>hook<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>
    <span class="token operator">=</span> <span class="token function">atomic_forced_read</span> <span class="token punctuation">(</span>__free_hook<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>hook <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">//__free_hook的调用</span>
    <span class="token punctuation">&#123;</span>
      <span class="token punctuation">(</span><span class="token operator">*</span>hook<span class="token punctuation">)</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> <span class="token function">RETURN_ADDRESS</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>mem <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                              <span class="token comment">/* free(0) has no effect */</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>

  p <span class="token operator">=</span> <span class="token function">mem2chunk</span> <span class="token punctuation">(</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">chunk_is_mmapped</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span>                       <span class="token comment">/* release mmapped memory. */</span>
    <span class="token punctuation">&#123;</span>
      <span class="token comment">/* see if the dynamic brk/mmap threshold needs adjusting */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mp_<span class="token punctuation">.</span>no_dyn_threshold
          <span class="token operator">&amp;&amp;</span> p<span class="token operator">-></span>size <span class="token operator">></span> mp_<span class="token punctuation">.</span>mmap_threshold
          <span class="token operator">&amp;&amp;</span> p<span class="token operator">-></span>size <span class="token operator">&lt;=</span> DEFAULT_MMAP_THRESHOLD_MAX<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
          mp_<span class="token punctuation">.</span>mmap_threshold <span class="token operator">=</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
          mp_<span class="token punctuation">.</span>trim_threshold <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> mp_<span class="token punctuation">.</span>mmap_threshold<span class="token punctuation">;</span>
          <span class="token function">LIBC_PROBE</span> <span class="token punctuation">(</span>memory_mallopt_free_dyn_thresholds<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span>
                      mp_<span class="token punctuation">.</span>mmap_threshold<span class="token punctuation">,</span> mp_<span class="token punctuation">.</span>trim_threshold<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token function">munmap_chunk</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

  ar_ptr <span class="token operator">=</span> <span class="token function">arena_for_chunk</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">_int_free</span> <span class="token punctuation">(</span>ar_ptr<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>过程：</p>
<ul>
<li>如果__free_hook上有东西则直接调用，然后返回</li>
<li>free(0)没有影响，直接返回</li>
<li>如果是mmap的chunk则特殊处理</li>
<li>正常调用<code>_int_free</code></li>
</ul>
<h2 id="int-free"><a href="#int-free" class="headerlink" title="_int_free"></a>_int_free</h2><h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">_int_free</span> <span class="token punctuation">(</span>mstate av<span class="token punctuation">,</span> mchunkptr p<span class="token punctuation">,</span> <span class="token keyword">int</span> have_lock<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  INTERNAL_SIZE_T size<span class="token punctuation">;</span>        <span class="token comment">/* its size */</span>
  mfastbinptr <span class="token operator">*</span>fb<span class="token punctuation">;</span>             <span class="token comment">/* associated fastbin */</span>
  mchunkptr nextchunk<span class="token punctuation">;</span>         <span class="token comment">/* next contiguous chunk */</span>
  INTERNAL_SIZE_T nextsize<span class="token punctuation">;</span>    <span class="token comment">/* its size */</span>
  <span class="token keyword">int</span> nextinuse<span class="token punctuation">;</span>               <span class="token comment">/* true if nextchunk is used */</span>
  INTERNAL_SIZE_T prevsize<span class="token punctuation">;</span>    <span class="token comment">/* size of previous contiguous chunk */</span>
  mchunkptr bck<span class="token punctuation">;</span>               <span class="token comment">/* misc temp for linking */</span>
  mchunkptr fwd<span class="token punctuation">;</span>               <span class="token comment">/* misc temp for linking */</span>

  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>errstr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> locked <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  size <span class="token operator">=</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="检查该chunk的合法性"><a href="#检查该chunk的合法性" class="headerlink" title="检查该chunk的合法性"></a>检查该chunk的合法性</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> p <span class="token operator">></span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> <span class="token operator">-</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>   <span class="token comment">//指针超出了地址空间的范围</span>
    <span class="token operator">||</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">misaligned_chunk</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>       <span class="token comment">//指针p不对齐</span>
  <span class="token punctuation">&#123;</span>
    errstr <span class="token operator">=</span> <span class="token string">"free(): invalid pointer"</span><span class="token punctuation">;</span>
  errout<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>have_lock <span class="token operator">&amp;&amp;</span> locked<span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token function">mutex_unlock</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>av<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span>check_action<span class="token punctuation">,</span> errstr<span class="token punctuation">,</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token comment">/* We know that each chunk is at least MINSIZE bytes in size or a
   multiple of MALLOC_ALIGNMENT.  */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;</span> MINSIZE <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">aligned_OK</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//size &lt; MINSIZE或者size不对齐</span>
  <span class="token punctuation">&#123;</span>
    errstr <span class="token operator">=</span> <span class="token string">"free(): invalid size"</span><span class="token punctuation">;</span>
    <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

<span class="token function">check_inuse_chunk</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="fastbin"><a href="#fastbin" class="headerlink" title="fastbin"></a>fastbin</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">get_max_fast</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">//属于fastbin范围</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">TRIM_FASTBINS   </span><span class="token comment">//为0，不调用</span></span>
      <span class="token comment">/*
	If TRIM_FASTBINS set, don't place chunks
	bordering top into fastbins
      */</span>
      <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">chunk_at_offset</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span> <span class="token operator">!=</span> av<span class="token operator">-></span>top<span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
      <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>  
	<span class="token operator">||</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">chunksize</span> <span class="token punctuation">(</span><span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">//检查next_chunk的size大小合法</span>
			     <span class="token operator">>=</span> av<span class="token operator">-></span>system_mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#123;</span>
	<span class="token comment">/* We might not have a lock at this point and concurrent modifications
	   of system_mem might have let to a false positive.  Redo the test
	   after getting the lock.  */</span>
  <span class="token comment">/*
   在这一点上，我们可能还没有获取到锁，并发修改 system_mem 可能导致了一个误报。在获取锁之后重新进行测试。
  */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>have_lock
	    <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token function">assert</span> <span class="token punctuation">(</span>locked <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		  <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>av<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		  locked <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                  <span class="token comment">//加锁</span>
		  <span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ
		    <span class="token operator">||</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span><span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> av<span class="token operator">-></span>system_mem<span class="token punctuation">;</span>
	      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	  <span class="token punctuation">&#123;</span>
	    errstr <span class="token operator">=</span> <span class="token string">"free(): invalid next size (fast)"</span><span class="token punctuation">;</span>
	    <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>
	  <span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> have_lock<span class="token punctuation">)</span>   
	  <span class="token punctuation">&#123;</span>
	    <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>av<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    locked <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	  <span class="token punctuation">&#125;</span>              <span class="token comment">//由于要求不要锁，所以mutex与locked置0</span>
      <span class="token punctuation">&#125;</span>

    <span class="token function">free_perturb</span> <span class="token punctuation">(</span><span class="token function">chunk2mem</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> size <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">set_fastchunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token function">fastbin_index</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">//计算索引</span>
    fb <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">fastbin</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>                              <span class="token comment">//fb是链表头</span>

    <span class="token comment">/* Atomically link P to its fastbin: P->FD = *FB; *FB = P;  */</span>
    mchunkptr old <span class="token operator">=</span> <span class="token operator">*</span>fb<span class="token punctuation">,</span> old2<span class="token punctuation">;</span>                            <span class="token comment">//old=*fb，定义old2</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> old_idx <span class="token operator">=</span> <span class="token operator">~</span><span class="token number">0u</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span>
      <span class="token punctuation">&#123;</span>
	<span class="token comment">/* Check that the top of the bin is not the record we are going to add
	   (i.e., double free).  */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>old <span class="token operator">==</span> p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token comment">//检查链表头是不是要释放的chunk，避免double free</span>
	  <span class="token punctuation">&#123;</span>
	    errstr <span class="token operator">=</span> <span class="token string">"double free or corruption (fasttop)"</span><span class="token punctuation">;</span>
	    <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>
	  <span class="token punctuation">&#125;</span>
	<span class="token comment">/* Check that size of fastbin chunk at the top is the same as
	   size of the chunk that we are adding.  We can dereference OLD
	   only if we have the lock, otherwise it might have already been
	   deallocated.  See use of OLD_IDX below for the actual check.  */</span>
  <span class="token comment">/*
   检查顶部的 fastbin 块的大小是否与我们要添加的块的大小相同。
   只有在持有锁的情况下才能引用 OLD，否则它可能已经被释放。
   下面的 OLD_IDX 的使用是实际检查的部分。
  */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>have_lock <span class="token operator">&amp;&amp;</span> old <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	  old_idx <span class="token operator">=</span> <span class="token function">fastbin_index</span><span class="token punctuation">(</span><span class="token function">chunksize</span><span class="token punctuation">(</span>old<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	p<span class="token operator">-></span>fd <span class="token operator">=</span> old2 <span class="token operator">=</span> old<span class="token punctuation">;</span>       
      <span class="token punctuation">&#125;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>old <span class="token operator">=</span> <span class="token function">catomic_compare_and_exchange_val_rel</span> <span class="token punctuation">(</span>fb<span class="token punctuation">,</span> p<span class="token punctuation">,</span> old2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> old2<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//总的来说目的就是将p插入到fastbin里</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>have_lock <span class="token operator">&amp;&amp;</span> old <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>old_idx <span class="token operator">!=</span> idx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#123;</span>
	errstr <span class="token operator">=</span> <span class="token string">"invalid fastbin entry (free)"</span><span class="token punctuation">;</span>
	<span class="token keyword">goto</span> errout<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="继续检查"><a href="#继续检查" class="headerlink" title="继续检查"></a>继续检查</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"> <span class="token comment">/*
   Consolidate other non-mmapped chunks as they arrive.
 */</span>

 <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">chunk_is_mmapped</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> have_lock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
     <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>av<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">//加锁</span>
     locked <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span>

   nextchunk <span class="token operator">=</span> <span class="token function">chunk_at_offset</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">/* Lightweight tests: check whether the block is already the
      top block.  */</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> av<span class="token operator">-></span>top<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">//p不能是top chunk</span>
     <span class="token punctuation">&#123;</span>
errstr <span class="token operator">=</span> <span class="token string">"double free or corruption (top)"</span><span class="token punctuation">;</span>
<span class="token keyword">goto</span> errout<span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span>
   <span class="token comment">/* Or whether the next chunk is beyond the boundaries of the arena.  */</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">contiguous</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span>
		  <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> nextchunk
		  <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> av<span class="token operator">-></span>top <span class="token operator">+</span> <span class="token function">chunksize</span><span class="token punctuation">(</span>av<span class="token operator">-></span>top<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>       <span class="token comment">//内存块连续且nextchunk超出边界</span>
     <span class="token punctuation">&#123;</span>
errstr <span class="token operator">=</span> <span class="token string">"double free or corruption (out)"</span><span class="token punctuation">;</span>
<span class="token keyword">goto</span> errout<span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span>
   <span class="token comment">/* Or whether the block is actually not marked used.  */</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">prev_inuse</span><span class="token punctuation">(</span>nextchunk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">//nextchunk的p位要为1</span>
     <span class="token punctuation">&#123;</span>
errstr <span class="token operator">=</span> <span class="token string">"double free or corruption (!prev)"</span><span class="token punctuation">;</span>
<span class="token keyword">goto</span> errout<span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span>

   nextsize <span class="token operator">=</span> <span class="token function">chunksize</span><span class="token punctuation">(</span>nextchunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>nextchunk<span class="token operator">-></span>size <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token operator">||</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>nextsize <span class="token operator">>=</span> av<span class="token operator">-></span>system_mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token comment">//size的大小要合法</span>
     <span class="token punctuation">&#123;</span>
errstr <span class="token operator">=</span> <span class="token string">"free(): invalid next size (normal)"</span><span class="token punctuation">;</span>
<span class="token keyword">goto</span> errout<span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span>

   <span class="token function">free_perturb</span> <span class="token punctuation">(</span><span class="token function">chunk2mem</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> size <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="考虑合并"><a href="#考虑合并" class="headerlink" title="考虑合并"></a>考虑合并</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">   <span class="token comment">/* consolidate backward */</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">prev_inuse</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>         <span class="token comment">//检查，前向合并</span>
     prevsize <span class="token operator">=</span> p<span class="token operator">-></span>prev_size<span class="token punctuation">;</span>
     size <span class="token operator">+=</span> prevsize<span class="token punctuation">;</span>
     p <span class="token operator">=</span> <span class="token function">chunk_at_offset</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> prevsize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">unlink</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> p<span class="token punctuation">,</span> bck<span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>nextchunk <span class="token operator">!=</span> av<span class="token operator">-></span>top<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//如果nextchunk不是topchunk</span>
     <span class="token comment">/* get and clear inuse bit */</span>
     nextinuse <span class="token operator">=</span> <span class="token function">inuse_bit_at_offset</span><span class="token punctuation">(</span>nextchunk<span class="token punctuation">,</span> nextsize<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//设置nextchunk的p位</span>

     <span class="token comment">/* consolidate forward */</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nextinuse<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//检查，后向合并</span>
<span class="token function">unlink</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> nextchunk<span class="token punctuation">,</span> bck<span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
size <span class="token operator">+=</span> nextsize<span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span> <span class="token keyword">else</span>
<span class="token function">clear_inuse_bit_at_offset</span><span class="token punctuation">(</span>nextchunk<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="unsorted-bin"><a href="#unsorted-bin" class="headerlink" title="unsorted bin"></a>unsorted bin</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">     <span class="token comment">/*
Place the chunk in unsorted chunk list. Chunks are
not placed into regular bins until after they have
been given one chance to be used in malloc.
     */</span>

     bck <span class="token operator">=</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
     fwd <span class="token operator">=</span> bck<span class="token operator">-></span>fd<span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>fwd<span class="token operator">-></span>bk <span class="token operator">!=</span> bck<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">//bck->fd->bk==bck</span>
<span class="token punctuation">&#123;</span>
  errstr <span class="token operator">=</span> <span class="token string">"free(): corrupted unsorted chunks"</span><span class="token punctuation">;</span>
  <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
     p<span class="token operator">-></span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>        <span class="token comment">//插入unsorted bin里</span>
     p<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  p<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  p<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
     bck<span class="token operator">-></span>fd <span class="token operator">=</span> p<span class="token punctuation">;</span>
     fwd<span class="token operator">-></span>bk <span class="token operator">=</span> p<span class="token punctuation">;</span>

     <span class="token function">set_head</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">set_foot</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token function">check_free_chunk</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span>

   <span class="token comment">/*
     If the chunk borders the current high end of memory,
     consolidate into top
   */</span>

   <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>         <span class="token comment">//如果nextchunk是topchunk，则合并到topchunk里</span>
     size <span class="token operator">+=</span> nextsize<span class="token punctuation">;</span>
     <span class="token function">set_head</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
     av<span class="token operator">-></span>top <span class="token operator">=</span> p<span class="token punctuation">;</span>
     <span class="token function">check_chunk</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="整理堆块"><a href="#整理堆块" class="headerlink" title="整理堆块"></a>整理堆块</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">    <span class="token comment">/*
      If freeing a large space, consolidate possibly-surrounding
      chunks. Then, if the total unused topmost memory exceeds trim
      threshold, ask malloc_trim to reduce top.

      Unless max_fast is 0, we don't know if there are fastbins
      bordering top, so we cannot tell for sure whether threshold
      has been reached unless fastbins are consolidated.  But we
      don't want to consolidate on each free.  As a compromise,
      consolidation is performed if FASTBIN_CONSOLIDATION_THRESHOLD
      is reached.
    */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">>=</span> FASTBIN_CONSOLIDATION_THRESHOLD<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token comment">//如果该chunk不在fastbin范围里</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">have_fastchunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token function">malloc_consolidate</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//整理fastbin</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">==</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">MORECORE_CANNOT_TRIM       </span></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">chunksize</span><span class="token punctuation">(</span>av<span class="token operator">-></span>top<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span>
	    <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>mp_<span class="token punctuation">.</span>trim_threshold<span class="token punctuation">)</span><span class="token punctuation">)</span>
	  <span class="token function">systrim</span><span class="token punctuation">(</span>mp_<span class="token punctuation">.</span>top_pad<span class="token punctuation">,</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//收缩堆</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">/* Always try heap_trim(), even if the top chunk is not
	   large, because the corresponding heap might go away.  */</span>
	heap_info <span class="token operator">*</span>heap <span class="token operator">=</span> <span class="token function">heap_for_ptr</span><span class="token punctuation">(</span><span class="token function">top</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">assert</span><span class="token punctuation">(</span>heap<span class="token operator">-></span>ar_ptr <span class="token operator">==</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">heap_trim</span><span class="token punctuation">(</span>heap<span class="token punctuation">,</span> mp_<span class="token punctuation">.</span>top_pad<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> have_lock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">assert</span> <span class="token punctuation">(</span>locked<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>av<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">/*
    If the chunk was allocated via mmap, release via munmap().
  */</span>

  <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//如果chunk是mmap得到的，那就调用munmap_chunk</span>
    <span class="token function">munmap_chunk</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>除非有报错，正常情况下<code>_int_free</code>会重头执行到尾</p>
<p>过程：fastbin-&gt;合并-&gt;unsorted bin-&gt;整理堆块</p>
<h1 id="glibc-2-27"><a href="#glibc-2-27" class="headerlink" title="glibc-2.27"></a>glibc-2.27</h1><p>最大的区别就是2.26加了一个tcache</p>
<p>先来了解一些tcache的调用</p>
<h2 id="tcache"><a href="#tcache" class="headerlink" title="tcache"></a>tcache</h2><h3 id="tcache结构体"><a href="#tcache结构体" class="headerlink" title="tcache结构体"></a>tcache结构体</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* We overlay this structure on the user-data portion of a chunk when
   the chunk is stored in the per-thread cache.  */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">tcache_entry</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">tcache_entry</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> tcache_entry<span class="token punctuation">;</span>

<span class="token comment">/* There is one of these for each thread, which contains the
   per-thread cache (hence "tcache_perthread_struct").  Keeping
   overall size low is mildly important.  Note that COUNTS and ENTRIES
   are redundant (we could have just counted the linked list each
   time), this is for performance reasons.  */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">tcache_perthread_struct</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> counts<span class="token punctuation">[</span>TCACHE_MAX_BINS<span class="token punctuation">]</span><span class="token punctuation">;</span>
  tcache_entry <span class="token operator">*</span>entries<span class="token punctuation">[</span>TCACHE_MAX_BINS<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> tcache_perthread_struct<span class="token punctuation">;</span>

<span class="token keyword">static</span> __thread bool tcache_shutting_down <span class="token operator">=</span> false<span class="token punctuation">;</span>
<span class="token keyword">static</span> __thread tcache_perthread_struct <span class="token operator">*</span>tcache <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img.hijwei.top/2/24/65e059ef00aca.png" alt="image-20240229125649925"></p>
<h3 id="tcache-get"><a href="#tcache-get" class="headerlink" title="tcache_get"></a>tcache_get</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Caller must ensure that we know tc_idx is valid and there's
   available chunks to remove.  */</span>
<span class="token keyword">static</span> __always_inline <span class="token keyword">void</span> <span class="token operator">*</span>
<span class="token function">tcache_get</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> tc_idx<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  tcache_entry <span class="token operator">*</span>e <span class="token operator">=</span> tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">assert</span> <span class="token punctuation">(</span>tc_idx <span class="token operator">&lt;</span> TCACHE_MAX_BINS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span> <span class="token punctuation">(</span>tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token operator">-></span>next<span class="token punctuation">;</span>
  <span class="token operator">--</span><span class="token punctuation">(</span>tcache<span class="token operator">-></span>counts<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> e<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>从tcache取出一个对应的块</p>
<h3 id="tcache-put"><a href="#tcache-put" class="headerlink" title="tcache_put"></a>tcache_put</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Caller must ensure that we know tc_idx is valid and there's room
   for more chunks.  */</span>
<span class="token keyword">static</span> __always_inline <span class="token keyword">void</span>
<span class="token function">tcache_put</span> <span class="token punctuation">(</span>mchunkptr chunk<span class="token punctuation">,</span> <span class="token class-name">size_t</span> tc_idx<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  tcache_entry <span class="token operator">*</span>e <span class="token operator">=</span> <span class="token punctuation">(</span>tcache_entry <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span> <span class="token punctuation">(</span>tc_idx <span class="token operator">&lt;</span> TCACHE_MAX_BINS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  e<span class="token operator">-></span>next <span class="token operator">=</span> tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
  tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
  <span class="token operator">++</span><span class="token punctuation">(</span>tcache<span class="token operator">-></span>counts<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>将chunk放入对应的tcache</p>
<h2 id="libc-malloc-1"><a href="#libc-malloc-1" class="headerlink" title="__libc_malloc"></a>__libc_malloc</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_TCACHE</span></span>
  <span class="token comment">/* int_free also calls request2size, be careful to not pad twice.  */</span>
  <span class="token class-name">size_t</span> tbytes<span class="token punctuation">;</span>
  <span class="token function">checked_request2size</span> <span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> tbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">size_t</span> tc_idx <span class="token operator">=</span> <span class="token function">csize2tidx</span> <span class="token punctuation">(</span>tbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">MAYBE_INIT_TCACHE</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  DIAG_PUSH_NEEDS_COMMENT<span class="token punctuation">;</span>f
  <span class="token keyword">if</span> <span class="token punctuation">(</span>tc_idx <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>tcache_bins
      <span class="token comment">/*&amp;&amp; tc_idx &lt; TCACHE_MAX_BINS*/</span> <span class="token comment">/* to appease gcc */</span>
      <span class="token operator">&amp;&amp;</span> tcache
      <span class="token operator">&amp;&amp;</span> tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token function">tcache_get</span> <span class="token punctuation">(</span>tc_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  DIAG_POP_NEEDS_COMMENT<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>SINGLE_THREAD_P<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      victim <span class="token operator">=</span> <span class="token function">_int_malloc</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>main_arena<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token operator">!</span>victim <span class="token operator">||</span> <span class="token function">chunk_is_mmapped</span> <span class="token punctuation">(</span><span class="token function">mem2chunk</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
	      <span class="token operator">&amp;</span>main_arena <span class="token operator">==</span> <span class="token function">arena_for_chunk</span> <span class="token punctuation">(</span><span class="token function">mem2chunk</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> victim<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在<code>__libc_malloc</code>里多了tcache的操作，可以直接在<code>__libc_malloc</code>获得chunk返回</p>
<p>并且多了SINGLE_THREAD_P判定，即是否为单线程，如果为单线程，就直接调用_int_malloc分配chunk，之后进行断言检查</p>
<h2 id="int-malloc-1"><a href="#int-malloc-1" class="headerlink" title="_int_malloc"></a>_int_malloc</h2><h3 id="fastbin-1"><a href="#fastbin-1" class="headerlink" title="fastbin"></a>fastbin</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">REMOVE_FB</span><span class="token expression"><span class="token punctuation">(</span>fb<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> pp<span class="token punctuation">)</span>			</span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">do</span>							</span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">&#123;</span>							</span><span class="token punctuation">\</span>
      <span class="token expression">victim <span class="token operator">=</span> pp<span class="token punctuation">;</span>					</span><span class="token punctuation">\</span>
      <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>victim <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>				</span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token keyword">break</span><span class="token punctuation">;</span>						</span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">&#125;</span>							</span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pp <span class="token operator">=</span> <span class="token function">catomic_compare_and_exchange_val_acq</span> <span class="token punctuation">(</span>fb<span class="token punctuation">,</span> victim<span class="token operator">-></span>fd<span class="token punctuation">,</span> victim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> victim<span class="token punctuation">)</span><span class="token punctuation">;</span>				</span></span>


  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">get_max_fast</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      idx <span class="token operator">=</span> <span class="token function">fastbin_index</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
      mfastbinptr <span class="token operator">*</span>fb <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">fastbin</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      mchunkptr pp<span class="token punctuation">;</span>
      victim <span class="token operator">=</span> <span class="token operator">*</span>fb<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>victim <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>    
	<span class="token punctuation">&#123;</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span>SINGLE_THREAD_P<span class="token punctuation">)</span>
	    <span class="token operator">*</span>fb <span class="token operator">=</span> victim<span class="token operator">-></span>fd<span class="token punctuation">;</span>
	  <span class="token keyword">else</span>
	    <span class="token function">REMOVE_FB</span> <span class="token punctuation">(</span>fb<span class="token punctuation">,</span> pp<span class="token punctuation">,</span> victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_likely</span> <span class="token punctuation">(</span>victim <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	    <span class="token punctuation">&#123;</span>
	      <span class="token class-name">size_t</span> victim_idx <span class="token operator">=</span> <span class="token function">fastbin_index</span> <span class="token punctuation">(</span><span class="token function">chunksize</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>victim_idx <span class="token operator">!=</span> idx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"malloc(): memory corruption (fast)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	      <span class="token function">check_remalloced_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_TCACHE</span></span>
	      <span class="token comment">/* While we're here, if we see other chunks of the same size,
		 stash them in the tcache.  */</span>
	      <span class="token class-name">size_t</span> tc_idx <span class="token operator">=</span> <span class="token function">csize2tidx</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
	      <span class="token keyword">if</span> <span class="token punctuation">(</span>tcache <span class="token operator">&amp;&amp;</span> tc_idx <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>tcache_bins<span class="token punctuation">)</span>
		<span class="token punctuation">&#123;</span>
		  mchunkptr tc_victim<span class="token punctuation">;</span>

		  <span class="token comment">/* While bin not empty and tcache not full, copy chunks.  */</span>
		  <span class="token keyword">while</span> <span class="token punctuation">(</span>tcache<span class="token operator">-></span>counts<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>tcache_count
			 <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>tc_victim <span class="token operator">=</span> <span class="token operator">*</span>fb<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
		    <span class="token punctuation">&#123;</span>
		      <span class="token keyword">if</span> <span class="token punctuation">(</span>SINGLE_THREAD_P<span class="token punctuation">)</span>
			<span class="token operator">*</span>fb <span class="token operator">=</span> tc_victim<span class="token operator">-></span>fd<span class="token punctuation">;</span>
		      <span class="token keyword">else</span>
			<span class="token punctuation">&#123;</span>
			  <span class="token function">REMOVE_FB</span> <span class="token punctuation">(</span>fb<span class="token punctuation">,</span> pp<span class="token punctuation">,</span> tc_victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
			  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>tc_victim <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			    <span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
		      <span class="token function">tcache_put</span> <span class="token punctuation">(</span>tc_victim<span class="token punctuation">,</span> tc_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
		    <span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	      <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
	      <span class="token function">alloc_perturb</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
	      <span class="token keyword">return</span> p<span class="token punctuation">;</span>
	    <span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>fastbin移除形式增加至两种</p>
<ul>
<li>如果为单线程<code>SINGLE_THREAD_P</code>那么就<code>*fb = victim-&gt;fd;</code>直接移除</li>
<li>如果不是<code>SINGLE_THREAD_P</code>那么就调用REMOVE_FB宏就是glibc2.23的正常移除形式</li>
</ul>
</li>
<li><p>新增fastbin填充tcache机制,当从fastbin中取出chunk后,如果该fastbin中还有剩余chunk,且对应tcache中有剩余空间,则会将fastbin中的chunk移入tcachebin</p>
</li>
</ul>
<h3 id="smallbin"><a href="#smallbin" class="headerlink" title="smallbin"></a>smallbin</h3><p>首先去除了smallbin未初始化就触发<code>malloc_consolidate</code>机制</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_TCACHE</span></span>
	  <span class="token comment">/* While we're here, if we see other chunks of the same size,
	     stash them in the tcache.  */</span>
	  <span class="token class-name">size_t</span> tc_idx <span class="token operator">=</span> <span class="token function">csize2tidx</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span>tcache <span class="token operator">&amp;&amp;</span> tc_idx <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>tcache_bins<span class="token punctuation">)</span>  <span class="token comment">//tcache存在，且tc_idx对应的tcache存在</span>
	    <span class="token punctuation">&#123;</span>
	      mchunkptr tc_victim<span class="token punctuation">;</span>

	      <span class="token comment">/* While bin not empty and tcache not full, copy chunks over.  */</span>
	      <span class="token keyword">while</span> <span class="token punctuation">(</span>tcache<span class="token operator">-></span>counts<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>tcache_count  <span class="token comment">//no full</span>
		     <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>tc_victim <span class="token operator">=</span> <span class="token function">last</span> <span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> bin<span class="token punctuation">)</span>            <span class="token comment">//链表有多个节点</span>
		<span class="token punctuation">&#123;</span>
		  <span class="token keyword">if</span> <span class="token punctuation">(</span>tc_victim <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
		    <span class="token punctuation">&#123;</span>
		      bck <span class="token operator">=</span> tc_victim<span class="token operator">-></span>bk<span class="token punctuation">;</span>
		      <span class="token function">set_inuse_bit_at_offset</span> <span class="token punctuation">(</span>tc_victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
		      <span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span>
			<span class="token function">set_non_main_arena</span> <span class="token punctuation">(</span>tc_victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
		      bin<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
		      bck<span class="token operator">-></span>fd <span class="token operator">=</span> bin<span class="token punctuation">;</span>

		      <span class="token function">tcache_put</span> <span class="token punctuation">(</span>tc_victim<span class="token punctuation">,</span> tc_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//把相应的chunk放到tcache</span>
	            <span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	    <span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>smallbin同样新增tcache填充机制,当从smallbin中取出chunk后,如果该smallbinbin中还有剩余chunk,且对应tcache中有剩余空间,则会将smallbin中的chunk移入tcachebin</p>
<p><strong>注意</strong>填充过程中是没有对smallbin的完整性进行检查的</p>
<h3 id="大循环-1"><a href="#大循环-1" class="headerlink" title="大循环"></a>大循环</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_TCACHE</span></span>
  INTERNAL_SIZE_T tcache_nb <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token class-name">size_t</span> tc_idx <span class="token operator">=</span> <span class="token function">csize2tidx</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>tcache <span class="token operator">&amp;&amp;</span> tc_idx <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>tcache_bins<span class="token punctuation">)</span>
    tcache_nb <span class="token operator">=</span> nb<span class="token punctuation">;</span>
  <span class="token keyword">int</span> return_cached <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  tcache_unsorted_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>设置参数</p>
<h3 id="unsorted-bin-1"><a href="#unsorted-bin-1" class="headerlink" title="unsorted bin"></a>unsorted bin</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_TCACHE</span></span>
	      <span class="token comment">/* Fill cache first, return to user only if cache fills.
		 We may return one of these chunks later.  */</span>
	      <span class="token keyword">if</span> <span class="token punctuation">(</span>tcache_nb
		  <span class="token operator">&amp;&amp;</span> tcache<span class="token operator">-></span>counts<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>tcache_count<span class="token punctuation">)</span>  <span class="token comment">//如果unsortedbin的符合tcache条件</span>
		<span class="token punctuation">&#123;</span>
		  <span class="token function">tcache_put</span> <span class="token punctuation">(</span>victim<span class="token punctuation">,</span> tc_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//放到tcache里</span>
		  return_cached <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		  <span class="token keyword">continue</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
	      <span class="token keyword">else</span>
		<span class="token punctuation">&#123;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果unsortedbin找到的符合tcache，那么先放到tcache里</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_TCACHE</span></span>
      <span class="token comment">/* If we've processed as many chunks as we're allowed while
	 filling the cache, return one of the cached ones.  */</span>
      <span class="token operator">++</span>tcache_unsorted_count<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>return_cached
	  <span class="token operator">&amp;&amp;</span> mp_<span class="token punctuation">.</span>tcache_unsorted_limit <span class="token operator">></span> <span class="token number">0</span>
	  <span class="token operator">&amp;&amp;</span> tcache_unsorted_count <span class="token operator">></span> mp_<span class="token punctuation">.</span>tcache_unsorted_limit<span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
	  <span class="token keyword">return</span> <span class="token function">tcache_get</span> <span class="token punctuation">(</span>tc_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在unsortedbin遍历结束后，会再进行判定，如果已经找到符合条件的chunk就直接返回</p>
<h2 id="libc-free-1"><a href="#libc-free-1" class="headerlink" title="__libc_free"></a>__libc_free</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">MAYBE_INIT_TCACHE</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>增加了tcache初始化判定，没有则初始化</p>
<h2 id="int-free-1"><a href="#int-free-1" class="headerlink" title="_int_free"></a>_int_free</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_TCACHE</span></span>
  <span class="token punctuation">&#123;</span>
    <span class="token class-name">size_t</span> tc_idx <span class="token operator">=</span> <span class="token function">csize2tidx</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>tcache
	<span class="token operator">&amp;&amp;</span> tc_idx <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>tcache_bins
	<span class="token operator">&amp;&amp;</span> tcache<span class="token operator">-></span>counts<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>tcache_count<span class="token punctuation">)</span>
      <span class="token punctuation">&#123;</span>
	<span class="token function">tcache_put</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> tc_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>tcache有位置，则先放在tcache里(优先级最高MAX)</p>
<h3 id="fastbin-2"><a href="#fastbin-2" class="headerlink" title="fastbin"></a>fastbin</h3><p>发生了与malloc相似的变化，free了一个fast chunk如果fastbin里还有，都放到tcache里</p>
<h1 id="glibc-2-29"><a href="#glibc-2-29" class="headerlink" title="glibc-2.29"></a>glibc-2.29</h1><h2 id="tcache-1"><a href="#tcache-1" class="headerlink" title="tcache"></a>tcache</h2><p>结构体新增了一个成员key</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">tcache_entry</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">tcache_entry</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
  <span class="token comment">/* This field exists to detect double frees.  */</span>
  <span class="token keyword">struct</span> <span class="token class-name">tcache_perthread_struct</span> <span class="token operator">*</span>key<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> tcache_entry<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="libc-malloc-2"><a href="#libc-malloc-2" class="headerlink" title="__libc_malloc"></a>__libc_malloc</h2><p>无变化</p>
<h2 id="int-malloc-2"><a href="#int-malloc-2" class="headerlink" title="_int_malloc"></a>_int_malloc</h2><p>新增了一些检查</p>
<h3 id="大循环-2"><a href="#大循环-2" class="headerlink" title="大循环"></a>大循环</h3><p>大循环开头</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span><span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">)</span>
  <span class="token operator">||</span> <span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span><span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token operator">></span> av<span class="token operator">-></span>system_mem<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">//next的size合法性</span>
	<span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"malloc(): invalid next size (unsorted)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">prev_size</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span>SIZE_BITS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">//标志位</span>
	<span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"malloc(): mismatching next->prev_size (unsorted)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>bck<span class="token operator">-></span>fd <span class="token operator">!=</span> victim<span class="token punctuation">)</span>                <span class="token comment">//victim->bk->fd==victim</span>
  <span class="token operator">||</span> <span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>victim<span class="token operator">-></span>fd <span class="token operator">!=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"malloc(): unsorted double linked list corrupted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span><span class="token function">prev_inuse</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
	<span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"malloc(): invalid next->prev_inuse (unsorted)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>分割判定后</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>bck<span class="token operator">-></span>fd <span class="token operator">!=</span> victim<span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token comment">//victim->bk->fd==victim</span>
  <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"malloc(): corrupted unsorted chunks 3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="libc-free-2"><a href="#libc-free-2" class="headerlink" title="__libc_free"></a>__libc_free</h2><p>无变化</p>
<h2 id="int-free-2"><a href="#int-free-2" class="headerlink" title="_int_free"></a>_int_free</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>e<span class="token operator">-></span>key <span class="token operator">==</span> tcache<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    tcache_entry <span class="token operator">*</span>tmp<span class="token punctuation">;</span>
    <span class="token function">LIBC_PROBE</span> <span class="token punctuation">(</span>memory_tcache_double_free<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> tc_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>tmp <span class="token operator">=</span> tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
     tmp<span class="token punctuation">;</span>
     tmp <span class="token operator">=</span> tmp<span class="token operator">-></span>next<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp <span class="token operator">==</span> e<span class="token punctuation">)</span>
    <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"free(): double free detected in tcache 2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* If we get here, it was a coincidence.  We've wasted a
       few cycles, but don't abort.  */</span>
  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在free的时候会遍历所有tcache，对比要free的是否存在double free</p>
<h1 id="glibc-2-32"><a href="#glibc-2-32" class="headerlink" title="glibc-2.32"></a>glibc-2.32</h1><h2 id="tcache-2"><a href="#tcache-2" class="headerlink" title="tcache"></a>tcache</h2><h3 id="tcache-put-1"><a href="#tcache-put-1" class="headerlink" title="tcache_put"></a>tcache_put</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">e<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token function">PROTECT_PTR</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>e<span class="token operator">-></span>next<span class="token punctuation">,</span> tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>放入tcache时加密</p>
<h3 id="tcache-get-1"><a href="#tcache-get-1" class="headerlink" title="tcache_get"></a>tcache_get</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">REVEAL_PTR</span> <span class="token punctuation">(</span>e<span class="token operator">-></span>next<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>tcache取出时解密</p>
<h2 id="libc-malloc-3"><a href="#libc-malloc-3" class="headerlink" title="__libc_malloc"></a>__libc_malloc</h2><p>没变化</p>
<h2 id="int-malloc-3"><a href="#int-malloc-3" class="headerlink" title="_int_malloc"></a>_int_malloc</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c">     <span class="token keyword">if</span> <span class="token punctuation">(</span>SINGLE_THREAD_P<span class="token punctuation">)</span>
<span class="token operator">*</span>fb <span class="token operator">=</span> <span class="token function">REVEAL_PTR</span> <span class="token punctuation">(</span>tc_victim<span class="token operator">-></span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">*</span>fb <span class="token operator">=</span> <span class="token function">REVEAL_PTR</span> <span class="token punctuation">(</span>tc_victim<span class="token operator">-></span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>fastbin和tcache的时候，会对加密后的指针解密</p>
<h2 id="libc-free-3"><a href="#libc-free-3" class="headerlink" title="__libc_free"></a>__libc_free</h2><p>没变化</p>
<h2 id="int-free-3"><a href="#int-free-3" class="headerlink" title="__int_free"></a>__int_free</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c">p<span class="token operator">-></span>fd <span class="token operator">=</span> <span class="token function">PROTECT_PTR</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-></span>fd<span class="token punctuation">,</span> old<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>fastbin的时候对指针加密，同时判断tcache double free的时候会解密</p>
<h2 id="tcache-fastbin加密"><a href="#tcache-fastbin加密" class="headerlink" title="tcache&amp;&amp;fastbin加密"></a>tcache&amp;&amp;fastbin加密</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Safe-Linking:
   Use randomness from ASLR (mmap_base) to protect single-linked lists
   of Fast-Bins and TCache.  That is, mask the "next" pointers of the
   lists' chunks, and also perform allocation alignment checks on them.
   This mechanism reduces the risk of pointer hijacking, as was done with
   Safe-Unlinking in the double-linked lists of Small-Bins.
   It assumes a minimum page size of 4096 bytes (12 bits).  Systems with
   larger pages provide less entropy, although the pointer mangling
   still works.  */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PROTECT_PTR</span><span class="token expression"><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> ptr<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">__typeof</span> <span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span> pos<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span> ptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">REVEAL_PTR</span><span class="token expression"><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span>  <span class="token function">PROTECT_PTR</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>ptr<span class="token punctuation">,</span> ptr<span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>tcache和fastbin新增链表加密</p>
<p>加密的具体方法是:<strong>取chunk的fd字段(next字段)的地址右移12位,再与要加密的数据异或</strong>,得到结果</p>
<p>解密则是与加密恰好相反</p>
<p>并且可以发现:</p>
<p><strong>对于一条fastbin或tcachebin单链表,从链表头看起,他的第一个chunk成员是不加密的,只有从第二个开始才会进行加密</strong></p>
<h1 id="glibc-2-34"><a href="#glibc-2-34" class="headerlink" title="glibc-2.34"></a>glibc-2.34</h1><p>发现在该版本去除了所有的hook函数</p>
<h2 id="libc-malloc-4"><a href="#libc-malloc-4" class="headerlink" title="__libc_malloc"></a>__libc_malloc</h2><p>主要是去除了hook</p>
<h2 id="int-malloc-4"><a href="#int-malloc-4" class="headerlink" title="__int_malloc"></a>__int_malloc</h2><p>没变化</p>
<h2 id="libc-free-4"><a href="#libc-free-4" class="headerlink" title="__libc_free"></a>__libc_free</h2><p>去除了hook</p>
<h2 id="int-free-4"><a href="#int-free-4" class="headerlink" title="_int_free"></a>_int_free</h2><p>没变化</p>
<h2 id="tcache-3"><a href="#tcache-3" class="headerlink" title="tcache"></a>tcache</h2><h3 id="key验证"><a href="#key验证" class="headerlink" title="key验证"></a>key验证</h3><p>以往key_entry结构体中用于验证double free的key字段是用tcache填充,现在改为用tcache_key填充</p>
<p>tcache_key的产生如下</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Process-wide key to try and catch a double-free in the same thread.  */</span>
<span class="token keyword">static</span> <span class="token class-name">uintptr_t</span> tcache_key<span class="token punctuation">;</span>

<span class="token comment">/* The value of tcache_key does not really have to be a cryptographically
   secure random number.  It only needs to be arbitrary enough so that it does
   not collide with values present in applications.  If a collision does happen
   consistently enough, it could cause a degradation in performance since the
   entire list is checked to check if the block indeed has been freed the
   second time.  The odds of this happening are exceedingly low though, about 1
   in 2^wordsize.  There is probably a higher chance of the performance
   degradation being due to a double free where the first free happened in a
   different thread; that's a case this check does not cover.  */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">tcache_key_initialize</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__getrandom</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>tcache_key<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tcache_key<span class="token punctuation">)</span><span class="token punctuation">,</span> GRND_NONBLOCK<span class="token punctuation">)</span>
      <span class="token operator">!=</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>tcache_key<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      tcache_key <span class="token operator">=</span> <span class="token function">random_bits</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">__WORDSIZE <span class="token operator">==</span> <span class="token number">64</span></span></span>
      tcache_key <span class="token operator">=</span> <span class="token punctuation">(</span>tcache_key <span class="token operator">&lt;&lt;</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">random_bits</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="glibc-2-39"><a href="#glibc-2-39" class="headerlink" title="glibc-2.39"></a>glibc-2.39</h1><h2 id="libc-malloc-5"><a href="#libc-malloc-5" class="headerlink" title="__libc_malloc"></a>__libc_malloc</h2><p>无变化</p>
<h2 id="int-malloc-5"><a href="#int-malloc-5" class="headerlink" title="_int_malloc"></a>_int_malloc</h2><p>没变化</p>
<h2 id="libc-free-5"><a href="#libc-free-5" class="headerlink" title="__libc_free"></a>__libc_free</h2><p>没变化</p>
<h2 id="int-free-5"><a href="#int-free-5" class="headerlink" title="_int_free"></a>_int_free</h2><p>没什么变化，就是部分调用由<code>_int_free_merge_chunk (av, p, size);</code>来完成</p>

          <div class="post-tags">
            <!-- 文章tags -->
            
          </div>
          <p class="motto">重拾纯粹的写作</p>
        </article>
        <!-- 评论 -->
        <div id="vcomments"></div>
      </div>
    </main>
    <!-- toc -->
    
    <cosy-drag-box id="toc-drag-box" trigger="left" min-width="220" uid="toc-box">
      <div class="meta-container">
        <div class="toc-wrapper cosy-scrollbar">
          <p class="catalog">
            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24">
              <g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 6h16"></path>
                <path d="M4 12h16"></path>
                <path d="M4 18h12"></path>
              </g>
            </svg>
            <span>目录</span>
          </p>
          <!-- 文章toc -->
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%86%E8%AF%BB%E6%BA%90%E7%A0%81"><span class="toc-number">1.</span> <span class="toc-text">细读源码</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#glibc-2-23"><span class="toc-number">2.</span> <span class="toc-text">glibc-2.23</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#malloc-state"><span class="toc-number">2.1.</span> <span class="toc-text">malloc_state</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#libc-malloc"><span class="toc-number">2.2.</span> <span class="toc-text">__libc_malloc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#callback"><span class="toc-number">2.2.1.</span> <span class="toc-text">callback</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#arena-get"><span class="toc-number">2.2.2.</span> <span class="toc-text">arena_get</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#int-malloc"><span class="toc-number">2.3.</span> <span class="toc-text">_int_malloc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#malloc-consolidate-%E6%95%B4%E7%90%86%E5%A0%86%E5%9D%97"><span class="toc-number">2.3.1.</span> <span class="toc-text">malloc_consolidate(整理堆块)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastbin%EF%BC%88FILO%EF%BC%89"><span class="toc-number">2.3.2.</span> <span class="toc-text">fastbin（FILO）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#do-check-remalloced-chunk"><span class="toc-number">2.3.3.</span> <span class="toc-text">do_check_remalloced_chunk</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#smallbin%EF%BC%88FIFO%EF%BC%89"><span class="toc-number">2.3.4.</span> <span class="toc-text">smallbin（FIFO）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#largebin-FIFO"><span class="toc-number">2.3.5.</span> <span class="toc-text">largebin(FIFO)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%A7%E5%BE%AA%E7%8E%AF"><span class="toc-number">2.3.6.</span> <span class="toc-text">大循环</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#unsortedbin-FIFO-%E9%81%8D%E5%8E%86"><span class="toc-number">2.3.7.</span> <span class="toc-text">unsortedbin(FIFO)遍历</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%90%8Elargebin%E7%9A%84%E5%88%86%E9%85%8D"><span class="toc-number">2.3.8.</span> <span class="toc-text">编译后largebin的分配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#binmap%E6%83%85%E5%86%B5"><span class="toc-number">2.3.9.</span> <span class="toc-text">binmap情况</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#use-top"><span class="toc-number">2.3.10.</span> <span class="toc-text">use_top</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sysmalloc"><span class="toc-number">2.3.11.</span> <span class="toc-text">sysmalloc</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#libc-free"><span class="toc-number">2.4.</span> <span class="toc-text">__libc_free</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#int-free"><span class="toc-number">2.5.</span> <span class="toc-text">_int_free</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">2.5.1.</span> <span class="toc-text">初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E8%AF%A5chunk%E7%9A%84%E5%90%88%E6%B3%95%E6%80%A7"><span class="toc-number">2.5.2.</span> <span class="toc-text">检查该chunk的合法性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastbin"><span class="toc-number">2.5.3.</span> <span class="toc-text">fastbin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%A7%E7%BB%AD%E6%A3%80%E6%9F%A5"><span class="toc-number">2.5.4.</span> <span class="toc-text">继续检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%80%83%E8%99%91%E5%90%88%E5%B9%B6"><span class="toc-number">2.5.5.</span> <span class="toc-text">考虑合并</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#unsorted-bin"><span class="toc-number">2.5.6.</span> <span class="toc-text">unsorted bin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B4%E7%90%86%E5%A0%86%E5%9D%97"><span class="toc-number">2.5.7.</span> <span class="toc-text">整理堆块</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#glibc-2-27"><span class="toc-number">3.</span> <span class="toc-text">glibc-2.27</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#tcache"><span class="toc-number">3.1.</span> <span class="toc-text">tcache</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#tcache%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">3.1.1.</span> <span class="toc-text">tcache结构体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcache-get"><span class="toc-number">3.1.2.</span> <span class="toc-text">tcache_get</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcache-put"><span class="toc-number">3.1.3.</span> <span class="toc-text">tcache_put</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#libc-malloc-1"><span class="toc-number">3.2.</span> <span class="toc-text">__libc_malloc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#int-malloc-1"><span class="toc-number">3.3.</span> <span class="toc-text">_int_malloc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#fastbin-1"><span class="toc-number">3.3.1.</span> <span class="toc-text">fastbin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#smallbin"><span class="toc-number">3.3.2.</span> <span class="toc-text">smallbin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%A7%E5%BE%AA%E7%8E%AF-1"><span class="toc-number">3.3.3.</span> <span class="toc-text">大循环</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#unsorted-bin-1"><span class="toc-number">3.3.4.</span> <span class="toc-text">unsorted bin</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#libc-free-1"><span class="toc-number">3.4.</span> <span class="toc-text">__libc_free</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#int-free-1"><span class="toc-number">3.5.</span> <span class="toc-text">_int_free</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#fastbin-2"><span class="toc-number">3.5.1.</span> <span class="toc-text">fastbin</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#glibc-2-29"><span class="toc-number">4.</span> <span class="toc-text">glibc-2.29</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#tcache-1"><span class="toc-number">4.1.</span> <span class="toc-text">tcache</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#libc-malloc-2"><span class="toc-number">4.2.</span> <span class="toc-text">__libc_malloc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#int-malloc-2"><span class="toc-number">4.3.</span> <span class="toc-text">_int_malloc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%A7%E5%BE%AA%E7%8E%AF-2"><span class="toc-number">4.3.1.</span> <span class="toc-text">大循环</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#libc-free-2"><span class="toc-number">4.4.</span> <span class="toc-text">__libc_free</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#int-free-2"><span class="toc-number">4.5.</span> <span class="toc-text">_int_free</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#glibc-2-32"><span class="toc-number">5.</span> <span class="toc-text">glibc-2.32</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#tcache-2"><span class="toc-number">5.1.</span> <span class="toc-text">tcache</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#tcache-put-1"><span class="toc-number">5.1.1.</span> <span class="toc-text">tcache_put</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcache-get-1"><span class="toc-number">5.1.2.</span> <span class="toc-text">tcache_get</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#libc-malloc-3"><span class="toc-number">5.2.</span> <span class="toc-text">__libc_malloc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#int-malloc-3"><span class="toc-number">5.3.</span> <span class="toc-text">_int_malloc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#libc-free-3"><span class="toc-number">5.4.</span> <span class="toc-text">__libc_free</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#int-free-3"><span class="toc-number">5.5.</span> <span class="toc-text">__int_free</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tcache-fastbin%E5%8A%A0%E5%AF%86"><span class="toc-number">5.6.</span> <span class="toc-text">tcache&amp;&amp;fastbin加密</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#glibc-2-34"><span class="toc-number">6.</span> <span class="toc-text">glibc-2.34</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#libc-malloc-4"><span class="toc-number">6.1.</span> <span class="toc-text">__libc_malloc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#int-malloc-4"><span class="toc-number">6.2.</span> <span class="toc-text">__int_malloc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#libc-free-4"><span class="toc-number">6.3.</span> <span class="toc-text">__libc_free</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#int-free-4"><span class="toc-number">6.4.</span> <span class="toc-text">_int_free</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tcache-3"><span class="toc-number">6.5.</span> <span class="toc-text">tcache</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#key%E9%AA%8C%E8%AF%81"><span class="toc-number">6.5.1.</span> <span class="toc-text">key验证</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#glibc-2-39"><span class="toc-number">7.</span> <span class="toc-text">glibc-2.39</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#libc-malloc-5"><span class="toc-number">7.1.</span> <span class="toc-text">__libc_malloc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#int-malloc-5"><span class="toc-number">7.2.</span> <span class="toc-text">_int_malloc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#libc-free-5"><span class="toc-number">7.3.</span> <span class="toc-text">__libc_free</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#int-free-5"><span class="toc-number">7.4.</span> <span class="toc-text">_int_free</span></a></li></ol></li></ol>
        </div>
      </div>
    </cosy-drag-box>
    
  </div>

</div>

<script>
  window.page = {
    use: 'valine'
  }
  window.katex = {
    enable: "",
    jsCdn: "//cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.js",
    cssCdn: "//cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.css"
  }
  window.mermaid = {
    enable: "",
    theme: "",
    cdn: "//cdn.jsdelivr.net/npm/mermaid@10.4.0/dist/mermaid.min.js",
  }
  window.valine = {
    enable: "",
    appId: '4Q4EAMdq8elmFDwiIj0R0Z80-gzGzoHsz',
    appKey: 'JRv5ulQZAwmbGgfeetCXRvoW',
    avatar: 'monsterid',
    cdn: '//unpkg.com/valine@latest/dist/Valine.min.js',
    serverURLs: ''
  };
</script>


<script src="/js/0af3d6bb.js"></script>

  </main>
</body>

<script>
  window.theme = {
    color: 'hsl(238,50%,56%)'
  }
</script>


<script src="/js/69a216b6.js"></script>


</html>
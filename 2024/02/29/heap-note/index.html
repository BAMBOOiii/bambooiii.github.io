<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    heap note
  </title>
  <meta name="description" content="">
  <meta name="keywords" content="">
  <meta name="author" content="sheep">
  <link rel="canonical" href="http://example.com/2024/02/29/heap-note/">
  
  
  <link rel="icon" href='/img/favicon.ico'>
  
  
  
<link rel="stylesheet" href="/css/b4c95347.css">

  <script>window.i18n = {"tip-status-done":"完成","tip-status-default":"全部","tip-status-todo":"计划","tip-status-doing":"进行","tip-status-other":"其他","text-select":"选择","text-move":"移动","text-esc":"退出","January":"一月","February":"二月","March":"三月","April":"四月","May":"五月","June":"六月","July":"七月","August":"八月","September":"九月","October":"十月","November":"十一月","December":"十二月"}</script>
<meta name="generator" content="Hexo 7.0.0"></head>

<body id="app">
  <aside id="aside-box" class="left-aside">
    <div class="header">
      
<link rel="stylesheet" href="/css/61875ce9.css">

<div class="profile">
  <a class="badge" href="/">
    <span>Hi</span>
    <span>sheep</span>
  </a>
  <cosy-tooltip id="left-aside-button" placement="right">
    <span slot="content">
      <span>显示 / 隐藏 左侧导航</span>
      <cosy-short-key>[</cosy-short-key>
    </span>
    <cosy-icon>
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20">
        <g fill="none">
          <path d="M16 4c1.104-.019 2 .896 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h12zm1 2a1 1 0 0 0-1-1h-2.995v10H16a1 1 0 0 0 1-1V6zm-4.995 9V5H4.001a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8.004z" fill="currentColor"></path>
        </g>
      </svg>
    </cosy-icon>
  </cosy-tooltip>
</div>

<script src="/js/a66044b6.js"></script>

      


<cosy-search id="post-search" placeholder="搜索">
  <div slot="short-key">
    <cosy-short-key>⌘</cosy-short-key>
    <cosy-short-key>K</cosy-short-key>
  </div>
</cosy-search>


<script>
  window.algolia = {
    appId: "R34LY1BBPU",
    SearchOnlyAPIKey: "4fd025154505a4b00fb416f52993d700"
  }
</script>


<script src="/js/5f00f278.js"></script>

    </div>
    <div class="aside-category">
      
<link rel="stylesheet" href="/css/db04a759.css">


<nav class="category-nav cosy-scrollbar">
  <ul><li data-path="archives">
        <a href="/archives">
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20"><g fill="none"><path d="M3.5 3A1.5 1.5 0 0 0 2 4.5v4A1.5 1.5 0 0 0 3.5 10h9A1.5 1.5 0 0 0 14 8.5v-4A1.5 1.5 0 0 0 12.5 3h-9zM3 4.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5v-4zm.5 6.5A1.5 1.5 0 0 0 2 12.5v4A1.5 1.5 0 0 0 3.5 18h9a1.5 1.5 0 0 0 1.5-1.5v-4a1.5 1.5 0 0 0-1.5-1.5h-9zM3 12.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5v-4zm14-.063a2.003 2.003 0 0 1-2.5-1.937A2 2 0 0 1 16 8.563a2.005 2.005 0 0 1 1 0a2 2 0 0 1 0 3.874zM16.5 3a.5.5 0 0 1 .5.5v4.041a3.02 3.02 0 0 0-1 0V3.5a.5.5 0 0 1 .5-.5zm0 10.5c-.17 0-.337-.014-.5-.041V17.5a.5.5 0 0 0 1 0v-4.041c-.163.027-.33.041-.5.041z" fill="currentColor"></path></g></svg>
          <div class="ellipsis">归档</div>
        </a>
      </li><li data-path="cosy-roadmap">
        <a href="/cosy-roadmap">
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20"><g fill="none"><path d="M9.384 2a1 1 0 0 0-.966.742L4.616 17H2.5a.5.5 0 0 0 0 1h15a.5.5 0 0 0 0-1h-2.116L11.582 2.742A1 1 0 0 0 10.616 2H9.384zM5.651 17l.8-3H11.5a.5.5 0 0 0 0-1H6.717l.534-2H10.5a.5.5 0 0 0 0-1H7.517l1.867-7h1.232l3.733 14H5.651z" fill="currentColor"></path></g></svg>
          <div class="ellipsis">路线图</div>
        </a>
      </li><li data-path="cosy-resume">
        <a href="/cosy-resume">
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20"><g fill="none"><path d="M8.5 4.498a1.5 1.5 0 1 1 3 0a1.5 1.5 0 0 1-3 0zm1.5-2.5a2.5 2.5 0 0 0-2.43 3.086L5.471 4.15a1.761 1.761 0 0 0-2.317.88c-.4.882-.008 1.917.877 2.31L7 8.662v2.287l-1.877 4.645a1.75 1.75 0 0 0 3.245 1.311l1.556-3.849a.073.073 0 0 1 .028-.038a.086.086 0 0 1 .046-.012c.02 0 .035.005.046.012a.074.074 0 0 1 .028.038l1.555 3.849a1.75 1.75 0 0 0 3.245-1.311L13 10.96V8.662l2.968-1.322a1.74 1.74 0 0 0 .877-2.31a1.761 1.761 0 0 0-2.317-.88l-2.097.934a2.5 2.5 0 0 0-2.43-3.086zM4.065 5.444a.761.761 0 0 1 1-.38l3.918 1.744a2.5 2.5 0 0 0 2.034 0l3.918-1.744a.761.761 0 0 1 1 .38a.739.739 0 0 1-.373.983l-2.969 1.321a1 1 0 0 0-.593.914v2.298a1 1 0 0 0 .073.375l1.872 4.633a.75.75 0 0 1-1.39.562l-1.556-3.849c-.364-.9-1.639-.9-2.003 0l-1.555 3.85a.75.75 0 1 1-1.39-.562l1.876-4.646A1 1 0 0 0 8 10.95V8.662a1 1 0 0 0-.593-.914L4.438 6.427a.739.739 0 0 1-.373-.983z" fill="currentColor"></path></g></svg>
          <div class="ellipsis">简历</div>
        </a>
      </li><li data-path="link">
        <a href="/link">
          <svg t="1705378180027" class="icon" viewBox="-250 -250 1400 1400" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1450" width="200" height="200"><path d="M593.94368 715.648a10.688 10.688 0 0 0-14.976 0L424.21568 870.4c-71.68 71.68-192.576 79.232-271.68 0-79.232-79.232-71.616-200 0-271.616l154.752-154.752a10.688 10.688 0 0 0 0-15.04l-52.992-52.992a10.688 10.688 0 0 0-15.04 0L84.50368 530.688a287.872 287.872 0 0 0 0 407.488 288 288 0 0 0 407.488 0l154.752-154.752a10.688 10.688 0 0 0 0-15.04l-52.736-52.736z m344.384-631.168a288.256 288.256 0 0 1 0 407.616l-154.752 154.752a10.688 10.688 0 0 1-15.04 0l-52.992-52.992a10.688 10.688 0 0 1 0-15.104l154.752-154.688c71.68-71.68 79.232-192.448 0-271.68-79.104-79.232-200-71.68-271.68 0L443.92768 307.2a10.688 10.688 0 0 1-15.04 0l-52.864-52.864a10.688 10.688 0 0 1 0-15.04l154.88-154.752a287.872 287.872 0 0 1 407.424 0z m-296.32 240.896l52.672 52.736a10.688 10.688 0 0 1 0 15.04l-301.504 301.44a10.688 10.688 0 0 1-15.04 0l-52.736-52.672a10.688 10.688 0 0 1 0-15.04l301.632-301.504a10.688 10.688 0 0 1 15.04 0z" fill="currentColor" p-id="1451"></path></svg>
          <div class="ellipsis">友链</div>
        </a>
      </li></ul>
  <ul><li class="">
        <a href="/categories/2024ROIS%E5%86%AC%E4%BB%A4%E8%90%A5/">
          
          <div class="ellipsis">
            <span>2024ROIS冬令营</span>
          </div>
        </a>
      </li><li class="active">
        <a href="/categories/Pwn%E7%9F%A5%E8%AF%86/">
          
          <div class="ellipsis">
            <span>Pwn知识</span>
          </div>
        </a>
      </li><li class="">
        <a href="/categories/%E5%B0%8F%E6%AF%94%E8%B5%9B/">
          
          <div class="ellipsis">
            <span>小比赛</span>
          </div>
        </a>
      </li><li class="">
        <a href="/categories/%E6%80%BB%E7%BB%93/">
          
          <div class="ellipsis">
            <span>总结</span>
          </div>
        </a>
      </li></ul>
</nav>


<script src="/js/118098c2.js"></script>

    </div>
    <div class="bottom">
      <cosy-tooltip id="button-preference" placement="right">
        <span slot="content">
          <span>偏好</span>
          <cosy-short-key>⌘</cosy-short-key>
          <cosy-short-key>p</cosy-short-key>
        </span>
        <cosy-icon bordered id="button-about-cosy-theme">
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 16 16">
            <g fill="none">
              <path d="M8 6a2 2 0 1 0 0 4a2 2 0 0 0 0-4zM7 8a1 1 0 1 1 2 0a1 1 0 0 1-2 0zm3.618-3.602a.708.708 0 0 1-.824-.567l-.26-1.416a.354.354 0 0 0-.275-.282a6.072 6.072 0 0 0-2.519 0a.354.354 0 0 0-.275.282l-.259 1.416a.71.71 0 0 1-.936.538l-1.359-.484a.355.355 0 0 0-.382.095c-.569.627-1 1.367-1.262 2.173a.352.352 0 0 0 .108.378l1.102.931a.704.704 0 0 1 0 1.076l-1.102.931a.352.352 0 0 0-.108.378A5.986 5.986 0 0 0 3.53 12.02a.355.355 0 0 0 .382.095l1.36-.484a.708.708 0 0 1 .936.538l.258 1.416c.026.14.135.252.275.281a6.075 6.075 0 0 0 2.52 0a.353.353 0 0 0 .274-.281l.26-1.416a.71.71 0 0 1 .936-.538l1.359.484c.135.048.286.01.382-.095c.569-.627 1-1.367 1.262-2.173a.352.352 0 0 0-.108-.378l-1.102-.931a.703.703 0 0 1 0-1.076l1.102-.931a.352.352 0 0 0 .108-.378A5.985 5.985 0 0 0 12.47 3.98a.355.355 0 0 0-.382-.095l-1.36.484a.71.71 0 0 1-.111.03zm-6.62.58l.937.333a1.71 1.71 0 0 0 2.255-1.3l.177-.97a5.105 5.105 0 0 1 1.265 0l.178.97a1.708 1.708 0 0 0 2.255 1.3L12 4.977c.255.334.467.698.63 1.084l-.754.637a1.704 1.704 0 0 0 0 2.604l.755.637a4.99 4.99 0 0 1-.63 1.084l-.937-.334a1.71 1.71 0 0 0-2.255 1.3l-.178.97a5.099 5.099 0 0 1-1.265 0l-.177-.97a1.708 1.708 0 0 0-2.255-1.3L4 11.023a4.987 4.987 0 0 1-.63-1.084l.754-.638a1.704 1.704 0 0 0 0-2.603l-.755-.637c.164-.386.376-.75.63-1.084z" fill="currentColor"></path>
            </g>
          </svg>
        </cosy-icon>
      </cosy-tooltip>
    </div>
  </aside>
  <main>
    
<link rel="stylesheet" href="/css/9bb9a539.css">


<div class="post-container">
  <header>
    <div class="left">
      
<link rel="stylesheet" href="/css/7d333f9e.css">

<nav class="breadcrumb">
  <section>
    <cosy-tooltip placement="bottom-left">
      <span slot="content"><span>首页</span>
        <cosy-short-key>⌘</cosy-short-key>
        <cosy-short-key>H</cosy-short-key>
      </span>
      <cosy-icon href="/">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20">
          <g fill="none">
            <path d="M8.998 2.388a1.5 1.5 0 0 1 2.005 0l5.5 4.942A1.5 1.5 0 0 1 17 8.445V15.5a1.5 1.5 0 0 1-1.5 1.5H13a1.5 1.5 0 0 1-1.5-1.5V12a.5.5 0 0 0-.5-.5H9a.5.5 0 0 0-.5.5v3.5A1.5 1.5 0 0 1 7 17H4.5A1.5 1.5 0 0 1 3 15.5V8.445c0-.425.18-.83.498-1.115l5.5-4.942zm1.336.744a.5.5 0 0 0-.668 0l-5.5 4.942A.5.5 0 0 0 4 8.445V15.5a.5.5 0 0 0 .5.5H7a.5.5 0 0 0 .5-.5V12A1.5 1.5 0 0 1 9 10.5h2a1.5 1.5 0 0 1 1.5 1.5v3.5a.5.5 0 0 0 .5.5h2.5a.5.5 0 0 0 .5-.5V8.445a.5.5 0 0 0-.166-.371l-5.5-4.942z" fill="currentColor"></path>
          </g>
        </svg>
      </cosy-icon>
    </cosy-tooltip>
    
    
    <svg class="arrow" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20">
      <g fill="none">
        <path d="M7.733 4.207a.75.75 0 0 1 1.06.026l5.001 5.25a.75.75 0 0 1 0 1.035l-5 5.25a.75.75 0 1 1-1.087-1.034L12.216 10l-4.51-4.734a.75.75 0 0 1 .027-1.06z" fill="currentColor"></path>
      </g>
    </svg>
    <a class="ellipsis" href="/categories/Pwn%E7%9F%A5%E8%AF%86/">
      Pwn知识
    </a>
    
    
    
    <svg class="arrow" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20">
      <g fill="none">
        <path d="M7.733 4.207a.75.75 0 0 1 1.06.026l5.001 5.25a.75.75 0 0 1 0 1.035l-5 5.25a.75.75 0 1 1-1.087-1.034L12.216 10l-4.51-4.734a.75.75 0 0 1 .027-1.06z" fill="currentColor"></path>
      </g>
    </svg>
    <span class="ellipsis">
      heap note
    </span>
    
  </section>
</nav>


<script src="/js/31d6cfe0.js"></script>

    </div>
    <div class="right">
      
      <cosy-tooltip id="toc-show-button" placement="left">
        <span slot="content">
          <span>显示 / 隐藏 文章目录</span>
          <cosy-short-key>]</cosy-short-key>
        </span>
        <cosy-icon>
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20">
            <g fill="none">
              <path d="M4 4c-1.104-.019-2 .896-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2H4zM3 6a1 1 0 0 1 1-1h2.995v10H4a1 1 0 0 1-1-1V6zm4.995 9V5h8.004a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H7.995z" fill="currentColor"></path>
            </g>
          </svg>
        </cosy-icon>
      </cosy-tooltip>
      
    </div>
  </header>
  <div class="content">
    <main class="cosy-scrollbar">
      <div class="article-container">
        <!-- 渲染文章内容 -->
        <article>
          <!-- 文章标题 -->
          <h1 class="post-title">heap note</h1>
          <div class="last-updated">
            上次更新: 2024-02-29 18:22:12
          </div>
          <!-- 文章 -->
          <h2 id="堆"><a href="#堆" class="headerlink" title="堆"></a>堆</h2><p>本篇文章摘自华庭大佬的<code>Glibc 内存管理</code>一书，只是插入了一些记录</p>
<h4 id="什么是堆"><a href="#什么是堆" class="headerlink" title="什么是堆"></a>什么是堆</h4><p>在程序运行过程中，堆可以提供动态分配的内存，允许程序申请大小未知的内存。堆其实就是程序虚拟地址空间的一块连续的线性区域，它由低地址向高地址方向增长。我们一般称管理堆的那部分程序为堆管理器。</p>
<p>堆管理器处于用户程序与内核中间，主要做以下工作</p>
<ol>
<li>响应用户的申请内存请求，向操作系统申请内存，然后将其返回给用户程序。同时，为了保持内存管理的高效性，内核一般都会预先分配很大的一块连续的内存，然后让堆管理器通过某种算法管理这块内存。只有当出现了堆空间不足的情况，堆管理器才会再次与操作系统进行交互。</li>
<li>管理用户所释放的内存。一般来说，用户释放的内存并不是直接返还给操作系统的，而是由堆管理器进行管理。这些释放的内存可以来响应用户新申请的内存的请求。</li>
</ol>
<p>Linux 中早期的堆分配与回收由 Doug Lea 实现，但它在并行处理多个线程时，会共享进程的堆内存空间。因此，为了安全性，一个线程使用堆时，会进行加锁。然而，与此同时，加锁会导致其它线程无法使用堆，降低了内存分配和回收的高效性。同时，如果在多线程使用时，没能正确控制，也可能影响内存分配和回收的正确性。Wolfram Gloger 在 Doug Lea 的基础上进行改进使其可以支持多线程，这个堆分配器就是 ptmalloc 。在 glibc-2.3.x. 之后，glibc 中集成了 ptmalloc2。</p>
<p>目前 Linux 标准发行版中使用的堆分配器是 glibc 中的堆分配器：ptmalloc2。ptmalloc2 主要是通过 malloc&#x2F;free 函数来分配和释放内存块。</p>
<p>需要注意的是，在内存分配与使用的过程中，Linux 有这样的一个基本内存管理思想，<strong>只有当真正访问一个地址的时候，系统才会建立虚拟页面与物理页面的映射关系</strong>。 所以虽然操作系统已经给程序分配了很大的一块内存，但是这块内存其实只是虚拟内存。只有当用户使用到相应的内存时，系统才会真正分配物理页面给用户使用。</p>
<h3 id="堆的基本操作"><a href="#堆的基本操作" class="headerlink" title="堆的基本操作"></a>堆的基本操作</h3><p>这里我们主要介绍</p>
<ul>
<li>基本的堆操作，包括堆的分配，回收，堆分配背后的系统调用</li>
<li>介绍堆目前的多线程支持。</li>
</ul>
<h4 id="malloc"><a href="#malloc" class="headerlink" title="malloc"></a>malloc</h4><p>在 glibc 的 <a target="_blank" rel="noopener" href="https://github.com/iromise/glibc/blob/master/malloc/malloc.c#L448">malloc.c</a> 中，malloc 的说明如下</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
  malloc(size_t n)
  Returns a pointer to a newly allocated chunk of at least n bytes, or null
  if no space is available. Additionally, on failure, errno is
  set to ENOMEM on ANSI C systems.
  If n is zero, malloc returns a minumum-sized chunk. (The minimum
  size is 16 bytes on most 32bit systems, and 24 or 32 bytes on 64bit
  systems.)  On most systems, size_t is an unsigned type, so calls
  with negative arguments are interpreted as requests for huge amounts
  of space, which will often fail. The maximum supported value of n
  differs across systems, but is in all cases less than the maximum
  representable value of a size_t.
*/</span>
<span class="token comment">/*
malloc函数用于分配至少n个字节大小的内存块，并返回指向该内存块的指针。如果没有足够的空间可用，则返回空指针。在失败的情况下，对于 ANSI C 系统，errno 会被设置为 ENOMEM。

如果 n 为零，则malloc返回一个最小尺寸的内存块。在大多数 32 位系统上，最小尺寸为 16 个字节，在 64 位系统上为 24 或 32 个字节。在大多数系统中，size_t 是无符号类型，因此带有负参数的调用会被解释为对大量空间的请求，通常会失败。n 的最大支持值因系统而异，但在所有情况下都小于 size_t 可表示的最大值
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看出，malloc 函数返回对应大小字节的内存块的指针。此外，该函数还对一些异常情况进行了处理</p>
<ul>
<li>当 n&#x3D;0 时，返回当前系统允许的堆的最小内存块。</li>
<li>当 n 为负数时，由于在大多数系统上，<strong>size_t 是无符号数（这一点非常重要）</strong>，所以程序就会申请很大的内存空间，但通常来说都会失败，因为系统没有那么多的内存可以分配。</li>
</ul>
<h4 id="free"><a href="#free" class="headerlink" title="free"></a>free</h4><p>在 glibc 的 <a target="_blank" rel="noopener" href="https://github.com/iromise/glibc/blob/master/malloc/malloc.c#L465">malloc.c</a> 中，free 的说明如下</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
      free(void* p)
      Releases the chunk of memory pointed to by p, that had been previously
      allocated using malloc or a related routine such as realloc.
      It has no effect if p is null. It can have arbitrary (i.e., bad!)
      effects if p has already been freed.
      Unless disabled (using mallopt), freeing very large spaces will
      when possible, automatically trigger operations that give
      back unused memory to the system, thus reducing program footprint.
    */</span>
<span class="token comment">/*
释放指向p的内存块，该内存块之前使用malloc或类似的realloc例程分配。如果p为null，则没有影响。如果p已经被释放，可能会产生任意（即不好的）影响。除非禁用（使用mallopt），释放非常大的空间将在可能的情况下自动触发操作，将未使用的内存返回给系统，从而减少程序占用空间。
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看出，free 函数会释放由 p 所指向的内存块。这个内存块有可能是通过 malloc 函数得到的，也有可能是通过相关的函数 realloc 得到的。</p>
<p>此外，该函数也同样对异常情况进行了处理</p>
<ul>
<li><strong>当 p 为空指针时，函数不执行任何操作。</strong></li>
<li>当 p 已经被释放之后，再次释放会出现乱七八糟的效果，这其实就是 <code>double free</code>。</li>
<li>除了被禁用 (mallopt) 的情况下，当释放很大的内存空间时，程序会将这些内存空间还给系统，以便于减小程序所使用的内存空间。</li>
</ul>
<h4 id="内存分配背后的系统调用"><a href="#内存分配背后的系统调用" class="headerlink" title="内存分配背后的系统调用"></a>内存分配背后的系统调用</h4><p>在前面提到的函数中，无论是 malloc 函数还是 free 函数，我们动态申请和释放内存时，都经常会使用，但是它们并不是真正与系统交互的函数。这些函数背后的系统调用主要是 <a target="_blank" rel="noopener" href="http://man7.org/linux/man-pages/man2/sbrk.2.html">(s)brk</a> 函数以及 <a target="_blank" rel="noopener" href="http://man7.org/linux/man-pages/man2/mmap.2.html">mmap, munmap</a> 函数。</p>
<p>如下图所示，我们主要考虑对堆进行申请内存块的操作。</p>
<p><img src="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/figure/brk%26mmap.png" alt="img"></p>
<h4 id="s-brk"><a href="#s-brk" class="headerlink" title="(s)brk"></a>(s)brk</h4><p>对于堆的操作，操作系统提供了 brk 函数，glibc 库提供了 sbrk 函数，我们可以通过增加 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Sbrk">brk</a> 的大小来向操作系统申请内存。</p>
<p>初始时，堆的起始地址 <a target="_blank" rel="noopener" href="http://elixir.free-electrons.com/linux/v3.8/source/include/linux/mm_types.h#L365">start_brk</a> 以及堆的当前末尾 <a target="_blank" rel="noopener" href="http://elixir.free-electrons.com/linux/v3.8/source/include/linux/mm_types.h#L365">brk</a> 指向同一地址。根据是否开启 ASLR，两者的具体位置会有所不同</p>
<ul>
<li>不开启 ASLR 保护时，start_brk 以及 brk 会指向 data&#x2F;bss 段的结尾。</li>
<li>开启 ASLR 保护时，start_brk 以及 brk 也会指向同一位置，只是这个位置是在 data&#x2F;bss 段结尾后的随机偏移处。</li>
</ul>
<p>具体效果如下图（这个图片与网上流传的基本一致，这里是因为要画一张大图，所以自己单独画了下）所示</p>
<p><img src="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/figure/program_virtual_address_memory_space.png" alt="img"></p>
<p><strong>例子</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* sbrk and brk example */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token keyword">void</span> <span class="token operator">*</span>curr_brk<span class="token punctuation">,</span> <span class="token operator">*</span>tmp_brk <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Welcome to sbrk example:%d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//输出当前进程的PID（进程标识符）</span>

        <span class="token comment">/* sbrk(0) gives current program break location */</span>
        tmp_brk <span class="token operator">=</span> curr_brk <span class="token operator">=</span> <span class="token function">sbrk</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//使用 sbrk(0) 获取当前程序堆区的边界</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Program Break Location1:%p\n"</span><span class="token punctuation">,</span> curr_brk<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* brk(addr) increments/decrements program break location */</span>
        <span class="token function">brk</span><span class="token punctuation">(</span>curr_brk<span class="token operator">+</span><span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 调用 brk(curr_brk+4096) 来将程序的堆区边界地址向上移动 4096 字节（4KB）。brk 函数设置新的 break 的位置。</span>

        curr_brk <span class="token operator">=</span> <span class="token function">sbrk</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Program break Location2:%p\n"</span><span class="token punctuation">,</span> curr_brk<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">brk</span><span class="token punctuation">(</span>tmp_brk<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//调用 brk(tmp_brk) 将程序的堆区边界重置回最初的位置</span>

        curr_brk <span class="token operator">=</span> <span class="token function">sbrk</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Program Break Location3:%p\n"</span><span class="token punctuation">,</span> curr_brk<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>需要注意的是，在每一次执行完操作后，都执行了 getchar() 函数，这是为了我们方便我们查看程序真正的映射。</p>
<p><strong>在第一次调用 brk 之前</strong></p>
<p>从下面的输出可以看出，并没有出现堆。因此</p>
<ul>
<li>start_brk &#x3D; brk &#x3D; end_data &#x3D; 0x804b000</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">sploitfun@sploitfun<span class="token operator">-</span>VirtualBox<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>syscalls$ <span class="token punctuation">.</span><span class="token operator">/</span>sbrk
Welcome to sbrk example<span class="token operator">:</span><span class="token number">6141</span>
Program Break Location1<span class="token operator">:</span><span class="token number">0x804b000</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
sploitfun@sploitfun<span class="token operator">-</span>VirtualBox<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>syscalls$ cat <span class="token operator">/</span>proc<span class="token operator">/</span><span class="token number">6141</span><span class="token operator">/</span>maps
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">0804</span>a000<span class="token operator">-</span><span class="token number">0804</span>b000 rw<span class="token operator">-</span>p <span class="token number">00001000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">539624</span>     <span class="token operator">/</span>home<span class="token operator">/</span>sploitfun<span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>syscalls<span class="token operator">/</span>sbrk
b7e21000<span class="token operator">-</span>b7e22000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
sploitfun@sploitfun<span class="token operator">-</span>VirtualBox<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>syscalls$<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>第一次增加 brk 后</strong></p>
<p>从下面的输出可以看出，已经出现了堆段</p>
<ul>
<li>start_brk &#x3D; end_data &#x3D; 0x804b000</li>
<li>brk &#x3D; 0x804c000</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">sploitfun@sploitfun<span class="token operator">-</span>VirtualBox<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>syscalls$ <span class="token punctuation">.</span><span class="token operator">/</span>sbrk
Welcome to sbrk example<span class="token operator">:</span><span class="token number">6141</span>
Program Break Location1<span class="token operator">:</span><span class="token number">0x804b000</span>
Program Break Location2<span class="token operator">:</span><span class="token number">0x804c000</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
sploitfun@sploitfun<span class="token operator">-</span>VirtualBox<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>syscalls$ cat <span class="token operator">/</span>proc<span class="token operator">/</span><span class="token number">6141</span><span class="token operator">/</span>maps
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">0804</span>a000<span class="token operator">-</span><span class="token number">0804</span>b000 rw<span class="token operator">-</span>p <span class="token number">00001000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">539624</span>     <span class="token operator">/</span>home<span class="token operator">/</span>sploitfun<span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>syscalls<span class="token operator">/</span>sbrk
<span class="token number">0804</span>b000<span class="token operator">-</span><span class="token number">0804</span>c000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>          <span class="token punctuation">[</span>heap<span class="token punctuation">]</span>
b7e21000<span class="token operator">-</span>b7e22000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
sploitfun@sploitfun<span class="token operator">-</span>VirtualBox<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>syscalls$<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中，关于堆的那一行</p>
<ul>
<li>0x0804b000 是相应堆的起始地址</li>
<li>rw-p 表明堆具有可读可写权限，并且属于隐私数据。</li>
<li>00000000 表明文件偏移，由于这部分内容并不是从文件中映射得到的，所以为 0。</li>
<li>00:00 是主从 (Major&#x2F;mirror) 的设备号，这部分内容也不是从文件中映射得到的，所以也都为 0。</li>
<li>0 表示着 Inode 号。由于这部分内容并不是从文件中映射得到的，所以为 0。</li>
</ul>
<h4 id="mmap"><a href="#mmap" class="headerlink" title="mmap"></a>mmap</h4><p>malloc 会使用 <a target="_blank" rel="noopener" href="http://lxr.free-electrons.com/source/mm/mmap.c?v=3.8#L1285">mmap</a> 来创建独立的匿名映射段。匿名映射的目的主要是可以申请以 0 填充的内存，并且这块内存仅被调用进程所使用。</p>
<p><strong>例子</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Private anonymous mapping example using mmap syscall */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>

<span class="token keyword">void</span> <span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> msg<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s failed. Exiting the process\n"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Welcome to private anonymous mapping example::PID:%d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Before mmap\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span><span class="token operator">*</span> addr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        addr <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token number">132</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">,</span> PROT_READ<span class="token operator">|</span>PROT_WRITE<span class="token punctuation">,</span> MAP_PRIVATE <span class="token operator">|</span> MAP_ANONYMOUS<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span>
                <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"mmap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"After mmap\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* Unmap mapped region. */</span>
        ret <span class="token operator">=</span> <span class="token function">munmap</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token number">132</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token function">errExit</span><span class="token punctuation">(</span><span class="token string">"munmap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"After munmap\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>在执行 mmap 之前</strong></p>
<p>我们可以从下面的输出看到，目前只有. so 文件的 mmap 段。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">sploitfun@sploitfun<span class="token operator">-</span>VirtualBox<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>syscalls$ cat <span class="token operator">/</span>proc<span class="token operator">/</span><span class="token number">6067</span><span class="token operator">/</span>maps
<span class="token number">08048000</span><span class="token operator">-</span><span class="token number">08049000</span> r<span class="token operator">-</span>xp <span class="token number">00000000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">539691</span>     <span class="token operator">/</span>home<span class="token operator">/</span>sploitfun<span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>syscalls<span class="token operator">/</span>mmap
<span class="token number">08049000</span><span class="token operator">-</span><span class="token number">0804</span>a000 r<span class="token operator">--</span>p <span class="token number">00000000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">539691</span>     <span class="token operator">/</span>home<span class="token operator">/</span>sploitfun<span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>syscalls<span class="token operator">/</span>mmap
<span class="token number">0804</span>a000<span class="token operator">-</span><span class="token number">0804</span>b000 rw<span class="token operator">-</span>p <span class="token number">00001000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">539691</span>     <span class="token operator">/</span>home<span class="token operator">/</span>sploitfun<span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>syscalls<span class="token operator">/</span>mmap
b7e21000<span class="token operator">-</span>b7e22000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
sploitfun@sploitfun<span class="token operator">-</span>VirtualBox<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>syscalls$<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>mmap 后</strong></p>
<p>从下面的输出可以看出，我们申请的内存与已经存在的内存段结合在了一起构成了 b7e00000 到 b7e21000 的 mmap 段。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">sploitfun@sploitfun<span class="token operator">-</span>VirtualBox<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>syscalls$ cat <span class="token operator">/</span>proc<span class="token operator">/</span><span class="token number">6067</span><span class="token operator">/</span>maps
<span class="token number">08048000</span><span class="token operator">-</span><span class="token number">08049000</span> r<span class="token operator">-</span>xp <span class="token number">00000000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">539691</span>     <span class="token operator">/</span>home<span class="token operator">/</span>sploitfun<span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>syscalls<span class="token operator">/</span>mmap
<span class="token number">08049000</span><span class="token operator">-</span><span class="token number">0804</span>a000 r<span class="token operator">--</span>p <span class="token number">00000000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">539691</span>     <span class="token operator">/</span>home<span class="token operator">/</span>sploitfun<span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>syscalls<span class="token operator">/</span>mmap
<span class="token number">0804</span>a000<span class="token operator">-</span><span class="token number">0804</span>b000 rw<span class="token operator">-</span>p <span class="token number">00001000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">539691</span>     <span class="token operator">/</span>home<span class="token operator">/</span>sploitfun<span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>syscalls<span class="token operator">/</span>mmap
b7e00000<span class="token operator">-</span>b7e22000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
sploitfun@sploitfun<span class="token operator">-</span>VirtualBox<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>syscalls$<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>munmap</strong></p>
<p>从下面的输出，我们可以看到我们原来申请的内存段已经没有了，内存段又恢复了原来的样子了。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">sploitfun@sploitfun<span class="token operator">-</span>VirtualBox<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>syscalls$ cat <span class="token operator">/</span>proc<span class="token operator">/</span><span class="token number">6067</span><span class="token operator">/</span>maps
<span class="token number">08048000</span><span class="token operator">-</span><span class="token number">08049000</span> r<span class="token operator">-</span>xp <span class="token number">00000000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">539691</span>     <span class="token operator">/</span>home<span class="token operator">/</span>sploitfun<span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>syscalls<span class="token operator">/</span>mmap
<span class="token number">08049000</span><span class="token operator">-</span><span class="token number">0804</span>a000 r<span class="token operator">--</span>p <span class="token number">00000000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">539691</span>     <span class="token operator">/</span>home<span class="token operator">/</span>sploitfun<span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>syscalls<span class="token operator">/</span>mmap
<span class="token number">0804</span>a000<span class="token operator">-</span><span class="token number">0804</span>b000 rw<span class="token operator">-</span>p <span class="token number">00001000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">539691</span>     <span class="token operator">/</span>home<span class="token operator">/</span>sploitfun<span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>syscalls<span class="token operator">/</span>mmap
b7e21000<span class="token operator">-</span>b7e22000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
sploitfun@sploitfun<span class="token operator">-</span>VirtualBox<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>syscalls$<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="多线程支持"><a href="#多线程支持" class="headerlink" title="多线程支持"></a>多线程支持</h4><p>在原来的 dlmalloc 实现中，当两个线程同时要申请内存时，只有一个线程可以进入临界区申请内存，而另外一个线程则必须等待直到临界区中不再有线程。这是因为所有的线程共享一个堆。在 glibc 的 ptmalloc 实现中，比较好的一点就是支持了多线程的快速访问。在新的实现中，所有的线程共享多个堆。</p>
<p>这里给出一个例子。</p>
<p><code>pthread_create</code> 是一个函数，用于在 POSIX 线程库中创建一个新的线程。</p>
<p>函数原型如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token class-name">pthread_t</span> <span class="token operator">*</span>thread<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">pthread_attr_t</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span>
                   <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>start_routine<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>参数说明：</p>
<ul>
<li><code>thread</code>：指向 <code>pthread_t</code> 类型的指针，用于存储新创建线程的标识符。</li>
<li><code>attr</code>：指向 <code>pthread_attr_t</code> 类型的指针，用于指定线程的属性。可以传递 <code>NULL</code>，表示使用默认属性。</li>
<li><code>start_routine</code>：指向线程函数的指针，该函数是线程的入口点，线程将从该函数开始执行。</li>
<li><code>arg</code>：传递给线程函数 <code>start_routine</code> 的参数。</li>
</ul>
<p>返回值：</p>
<ul>
<li>如果成功创建线程，则返回 0，表示成功。</li>
<li>如果创建线程失败，则返回一个非零的错误码，表示失败的原因。</li>
</ul>
<p><code>pthread_create</code> 函数用于创建一个新的线程，并在指定的线程函数 <code>start_routine</code> 中执行。新线程的执行将从 <code>start_routine</code> 函数开始，该函数接受一个 <code>void*</code> 类型的参数 <code>arg</code>。线程函数可以执行任意操作，包括计算、I&#x2F;O 操作、同步等。</p>
<p>使用 <code>pthread_create</code> 创建的线程在执行完毕后，可以通过调用 <code>pthread_join</code> 函数来等待线程的结束，并获取线程的返回值。此外，还可以使用其他线程相关的函数来管理和操作线程，例如 <code>pthread_detach</code>、<code>pthread_cancel</code> 等。</p>
<p>需要注意的是，<code>pthread_create</code> 函数是 POSIX 标准中定义的线程创建函数，在不同的操作系统和编译器中可能有所差异。在使用时，应仔细阅读相关文档并遵循相应的使用规范。</p>
<p><code>pthread_join</code> 是一个函数，用于等待指定的线程结束，并获取线程的返回值。</p>
<p>函数原型如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">pthread_join</span><span class="token punctuation">(</span><span class="token class-name">pthread_t</span> thread<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>retval<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>参数说明：</p>
<ul>
<li><code>thread</code>：要等待的线程标识符，通常由 <code>pthread_create</code> 返回。</li>
<li><code>retval</code>：指向 <code>void*</code> 类型指针的指针，用于存储线程的返回值。</li>
</ul>
<p>返回值：</p>
<ul>
<li>如果成功等待线程结束，则返回 0，表示成功。</li>
<li>如果等待线程失败，则返回一个非零的错误码，表示失败的原因。</li>
</ul>
<p><code>pthread_join</code> 函数用于等待指定的线程结束。当调用该函数时，当前线程将被阻塞，直到被等待的线程执行完毕。在线程结束后，可以通过 <code>retval</code> 参数获取线程的返回值，该返回值是线程函数 <code>start_routine</code> 的返回值。</p>
<p>需要注意的是，如果线程被成功等待并成功获取返回值，那么线程的资源将被释放，不再占用系统资源。但是，如果不关心线程的返回值，可以将 <code>retval</code> 参数设置为 <code>NULL</code>。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Per thread arena example. */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>

<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">threadFunc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Before malloc in thread 1\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span><span class="token operator">*</span> addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"After malloc and before free in thread 1\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"After free in thread 1\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">pthread_t</span> t1<span class="token punctuation">;</span>
        <span class="token keyword">void</span><span class="token operator">*</span> s<span class="token punctuation">;</span>
        <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
        <span class="token keyword">char</span><span class="token operator">*</span> addr<span class="token punctuation">;</span>

        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Welcome to per thread arena example::%d\n"</span><span class="token punctuation">,</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Before malloc in main thread\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"After malloc and before free in main thread\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"After free in main thread\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t1<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> threadFunc<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Thread creation error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        ret <span class="token operator">=</span> <span class="token function">pthread_join</span><span class="token punctuation">(</span>t1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Thread join error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>第一次申请之前</strong>， 没有任何任何堆段。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">sploitfun@sploitfun<span class="token operator">-</span>VirtualBox<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread$ <span class="token punctuation">.</span><span class="token operator">/</span>mthread
Welcome to per thread arena example<span class="token operator">::</span><span class="token number">6501</span>
Before malloc in main thread
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
sploitfun@sploitfun<span class="token operator">-</span>VirtualBox<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread$ cat <span class="token operator">/</span>proc<span class="token operator">/</span><span class="token number">6501</span><span class="token operator">/</span>maps
<span class="token number">08048000</span><span class="token operator">-</span><span class="token number">08049000</span> r<span class="token operator">-</span>xp <span class="token number">00000000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">539625</span>     <span class="token operator">/</span>home<span class="token operator">/</span>sploitfun<span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread<span class="token operator">/</span>mthread
<span class="token number">08049000</span><span class="token operator">-</span><span class="token number">0804</span>a000 r<span class="token operator">--</span>p <span class="token number">00000000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">539625</span>     <span class="token operator">/</span>home<span class="token operator">/</span>sploitfun<span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread<span class="token operator">/</span>mthread
<span class="token number">0804</span>a000<span class="token operator">-</span><span class="token number">0804</span>b000 rw<span class="token operator">-</span>p <span class="token number">00001000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">539625</span>     <span class="token operator">/</span>home<span class="token operator">/</span>sploitfun<span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread<span class="token operator">/</span>mthread
b7e05000<span class="token operator">-</span>b7e07000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
sploitfun@sploitfun<span class="token operator">-</span>VirtualBox<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread$<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>第一次申请后</strong>， 从下面的输出可以看出，堆段被建立了，并且它就紧邻着数据段，这说明 malloc 的背后是用 brk 函数来实现的。同时，需要注意的是，我们虽然只是申请了 1000 个字节，但是我们却得到了 0x0806c000-0x0804b000&#x3D;0x21000 个字节的堆。<strong>这说明虽然程序可能只是向操作系统申请很小的内存，但是为了方便，操作系统会把很大的内存分配给程序。这样的话，就避免了多次内核态与用户态的切换，提高了程序的效率。</strong>我们称这一块连续的内存区域为 arena。此外，我们称由主线程申请的内存为 main_arena。后续的申请的内存会一直从这个 arena 中获取，直到空间不足。当 arena 空间不足时，它可以通过增加 brk 的方式来增加堆的空间。类似地，arena 也可以通过减小 brk 来缩小自己的空间。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">sploitfun@sploitfun<span class="token operator">-</span>VirtualBox<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread$ <span class="token punctuation">.</span><span class="token operator">/</span>mthread
Welcome to per thread arena example<span class="token operator">::</span><span class="token number">6501</span>
Before malloc in main thread
After malloc and before free in main thread
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
sploitfun@sploitfun<span class="token operator">-</span>VirtualBox<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>lsploits<span class="token operator">/</span>hof<span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread$ cat <span class="token operator">/</span>proc<span class="token operator">/</span><span class="token number">6501</span><span class="token operator">/</span>maps
<span class="token number">08048000</span><span class="token operator">-</span><span class="token number">08049000</span> r<span class="token operator">-</span>xp <span class="token number">00000000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">539625</span>     <span class="token operator">/</span>home<span class="token operator">/</span>sploitfun<span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread<span class="token operator">/</span>mthread
<span class="token number">08049000</span><span class="token operator">-</span><span class="token number">0804</span>a000 r<span class="token operator">--</span>p <span class="token number">00000000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">539625</span>     <span class="token operator">/</span>home<span class="token operator">/</span>sploitfun<span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread<span class="token operator">/</span>mthread
<span class="token number">0804</span>a000<span class="token operator">-</span><span class="token number">0804</span>b000 rw<span class="token operator">-</span>p <span class="token number">00001000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">539625</span>     <span class="token operator">/</span>home<span class="token operator">/</span>sploitfun<span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread<span class="token operator">/</span>mthread
<span class="token number">0804</span>b000<span class="token operator">-</span><span class="token number">0806</span>c000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>          <span class="token punctuation">[</span>heap<span class="token punctuation">]</span>
b7e05000<span class="token operator">-</span>b7e07000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
sploitfun@sploitfun<span class="token operator">-</span>VirtualBox<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread$<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>在主线程释放内存后</strong>，我们从下面的输出可以看出，其对应的 arena 并没有进行回收，而是交由 glibc 来进行管理。当后面程序再次申请内存时，在 glibc 中管理的内存充足的情况下，glibc 就会根据堆分配的算法来给程序分配相应的内存。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">sploitfun@sploitfun<span class="token operator">-</span>VirtualBox<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread$ <span class="token punctuation">.</span><span class="token operator">/</span>mthread
Welcome to per thread arena example<span class="token operator">::</span><span class="token number">6501</span>
Before malloc in main thread
After malloc and before free in main thread
After free in main thread
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
sploitfun@sploitfun<span class="token operator">-</span>VirtualBox<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>lsploits<span class="token operator">/</span>hof<span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread$ cat <span class="token operator">/</span>proc<span class="token operator">/</span><span class="token number">6501</span><span class="token operator">/</span>maps
<span class="token number">08048000</span><span class="token operator">-</span><span class="token number">08049000</span> r<span class="token operator">-</span>xp <span class="token number">00000000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">539625</span>     <span class="token operator">/</span>home<span class="token operator">/</span>sploitfun<span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread<span class="token operator">/</span>mthread
<span class="token number">08049000</span><span class="token operator">-</span><span class="token number">0804</span>a000 r<span class="token operator">--</span>p <span class="token number">00000000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">539625</span>     <span class="token operator">/</span>home<span class="token operator">/</span>sploitfun<span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread<span class="token operator">/</span>mthread
<span class="token number">0804</span>a000<span class="token operator">-</span><span class="token number">0804</span>b000 rw<span class="token operator">-</span>p <span class="token number">00001000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">539625</span>     <span class="token operator">/</span>home<span class="token operator">/</span>sploitfun<span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread<span class="token operator">/</span>mthread
<span class="token number">0804</span>b000<span class="token operator">-</span><span class="token number">0806</span>c000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>          <span class="token punctuation">[</span>heap<span class="token punctuation">]</span>
b7e05000<span class="token operator">-</span>b7e07000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
sploitfun@sploitfun<span class="token operator">-</span>VirtualBox<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread$<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>在第一个线程 malloc 之前</strong>，我们可以看到并没有出现与线程 1 相关的堆，但是出现了与线程 1 相关的栈。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">sploitfun@sploitfun<span class="token operator">-</span>VirtualBox<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread$ <span class="token punctuation">.</span><span class="token operator">/</span>mthread
Welcome to per thread arena example<span class="token operator">::</span><span class="token number">6501</span>
Before malloc in main thread
After malloc and before free in main thread
After free in main thread
Before malloc in thread <span class="token number">1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
sploitfun@sploitfun<span class="token operator">-</span>VirtualBox<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread$ cat <span class="token operator">/</span>proc<span class="token operator">/</span><span class="token number">6501</span><span class="token operator">/</span>maps
<span class="token number">08048000</span><span class="token operator">-</span><span class="token number">08049000</span> r<span class="token operator">-</span>xp <span class="token number">00000000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">539625</span>     <span class="token operator">/</span>home<span class="token operator">/</span>sploitfun<span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread<span class="token operator">/</span>mthread
<span class="token number">08049000</span><span class="token operator">-</span><span class="token number">0804</span>a000 r<span class="token operator">--</span>p <span class="token number">00000000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">539625</span>     <span class="token operator">/</span>home<span class="token operator">/</span>sploitfun<span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread<span class="token operator">/</span>mthread
<span class="token number">0804</span>a000<span class="token operator">-</span><span class="token number">0804</span>b000 rw<span class="token operator">-</span>p <span class="token number">00001000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">539625</span>     <span class="token operator">/</span>home<span class="token operator">/</span>sploitfun<span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread<span class="token operator">/</span>mthread
<span class="token number">0804</span>b000<span class="token operator">-</span><span class="token number">0806</span>c000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>          <span class="token punctuation">[</span>heap<span class="token punctuation">]</span>
b7604000<span class="token operator">-</span>b7605000 <span class="token operator">--</span><span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>
b7605000<span class="token operator">-</span>b7e07000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>          <span class="token punctuation">[</span>stack<span class="token operator">:</span><span class="token number">6594</span><span class="token punctuation">]</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
sploitfun@sploitfun<span class="token operator">-</span>VirtualBox<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread$<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>第一个线程 malloc 后</strong>， 我们可以从下面输出看出线程 1 的堆段被建立了。而且它所在的位置为内存映射段区域，同样大小也是 132KB(b7500000-b7521000)。因此这表明该线程申请的堆时，背后对应的函数为 mmap 函数。同时，我们可以看出实际真的分配给程序的内存为 1M(b7500000-b7600000)。而且，只有 132KB 的部分具有可读可写权限，这一块连续的区域成为 thread arena。</p>
<p>注意：</p>
<blockquote>
<p>当用户请求的内存大于 128KB 时，并且没有任何 arena 有足够的空间时，那么系统就会执行 mmap 函数来分配相应的内存空间。这与这个请求来自于主线程还是从线程无关。</p>
</blockquote>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">sploitfun@sploitfun<span class="token operator">-</span>VirtualBox<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread$ <span class="token punctuation">.</span><span class="token operator">/</span>mthread
Welcome to per thread arena example<span class="token operator">::</span><span class="token number">6501</span>
Before malloc in main thread
After malloc and before free in main thread
After free in main thread
Before malloc in thread <span class="token number">1</span>
After malloc and before free in thread <span class="token number">1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
sploitfun@sploitfun<span class="token operator">-</span>VirtualBox<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread$ cat <span class="token operator">/</span>proc<span class="token operator">/</span><span class="token number">6501</span><span class="token operator">/</span>maps
<span class="token number">08048000</span><span class="token operator">-</span><span class="token number">08049000</span> r<span class="token operator">-</span>xp <span class="token number">00000000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">539625</span>     <span class="token operator">/</span>home<span class="token operator">/</span>sploitfun<span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread<span class="token operator">/</span>mthread
<span class="token number">08049000</span><span class="token operator">-</span><span class="token number">0804</span>a000 r<span class="token operator">--</span>p <span class="token number">00000000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">539625</span>     <span class="token operator">/</span>home<span class="token operator">/</span>sploitfun<span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread<span class="token operator">/</span>mthread
<span class="token number">0804</span>a000<span class="token operator">-</span><span class="token number">0804</span>b000 rw<span class="token operator">-</span>p <span class="token number">00001000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">539625</span>     <span class="token operator">/</span>home<span class="token operator">/</span>sploitfun<span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread<span class="token operator">/</span>mthread
<span class="token number">0804</span>b000<span class="token operator">-</span><span class="token number">0806</span>c000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>          <span class="token punctuation">[</span>heap<span class="token punctuation">]</span>
b7500000<span class="token operator">-</span>b7521000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>
b7521000<span class="token operator">-</span>b7600000 <span class="token operator">--</span><span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>
b7604000<span class="token operator">-</span>b7605000 <span class="token operator">--</span><span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>
b7605000<span class="token operator">-</span>b7e07000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>          <span class="token punctuation">[</span>stack<span class="token operator">:</span><span class="token number">6594</span><span class="token punctuation">]</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
sploitfun@sploitfun<span class="token operator">-</span>VirtualBox<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread$<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>在第一个线程释放内存后</strong>， 我们可以从下面的输出看到，这样释放内存同样不会把内存重新给系统。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">sploitfun@sploitfun<span class="token operator">-</span>VirtualBox<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread$ <span class="token punctuation">.</span><span class="token operator">/</span>mthread
Welcome to per thread arena example<span class="token operator">::</span><span class="token number">6501</span>
Before malloc in main thread
After malloc and before free in main thread
After free in main thread
Before malloc in thread <span class="token number">1</span>
After malloc and before free in thread <span class="token number">1</span>
After free in thread <span class="token number">1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
sploitfun@sploitfun<span class="token operator">-</span>VirtualBox<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread$ cat <span class="token operator">/</span>proc<span class="token operator">/</span><span class="token number">6501</span><span class="token operator">/</span>maps
<span class="token number">08048000</span><span class="token operator">-</span><span class="token number">08049000</span> r<span class="token operator">-</span>xp <span class="token number">00000000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">539625</span>     <span class="token operator">/</span>home<span class="token operator">/</span>sploitfun<span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread<span class="token operator">/</span>mthread
<span class="token number">08049000</span><span class="token operator">-</span><span class="token number">0804</span>a000 r<span class="token operator">--</span>p <span class="token number">00000000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">539625</span>     <span class="token operator">/</span>home<span class="token operator">/</span>sploitfun<span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread<span class="token operator">/</span>mthread
<span class="token number">0804</span>a000<span class="token operator">-</span><span class="token number">0804</span>b000 rw<span class="token operator">-</span>p <span class="token number">00001000</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">01</span> <span class="token number">539625</span>     <span class="token operator">/</span>home<span class="token operator">/</span>sploitfun<span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread<span class="token operator">/</span>mthread
<span class="token number">0804</span>b000<span class="token operator">-</span><span class="token number">0806</span>c000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>          <span class="token punctuation">[</span>heap<span class="token punctuation">]</span>
b7500000<span class="token operator">-</span>b7521000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>
b7521000<span class="token operator">-</span>b7600000 <span class="token operator">--</span><span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>
b7604000<span class="token operator">-</span>b7605000 <span class="token operator">--</span><span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>
b7605000<span class="token operator">-</span>b7e07000 rw<span class="token operator">-</span>p <span class="token number">00000000</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">0</span>          <span class="token punctuation">[</span>stack<span class="token operator">:</span><span class="token number">6594</span><span class="token punctuation">]</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
sploitfun@sploitfun<span class="token operator">-</span>VirtualBox<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>ptmalloc<span class="token punctuation">.</span>ppt<span class="token operator">/</span>mthread$<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="glibc内存管理篇"><a href="#glibc内存管理篇" class="headerlink" title="glibc内存管理篇"></a>glibc内存管理篇</h4><h4 id="5-源代码分析"><a href="#5-源代码分析" class="headerlink" title="5.  源代码分析"></a>5.  源代码分析</h4><h5 id="5-1-边界标记法"><a href="#5-1-边界标记法" class="headerlink" title="5.1  边界标记法"></a>5.1  边界标记法</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">malloc_chunk</span> <span class="token punctuation">&#123;</span>

  INTERNAL_SIZE_T      mchunk_prev_size<span class="token punctuation">;</span>  <span class="token comment">/* Size of previous chunk (if free).  这个字段存储前一个内存块的大小（以字节为单位），但仅当这个内存块是“空闲”的（也就是当前没有被分配）时才有意义。*/</span>
  INTERNAL_SIZE_T      mchunk_size<span class="token punctuation">;</span>       <span class="token comment">/* Size in bytes, including overhead.这个字段存储当前内存块的大小（字节为单位），包括管理这片内存所需的额外开销。这意味着这个数字可能比用户请求的大小要大一些，因为它还包括结构体自身的大小以及可能的填充字节，以保持内存对齐。 */</span>

  <span class="token keyword">struct</span> <span class="token class-name">malloc_chunk</span><span class="token operator">*</span> fd<span class="token punctuation">;</span>         <span class="token comment">/* double links -- used only if free. 这是一个指向下一个内存块的指针，只有当当前内存块是空闲的时候，这个指针才有用。它用于双向链表结构中，指向链表中的下一块空闲内存块。*/</span>
  <span class="token keyword">struct</span> <span class="token class-name">malloc_chunk</span><span class="token operator">*</span> bk<span class="token punctuation">;</span>         <span class="token comment">/*这是一个指向上一个内存块的指针，同样地，只有当前内存块是空闲的时候，这个指针才有用，它是双向链表中的向前链接。*/</span>

  <span class="token comment">/* Only used for large blocks: pointer to next larger size.  */</span>
  <span class="token keyword">struct</span> <span class="token class-name">malloc_chunk</span><span class="token operator">*</span> fd_nextsize<span class="token punctuation">;</span> <span class="token comment">/* double links -- used only if free.这个字段是为了管理较大的内存块而设置的，它是指向上一个geng'xiao内存块的指针。这个指针也只在当前内存块空闲时使用。 */</span>
  <span class="token keyword">struct</span> <span class="token class-name">malloc_chunk</span><span class="token operator">*</span> bk_nextsize<span class="token punctuation">;</span>  <span class="token comment">/* 这个字段类似于`fd_nextsize`，但它指向的是下一个更大的内存块。*/</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>prev_size</strong>:如果前一个 chunk 是<strong>空闲</strong>的，该域表示<strong>前一个 chunk 的大小</strong>，如果前一个 chunk <strong>不空闲</strong>，该域<strong>无意义</strong>。 </p>
<p><strong>size</strong>：<strong>当前 chunk 的大小</strong>，并且<strong>记录了当前 chunk 和前一个 chunk 的一些属性</strong>，包括前一个 chunk 是否在使用中，当前 chunk 是否是通过 mmap 获得的内存，当前 chunk 是否属于 非主分配区。</p>
<p> <strong>fd 和 bk</strong>：指针 fd 和 bk <strong>只有当该 chunk 块空闲时才存在</strong>，其作用是用于将对应的空闲 chunk 块加入到空闲 chunk 块链表中统一管理，如果该 chunk 块被分配给应用程序使用，那 么这两个指针也就没有用（该 chunk 块已经从空闲链中拆出）了，所以也<strong>当作应用程序的使用空间</strong>，而不至于浪费。 <strong>fd指向低地址，bk指向高地址</strong></p>
<p><strong>fd_nextsize 和 bk_nextsize</strong>:当当前的 chunk 存在于 large bins 中时，large bins 中的空闲 chunk 是按照大小排序的，但同一个大小的 chunk 可能有多个，增加了这两个字段可以<strong>加快遍历空闲 chunk</strong>，并查找满足需要的空闲 chunk，<strong>fd_nextsize 指向下一个比当前 chunk 大小 大的第一个空闲 chunk</strong>，<strong>bk_nextszie 指向前一个比当前 chunk 大小小的第一个空闲 chunk</strong>。 <strong>如果该 chunk 块被分配给应用程序使用，那么这两个指针也就没有用</strong>（该 chunk 块已经从 size 链中拆出）了，所以也<strong>当作应用程序的使用空间</strong>，而不至于浪费。</p>
<p>一个已分配的块的结构如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">chunk<span class="token operator">-></span>  <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span>
         <span class="token operator">|</span> 前一个块的大小（如果已分配） <span class="token operator">|</span> <span class="token operator">|</span>
         <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span>
         <span class="token operator">|</span> 块的大小（以字节为单位） <span class="token operator">|</span>M<span class="token operator">|</span>P<span class="token operator">|</span>
 mem<span class="token operator">-></span>   <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span>
         <span class="token operator">|</span> 用户数据从这里开始<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span>
         <span class="token punctuation">.</span> 
         <span class="token punctuation">.</span> （<span class="token function">malloc_usable_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 字节） 
         <span class="token punctuation">.</span>
         <span class="token operator">|</span>
nextchunk<span class="token operator">-></span> <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span>
             <span class="token operator">|</span> 块的大小 <span class="token operator">|</span>
             <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在这里，”chunk”在大多数malloc代码中表示块的前部，而”mem”是返回给调用者的指针。块的前部包含了前一个块的大小（如果该块已分配），以及当前块的大小（以字节为单位）。”M”和”P”是用于表示块的状态（分配或空闲）的位标志。”mem”指针指向的位置是用户数据的起始位置。下一个块的位置由”nextchunk”指针表示，并且包含了下一个块的大小信息。</p>
<p>空闲块以循环双向链表的形式存储，结构如下所示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">chunk<span class="token operator">-></span>  <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span>
         <span class="token operator">|</span> 前一个块的大小 <span class="token operator">|</span>
         <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span>
`head<span class="token operator">:</span>'  <span class="token operator">|</span> 块的大小（以字节为单位） <span class="token operator">|</span>P<span class="token operator">|</span>
 mem<span class="token operator">-></span>   <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span>
         <span class="token operator">|</span> 指向链表中下一个块的前向指针 <span class="token operator">|</span>fd
         <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span>
         <span class="token operator">|</span> 指向链表中前一个块的后向指针 <span class="token operator">|</span>bk
         <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span>
         <span class="token operator">|</span> 未使用的空间（可能为<span class="token number">0</span>字节） <span class="token punctuation">.</span>
         <span class="token punctuation">.</span>
         <span class="token punctuation">.</span> <span class="token operator">|</span>
nextchunk<span class="token operator">-></span> <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span>
`foot<span class="token operator">:</span>'  <span class="token operator">|</span> 块的大小 <span class="token operator">|</span>
         <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>​	在这里，空闲块的结构与已分配块的结构类似，但有一些差别。空闲块的前部包含了前一个块的大小。<code>head:</code>标记表示这是一个空闲块的头部。在<code>mem</code>指针指向的位置，<strong>存储了块的大小信息和状态标志</strong>（P表示空闲）。空闲块还包含了指向链表中下一个块和前一个块的指针，<strong>形成了循环双向链表的结构</strong>。链表的头部指针指向第一个空闲块。<strong>空闲块的尾部有一个<code>foot:</code>标记，标识块的大小</strong>。</p>
<p>​	<strong>P（PREV_INUSE）位存储在chunk大小的未使用的低位上（chunk大小总是二字倍数）</strong>，它是用于标记<strong>前一个chunk</strong>是否在使用的一个位。如果该位被<em>清除</em>，则当前chunk大小之前的字包含了前一个chunk的大小，并且可以用来找到上一个chunk的开头。第一次分配的chunk总是设置了这个位，这样可以防止访问不存在的（或不属于自己的）内存。如果任何给定的chunk的prev_inuse被设置，则你无法确定前一个chunk的大小，甚至在尝试这样做时可能会遇到内存寻址错误。</p>
<p>​	值得注意的是，当前chunk的<code>foot</code><strong>实际上表示为下一个chunk的prev_size</strong>。这样做可以更容易地处理对齐等问题，但在尝试扩展或适应这段代码时可能会非常困惑。</p>
<p>​	所有这些都有两个异常情况：</p>
<ol>
<li>特殊的chunk <code>顶端</code>（top）并不使用它的后续大小字段，因为没有紧接着的下一个chunk需要依赖它的索引。在初始化后，<code>顶端</code>chunk强制被设置为一直存在。如果它变得小于MINSIZE字节，则会被重新填充。</li>
<li>通过mmap分配的chunks，在其大小字段中设置了第二低位的M（IS_MMAPPED）位。因为它们是单独一个一个分配的，每一个都必须包含自己的后续大小字段。</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* conversion from malloc headers to user pointers, and back */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">chunk2mem</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>Void_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token operator">*</span>SIZE_SZ<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">mem2chunk</span><span class="token expression"><span class="token punctuation">(</span>mem<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mchunkptr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>mem<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token operator">*</span>SIZE_SZ<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token comment">/* The smallest possible chunk */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MIN_CHUNK_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token function">offsetof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">malloc_chunk</span><span class="token punctuation">,</span> fd_nextsize<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token comment">/* The smallest size we can malloc is an aligned minimal chunk */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MINSIZE</span> </span>
 <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>MIN_CHUNK_SIZE<span class="token operator">+</span>MALLOC_ALIGN_MASK<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span>MALLOC_ALIGN_MASK<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">/* Check if m has acceptable alignment */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">aligned_OK</span><span class="token expression"><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token operator">&amp;</span> MALLOC_ALIGN_MASK<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">misaligned_chunk</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">)</span></span></span>
 	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>MALLOC_ALIGNMENT <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ <span class="token operator">?</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span>
 	<span class="token operator">&amp;</span> MALLOC_ALIGN_MASK<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>​	对于<strong>已经分配的 chunk</strong>，<strong>通过 chunk2mem 宏根据 chunk 地址获得返回给用户的内存地址</strong>，反过来<strong>通过 mem2chunk 宏根据 mem 地址得到 chunk 地址</strong>，chunk 的地址是按 <strong>2 * SIZE_SZ 对齐</strong>的，而 chunk 结构体的<strong>前两个域刚好也是 2*SIZE_SZ 大小</strong>，所以，<strong>mem 地址也是 2 * SIZE_SZ 对齐的</strong>。宏 aligned_OK 和misaligned_chunk(p)用于校验地址是否是按 2 * SIZE_SZ 对齐的。 <strong>MIN_CHUNK_SIZE 定义了最小的 chunk 的大小，32 位平台上位 16 字节，64 位平台为 24 字节或是 32 字节</strong>。<strong>MINSIZE 定义了最小的分配的内存大小</strong>，是对 MIN_CHUNK_SIZE 进行了 2*SIZE_SZ 对齐，地址对齐后与 MIN_CHUNK_SIZE 的大小仍然是一样的。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
检查一个请求是否过大，以至于在填充和对齐时会绕回零。为了简化其他代码，边界被设置得足够低，以至于添加MINSIZE也不会绕回零。
*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">REQUEST_OUT_OF_RANGE</span><span class="token expression"><span class="token punctuation">(</span>req<span class="token punctuation">)</span> </span></span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token operator">>=</span> 
    <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>INTERNAL_SIZE_T<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span> <span class="token operator">*</span> MINSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">/* 将请求的字节数填充为可用的大小 - 内部版本 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">request2size</span><span class="token expression"><span class="token punctuation">(</span>req<span class="token punctuation">)</span> </span></span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token operator">+</span> SIZE_SZ <span class="token operator">+</span> MALLOC_ALIGN_MASK <span class="token operator">&lt;</span> MINSIZE<span class="token punctuation">)</span> 
     <span class="token operator">?</span> MINSIZE 
     <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token operator">+</span> SIZE_SZ <span class="token operator">+</span> MALLOC_ALIGN_MASK<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span>MALLOC_ALIGN_MASK<span class="token punctuation">)</span>
<span class="token comment">/* 相同功能，同时执行参数检查 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">checked_request2size</span><span class="token expression"><span class="token punctuation">(</span>req<span class="token punctuation">,</span> sz<span class="token punctuation">)</span> </span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">REQUEST_OUT_OF_RANGE</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> 
    MALLOC_FAILURE_ACTION<span class="token punctuation">;</span> 
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> 
    <span class="token punctuation">&#125;</span> 
    <span class="token punctuation">(</span>sz<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">request2size</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">*</span><span class="token operator">/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这几个宏用于将用户请求的分配大小转换成内部需要分配的 chunk 大小，这里需要注意 的在转换时不但考虑的地址对齐，还额外加上了 SIZE_SZ，这意味着 ptmalloc 分配内存需要 一个额外的overhead，为SIZE_SZ字节，通过chunk的空间复用，我们很容易得出这个overhead 为 SIZE_SZ。</p>
<p><strong>wiki:   当一个 chunk 处于已分配状态时，它的物理相邻的下一个 chunk 的 prev_size 字段必然是无效的，故而这个字段就可以被当前这个 chunk 使用。这就是 ptmalloc 中 chunk 间的复用。具体流程如下</strong></p>
<ol>
<li>首先，利用 <strong>REQUEST_OUT_OF_RANGE 判断</strong>是否可以分配用户请求的字节大小的 chunk。</li>
<li>其次，需要注意的是用户请求的字节是用来存储数据的，即 chunk header 后面的部分。与此同时，由于 chunk 间复用，所以可以使用下一个 chunk 的 prev_size 字段。因此，这里只需要再添加 SIZE_SZ 大小即可以完全存储内容。</li>
<li>由于系统中所允许的申请的 chunk 最小是 MINSIZE，所以与其进行比较。如果<strong>不满足最低要求，那么就需要直接分配 MINSIZE 字节。</strong></li>
<li><strong>如果大于的话</strong>，因为系统中申请的 chunk 需要 2 * SIZE_SZ 对齐，所以这里需要<strong>加上 MALLOC_ALIGN_MASK 以便于对齐。</strong></li>
</ol>
<p>以 Linux X86_64 平台为例，假设 SIZE_SZ 为 8 字节，空闲时，<strong>一个 chunk 中至少要 4 个 size_t（8B）大小的空间，用来存储 prev_size，size，fd 和 bk，也就是 MINSIZE（32B），chunk 的大小要对齐到 2 * SIZE_SZ（16B）。</strong>当一个 chunk <strong>处于使用状态时</strong>，它的下一个 chunk 的 <strong>prev_size 域肯定是无效</strong>的。所以实际上，这个空间也<strong>可以被当前 chunk 使用</strong>。这听起来有点 不可思议，但确实是<strong>合理空间复用</strong>的例子。故而实际上，一个使用中的 chunk 的大小的计算公式应该是：<strong>in_use_size &#x3D; (用户请求大小+ 16 - 8 ) align to 8B</strong>，这里加 16 是因为需要存储 prev_size 和 size，但又因为向下一个 chunk“借”了 8B，所以要减去 8，<strong>每分配一个 chunk 的 overhead 为 8B</strong>，即 <strong>SIZE_SZ 的大小</strong>。最后，因为空闲的 chunk 和使用中的 chunk 使用的是同一块空间。所以肯定要取其中最大者作为实际的分配空间。即**最终的分配空间 chunk_size &#x3D; max(in_use_size, 32)**。这就是当用户请求内存分配时，ptmalloc 实际需要分配的内存大小。 </p>
<p><strong>注意：如果 chunk 是由 mmap ()直接分配的，则该 chunk 不会有前一个 chunk 和后一个 chunk，所有本 chunk 没有下一个 chunk 的 prev_size 的空间可以“借”，所以对于直接 mmap() 分配内存的 overhead 为 2 * SIZE_SZ,因为每个<code>mmap()</code>分配的内存块都有一个额外的头部和尾部，用于管理和维护内存的相关信息。</strong></p>
<p>对于使用<code>mmap()</code>直接分配的内存块，其内存布局通常是独立的，与其他内存块没有前后关系。因此，这些内存块不会有前一个块或后一个块，也就无法利用前一个块的<code>prev_size</code>字段来存储额外的信息。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* 当前一个相邻的内存块正在使用时，将 size 字段与 PREV_INUSE 进行按位或操作 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PREV_INUSE</span> <span class="token expression"><span class="token number">0x1</span> </span></span>
<span class="token comment">/* 提取前一个内存块的使用位 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">prev_inuse</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">&amp;</span> PREV_INUSE<span class="token punctuation">)</span></span></span>
<span class="token comment">/* 当内存块是通过 mmap() 函数获取时，将 size 字段与 IS_MMAPPED 进行按位或操作 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IS_MMAPPED</span> <span class="token expression"><span class="token number">0x2</span> </span></span>
<span class="token comment">/* 检查内存块是否是通过 mmap() 函数获取的 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">chunk_is_mmapped</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">&amp;</span> IS_MMAPPED<span class="token punctuation">)</span> </span></span>
<span class="token comment">/* 当内存块来自非主要堆区时，将 size 字段与 NON_MAIN_ARENA 进行按位或操作。
   这仅在必要时在将内存块交给用户之前设置。 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NON_MAIN_ARENA</span> <span class="token expression"><span class="token number">0x4</span></span></span>
<span class="token comment">/*检查内存块是否来自非主要堆区 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">chunk_non_main_arena</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">&amp;</span> NON_MAIN_ARENA<span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>解释：</strong></p>
<ol>
<li><code>PREV_INUSE</code>（0x1）：用于表示前一个相邻内存块是否正在使用的标志位。当前一个内存块处于使用状态时，<strong>将该标志位设置为1。</strong></li>
<li><code>prev_inuse(p)</code>：用于提取给定内存块（<code>p</code>）的前一个内存块的使用状态。通过与<code>PREV_INUSE</code>进行按位与操作，可以获取前一个内存块的使用状态。</li>
<li><code>IS_MMAPPED</code>（0x2）：用于表示内存块是否是通过<code>mmap()</code>函数获得的标志位。当内存块是通过<code>mmap()</code>函数分配的时，<strong>将该标志位设置为1。</strong></li>
<li><code>chunk_is_mmapped(p)</code>：用于检查给定内存块（<code>p</code>）是否是通过<code>mmap()</code>函数分配的内存块。<strong>通过与<code>IS_MMAPPED</code>进行按位与操作，可以判断内存块是否是通过<code>mmap()</code>函数分配的。</strong></li>
<li><code>NON_MAIN_ARENA</code>（0x4）：用于表示内存块是否来自非主要堆区（non-main arena）的标志位。非主要堆区是glibc中用于管理多个堆的机制，<strong>当内存块来自非主要堆区时，将该标志位设置为1。</strong></li>
<li><code>chunk_non_main_arena(p)</code>：用于检查给定内存块（<code>p</code>）是否来自非主要堆区。<strong>通过与<code>NON_MAIN_ARENA</code>进行按位与操作，可以判断内存块是否来自非主要堆区。</strong></li>
</ol>
<p>chunk 在分割时总是以地址对齐（默认是 8 字节，可以自由设置，但是 8 字节是最小值 并且设置的值必须是 2 为底的幂函数值，即是 alignment &#x3D; 2^n，n 为整数且 n&gt;&#x3D;3）的方式来 进行的，所以用 chunk-&gt;size 来存储本 chunk 块大小字节数的话，其<strong>末 3bit 位</strong>总是 0，因此 <strong>这三位可以用来存储其它信息</strong>，比如： </p>
<p><strong>以第 0 位作为 P 状态位</strong>，标记<strong>前一</strong>chunk 块是否在使用中，<strong>为 1 表示使用，为 0 表示空闲</strong>。 </p>
<p><strong>以第 1 位作为 M 状态位</strong>，标记本 chunk 块<strong>是否是使用 mmap()直接从进程的 mmap 映射区域分配的</strong>，<strong>为 1 表示是，为 0 表示否。</strong> </p>
<p><strong>以第 2 位作为 A 状态位</strong>，标记本 chunk <strong>是否属于非主分配区</strong>，<strong>为 1 表示是，为 0 表示 否</strong>。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 Bits to mask off when extracting size
 Note: IS_MMAPPED is intentionally not masked off from size field in
 macros for which mmapped chunks should never be seen. This should
 cause helpful core dumps to occur if it is tried by accident by
 people extending or adapting this malloc.
*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SIZE_BITS</span> <span class="token expression"><span class="token punctuation">(</span>PREV_INUSE<span class="token operator">|</span>IS_MMAPPED<span class="token operator">|</span>NON_MAIN_ARENA<span class="token punctuation">)</span></span></span>
<span class="token comment">/* Get size, ignoring use bits */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">chunksize</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span>SIZE_BITS<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token comment">/* Ptr to next physical malloc_chunk. */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">next_chunk</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mchunkptr<span class="token punctuation">)</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">&amp;</span> <span class="token operator">~</span>SIZE_BITS<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token comment">/* Ptr to previous physical malloc_chunk */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">prev_chunk</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mchunkptr<span class="token punctuation">)</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token operator">-></span>prev_size<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token comment">/* Treat space at ptr + offset as a chunk */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">chunk_at_offset</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">,</span> s<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mchunkptr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
提取大小时要屏蔽的位
注意：在那些不应该看到 mmapped 块的宏中，意图上并没有从大小字段中屏蔽 IS_MMAPPED。
如果由于意外而尝试这样做，这应该导致有用的核心转储发生，以帮助扩展或调整此 malloc 实现的人员。
*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SIZE_BITS</span> <span class="token expression"><span class="token punctuation">(</span>PREV_INUSE<span class="token operator">|</span>IS_MMAPPED<span class="token operator">|</span>NON_MAIN_ARENA<span class="token punctuation">)</span></span></span>
<span class="token comment">/* 获取大小，忽略使用位 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">chunksize</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span>SIZE_BITS<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token comment">/* 指向下一个物理 malloc_chunk 的指针 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">next_chunk</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mchunkptr<span class="token punctuation">)</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">&amp;</span> <span class="token operator">~</span>SIZE_BITS<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token comment">/* 指向前一个物理 malloc_chunk 的指针 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">prev_chunk</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mchunkptr<span class="token punctuation">)</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token operator">-></span>prev_size<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token comment">/* 将 ptr + offset 处的空间视为一个块 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">chunk_at_offset</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">,</span> s<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mchunkptr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这些宏的作用如下：</p>
<ol>
<li><code>SIZE_BITS</code>：<strong>用于屏蔽提取大小时不需要的位</strong>。其中包括 <code>PREV_INUSE</code>、<code>IS_MMAPPED</code> 和 <code>NON_MAIN_ARENA</code>。这些位用于标记内存块的状态和属性。</li>
<li><code>chunksize(p)</code>：<strong>用于获取给定内存块（<code>p</code>）的大小</strong>。通过将内存块的 size 字段与 <code>SIZE_BITS</code> 进行按位与操作，可以得到实际的内存块大小，忽略了使用位。</li>
<li><code>next_chunk(p)</code>：<strong>用于获取给定内存块（<code>p</code>）的下一个物理 <code>malloc_chunk</code> 的指针</strong>。通过将内存块的地址加上内存块的大小（忽略了使用位），可以得到下一个物理内存块的地址。</li>
<li><code>prev_chunk(p)</code>：<strong>用于获取给定内存块（<code>p</code>）的前一个物理 <code>malloc_chunk</code> 的指针</strong>。通过将内存块的地址减去前一个内存块的 <code>prev_size</code> 字段的值，可以得到前一个物理内存块的地址。</li>
<li><code>chunk_at_offset(p, s)</code>：<strong>将给定内存块（<code>p</code>）的地址加上偏移量 <code>s</code>，将结果视为一个块的指针</strong>。这个宏用于在指定偏移量处处理内存块。</li>
</ol>
<p>prev_size 字段虽然在当前 chunk 块结构体内，<strong>记录的却是前一个邻接 chunk 块的信息</strong>， 这样做的好处就是我们通过本块 chunk 结构体就可以直接获取到前一 chunk 块的信息，从而 方便做进一步的处理操作。相对的，当前 chunk 块的 foot 信息就存在于下一个邻接 chunk 块的结构体内。字段 prev_size 记录的什么信息呢？有两种情况： </p>
<p>1）如果前一个邻接 chunk 块空闲，那么当前 chunk 块结构体内的 prev_size 字段记录的 是前一个邻接 chunk 块的大小。这就是由当前 chunk 指针获得前一个空闲 chunk 地址的依据。 宏 prev_chunk(p)就是依赖这个假设实现的。 </p>
<p>2）如果前一个邻接 chunk 在使用中，则当前 chunk 的 prev_size 的空间被前一个 chunk 借用中，其中的值是前一个 chunk 的内存内容，对当前 chunk 没有任何意义。 </p>
<p>字段 size 记录了本 chunk 的大小，无论下一个 chunk 是空闲状态或是被使用状态，都可以通过本 chunk 的地址加上本 chunk 的大小，得到下一个 chunk 的地址，由于 size 的低 3 个 bit 记录了控制信息，需要屏蔽掉这些控制信息，取出实际的 size 在进行计算下一个 chunk 地址，这是 next_chunk(p)的实现原理。</p>
<p><strong>浅浅理解：标志位是不占用内存大小的，实际size包含例如pre_size之类的管理信息</strong></p>
<p>宏 chunksize(p)用于获得 chunk 的实际大小，需要屏蔽掉 size 中的控制信息。</p>
<p> 宏 chunk_at_offset(p, s)将 p+s 的地址强制看作一个 chunk。 </p>
<p><strong>注意：按照边界标记法，可以有多个连续的并且正在被使用中的 chunk 块，但是不会有 多个连续的空闲 chunk 块，因为连续的多个空闲 chunk 块一定会合并成一个大的空闲 chunk 块。</strong></p>
<p><strong>补充：合并空闲块的目标通常是为了提高内存利用率和减少内存碎片化</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* 提取 p 的 inuse 位 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">inuse</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">)</span></span></span>
	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mchunkptr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">&amp;</span> <span class="token operator">~</span>SIZE_BITS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-></span>size<span class="token punctuation">)</span> <span class="token operator">&amp;</span> PREV_INUSE<span class="token punctuation">)</span>
<span class="token comment">/* 设置/清除块的 inuse 位，同时不影响其他属性 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">set_inuse</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">)</span></span></span>
	<span class="token punctuation">(</span><span class="token punctuation">(</span>mchunkptr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">&amp;</span> <span class="token operator">~</span>SIZE_BITS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">|=</span> PREV_INUSE
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">clear_inuse</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">)</span></span></span>
	<span class="token punctuation">(</span><span class="token punctuation">(</span>mchunkptr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">&amp;</span> <span class="token operator">~</span>SIZE_BITS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>PREV_INUSE<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><code>inuse(p)</code> 宏用于提取给定内存块 <code>p</code> 的 inuse 位。通过对 <code>p</code> 进行位运算和指针偏移，获取下一个内存块的起始位置，并从其 <code>size</code> 字段中提取出 PREV_INUSE 位的值，<strong>以确定 <code>p</code> 是否被标记为已使用。</strong></li>
<li><code>set_inuse(p)</code> 宏<strong>用于将给定内存块 <code>p</code> 标记为已使用，而不影响其他属性</strong>。通过对 <code>p</code> 进行位运算和指针偏移，获取下一个内存块的起始位置，并将其 <code>size</code> 字段中的 PREV_INUSE 位置为 1，表示该内存块已被使用。</li>
<li><code>clear_inuse(p)</code> 宏<strong>用于将给定内存块 <code>p</code> 标记为未使用，而不影响其他属性</strong>。通过对 <code>p</code> 进行位运算和指针偏移，获取下一个内存块的起始位置，并将其 <code>size</code> 字段中的 PREV_INUSE 位清零，表示该内存块未被使用。</li>
</ul>
<p>上面的这一组宏<strong>用于 check&#x2F;set&#x2F;clear 当前 chunk 使用标志位，</strong>当前 chunk 的使用标志位存储在下一个 chunk 的 size 的第 0 bit（P 状态位），所以首先要获得下一个 chunk 的地址， 然后 check&#x2F;set&#x2F;clear 下一个 chunk 的 size 域的第 0 bit。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* check/set/clear inuse bits in known places */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">inuse_bit_at_offset</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">,</span> s<span class="token punctuation">)</span></span></span>
	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mchunkptr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">&amp;</span> PREV_INUSE<span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">set_inuse_bit_at_offset</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">,</span> s<span class="token punctuation">)</span></span></span>
	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mchunkptr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">|=</span> PREV_INUSE<span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">clear_inuse_bit_at_offset</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">,</span> s<span class="token punctuation">)</span></span></span>
	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mchunkptr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面的三个宏用于 check&#x2F;set&#x2F;clear <strong>指定 chunk 的 size 域中的使用标志位</strong>。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Set size at head, without disturbing its use bit */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">set_head_size</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">,</span> s<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">&amp;</span> SIZE_BITS<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token comment">/* Set size/use field */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">set_head</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">,</span> s<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token operator">-></span>size <span class="token operator">=</span> <span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token comment">/* Set size at footer (only when chunk is not in use) */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">set_foot</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">,</span> s<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mchunkptr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-></span>prev_size <span class="token operator">=</span> <span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> 宏 set_head_size(p, s)用<strong>于设置当前 chunk p 的 size 域并保留 size 域的控制信息</strong>。宏 set_head(p, s) 用于设置当前 chunk p 的 size 域并忽略已有的 size 域控制信息。宏 set_foot(p,  s)用于设置当前 chunk p 的下一个 chunk 的 prev_size 为 s，s 为当前 chunk 的 size，<strong>只有当 chunk  p 为空闲时才能使用这个宏</strong>，<strong>当前 chunk 的 foot 的内存空间存在于下一个 chunk，即下一个 chunk 的 prev_size。</strong></p>
<h5 id="5-2-分箱式内存管理"><a href="#5-2-分箱式内存管理" class="headerlink" title="5.2 分箱式内存管理"></a>5.2 分箱式内存管理</h5><p>​	对于空闲的 chunk，ptmalloc 采用分箱式内存管理方式，<strong>根据空闲 chunk 的大小和处于的状态将其放在四个不同的 bin 中</strong>，这四个空闲 chunk 的容器包括 <strong>fast bins，unsorted bin， small bins 和 large bins</strong>。<strong>Fast bins</strong> 是<strong>小内存块的高速缓存</strong>，当一些大小<strong>小于 64 字节的 chunk 被回收时</strong>，<strong>首先会放入 fast bins 中</strong>，在<strong>分配小内存时</strong>，<strong>首先会查看 fast bins 中是否有合适的 内存块</strong>，如果存在，则直接返回 fast bins 中的内存块，以加快分配速度。<strong>Usorted bin 只有一个</strong>，<strong>回收的 chunk 块必须先放到 unsorted bin 中</strong>，<strong>分配内存时会查看 unsorted bin 中是否有合适的 chunk</strong>，如果找到满足条件的 chunk，则直接返回给用户，<strong>否则将 unsorted bin 的所有 chunk 放入 small bins 或是 large bins 中</strong>。Small bins 用于<strong>存放固定大小的 chunk</strong>，共 <strong>64</strong> 个 bin，<strong>最小的 chunk 大小为 16 字节或 32 字节</strong>，每个 bin 的<strong>大小相差 8 字节或是 16 字节</strong>，当 分配小内存块时，采用<strong>精确匹配</strong>的方式从 small bins 中查找合适的 chunk。<strong>Large bins 用于存 储大于等于 512B 或 1024B 的空闲 chunk</strong>，这些 chunk 使用双向链表的形式按大小顺序排序， <strong>分配内存时按最近匹配方式从 large bins 中分配 chunk</strong>。</p>
<h5 id="问题小结"><a href="#问题小结" class="headerlink" title="问题小结"></a>问题小结</h5><p><strong>问题：为什么bin数组在遍历的时候会往前跨两个地址，并且将bin元素强转成chunk指针类型？</strong></p>
<p><strong>解答：因为chunk指针指向chunk，如果直接使用bin数组的fd和bk来寻址，那么链表会断掉，因为类型不符合</strong></p>
<p>太强了！！ 强转很重要！！！！</p>
<p>bin 通用的宏如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">malloc_chunk</span> <span class="token operator">*</span>mbinptr<span class="token punctuation">;</span>

<span class="token comment">/* addressing -- note that bin_at(0) does not exist */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">bin_at</span><span class="token expression"><span class="token punctuation">(</span>m<span class="token punctuation">,</span> i<span class="token punctuation">)</span>                                                           </span></span>
    <span class="token punctuation">(</span>mbinptr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token operator">-></span>bins<span class="token punctuation">[</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span>       <span class="token comment">//这里往前跨两个且强转         </span>
              <span class="token function">offsetof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">malloc_chunk</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">/* analog of ++bin */</span>
<span class="token comment">//获取下一个bin的地址</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">next_bin</span><span class="token expression"><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mbinptr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>mchunkptr<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token comment">/* Reminders about list directionality within bins */</span>
<span class="token comment">// 这两个宏可以用来遍历bin</span>
<span class="token comment">// 获取 bin 的位于链表头的 chunk</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">first</span><span class="token expression"><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token operator">-></span>fd<span class="token punctuation">)</span></span></span>
<span class="token comment">// 获取 bin 的位于链表尾的 chunk</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">last</span><span class="token expression"><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token operator">-></span>bk<span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="5-2-1-Small-bins"><a href="#5-2-1-Small-bins" class="headerlink" title="5.2.1 Small bins"></a>5.2.1 Small bins</h5><p>​	ptmalloc使用small bins管理空闲小chunk，每个small bin中的chunk的大小与bin的index 有如下关系： 	<strong>Chunk_size&#x3D;2 * SIZE_SZ * index</strong> </p>
<p>​	在 <strong>SIZE_SZ 为 4B</strong> 的平台上，small bins 中的 chunk <strong>大小是以 8B 为公差的等差数列</strong>，最大 的 chunk 大小为 <strong>504B</strong>，最小的 chunk 大小为 <strong>16B</strong>，所以<strong>实际共 62 个 bin</strong>。分别为 <strong>16B、24B、 32B，„„，504B</strong>。在 <strong>SIZE_SZ 为 8B</strong> 的平台上，small bins 中的 chunk <strong>大小是以 16B 为公差的等差数列</strong>，最大的 chunk 大小为 <strong>1008B</strong>，最小的 chunk 大小为 <strong>32B</strong>，所以<strong>实际共 62 个 bin</strong>。 分别为 <strong>32B、48B、64B，…… ，1008B</strong>。 </p>
<p>​	<strong>ptmalloc 维护了 62 个双向环形链表</strong>（每个链表<strong>都具有链表头节点</strong>，加头节点的最大作用就是便于对链表内节点的统一处理，即简化编程），<strong>每一个链表内的各空闲 chunk 的大小一致</strong>，因此<strong>当应用程序需要分配某个字节大小的内存空间时直接在对应的链表内取就可以了</strong>， 这样既可以很好的满足应用程序的内存空间申请请求而又不会出现太多的内存碎片。我们可 以用如下图来表示在 SIZE_SZ 为 4B 的平台上 ptmalloc 对 512B 字节以下的空闲 chunk 组织方 式（所谓的分箱机制）</p>
<p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20231219202911816.png" alt="image-20231219202911816"></p>
<h5 id="5-2-2-Large-bins"><a href="#5-2-2-Large-bins" class="headerlink" title="5.2.2 Large bins"></a>5.2.2 Large bins</h5><p>​	在 SIZE_SZ 为 4B 的平台上，大于等于 512B 的空闲 chunk，或者，在 SIZE_SZ 为 8B 的平 台上，大小大于等于 1024B 的空闲 chunk，由 sorted bins 管理。<strong>Large bins 一共包括 63 个 bin</strong>， <strong>每个 bin 中的 chunk 大小不是一个固定公差的等差数列</strong>，而是<strong>分成 6 组 bin</strong>，<strong>每组 bin 是一个 固定公差的等差数列</strong>，每组的 bin <strong>数量依次为 32、16、8、4、2、1</strong>，<strong>公差依次为 64B、512B、 4096B、32768B、262144B 等</strong>。</p>
<p>​	以 SIZE_SZ 为 4B 的平台为例，第一个 large bin 的起始 chunk 大小为 512B，共 32 个 bin， 公差为 64B，等差数列满足如下关系：</p>
<p>​	<strong>Chunk_size&#x3D;512 + 64 * index</strong></p>
<p>​	第二个 large bin 的起始 chunk 大小为第一组 bin 的结束 chunk 大小，满足如下关系： </p>
<p>​	<strong>Chunk_size&#x3D;512 + 64 * 32 + 512 * index</strong> </p>
<p>​	同理，我们可计算出每个 bin 的起始 chunk 大小和结束 chunk 大小。这些 bin 都是很有规律的，其实 small bins 也是满足类似规律，small bins 可以看着是公差为 8 的等差数列，一 共有 64 个 bin<strong>（第 0 和 1bin 不存在）</strong>，所以我们可以将 small bins 和 large bins 存放在同一个包含 128 个 chunk 的数组上，数组的前一部分位 small bins，后一部分为 large bins，每个 bin 的 index 为 chunk 数组的下标，于是，我们可以根据数组下标计算出该 bin 的 chunk 大小（small bins）或是 chunk 大小范围（large bins），也可以根据需要分配内存块大小计算出所需 chunk 所属 bin 的 index，ptmalloc 使用了一组宏巧妙的实现了这种计算。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NBINS</span> <span class="token expression"><span class="token number">128</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NSMALLBINS</span> <span class="token expression"><span class="token number">64</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SMALLBIN_WIDTH</span> <span class="token expression">MALLOC_ALIGNMENT</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MIN_LARGE_SIZE</span> <span class="token expression"><span class="token punctuation">(</span>NSMALLBINS <span class="token operator">*</span> SMALLBIN_WIDTH<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">in_smallbin_range</span><span class="token expression"><span class="token punctuation">(</span>sz<span class="token punctuation">)</span> </span></span>
	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>MIN_LARGE_SIZE<span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">smallbin_index</span><span class="token expression"><span class="token punctuation">(</span>sz<span class="token punctuation">)</span> </span></span>
	<span class="token punctuation">(</span>SMALLBIN_WIDTH <span class="token operator">==</span> <span class="token number">16</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">largebin_index_32</span><span class="token expression"><span class="token punctuation">(</span>sz<span class="token punctuation">)</span> </span></span>
	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">38</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token number">56</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token operator">:</span> 
	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token number">91</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token operator">:</span> 
	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token number">110</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token operator">:</span> 
	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token number">119</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token operator">:</span> 
	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">18</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token number">124</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token operator">:</span> 
     									  <span class="token number">126</span><span class="token punctuation">)</span>
<span class="token comment">// XXX It remains to be seen whether it is good to keep the widths of</span>
<span class="token comment">// XXX the buckets the same or whether it should be scaled by a factor</span>
<span class="token comment">// XXX of two as well.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">largebin_index_64</span><span class="token expression"><span class="token punctuation">(</span>sz<span class="token punctuation">)</span> </span></span>
	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">48</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token number">48</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token operator">:</span> 
	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token number">91</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token operator">:</span> 
	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token number">110</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token operator">:</span> 
	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token number">119</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token operator">:</span> 
	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">18</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token number">124</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token operator">:</span> 
										  <span class="token number">126</span><span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">largebin_index</span><span class="token expression"><span class="token punctuation">(</span>sz<span class="token punctuation">)</span> </span></span>
	<span class="token punctuation">(</span>SIZE_SZ <span class="token operator">==</span> <span class="token number">8</span> <span class="token operator">?</span> <span class="token function">largebin_index_64</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">largebin_index_32</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">bin_index</span><span class="token expression"><span class="token punctuation">(</span>sz<span class="token punctuation">)</span> </span></span>
	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">in_smallbin_range</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">smallbin_index</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">largebin_index</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>​	注意：如果对于用户要分配的内存大小 size， 必须先使用 checked_request2size(req, sz)计算出 chunk 的大小，再使用 bin_index(sz)计算出 chunk 所属的 bin index。 </p>
<p>​	对于 SIZE_SZ 为 4B 的平台，<strong>bin[0]和 bin[1]是不存在的</strong>，因为最小的 chunk 为 16B，small  bins 一共 62 个，large bins 一共 63 个，加起来一共 125 个 bin。而 NBINS 定义为 128，<strong>其实 bin[0]和 bin[127]都不存在</strong>，<strong>bin[1]为 unsorted bin 的 chunk 链表头</strong>。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">malloc_chunk</span><span class="token operator">*</span> mbinptr<span class="token punctuation">;</span>

<span class="token comment">/* addressing -- note that bin_at(0) does not exist */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">bin_at</span><span class="token expression"><span class="token punctuation">(</span>m<span class="token punctuation">,</span> i<span class="token punctuation">)</span> </span></span>
<span class="token punctuation">(</span>mbinptr<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token operator">-></span>bins<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">offsetof</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">malloc_chunk</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">/* analog of ++bin */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">next_bin</span><span class="token expression"><span class="token punctuation">(</span>b<span class="token punctuation">)</span> </span></span>
<span class="token punctuation">(</span><span class="token punctuation">(</span>mbinptr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>mchunkptr<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">/* Reminders about list directionality within bins */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">first</span><span class="token expression"><span class="token punctuation">(</span>b<span class="token punctuation">)</span> </span></span>
<span class="token punctuation">(</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token operator">-></span>fd<span class="token punctuation">)</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">last</span><span class="token expression"><span class="token punctuation">(</span>b<span class="token punctuation">)</span> </span></span>
<span class="token punctuation">(</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token operator">-></span>bk<span class="token punctuation">)</span>

<span class="token comment">/* Take a chunk off a bin list */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">unlink</span><span class="token expression"><span class="token punctuation">(</span>P<span class="token punctuation">,</span> BK<span class="token punctuation">,</span> FD<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </span></span>
FD <span class="token operator">=</span> P<span class="token operator">-></span>fd<span class="token punctuation">;</span> 
BK <span class="token operator">=</span> P<span class="token operator">-></span>bk<span class="token punctuation">;</span> 
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>FD<span class="token operator">-></span>bk <span class="token operator">!=</span> P <span class="token operator">||</span> BK<span class="token operator">-></span>fd <span class="token operator">!=</span> P<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span>check_action<span class="token punctuation">,</span> <span class="token string">"corrupted double-linked list"</span><span class="token punctuation">,</span> P<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">else</span> <span class="token punctuation">&#123;</span> 
    FD<span class="token operator">-></span>bk <span class="token operator">=</span> BK<span class="token punctuation">;</span> 
    BK<span class="token operator">-></span>fd <span class="token operator">=</span> FD<span class="token punctuation">;</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span>P<span class="token operator">-></span>size<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>P<span class="token operator">-></span>fd_nextsize <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> 
        <span class="token function">assert</span> <span class="token punctuation">(</span>P<span class="token operator">-></span>fd_nextsize<span class="token operator">-></span>bk_nextsize <span class="token operator">==</span> P<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token function">assert</span> <span class="token punctuation">(</span>P<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">==</span> P<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>FD<span class="token operator">-></span>fd_nextsize <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> 
            <span class="token keyword">if</span> <span class="token punctuation">(</span>P<span class="token operator">-></span>fd_nextsize <span class="token operator">==</span> P<span class="token punctuation">)</span> 
                FD<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> FD<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> FD<span class="token punctuation">;</span> 
            <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> 
                FD<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> P<span class="token operator">-></span>fd_nextsize<span class="token punctuation">;</span> 
                FD<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> P<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span> 
                P<span class="token operator">-></span>fd_nextsize<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> FD<span class="token punctuation">;</span> 
                P<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> FD<span class="token punctuation">;</span> 
            <span class="token punctuation">&#125;</span> 
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> 
            P<span class="token operator">-></span>fd_nextsize<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> P<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span> 
            P<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> P<span class="token operator">-></span>fd_nextsize<span class="token punctuation">;</span> 
        <span class="token punctuation">&#125;</span> 
    <span class="token punctuation">&#125;</span> 
<span class="token punctuation">&#125;</span> 
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>宏 bin_at(m, i)<strong>通过 bin index 获得 bin 的链表头</strong>，<strong>chunk 中的 fb 和 bk 用于将空闲 chunk 链入链表中</strong>，而对于每个 bin 的链表头，只需要这两个域就可以了，<strong>prev_size 和 size 对链表都来说都没有意义</strong>，浪费空间，<strong>ptmalloc</strong> 为了节约这点内存空间，增大 cpu 高速缓存的命中率，<strong>在 bins 数组中只为每个 bin 预留了两个指针的内存空间用于存放 bin 的链表头的 fb 和 bk 指针</strong>。 </p>
<p>从 bin_at(m, i)的定义可以看出，bin[0]不存在，以 SIZE_SZ 为 4B 的平台为例，<strong>bin[1]的前 4B 存储的是指针 fb，后 4B 存储的是指针 bk</strong>，而 <strong>bin_at 返回的是 malloc_chunk 的指针</strong>，由 于 fb 在 malloc_chunk 的偏移地址为 offsetof (struct malloc_chunk, fd))&#x3D;8，所以用 fb 的地址减去 8 就得到 malloc_chunk 的地址。但切记，<strong>对 bin 的链表头的 chunk，一定不能修改 prev_size 和 size 域</strong>，<strong>这两个域是与其他 bin 的链表头的 fb 和 bk 内存复用的</strong>。 </p>
<p><strong>宏 next_bin(b)用于获得下一个 bin 的地址</strong>，根据前面的分析，我们知道<strong>只需要将当前 bin 的地址向后移动两个指针的长度</strong>就得到下一个 bin 的链表头地址。 </p>
<p>每个 bin 使用双向循环链表管理空闲 chunk，<strong>bin 的链表头的指针 fb 指向第一个可用的 chunk</strong>，<strong>指针 bk 指向最后一个可用的 chunk</strong>。<strong>宏 first(b)用于获得 bin 的第一个可用 chunk， 宏 last(b)用于获得 bin 的最后一个可用的 chunk，这两个宏便于遍历 bin，而跳过 bin 的链表头。</strong> </p>
<p><strong>宏 unlink(P, BK, FD)用于将 chunk 从所在的空闲链表中取出来</strong>，注意 <strong>large bins 中的空闲 chunk 可能处于两个双向循环链表中</strong>，unlink 时需要从两个链表中都删除。(还有一个由fdnextsize,bknextsize组成的链表，因为large bin十分特殊，<strong>大小可能不相同</strong>)</p>
<p><strong>注意：bins是声明在malloc_state的指针数组，长度为254，2个元素构成一个bin，bin数组元素指向的是所对应管理的chunk</strong></p>
<h5 id="5-2-3-Unsorted-bin"><a href="#5-2-3-Unsorted-bin" class="headerlink" title="5.2.3  Unsorted bin"></a>5.2.3  Unsorted bin</h5><p>Unsorted bin 可以看作是 small bins 和 large bins 的 cache(缓存)，<strong>只有一个 unsorted bin</strong>，以双向链表管理空闲 chunk，<strong>空闲 chunk 不排序</strong>，所有的 chunk 在<strong>回收时都要先放到 unsorted bin 中</strong>，<strong>分配时</strong>，如果在 <strong>unsorted bin 中没有合适的 chunk</strong>，就<strong>会把 unsorted bin 中的所有 chunk 分别加入到所属的 bin 中</strong>，然后<strong>再在 bin 中分配合适的 chunk</strong>。Bins 数组中的<strong>元素 bin[1]用于 存储 unsorted bin 的 chunk 链表头</strong>。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 Unsorted chunks
 All remainders from chunk splits, as well as all returned chunks,
 are first placed in the "unsorted" bin. They are then placed
 in regular bins after malloc gives them ONE chance to be used before
 binning. So, basically, the unsorted_chunks list acts as a queue,
 with chunks being placed on it in free (and malloc_consolidate),
 and taken off (to be either used or placed in bins) in malloc.
 The NON_MAIN_ARENA flag is never set for unsorted chunks, so it
 does not have to be taken into account in size comparisons.
*/</span>
<span class="token comment">/* The otherwise unindexable 1-bin is used to hold unsorted chunks. */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">unsorted_chunks</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">bin_at</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token comment">/*
 Top
 The top-most available chunk (i.e., the one bordering the end of
 available memory) is treated specially. It is never included in
 any bin, is used only if no other chunk is available, and is
 released back to the system if it is very large (see
 M_TRIM_THRESHOLD). Because top initially
 points to its own bin with initial zero size, thus forcing
 extension on the first malloc request, we avoid having any special
 code in malloc to check whether it even exists yet. But we still
 need to do so when getting memory from system, so we make
 initial_top treat the bin as a legal but unusable chunk during the
 interval between initialization and the first call to
 sYSMALLOc. (This is somewhat delicate, since it relies on
 the 2 preceding words to be zero during this interval as well.)
*/</span>
<span class="token comment">/* Conveniently, the unsorted bin can be used as dummy top on first call */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">initial_top</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
未排序的块
所有从块分割中剩余的部分，以及所有返回的块，
首先放置在"未排序"的 bin 中。然后，在 malloc 给它们一次使用的机会之前，
将它们放置在常规的 bin 中。因此，基本上，未排序的块列表充当队列，
在释放时将块放置在其中（以及 malloc_consolidate 中），
并在 malloc 中取出（用于使用或放置在 bins 中）。
未排序的块从不设置 NON_MAIN_ARENA 标志，因此在大小比较中不需要考虑它。
*/</span>
<span class="token comment">/*无法索引的 1-bin 用于保存未排序的块。*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">unsorted_chunks</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">bin_at</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token comment">/*
顶部
最顶部的可用块（即，与可用内存结束边界相邻的块）被特殊对待。
它从不包含在任何 bin 中，仅在没有其他块可用时使用，并且如果非常大（参见 M_TRIM_THRESHOLD）则释放回系统。
因为 top 最初指向自己的 bin，初始大小为零，因此在第一个 malloc 请求时强制扩展，
我们避免在 malloc 中添加任何特殊代码来检查它是否已经存在。
但是，在从系统获取内存时，我们仍然需要这样做，因此我们使 initial_top 在初始化和第一次调用 sYSMALLOc 之间的时间间隔内将 bin 视为合法但不可用的块。（这有些微妙，因为它还依赖于在此时间间隔内前两个字为零。）
*/</span>
<span class="token comment">/* 方便的是，未排序的 bin 可以在第一次调用时用作虚拟顶部 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">initial_top</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面的宏的定义比较明显，<strong>把 bin[1]设置为 unsorted bin 的 chunk 链表头</strong>，对 top chunk 的初始化，也暂时把 top chunk 初始化为 unsort chunk，<strong>仅仅是初始化一个值而已</strong>，这个 chunk 的内容肯定不能用于 top chunk 来分配内存，主要原因是 <strong>top chunk 不属于任何 bin</strong>，<strong>但 ptmalloc 中的一些 check 代码，可能需要 top chunk 属于一个合法的 bin。</strong></p>
<h5 id="5-2-4-Fast-bins"><a href="#5-2-4-Fast-bins" class="headerlink" title="5.2.4  Fast bins"></a>5.2.4  Fast bins</h5><p>Fast bins 主要是用于提高小内存的分配效率，<strong>默认情况下，对于 SIZE_SZ 为 4B 的平台， 小于 64B 的 chunk 分配请求，对于 SIZE_SZ 为 8B 的平台，小于 128B 的 chunk 分配请求， 首先会查找 fast bins 中是否有所需大小的 chunk 存在（精确匹配），</strong>如果存在，就直接返回。 </p>
<p>Fast bins 可以看着是 small bins 的一小部分 cache，<strong>默认情况下，fast bins 只 cache 了 small  bins 的前 7 个大小的空闲 chunk</strong>，也就是说，对于 SIZE_SZ 为 4B 的平台，fast bins 有 7 个 chunk 空闲链表（bin），每个 bin 的 chunk 大小依次为 16B，24B，32B，40B，48B，56B，64B；对于 SIZE_SZ 为 8B 的平台，fast bins 有 7 个 chunk 空闲链表（bin），每个 bin 的 chunk 大小依 次为 <strong>32B</strong>，48B，64B，80B，96B，112B，<strong>128B</strong>。以 32 为系统为例，分配的内存大小与 chunk 大小和 fast bins 的对应关系如下表所示：</p>
<p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20231219224233213.png" alt="image-20231219224233213"></p>
<p>Fast bins 可以看着是 LIFO 的栈，使用单向链表实现。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 Fastbins
 An array of lists holding recently freed small chunks. Fastbins
 are not doubly linked. It is faster to single-link them, and
 since chunks are never removed from the middles of these lists,
 double linking is not necessary. Also, unlike regular bins, they
 are not even processed in FIFO order (they use faster LIFO) since
 ordering doesn't much matter in the transient contexts in which
 fastbins are normally used.
 
 Chunks in fastbins keep their inuse bit set, so they cannot
 be consolidated with other free chunks. malloc_consolidate
 releases all chunks in fastbins and consolidates them with
 other free chunks.
*/</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">malloc_chunk</span><span class="token operator">*</span> mfastbinptr<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">fastbin</span><span class="token expression"><span class="token punctuation">(</span>ar_ptr<span class="token punctuation">,</span> idx<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ar_ptr<span class="token punctuation">)</span><span class="token operator">-></span>fastbinsY<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
fast bins
一个包含最近释放的小块的链表数组。fast bins 不是双向链表。
使用单向链接可以更快地操作它们，并且由于这些链表中的块从不被移除，
所以不需要双向链接。此外，与常规 bins 不同，它们甚至不按照 FIFO 的顺序进行处理
（它们使用更快的 LIFO），因为在通常使用fast bins 的瞬时上下文中，顺序并不重要。
fast bins 中的块保持其 inuse 位设置，因此它们不能与其他空闲块合并。
malloc_consolidate 释放fast bins 中的所有块，并将它们与其他空闲块合并。
*/</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">malloc_chunk</span> mfastbinptr<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">fastbin</span><span class="token expression"><span class="token punctuation">(</span>ar_ptr<span class="token punctuation">,</span> idx<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ar_ptr<span class="token punctuation">)</span><span class="token operator">-></span>fastbinsY<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>根据 fast bin 的 index，获得 fast bin 的地址。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* offset 2 to use otherwise unindexable first 2 bins */</span>
<span class="token comment">/* 
将大小转换为快速 bins 的索引。
这个宏定义用于将块的大小转换为在快速 bins 中的索引。
它使用了一个偏移量 2，以便使用起始的两个 bins，这样就可以处理无法索引的前两个 bins。
*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">fastbin_index</span><span class="token expression"><span class="token punctuation">(</span>sz<span class="token punctuation">)</span> </span></span>
 <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token punctuation">(</span>SIZE_SZ <span class="token operator">==</span> <span class="token number">8</span> <span class="token operator">?</span> <span class="token number">4</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>​	宏 fastbin_index(sz)<strong>用于获得 fast bin 在 fast bins 数组中的 index</strong>，<strong>由于 bin[0]和 bin[1]中 的chunk不存在，所以需要减2</strong>，对于SIZE_SZ为4B的平台，将sz除以8减2得到fast bin index， 对于 SIZE_SZ 为 8B 的平台，将 sz 除以 16 减去 2 得到 fast bin index。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* The maximum fastbin request size we support */</span>
<span class="token comment">/* 我们支持的最大快速 bins 请求大小 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_FAST_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">80</span> <span class="token operator">*</span> SIZE_SZ <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NFASTBINS</span> <span class="token expression"><span class="token punctuation">(</span><span class="token function">fastbin_index</span><span class="token punctuation">(</span><span class="token function">request2size</span><span class="token punctuation">(</span>MAX_FAST_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span></span></span>
<span class="token comment">/*
 FASTBIN_CONSOLIDATION_THRESHOLD is the size of a chunk in free() 
 that triggers automatic consolidation of possibly-surrounding
 fastbin chunks. This is a heuristic, so the exact value should not
 matter too much. It is defined at half the default trim threshold as a
 compromise heuristic to only attempt consolidation if it is likely
 to lead to trimming. However, it is not dynamically tunable, since
 consolidation reduces fragmentation surrounding large chunks even
 if trimming is not used.
*/</span>
<span class="token comment">/*
FASTBIN_CONSOLIDATION_THRESHOLD 是在 free() 函数中触发自动合并可能周围的快速 bins 块的块大小阈值。
这是一个启发式值，所以具体的数值并不太重要。它被定义为默认修剪阈值的一半，作为一个折衷的启发式值，
只有当合并可能导致修剪时才尝试合并。然而，它不能动态调整，因为即使不使用修剪，合并也可以减少大块周围的碎片化。
*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FASTBIN_CONSOLIDATION_THRESHOLD</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">65536UL</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>​	根据 SIZE_SZ 的不同大小，<strong>定义 MAX_FAST_SIZE 为 80B 或是 160B</strong>，fast bins 数组的大小 NFASTBINS 为 10，FASTBIN_CONSOLIDATION_THRESHOLD 为 64k，<strong>当每次释放的 chunk 与该 chunk 相邻的空闲 chunk 合并后的大小大于 64k 时</strong>，就认为<strong>内存碎片可能比较多</strong>了，就需要 <strong>把 fast bins 中的所有 chunk 都进行合并</strong>，以减少内存碎片对系统的影响。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">DEFAULT_MXFAST</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_MXFAST</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">64</span> <span class="token operator">*</span> SIZE_SZ <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token comment">/*
 Set value of max_fast.
 Use impossibly small value if 0.
 Precondition: there are no existing fastbin chunks.
 Setting the value clears fastchunk bit but preserves noncontiguous bit.
*/</span>
<span class="token comment">/*
设置 max_fast 的值。
如果为 0，则使用不可能的小值。
前提条件：不存在现有的 fastbin 块。
设置该值会清除 fastchunk 位，但保留非连续 bit。
*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">set_max_fast</span><span class="token expression"><span class="token punctuation">(</span>s<span class="token punctuation">)</span> </span></span>
 global_max_fast <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> SMALLBIN_WIDTH<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">+</span> SIZE_SZ<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span>MALLOC_ALIGN_MASK<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">get_max_fast</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> global_max_fast</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>​	上面的<strong>宏 DEFAULT_MXFAST 定义了默认的 fast bins 中最大的 chunk 大小</strong>，<strong>对于 SIZE_SZ 为 4B</strong> 的平台，<strong>最大 chunk 为 64B</strong>，对于 <strong>SIZE_SZ 为 8B</strong> 的平台，<strong>最大 chunk 为 128B</strong>。ptmalloc 默认情况下<strong>调用 set_max_fast(s)将全局变量 global_max_fast 设置为 DEFAULT_MXFAST</strong>，也就 是设置 fast bins 中 chunk 的最大值，<strong>get_max_fast()用于获得这个全局变量 global_max_fast 的值</strong>。</p>
<h5 id="5-3-核心结构体分析"><a href="#5-3-核心结构体分析" class="headerlink" title="5.3 核心结构体分析"></a>5.3 核心结构体分析</h5><p>每个分配区是 struct malloc_state 的一个实例，ptmalloc 使用 <strong>malloc_state 来管理分配区</strong>， 而<strong>参数管理使用 struct malloc_par，全局拥有一个唯一的 malloc_par 实例。</strong></p>
<h5 id="5-3-1-malloc-state"><a href="#5-3-1-malloc-state" class="headerlink" title="5.3.1 malloc_state"></a>5.3.1 malloc_state</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">malloc_state</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">/* Serialize access.  */</span>
  <span class="token comment">/* 序列化访问 */</span>
  <span class="token function">__libc_lock_define</span> <span class="token punctuation">(</span><span class="token punctuation">,</span> mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Flags (formerly in max_fast).  */</span>
  <span class="token comment">/* 标志位（以前在 max_fast 中） */</span>
  <span class="token keyword">int</span> flags<span class="token punctuation">;</span>

  <span class="token comment">/* Set if the fastbin chunks contain recently inserted free blocks.  */</span>
  <span class="token comment">/* Note this is a bool but not all targets support atomics on booleans.  */</span>
  <span class="token comment">/* 如果 fastbin 块包含最近插入的空闲块，则设置为 1 */</span>
  <span class="token comment">/* 注意，这是一个布尔值，但并非所有目标平台都支持对布尔值的原子操作 */</span>
  <span class="token keyword">int</span> have_fastchunks<span class="token punctuation">;</span>

  <span class="token comment">/* Fastbins */</span>
  mfastbinptr fastbinsY<span class="token punctuation">[</span>NFASTBINS<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">/* Base of the topmost chunk -- not otherwise kept in a bin */</span>
  <span class="token comment">/* 最顶层块的基址 -- 不在任何 bin 中 */</span>
  mchunkptr top<span class="token punctuation">;</span>

  <span class="token comment">/* The remainder from the most recent split of a small request */</span>
  <span class="token comment">/* 最近一次拆分小型请求产生的剩余块 */</span>
  mchunkptr last_remainder<span class="token punctuation">;</span>

  <span class="token comment">/* Normal bins packed as described above */</span>
  <span class="token comment">/* 正常 bins，按照上述描述进行打包 */</span>
  mchunkptr bins<span class="token punctuation">[</span>NBINS <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">/* Bitmap of bins */</span>
  <span class="token comment">/* bins 的位图 */</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> binmap<span class="token punctuation">[</span>BINMAPSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">/* Linked list */</span>
  <span class="token comment">/* 链表 */</span>
  <span class="token keyword">struct</span> <span class="token class-name">malloc_state</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>

  <span class="token comment">/* Linked list for free arenas.  Access to this field is serialized
     by free_list_lock in arena.c.  */</span>
  <span class="token comment">/* 用于空闲 arenas 的链表。访问该字段由 arena.c 中的 free_list_lock 进行序列化 */</span>
  <span class="token keyword">struct</span> <span class="token class-name">malloc_state</span> <span class="token operator">*</span>next_free<span class="token punctuation">;</span>

  <span class="token comment">/* Number of threads attached to this arena.  0 if the arena is on
     the free list.  Access to this field is serialized by
     free_list_lock in arena.c.  */</span>
   <span class="token comment">/* 附加到该 arena 的线程数。如果该 arena 在空闲列表中，则为 0。访问该字段由 arena.c 中的              free_list_lock 进行序列化 */</span>
  INTERNAL_SIZE_T attached_threads<span class="token punctuation">;</span>

  <span class="token comment">/* Memory allocated from the system in this arena.  */</span>
  <span class="token comment">/* 在该 arena 中从系统分配的内存 */</span>
  INTERNAL_SIZE_T system_mem<span class="token punctuation">;</span>
  INTERNAL_SIZE_T max_system_mem<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>​	<strong>Mutex 用于串行化访问分配区</strong>，当有多个线程访问同一个分配区时，<strong>第一个获得这个 mutex 的线程将使用该分配区分配内存</strong>，<strong>分配完成后，释放该分配区的 mutex</strong>，以便其它线程使用该分配区。</p>
<p>​	<strong>Flags 记录了分配区的一些标志</strong>，<strong>bit0</strong> 用于标识分配区<strong>是否包含至少一个 fast bin chunk</strong>， <strong>bit1</strong> 用于标识分配区<strong>是否能返回连续的虚拟地址空间</strong>。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 FASTCHUNKS_BIT held in max_fast indicates that there are probably
 some fastbin chunks. It is set true on entering a chunk into any
 fastbin, and cleared only in malloc_consolidate.
 The truth value is inverted so that have_fastchunks will be true
 upon startup (since statics are zero-filled), simplifying
 initialization checks.
*/</span>
<span class="token comment">/*
在 max_fast 中持有的 FASTCHUNKS_BIT 表示可能存在一些 fastbin 块。
当将块插入任何 fastbin 中时，将其设置为 true，并且仅在 malloc_consolidate 中清除。
为了使 have_fastchunks 在启动时为 true（因为静态变量会被零填充），真值被取反，简化了初始化检查。
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该注释解释了在 <code>max_fast</code> 中持有的 <strong><code>FASTCHUNKS_BIT</code></strong> 表示可能存在一些 <code>fastbin</code> 块的含义。<strong>当将块插入任何 <code>fastbin</code>中时，会将该标志位设置为 <code>true</code><strong>，并且</strong>只有在 <code>malloc_consolidate</code> 函数中才会清除该标志位</strong>。为了确保在启动时 <code>have_fastchunks</code> 为 <code>true</code>（<strong>因为静态变量会被零填充</strong>），<strong>真值被取反，简化了初始化检查</strong>。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FASTCHUNKS_BIT</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1U</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">have_fastchunks</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token operator">-></span>flags <span class="token operator">&amp;</span> FASTCHUNKS_BIT<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">ATOMIC_FASTBINS</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">clear_fastchunks</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token function">catomic_or</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token operator">-></span>flags<span class="token punctuation">,</span> FASTCHUNKS_BIT<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">set_fastchunks</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token function">catomic_and</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token operator">-></span>flags<span class="token punctuation">,</span> <span class="token operator">~</span>FASTCHUNKS_BIT<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">clear_fastchunks</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token operator">-></span>flags <span class="token operator">|=</span> FASTCHUNKS_BIT<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">set_fastchunks</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token operator">-></span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>FASTCHUNKS_BIT<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>​	上面的宏<strong>用于设置或是置位 flags 中 fast chunk 的标志位 bit0</strong>，如果 <strong>bit0 为 0</strong>，表示<strong>分配区中有 fast chunk</strong>，<strong>如果为 1 表示没有 fast chunk</strong>，<strong>初始化完成后的 malloc_state 实例中，flags 值为 0</strong>，表示该分配区中有 fast chunk，但<strong>实际上没有</strong>，试图<strong>从 fast bins 中分配 chunk 都会返回 NULL</strong>，在<strong>第一次调用函数 malloc_consolidate()对 fast bins 进行 chunk 合并时</strong>，如果 <strong>max_fast 大于 0</strong>，会<strong>调用 clear_fastchunks 宏</strong>，<strong>标志该分配区中已经没有 fast chunk</strong>，因为函数 malloc_consolidate()会合并所有的 fast bins 中的 chunk。<strong>clear_fastchunks 宏只会在函数 malloc_consolidate()中调用</strong>。<strong>当有 fast chunk 加入 fast bins 时，就是调用 set_fastchunks 宏标 46 识分配区的 fast bins 中存在 fast chunk。</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 NONCONTIGUOUS_BIT indicates that MORECORE does not return contiguous
 regions. Otherwise, contiguity is exploited in merging together,
 when possible, results from consecutive MORECORE calls.
 The initial value comes from MORECORE_CONTIGUOUS, but is
 changed dynamically if mmap is ever used as an sbrk substitute.
*/</span>
<span class="token comment">/*
NONCONTIGUOUS_BIT 表示 MORECORE 不返回连续的内存区域。
否则，在可能的情况下，连续的 MORECORE 调用结果会被合并在一起。
初始值来自 MORECORE_CONTIGUOUS，但如果 mmap 被用作 sbrk 的替代，则会动态更改。
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该注释解释了 <code>NONCONTIGUOUS_BIT</code> 的含义。**<code>NONCONTIGUOUS_BIT</code> 表示 <code>MORECORE</code> 函数不返回连续的内存区域。<strong>在正常情况下，</strong>如果连续的 <code>MORECORE</code> 调用返回的内存区域是相邻的<strong>，那么在</strong>合并内存块时可以利用这种连续性。**</p>
<p>初始情况下，**<code>NONCONTIGUOUS_BIT</code> 的值来自 <code>MORECORE_CONTIGUOUS</code><strong>，但</strong>如果在后续的内存分配中使用了 <code>mmap</code> 作为 <code>sbrk</code> 的替代方式，那么 <code>NONCONTIGUOUS_BIT</code> 的值会动态地进行更改。**</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NONCONTIGUOUS_BIT</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">2U</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">contiguous</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token operator">-></span>flags <span class="token operator">&amp;</span> NONCONTIGUOUS_BIT<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">noncontiguous</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token operator">-></span>flags <span class="token operator">&amp;</span> NONCONTIGUOUS_BIT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">set_noncontiguous</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token operator">-></span>flags <span class="token operator">|=</span> NONCONTIGUOUS_BIT<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">set_contiguous</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token operator">-></span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>NONCONTIGUOUS_BIT<span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>​	Flags 的 <strong>bit1 如果为 0</strong>，表示 <strong>MORCORE 返回连续虚拟地址空间</strong>，<strong>bit1 为 1</strong>，表示 <strong>MORCORE 返回非连续虚拟地址空间</strong>，对于<strong>主分配区，MORECORE 其实为 sbr()，默认返回连续虚拟地 址空间</strong>，对于<strong>非主分配区，使用 mmap()分配大块虚拟内存，然后进行切分来模拟主分配区的行为</strong>，而默认情况下 mmap 映射区域是不保证虚拟地址空间连续的，所以<strong>非主分配区默认分配非连续虚拟地址空间。</strong></p>
<p>​	Malloc_state 中声明了几个对锁的统计变量，<strong>默认没有定义 THREAD_STATS</strong>，所以<strong>不会对锁的争用情况做统计</strong>。 </p>
<p>​	<strong>fastbinsY 拥有 10（NFASTBINS）个元素的数组</strong>，<strong>用于存放每个 fast chunk 链表头指针</strong>， <strong>所以 fast bins 最多包含 10 个 fast chunk 的单向链表。</strong> </p>
<p>​	<strong>top 是一个 chunk 指针</strong>，<strong>指向分配区的 top chunk</strong>。 </p>
<p>​	<strong>last_remainder 是一个 chunk 指针</strong>，分配区上次分配 small chunk 时，从一个 chunk 中分裂出一个 small chunk 返回给用户，<strong>分裂后的剩余部分形成一个 chunk，last_remainder 就是指向的这个 chunk。</strong></p>
<p>​	<strong>bins 用于存储 unstored bin，small bins 和 large bins 的 chunk 链表头</strong>，small bins 一共 62 个，large bins 一共 63 个，加起来一共 125 个 bin。而 NBINS 定义为 128，其实 bin[0]和 bin[127] 都不存在，bin[1]为 unsorted bin 的 chunk 链表头，所以实际只有 126bins。<strong>Bins 数组能存放 了 254（NBINS * 2 – 2）个 mchunkptr 指针</strong>，而我们实现需要存储 chunk 的实例，一般情况下， <strong>chunk 实例的大小为 6 个 mchunkptr 大小</strong>，这 254 个指针的大小怎么能存下 126 个 chunk 呢？ 这里使用了一个技巧，如果按照我们的常规想法，也许会申请 126 个 malloc_chunk 结构体指针元素的数组，然后再给链表申请一个头节点（即 126 个），再让每个指针元素正确指向而形成 126 个具有头节点的链表。事实上，对于 malloc_chunk 类型的链表“头节点”，其内的 <strong>prev_size 和 size 字段是没有任何实际作用的，fd_nextsize 和 bk_nextsize 字段只有 large bins 中的空闲 chunk 才会用到，而对于 large bins 的空闲 chunk 链表头不需要这两个字段，因此 这四个字段所占空间如果不合理使用的话那就是白白的浪费。</strong>我们再来看一看 128 个 malloc_chunk 结构体指针元素的数组占了多少内存空间呢？<strong>假设 SIZE_SZ 的大小为 8B，则指针的大小也为 8B</strong>，结果为 126 * 2 * 8&#x3D;2016 字节。而 126 个 malloc_chunk 类型的链表“头节点” 需要多少内存呢？126 * 6 * 8&#x3D;6048，真的是 6048B 么？不是，刚才不是说了，prev_size，size， fd_nextsize 和 bk_nextsize 这四个字段是没有任何实际作用的，因此完全可以被重用（覆盖）， 47 因此实际需要内存为 126<em>2</em>8&#x3D;2016。<em><em>Bins 指针数组的大小为，（128 * 2 - 2）</em> 8&#x3D;2032</em>* , 2032 大 于 2016（<strong>事实上最后 16 个字节都被浪费掉了</strong>），那么这 <strong>254 个 malloc_chunk结构体指针元素数组所占内存空间就可以存储这 126 个头节点了。</strong></p>
<p>​	<strong>binmap 字段是一个 int 数组，ptmalloc 用一个 bit 来标识该 bit 对应的 bin 中是否包含空 闲 chunk。</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
 Binmap
 To help compensate for the large number of bins, a one-level index
 structure is used for bin-by-bin searching. `binmap' is a
 bitvector recording whether bins are definitely empty so they can
 be skipped over during during traversals. The bits are NOT always
 cleared as soon as bins are empty, but instead only
 when they are noticed to be empty during traversal in malloc.
*/</span>
<span class="token comment">/*
位图（Binmap）
为了弥补大量的 bin（内存块链表），使用了一级索引结构来进行逐个 bin 的搜索。
binmap 是一个位向量，记录了哪些 bin 明确为空，以便在遍历过程中可以跳过这些空的 bin。
这些位在 bin 变为空时并不总是立即清除，而是在 malloc 的遍历过程中注意到它们为空时才进行清除。
*/</span> 
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BITSPERMAP</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1U</span> <span class="token operator">&lt;&lt;</span> BINMAPSHIFT<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BINMAPSIZE</span> <span class="token expression"><span class="token punctuation">(</span>NBINS <span class="token operator">/</span> BITSPERMAP<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">idx2block</span><span class="token expression"><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">>></span> BINMAPSHIFT<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">idx2bit</span><span class="token expression"><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1U</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1U</span> <span class="token operator">&lt;&lt;</span> BINMAPSHIFT<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">mark_bin</span><span class="token expression"><span class="token punctuation">(</span>m<span class="token punctuation">,</span>i<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token operator">-></span>binmap<span class="token punctuation">[</span><span class="token function">idx2block</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token function">idx2bit</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">unmark_bin</span><span class="token expression"><span class="token punctuation">(</span>m<span class="token punctuation">,</span>i<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token operator">-></span>binmap<span class="token punctuation">[</span><span class="token function">idx2block</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token function">idx2bit</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">get_binmap</span><span class="token expression"><span class="token punctuation">(</span>m<span class="token punctuation">,</span>i<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token operator">-></span>binmap<span class="token punctuation">[</span><span class="token function">idx2block</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token function">idx2bit</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>​	<strong>binmap 一共 128bit，16 字节，4 个 int 大小</strong>，binmap 按 int 分成 4 个 block，每个 block 有 32 个 bit，根据 bin indx 可以使用宏 idx2block 计算出该 bin 在 binmap 对应的 bit 属于哪个 block。idx2bit 宏取第 i 位为 1，其它位都为 0 的掩码，举个例子：idx2bit(3) 为 “0000 1000” （只显示 8 位）。<strong>mark_bin 设置第 i 个 bin 在 binmap 中对应的 bit 位为 1；unmark_bin 设置 第 i 个 bin 在 binmap 中对应的 bit 位为 0；get_binmap 获取第 i 个 bin 在 binmap 中对应的 bit。</strong> </p>
<p>​	<strong>next 字段用于将分配区以单向链表链接起来。</strong> </p>
<p>​	<strong>next_free 字段空闲的分配区链接在单向链表中，只有在定义了 PER_THREAD 的情况下才 定义该字段。</strong> </p>
<p>​	<strong>system_mem 字段记录了当前分配区已经分配的内存大小。</strong> </p>
<p>​	<strong>max_system_mem 记录了当前分配区最大能分配的内存大小。</strong></p>
<h4 id="堆相关数据结构-大部分与上述重复"><a href="#堆相关数据结构-大部分与上述重复" class="headerlink" title="堆相关数据结构(大部分与上述重复)"></a>堆相关数据结构(大部分与上述重复)</h4><p><strong>！！！一些关于堆的约束，后面详细考虑！！！</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
    The three exceptions to all this are:
     1. The special chunk `top' doesn't bother using the
    trailing size field since there is no next contiguous chunk
    that would have to index off it. After initialization, `top'
    is forced to always exist.  If it would become less than
    MINSIZE bytes long, it is replenished.
     2. Chunks allocated via mmap, which have the second-lowest-order
    bit M (IS_MMAPPED) set in their size fields.  Because they are
    allocated one-by-one, each must contain its own trailing size
    field.  If the M bit is set, the other bits are ignored
    (because mmapped chunks are neither in an arena, nor adjacent
    to a freed chunk).  The M bit is also used for chunks which
    originally came from a dumped heap via malloc_set_state in
    hooks.c.
     3. Chunks in fastbins are treated as allocated chunks from the
    point of view of the chunk allocator.  They are consolidated
    with their neighbors only in bulk, in malloc_consolidate.
*/</span>
<span class="token comment">/*
    在所有这些规则之外，有三个例外情况：
     1. 特殊块 top 不使用尾部的大小字段，因为没有下一个连续的块需要引用它。在初始化之后，top 始终存在。如果它的长度变得小于 MINSIZE 字节，它会被重新填充。
     2. 通过 mmap 分配的块，在其大小字段中设置了第二低位 M（IS_MMAPPED）。因为它们是逐个分配的，每个块必须包含自己的尾部大小字段。如果设置了 M 位，其他位将被忽略（因为 mmapped 块既不在一个 arena 中，也不与已释放的块相邻）。M 位还用于最初通过 hooks.c 中的 malloc_set_state 从已转储堆中获取的块。
     3. 快速分配链表（fastbins）中的块在块分配器的视角中被视为已分配的块。它们仅在 malloc_consolidate 中批量与相邻块合并。
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="Top-Chunk"><a href="#Top-Chunk" class="headerlink" title="Top Chunk"></a>Top Chunk</h5><p>glibc 中对于 top chunk 的描述如下</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
   Top

    The top-most available chunk (i.e., the one bordering the end of
    available memory) is treated specially. It is never included in
    any bin, is used only if no other chunk is available, and is
    released back to the system if it is very large (see
    M_TRIM_THRESHOLD).  Because top initially
    points to its own bin with initial zero size, thus forcing
    extension on the first malloc request, we avoid having any special
    code in malloc to check whether it even exists yet. But we still
    need to do so when getting memory from system, so we make
    initial_top treat the bin as a legal but unusable chunk during the
    interval between initialization and the first call to
    sysmalloc. (This is somewhat delicate, since it relies on
    the 2 preceding words to be zero during this interval as well.)
 */</span>

<span class="token comment">/* Conveniently, the unsorted bin can be used as dummy top on first call */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">initial_top</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>程序第一次进行 malloc 的时候，heap 会被分为两块，一块给用户，剩下的那块就是 top chunk。其实，所谓的 top chunk 就是处于当前堆的物理地址最高的 chunk。这个 chunk 不属于任何一个 bin，它的作用<strong>在于当所有的 bin 都无法满足用户请求的大小时，如果其大小不小于指定的大小，就进行分配，并将剩下的部分作为新的 top chunk</strong>。否则，就对 heap 进行扩展后再进行分配。在 main arena 中通过 sbrk 扩展 heap，而在 thread arena 中通过 mmap 分配新的 heap。</p>
<p>需要注意的是，top chunk 的 prev_inuse 比特位始终为 1，否则其前面的 chunk 就会被合并到 top chunk 中。</p>
<p><strong>初始情况下，我们可以将 unsorted chunk 作为 top chunk。</strong></p>
<h5 id="last-remainder"><a href="#last-remainder" class="headerlink" title="last remainder"></a>last remainder</h5><p>在用户使用 malloc 请求分配内存时，<strong>ptmalloc2 找到的 chunk 可能并不和申请的内存大小一致</strong>，这时候<strong>就将分割之后的剩余部分称之为 last remainder chunk ，unsort bin 也会存这一块</strong>。<strong>top chunk 分割剩下的部分不会作为 last remainder.</strong></p>
<h4 id="宏观结构"><a href="#宏观结构" class="headerlink" title="宏观结构"></a>宏观结构</h4><h5 id="arena"><a href="#arena" class="headerlink" title="arena"></a>arena</h5><p>在我们之前介绍的例子中，无论是主线程还是新创建的线程，在第一次申请内存时，都会有独立的 arena。那么会不会每个线程都有独立的 arena 呢？下面我们就具体介绍。</p>
<h5 id="arena-数量"><a href="#arena-数量" class="headerlink" title="arena 数量"></a>arena 数量</h5><p>对于不同系统，arena 数量的<a target="_blank" rel="noopener" href="https://github.com/sploitfun/lsploits/blob/master/glibc/malloc/arena.c#L847">约束</a>如下</p>
<pre class="line-numbers language-none"><code class="language-none">For 32 bit systems:
     Number of arena &#x3D; 2 * number of cores.
For 64 bit systems:
     Number of arena &#x3D; 8 * number of cores.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>显然，不是每一个线程都会有对应的 arena。至于为什么 64 位系统，要那么设置，我也没有想明白。此外，因为每个系统的核数是有限的，当线程数大于核数的二倍（超线程技术）时，就必然有线程处于等待状态，所以没有必要为每个线程分配一个 arena。</p>
<h5 id="arena-分配规则-来自于不知名博客，不确定其完全正确性"><a href="#arena-分配规则-来自于不知名博客，不确定其完全正确性" class="headerlink" title="arena 分配规则(来自于不知名博客，不确定其完全正确性)"></a>arena 分配规则(来自于不知名博客，不确定其完全正确性)</h5><p>Ptmalloc2通过几种数据结构来进行管理，主要有arena,heap,chunk三种层级。<strong>arena和heap都是对chunk的一种组织方式，方便之后的分配，arena又是对heap的组织，arene是堆管理器。</strong></p>
<ul>
<li><p><code>arena</code>: 有一个main_arena，是由主线程创建的，thread_arena则为各线程创建的，当arena满了之后就不再创建而是与其他arena共享一个arena，方法为依次给各个arena上锁（查看是否有其他线程正在使用该arena），如果上锁成功（没有其他线程正在使用），则使用该arena，之后一直使用这个arena，如果无法使用则阻塞等待。</p>
</li>
<li><p><code>heap</code>的等级就比arena要低一些了，一个arena可以有多个heap，也是存储了堆相关的信息。</p>
</li>
<li><p><code>chunk</code>为分配给用户的内存的一个单位，每当我们分配一段内存的时候其实就是分配得到了一个chunk，我们就可以在chunk当中进行一定的操作了。不过为了进行动态分配，chunk本身也有一些数据（元数据），是用来指示其分配等等的数据。</p>
</li>
<li><p>glibc的malloc源码中涉及三种最重要数据结构：<strong>Arena、Heap、Chunk</strong> ，分别对应结构体<strong>malloc_state、heap_info、malloc_chunk 。</strong>每个数据结构都有对应的结构体实现,如图:</p>
<p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20231220232830154.png" alt="image-20231220232830154"></p>
<ul>
<li><strong>Thread - Arena</strong> ： <strong>一个Arena对应多个线程Thread</strong>。即<strong>每个线程都有一个Arena</strong>，但是**有可能多个线程共用一个Arena(同一时间只能一对一)**。每个Arena都包含一个malloc_state结构体，保存bins, top chunk, Last reminder chunk等信息。</li>
<li><strong>Arena - Heap</strong>：一个Arena可能拥有多个heap。Arena开始的时候只有一个heap，<strong>但是当这个heap的空间用尽时，就需要获取新的heap</strong>。(也可以理解为subheap子堆)</li>
<li><strong>Heap - Chunk</strong>：一个Heap根据用户的请求会划分为多个chunk，<strong>每个chunk拥有自己的header - malloc_chunk。</strong></li>
</ul>
</li>
</ul>
<h5 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h5><p>与 thread 不同的是，main_arena 并不在申请的 heap 中，而是一个全局变量，在 libc.so 的数据段。</p>
<h5 id="heap-info"><a href="#heap-info" class="headerlink" title="heap_info"></a>heap_info</h5><p>程序刚开始执行时，每个线程是没有 heap 区域的。当其申请内存时，就需要一个结构来记录对应的信息，而 heap_info 的作用就是这个。而且当该 heap 的资源被使用完后，就必须得再次申请内存了。此外，一般申请的 heap 是不连续的，因此需要记录不同 heap 之间的链接结构。</p>
<p><strong>该数据结构是专门为从 Memory Mapping Segment 处申请的内存准备的，即为非主线程准备的。</strong></p>
<p>主线程可以通过 sbrk() 函数扩展 program break location 获得（直到触及 Memory Mapping Segment），只有一个 heap，没有 heap_info 数据结构。</p>
<p><strong>heap_info 的主要结构如下</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HEAP_MIN_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">32</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">HEAP_MAX_SIZE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">ifdef</span> <span class="token expression">DEFAULT_MMAP_THRESHOLD_MAX</span></span>
<span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">define</span> <span class="token macro-name">HEAP_MAX_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> DEFAULT_MMAP_THRESHOLD_MAX<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">define</span> <span class="token macro-name">HEAP_MAX_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span> </span><span class="token comment">/* must be a power of two */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/* HEAP_MIN_SIZE and HEAP_MAX_SIZE limit the size of mmap()ed heaps
   that are dynamically created for multi-threaded programs.  The
   maximum size must be a power of two, for fast determination of
   which heap belongs to a chunk.  It should be much larger than the
   mmap threshold, so that requests with a size just below that
   threshold can be fulfilled without creating too many heaps.  */</span>

<span class="token comment">/***************************************************************************/</span>

<span class="token comment">/* A heap is a single contiguous memory region holding (coalesceable)
   malloc_chunks.  It is allocated with mmap() and always starts at an
   address aligned to HEAP_MAX_SIZE.  */</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_heap_info</span>
<span class="token punctuation">&#123;</span>
  mstate ar_ptr<span class="token punctuation">;</span> <span class="token comment">/* Arena for this heap. */</span>
  <span class="token keyword">struct</span> <span class="token class-name">_heap_info</span> <span class="token operator">*</span>prev<span class="token punctuation">;</span> <span class="token comment">/* Previous heap. */</span>
  <span class="token class-name">size_t</span> size<span class="token punctuation">;</span>   <span class="token comment">/* Current size in bytes. */</span>
  <span class="token class-name">size_t</span> mprotect_size<span class="token punctuation">;</span> <span class="token comment">/* Size in bytes that has been mprotected
                           PROT_READ|PROT_WRITE.  */</span>
  <span class="token comment">/* Make sure the following data is properly aligned, particularly
     that sizeof (heap_info) + 2 * SIZE_SZ is a multiple of
     MALLOC_ALIGNMENT. */</span>
  <span class="token keyword">char</span> pad<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span> <span class="token operator">*</span> SIZE_SZ <span class="token operator">&amp;</span> MALLOC_ALIGN_MASK<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> heap_info<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HEAP_MIN_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">32</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">HEAP_MAX_SIZE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">ifdef</span> <span class="token expression">DEFAULT_MMAP_THRESHOLD_MAX</span></span>
<span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">define</span> <span class="token macro-name">HEAP_MAX_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> DEFAULT_MMAP_THRESHOLD_MAX<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">define</span> <span class="token macro-name">HEAP_MAX_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span> </span><span class="token comment">/* 必须是2的幂次方 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/* HEAP_MIN_SIZE和HEAP_MAX_SIZE限制了为多线程程序动态创建的mmap()堆的大小。
   最大大小必须是2的幂次方，以便快速确定一个内存块属于哪个堆。
   它应该比mmap阈值大得多，这样可以满足大小接近阈值的请求而不会创建太多堆。 */</span>

<span class="token comment">/***************************************************************************/</span>

<span class="token comment">/* 堆（heap）是一个连续的内存区域，包含（可合并的）malloc_chunk。
   它是通过mmap()分配的，并且始终从HEAP_MAX_SIZE对齐的地址开始。 */</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_heap_info</span>
<span class="token punctuation">&#123;</span>
  mstate ar_ptr<span class="token punctuation">;</span> <span class="token comment">/* 该堆所属的Arena。 */</span>
  <span class="token keyword">struct</span> <span class="token class-name">_heap_info</span> <span class="token operator">*</span>prev<span class="token punctuation">;</span> <span class="token comment">/* 前一个堆。 */</span>
  <span class="token class-name">size_t</span> size<span class="token punctuation">;</span>   <span class="token comment">/* 当前大小（以字节为单位）。 */</span>
  <span class="token class-name">size_t</span> mprotect_size<span class="token punctuation">;</span> <span class="token comment">/* 已通过mprotect设置为PROT_READ|PROT_WRITE的内存大小（以字节为单位）。 */</span>
  <span class="token comment">/* 确保以下数据正确对齐，特别是sizeof(heap_info) + 2 * SIZE_SZ是MALLOC_ALIGNMENT的倍数。 */</span>
  <span class="token keyword">char</span> pad<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span> <span class="token operator">*</span> SIZE_SZ <span class="token operator">&amp;</span> MALLOC_ALIGN_MASK<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> heap_info<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该结构主要是描述堆的基本信息，包括</p>
<ul>
<li><strong>堆对应的 arena 的地址</strong></li>
<li>由于一个线程申请一个堆之后，可能会使用完，之后就必须得再次申请。因此，一个线程可能会有多个堆。prev 即记录了上一个 heap_info 的地址。这里可以看到每个堆的 heap_info 是<strong>通过单向链表进行链接的。</strong></li>
<li><strong>size 表示当前堆的大小</strong></li>
<li>最后一部分<strong>确保对齐</strong></li>
</ul>
<p><strong>pad 里负数的缘由是什么呢？</strong></p>
<p><code>pad</code> 是为了确保分配的空间是按照 <code>MALLOC_ALIGN_MASK+1</code> (记为 <code>MALLOC_ALIGN_MASK_1</code>) 对齐的。在 <code>pad</code> 之前该结构体一共有 6 个 <code>SIZE_SZ</code> 大小的成员, 为了确保 <code>MALLOC_ALIGN_MASK_1</code> 字节对齐, 可能需要进行 <code>pad</code>，不妨假设该结构体的最终大小为 <code>MALLOC_ALIGN_MASK_1*x</code>，其中 <code>x</code> 为自然数，那么需要 <code>pad</code> 的空间为 <code>MALLOC_ALIGN_MASK_1 * x - 6 * SIZE_SZ = (MALLOC_ALIGN_MASK_1 * x - 6 * SIZE_SZ) % MALLOC_ALIGN_MASK_1 = 0 - 6 * SIZE_SZ % MALLOC_ALIGN_MASK_1=-6 * SIZE_SZ % MALLOC_ALIGN_MASK_1 = -6 * SIZE_SZ &amp; MALLOC_ALIGN_MASK</code>。</p>
<p>看起来该结构应该是相当重要的，但是如果如果我们仔细看完整个 malloc 的实现的话，就会发现它出<strong>现的频率并不高。</strong></p>
<h5 id="malloc-state"><a href="#malloc-state" class="headerlink" title="malloc_state"></a>malloc_state</h5><p><strong>该结构用于管理堆</strong>，<strong>记录每个 arena 当前申请的内存的具体状态</strong>，比如说是否有空闲 chunk，有什么大小的空闲 chunk 等等。<strong>无论是 thread arena 还是 main arena，它们都只有一个 malloc state 结构</strong>。由于 thread 的 arena 可能有多个，malloc state 结构会在最新申请的 arena 中。</p>
<p><strong>注意，main arena 的 malloc_state 并不是 heap segment 的一部分，而是一个全局变量，存储在 libc.so 的数据段。</strong></p>
<p>其结构如下</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">malloc_state</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">/* Serialize access.  */</span>
  <span class="token comment">/* 序列化访问 */</span>
  <span class="token function">__libc_lock_define</span> <span class="token punctuation">(</span><span class="token punctuation">,</span> mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Flags (formerly in max_fast).  */</span>
  <span class="token comment">/* 标志位（以前在 max_fast 中） */</span>
  <span class="token keyword">int</span> flags<span class="token punctuation">;</span>

  <span class="token comment">/* Set if the fastbin chunks contain recently inserted free blocks.  */</span>
  <span class="token comment">/* Note this is a bool but not all targets support atomics on booleans.  */</span>
  <span class="token comment">/* 如果 fastbin 块包含最近插入的空闲块，则设置为 1 */</span>
  <span class="token comment">/* 注意，这是一个布尔值，但并非所有目标平台都支持对布尔值的原子操作 */</span>
  <span class="token keyword">int</span> have_fastchunks<span class="token punctuation">;</span>

  <span class="token comment">/* Fastbins */</span>
  mfastbinptr fastbinsY<span class="token punctuation">[</span>NFASTBINS<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">/* Base of the topmost chunk -- not otherwise kept in a bin */</span>
  <span class="token comment">/* 最顶层块的基址 -- 不在任何 bin 中 */</span>
  mchunkptr top<span class="token punctuation">;</span>

  <span class="token comment">/* The remainder from the most recent split of a small request */</span>
  <span class="token comment">/* 最近一次拆分小型请求产生的剩余块 */</span>
  mchunkptr last_remainder<span class="token punctuation">;</span>

  <span class="token comment">/* Normal bins packed as described above */</span>
  <span class="token comment">/* 正常 bins，按照上述描述进行打包 */</span>
  mchunkptr bins<span class="token punctuation">[</span>NBINS <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">/* Bitmap of bins */</span>
  <span class="token comment">/* bins 的位图 */</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> binmap<span class="token punctuation">[</span>BINMAPSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">/* Linked list */</span>
  <span class="token comment">/* 链表 */</span>
  <span class="token keyword">struct</span> <span class="token class-name">malloc_state</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>

  <span class="token comment">/* Linked list for free arenas.  Access to this field is serialized
     by free_list_lock in arena.c.  */</span>
  <span class="token comment">/* 用于空闲 arenas 的链表。访问该字段由 arena.c 中的 free_list_lock 进行序列化 */</span>
  <span class="token keyword">struct</span> <span class="token class-name">malloc_state</span> <span class="token operator">*</span>next_free<span class="token punctuation">;</span>

  <span class="token comment">/* 
     Number of threads attached to this arena.  0 if the arena is on
     the free list.  Access to this field is serialized by
     free_list_lock in arena.c.  
  */</span>
   <span class="token comment">/* 附加到该 arena 的线程数。如果该 arena 在空闲列表中，则为 0。访问该字段由 arena.c 中的              free_list_lock 进行序列化 */</span>
  INTERNAL_SIZE_T attached_threads<span class="token punctuation">;</span>

  <span class="token comment">/* Memory allocated from the system in this arena.  */</span>
  <span class="token comment">/* 在该 arena 中从系统分配的内存 */</span>
  INTERNAL_SIZE_T system_mem<span class="token punctuation">;</span>
  INTERNAL_SIZE_T max_system_mem<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><strong>_libc_lock_define(, mutex);</strong><ul>
<li>该变量<strong>用于控制程序串行访问同一个分配区</strong>，当一个线程获取了分配区之后，其它线程要想访问该分配区，就必须等待该线程分配完成后才能够使用。</li>
</ul>
</li>
<li><strong>flags</strong><ul>
<li>flags 记录了分配区的一些标志，比如 bit0 记录了分配区是否有 fast bin chunk ，bit1 标识分配区是否能返回连续的虚拟地址空间。具体如下</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
   FASTCHUNKS_BIT held in max_fast indicates that there are probably
   some fastbin chunks. It is set true on entering a chunk into any
   fastbin, and cleared only in malloc_consolidate.
   The truth value is inverted so that have_fastchunks will be true
   upon startup (since statics are zero-filled), simplifying
   initialization checks.
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FASTCHUNKS_BIT</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1U</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">have_fastchunks</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token operator">-></span>flags <span class="token operator">&amp;</span> FASTCHUNKS_BIT<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">clear_fastchunks</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token function">catomic_or</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token operator">-></span>flags<span class="token punctuation">,</span> FASTCHUNKS_BIT<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">set_fastchunks</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token function">catomic_and</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token operator">-></span>flags<span class="token punctuation">,</span> <span class="token operator">~</span>FASTCHUNKS_BIT<span class="token punctuation">)</span></span></span>

<span class="token comment">/*
   NONCONTIGUOUS_BIT indicates that MORECORE does not return contiguous
   regions.  Otherwise, contiguity is exploited in merging together,
   when possible, results from consecutive MORECORE calls.
   The initial value comes from MORECORE_CONTIGUOUS, but is
   changed dynamically if mmap is ever used as an sbrk substitute.
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NONCONTIGUOUS_BIT</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">2U</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">contiguous</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token operator">-></span>flags <span class="token operator">&amp;</span> NONCONTIGUOUS_BIT<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">noncontiguous</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token operator">-></span>flags <span class="token operator">&amp;</span> NONCONTIGUOUS_BIT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">set_noncontiguous</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token operator">-></span>flags <span class="token operator">|=</span> NONCONTIGUOUS_BIT<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">set_contiguous</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token operator">-></span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>NONCONTIGUOUS_BIT<span class="token punctuation">)</span></span></span>

<span class="token comment">/* ARENA_CORRUPTION_BIT is set if a memory corruption was detected on the
   arena.  Such an arena is no longer used to allocate chunks.  Chunks
   allocated in that arena before detecting corruption are not freed.  */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ARENA_CORRUPTION_BIT</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">4U</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">arena_is_corrupt</span><span class="token expression"><span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>A<span class="token punctuation">)</span><span class="token operator">-></span>flags <span class="token operator">&amp;</span> ARENA_CORRUPTION_BIT<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">set_arena_corrupt</span><span class="token expression"><span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>A<span class="token punctuation">)</span><span class="token operator">-></span>flags <span class="token operator">|=</span> ARENA_CORRUPTION_BIT<span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
   FASTCHUNKS_BIT在max_fast中表示可能存在一些fastbin块。
   它在将块放入任何fastbin时设置为true，并且仅在malloc_consolidate中清除。
   真值取反，以便在启动时have_fastchunks为true（因为静态变量被零填充），
   简化了初始化检查。
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FASTCHUNKS_BIT</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1U</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">have_fastchunks</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token operator">-></span>flags <span class="token operator">&amp;</span> FASTCHUNKS_BIT<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">clear_fastchunks</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token function">catomic_or</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token operator">-></span>flags<span class="token punctuation">,</span> FASTCHUNKS_BIT<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">set_fastchunks</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token function">catomic_and</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token operator">-></span>flags<span class="token punctuation">,</span> <span class="token operator">~</span>FASTCHUNKS_BIT<span class="token punctuation">)</span></span></span>

<span class="token comment">/*
   NONCONTIGUOUS_BIT指示MORECORE不返回连续的内存区域。
   否则，在可能的情况下，利用连续性合并连续MORECORE调用的结果。
   初始值来自MORECORE_CONTIGUOUS，但如果mmap被用作sbrk替代品，则会动态更改。
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NONCONTIGUOUS_BIT</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">2U</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">contiguous</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token operator">-></span>flags <span class="token operator">&amp;</span> NONCONTIGUOUS_BIT<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">noncontiguous</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token operator">-></span>flags <span class="token operator">&amp;</span> NONCONTIGUOUS_BIT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">set_noncontiguous</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token operator">-></span>flags <span class="token operator">|=</span> NONCONTIGUOUS_BIT<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">set_contiguous</span><span class="token expression"><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token operator">-></span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>NONCONTIGUOUS_BIT<span class="token punctuation">)</span></span></span>

<span class="token comment">/* ARENA_CORRUPTION_BIT如果在arena上检测到内存损坏，则设置。
   这样的arena不再用于分配块。在检测到损坏之前在该arena中分配的块不会被释放。 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ARENA_CORRUPTION_BIT</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">4U</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">arena_is_corrupt</span><span class="token expression"><span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>A<span class="token punctuation">)</span><span class="token operator">-></span>flags <span class="token operator">&amp;</span> ARENA_CORRUPTION_BIT<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">set_arena_corrupt</span><span class="token expression"><span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>A<span class="token punctuation">)</span><span class="token operator">-></span>flags <span class="token operator">|=</span> ARENA_CORRUPTION_BIT<span class="token punctuation">)</span></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><strong>fastbinsY[NFASTBINS]</strong><ul>
<li><strong>存放每个 fast chunk 链表头部的指针</strong></li>
</ul>
</li>
<li><strong>top</strong><ul>
<li><strong>指向分配区的 top chunk</strong></li>
</ul>
</li>
<li><strong>last_reminder</strong><ul>
<li><strong>最新的 chunk 分割之后剩下的那部分</strong></li>
</ul>
</li>
<li><strong>bins</strong><ul>
<li><strong>用于存储 unstored bin，small bins 和 large bins 的 chunk 链表。</strong></li>
</ul>
</li>
<li><strong>binmap</strong><ul>
<li><strong>ptmalloc 用一个 bit 来标识某一个 bin 中是否包含空闲 chunk 。</strong></li>
</ul>
</li>
</ul>
<h5 id="malloc-par"><a href="#malloc-par" class="headerlink" title="malloc_par"></a>malloc_par</h5><p><strong>！！待补充！！</strong></p>
<h4 id="基础操作"><a href="#基础操作" class="headerlink" title="基础操作"></a>基础操作</h4><h5 id="unlink"><a href="#unlink" class="headerlink" title="unlink"></a>unlink</h5><p>unlink 用来<strong>将一个双向链表（只存储空闲的 chunk）中的一个元素取出来</strong>，可能在以下地方使用</p>
<ul>
<li><strong>malloc</strong><ul>
<li>从恰好大小合适的 large bin 中获取 chunk。<ul>
<li><strong>这里需要注意的是 fastbin 与 small bin 就没有使用 unlink，这就是为什么漏洞会经常出现在它们这里的原因。</strong></li>
<li><strong>依次遍历处理 unsorted bin 时也没有使用 unlink 。</strong></li>
</ul>
</li>
<li>从比请求的 chunk 所在的 bin 大的 bin 中取 chunk。</li>
</ul>
</li>
<li><strong>free</strong><ul>
<li>后向合并，合并物理相邻低地址空闲 chunk。</li>
<li>前向合并，合并物理相邻高地址空闲 chunk（除了 top chunk）。</li>
</ul>
</li>
<li><strong>malloc_consolidate</strong><ul>
<li>后向合并，合并物理相邻低地址空闲 chunk。</li>
<li>前向合并，合并物理相邻高地址空闲 chunk（除了 top chunk）。</li>
</ul>
</li>
<li><strong>realloc</strong><ul>
<li>前向扩展，合并物理相邻高地址空闲 chunk（除了 top chunk）。</li>
</ul>
</li>
</ul>
<p>由于 unlink 使用非常频繁，所以 unlink 被实现为了一个宏，如下</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Take a chunk off a bin list */</span>
<span class="token comment">// unlink p</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">unlink</span><span class="token expression"><span class="token punctuation">(</span>AV<span class="token punctuation">,</span> P<span class="token punctuation">,</span> BK<span class="token punctuation">,</span> FD<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                                            </span></span>
    <span class="token comment">// 由于 P 已经在双向链表中，所以有两个地方记录其大小，所以检查一下其大小是否一致。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">chunksize</span><span class="token punctuation">(</span>P<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">prev_size</span> <span class="token punctuation">(</span><span class="token function">next_chunk</span><span class="token punctuation">(</span>P<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      
      <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"corrupted size vs. prev_size"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               
    FD <span class="token operator">=</span> P<span class="token operator">-></span>fd<span class="token punctuation">;</span>                                                                      
    BK <span class="token operator">=</span> P<span class="token operator">-></span>bk<span class="token punctuation">;</span>                                                                      
    <span class="token comment">// 防止攻击者简单篡改空闲的 chunk 的 fd 与 bk 来实现任意写的效果。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>FD<span class="token operator">-></span>bk <span class="token operator">!=</span> P <span class="token operator">||</span> BK<span class="token operator">-></span>fd <span class="token operator">!=</span> P<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                      
      <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span>check_action<span class="token punctuation">,</span> <span class="token string">"corrupted double-linked list"</span><span class="token punctuation">,</span> P<span class="token punctuation">,</span> AV<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                                                                      
        FD<span class="token operator">-></span>bk <span class="token operator">=</span> BK<span class="token punctuation">;</span>                                                              
        BK<span class="token operator">-></span>fd <span class="token operator">=</span> FD<span class="token punctuation">;</span>                                                              
        <span class="token comment">// 下面主要考虑 P 对应的 nextsize 双向链表的修改</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span> <span class="token punctuation">(</span><span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>P<span class="token punctuation">)</span><span class="token punctuation">)</span>                              
            <span class="token comment">// 如果P->fd_nextsize为 NULL，表明 P 未插入到 nextsize 链表中。</span>
            <span class="token comment">// 那么其实也就没有必要对 nextsize 字段进行修改了。</span>
            <span class="token comment">// 这里没有去判断 bk_nextsize 字段，可能会出问题。</span>
            <span class="token operator">&amp;&amp;</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>P<span class="token operator">-></span>fd_nextsize <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                      
            <span class="token comment">// 类似于小的 chunk 的检查思路</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>P<span class="token operator">-></span>fd_nextsize<span class="token operator">-></span>bk_nextsize <span class="token operator">!=</span> P<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>              
                <span class="token operator">||</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>P<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">!=</span> P<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    
              <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span>check_action<span class="token punctuation">,</span>                                      
                               <span class="token string">"corrupted double-linked list (not small)"</span><span class="token punctuation">,</span>    
                               P<span class="token punctuation">,</span> AV<span class="token punctuation">)</span><span class="token punctuation">;</span>                                              
            <span class="token comment">// 这里说明 P 已经在 nextsize 链表中了。</span>
            <span class="token comment">// 如果 FD 没有在 nextsize 链表中</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>FD<span class="token operator">-></span>fd_nextsize <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                                      
                <span class="token comment">// 如果 nextsize 串起来的双链表只有 P 本身，那就直接拿走 P</span>
                <span class="token comment">// 令 FD 为 nextsize 串起来的</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>P<span class="token operator">-></span>fd_nextsize <span class="token operator">==</span> P<span class="token punctuation">)</span>                                      
                  FD<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> FD<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> FD<span class="token punctuation">;</span>                    
                <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                                                              
                <span class="token comment">// 否则我们需要将 FD 插入到 nextsize 形成的双链表中</span>
                    FD<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> P<span class="token operator">-></span>fd_nextsize<span class="token punctuation">;</span>                              
                    FD<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> P<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>                              
                    P<span class="token operator">-></span>fd_nextsize<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> FD<span class="token punctuation">;</span>                              
                    P<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> FD<span class="token punctuation">;</span>                              
                  <span class="token punctuation">&#125;</span>                                                              
              <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                                                              
                <span class="token comment">// 如果在的话，直接拿走即可</span>
                P<span class="token operator">-></span>fd_nextsize<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> P<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>                      
                P<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> P<span class="token operator">-></span>fd_nextsize<span class="token punctuation">;</span>                      
              <span class="token punctuation">&#125;</span>                                                                      
          <span class="token punctuation">&#125;</span>                                                                      
      <span class="token punctuation">&#125;</span>                                                                              
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里我们以 small bin 的 unlink 为例子介绍一下。对于 large bin 的 unlink，与其类似，只是多了一个 nextsize 的处理。</p>
<p><img src="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/implementation/figure/unlink_smallbin_intro.png" alt="img"></p>
<p>可以看出， <strong>P 最后的 fd 和 bk 指针并没有发生变化</strong>，但是当我们去遍历整个双向链表时，已经遍历不到对应的链表了。这一点没有变化还是很有用处的，因为我们有时候可以使用这个方法来泄漏地址</p>
<ul>
<li><strong>libc 地址</strong><ul>
<li>P 位于双向链表头部，bk 泄漏</li>
<li>P 位于双向链表尾部，fd 泄漏</li>
<li>双向链表只包含一个空闲 chunk 时，P 位于双向链表中，fd 和 bk 均可以泄漏</li>
</ul>
</li>
<li><strong>泄漏堆地址</strong>，双向链表包含多个空闲 chunk<ul>
<li>P 位于双向链表头部，fd 泄漏</li>
<li>P 位于双向链表中，fd 和 bk 均可以泄漏</li>
<li>P 位于双向链表尾部，bk 泄漏</li>
</ul>
</li>
</ul>
<p><strong>注意</strong></p>
<ul>
<li>这里的<strong>头部</strong>指的是 bin 的 fd 指向的 chunk，即双向链表中<strong>最新加入的 chunk</strong>。</li>
<li>这里的<strong>尾部</strong>指的是 bin 的 bk 指向的 chunk，即双向链表中<strong>最先加入的 chunk</strong>。</li>
</ul>
<p>同时，无论是对于 fd，bk 还是 fd_nextsize ，bk_nextsize，程序都会检测 fd 和 bk 是否满足对应的要求。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// fd bk</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>FD<span class="token operator">-></span>bk <span class="token operator">!=</span> P <span class="token operator">||</span> BK<span class="token operator">-></span>fd <span class="token operator">!=</span> P<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                      
  <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span>check_action<span class="token punctuation">,</span> <span class="token string">"corrupted double-linked list"</span><span class="token punctuation">,</span> P<span class="token punctuation">,</span> AV<span class="token punctuation">)</span><span class="token punctuation">;</span>  

  <span class="token comment">// next_size related</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>P<span class="token operator">-></span>fd_nextsize<span class="token operator">-></span>bk_nextsize <span class="token operator">!=</span> P<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>              
                <span class="token operator">||</span> <span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>P<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">!=</span> P<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    
              <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span>check_action<span class="token punctuation">,</span><span class="token string">"corrupted double-linked list (not small)"</span><span class="token punctuation">,</span> P<span class="token punctuation">,</span> AV<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>看起来似乎很正常。我们以 fd 和 bk 为例，P 的 forward chunk 的 bk 很自然是 P ，同样 P 的 backward chunk 的 fd 也很自然是 P 。如果没有做相应的检查的话，我们可以修改 P 的 fd 与 bk，从而可以很容易地达到任意地址写的效果。关于更加详细的例子，可以参见利用部分的 unlink 。</p>
<p><strong>注意：堆的第一个 chunk 所记录的 prev_inuse 位默认为 1。</strong></p>
<h5 id="malloc-printerr"><a href="#malloc-printerr" class="headerlink" title="malloc_printerr"></a>malloc_printerr</h5><p>在 glibc malloc 时检测到错误的时候，会调用 <code>malloc_printerr</code> 函数。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">malloc_printerr</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>str<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">__libc_message</span><span class="token punctuation">(</span>do_abort<span class="token punctuation">,</span> <span class="token string">"%s\n"</span><span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__builtin_unreachable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>主要会<strong>调用 <code>__libc_message</code> 来执行<code>abort</code> 函数</strong>，如下</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>action <span class="token operator">&amp;</span> do_abort<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>action <span class="token operator">&amp;</span> do_backtrace<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">BEFORE_ABORT</span><span class="token punctuation">(</span>do_abort<span class="token punctuation">,</span> written<span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Kill the application.  */</span>
  <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>在<code>abort</code> 函数里，在 glibc 还是 2.23 版本时，会 fflush stream</strong>。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Flush all streams.  We cannot close them now because the user
   might have registered a handler for SIGABRT.  */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>stage <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token operator">++</span>stage<span class="token punctuation">;</span>
    <span class="token function">fflush</span> <span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="堆初始化"><a href="#堆初始化" class="headerlink" title="堆初始化"></a>堆初始化</h5><p>堆初始化是在<strong>用户第一次申请内存时执行 malloc_consolidate 再执行 malloc_init_state 实现的</strong>。这里不做过多讲解。可以参见 <code>malloc_state</code> 相关函数。</p>
<h4 id="申请内存块"><a href="#申请内存块" class="headerlink" title="申请内存块"></a>申请内存块</h4><h5 id="libc-malloc"><a href="#libc-malloc" class="headerlink" title="__libc_malloc"></a>__libc_malloc</h5><p>一般我们会使用 malloc 函数来申请内存块，可是当仔细看 glibc 的源码实现时，其实并没有 malloc 函数。其实该函数真正调用的是 __libc_malloc 函数。为什么不直接写个 malloc 函数呢，因为有时候我们可能需要不同的名称。此外，__libc_malloc 函数只是用来简单封装 _int_malloc 函数。_int_malloc 才是申请内存块的核心。下面我们来仔细分析一下具体的实现。</p>
<p>该函数会<strong>首先检查是否有内存分配函数的钩子函数（__malloc_hook）</strong>，这个主要用于用户自定义的堆分配函数，方便用户快速修改堆分配函数并进行测试。这里需要注意的是，<strong>用户申请的字节一旦进入申请内存函数中就变成了无符号整数</strong>。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// wapper for int_malloc</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">__libc_malloc</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> bytes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    mstate ar_ptr<span class="token punctuation">;</span>     <span class="token comment">//表示堆管理器的状态</span>
    <span class="token keyword">void</span> <span class="token operator">*</span> victim<span class="token punctuation">;</span>    <span class="token comment">//表示分配的内存块的指针</span>
    <span class="token comment">// 检查是否有内存分配钩子，如果有，调用钩子并返回.</span>
    <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>hook<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">atomic_forced_read</span><span class="token punctuation">(</span>__malloc_hook<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span><span class="token punctuation">(</span>hook <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">*</span>hook<span class="token punctuation">)</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> <span class="token function">RETURN_ADDRESS</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token comment">//钩子函数接受两个参数：分配的字节数和返回地址。这里使用RETURN_ADDRESS(0)获取当前函数的返回地址作为参数传递给钩子函数</span>
    <span class="token comment">//如果不存在内存分配钩子，则继续执行后续的内存分配操作</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>接着会寻找一个 arena 来试图分配内存。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">arena_get</span><span class="token punctuation">(</span>ar_ptr<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后调用 _int_malloc 函数去申请对应的内存。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">victim <span class="token operator">=</span> <span class="token function">_int_malloc</span><span class="token punctuation">(</span>ar_ptr<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果分配失败的话，ptmalloc 会尝试再去寻找一个可用的 arena，并分配内存。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Retry with another arena only if we were able to find a usable arena before.  */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>victim <span class="token operator">&amp;&amp;</span> ar_ptr <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">LIBC_PROBE</span><span class="token punctuation">(</span>memory_malloc_retry<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ar_ptr <span class="token operator">=</span> <span class="token function">arena_get_retry</span><span class="token punctuation">(</span>ar_ptr<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//用于在给定的堆管理器中查找另一个可用的堆管理器的函数</span>
    victim <span class="token operator">=</span> <span class="token function">_int_malloc</span><span class="token punctuation">(</span>ar_ptr<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果申请到了 arena，那么在退出之前还得<strong>解锁</strong>。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>ar_ptr <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token function">__libc_lock_unlock</span><span class="token punctuation">(</span>ar_ptr<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>判断目前的状态是否满足以下条件</p>
<ul>
<li>要么没有申请到内存</li>
<li>要么是 mmap 的内存</li>
<li><strong>要么申请到的内存必须在其所分配的 arena 中</strong></li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>victim <span class="token operator">||</span> <span class="token function">chunk_is_mmapped</span><span class="token punctuation">(</span><span class="token function">mem2chunk</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>ar_ptr <span class="token operator">==</span> <span class="token function">arena_for_chunk</span><span class="token punctuation">(</span><span class="token function">mem2chunk</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//断言语句，假则中断程序，确保在特定情况下，victim指针的状态与堆管理器的状态相符合</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>最后返回内存。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">    <span class="token keyword">return</span> victim<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h5 id="int-malloc"><a href="#int-malloc" class="headerlink" title="_int_malloc"></a>_int_malloc</h5><p>_int_malloc 是内存分配的核心函数，其核心思路有如下</p>
<ol>
<li>它根据用户申请的<strong>内存块大小</strong>以及<strong>相应大小 chunk 通常使用的频度</strong>（fastbin chunk, small chunk, large chunk），依次实现了不同的分配方法。</li>
<li>它由小到大依次检查不同的 bin 中是否有相应的空闲块可以满足用户请求的内存。</li>
<li>当所有的空闲 chunk 都无法满足时，它会考虑 top chunk。</li>
<li>当 top chunk 也无法满足时，堆分配器才会进行内存块申请。</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">在进入该函数后，函数立马定义了一系列自己需要的变量，并将用户申请的内存大小转换为内部的 chunk 大小。


<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">_int_malloc</span><span class="token punctuation">(</span>mstate av<span class="token punctuation">,</span> <span class="token class-name">size_t</span> bytes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    INTERNAL_SIZE_T nb<span class="token punctuation">;</span>  <span class="token comment">/* normalized request size */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span>    idx<span class="token punctuation">;</span> <span class="token comment">/* associated bin index */</span>
    mbinptr         bin<span class="token punctuation">;</span> <span class="token comment">/* associated bin */</span>

    mchunkptr       victim<span class="token punctuation">;</span>       <span class="token comment">/* inspected/selected chunk */</span>
    INTERNAL_SIZE_T size<span class="token punctuation">;</span>         <span class="token comment">/* its size */</span>
    <span class="token keyword">int</span>             victim_index<span class="token punctuation">;</span> <span class="token comment">/* its bin index */</span>

    mchunkptr     remainder<span class="token punctuation">;</span>      <span class="token comment">/* remainder from a split */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> remainder_size<span class="token punctuation">;</span> <span class="token comment">/* its size */</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> block<span class="token punctuation">;</span> <span class="token comment">/* bit map traverser */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> bit<span class="token punctuation">;</span>   <span class="token comment">/* bit map traverser */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> map<span class="token punctuation">;</span>   <span class="token comment">/* current word of binmap */</span>

    mchunkptr fwd<span class="token punctuation">;</span> <span class="token comment">/* misc temp for linking */</span>
    mchunkptr bck<span class="token punctuation">;</span> <span class="token comment">/* misc temp for linking */</span>

    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>errstr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token comment">/*
       Convert request size to internal form by adding SIZE_SZ bytes
       overhead plus possibly more to obtain necessary alignment and/or
       to obtain a size of at least MINSIZE, the smallest allocatable
       size. Also, checked_request2size traps (returning 0) request sizes
       that are so large that they wrap around zero when padded and
       aligned.
     */</span>

    <span class="token function">checked_request2size</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">_int_malloc</span><span class="token punctuation">(</span>mstate av<span class="token punctuation">,</span> <span class="token class-name">size_t</span> bytes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    INTERNAL_SIZE_T nb<span class="token punctuation">;</span>  <span class="token comment">/* 规范化后的请求大小 */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> idx<span class="token punctuation">;</span>   <span class="token comment">/* 相关联的bin索引 */</span>
    mbinptr bin<span class="token punctuation">;</span>        <span class="token comment">/* 相关联的bin */</span>

    mchunkptr victim<span class="token punctuation">;</span>       <span class="token comment">/* 被检查/选择的chunk */</span>
    INTERNAL_SIZE_T size<span class="token punctuation">;</span>   <span class="token comment">/* chunk的大小 */</span>
    <span class="token keyword">int</span> victim_index<span class="token punctuation">;</span>       <span class="token comment">/* chunk的bin索引 */</span>

    mchunkptr remainder<span class="token punctuation">;</span>      <span class="token comment">/* 分割后的剩余部分 */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> remainder_size<span class="token punctuation">;</span> <span class="token comment">/* 剩余部分的大小 */</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> block<span class="token punctuation">;</span> <span class="token comment">/* 位图遍历器 */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> bit<span class="token punctuation">;</span>   <span class="token comment">/* 位图遍历器 */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> map<span class="token punctuation">;</span>   <span class="token comment">/* 当前binmap的字 */</span>

    mchunkptr fwd<span class="token punctuation">;</span> <span class="token comment">/* 用于链接的临时变量 */</span>
    mchunkptr bck<span class="token punctuation">;</span> <span class="token comment">/* 用于链接的临时变量 */</span>

    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>errstr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token comment">/*
       通过添加SIZE_SZ字节的开销，将请求大小转换为内部形式，
       可能还需要更多的字节以获得必要的对齐和/或至少为MINSIZE的大小，
       MINSIZE是最小可分配大小。此外，checked_request2size函数
       会检查并阻止（返回0）请求大小太大，以至于在填充和对齐时
       四舍五入为零。
     */</span>

    <span class="token function">checked_request2size</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 其他代码...</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="arena-1"><a href="#arena-1" class="headerlink" title="arena"></a>arena</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* There are no usable arenas.  Fall back to sysmalloc to get a chunk from mmap.  */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span><span class="token punctuation">(</span>av <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">sysmalloc</span><span class="token punctuation">(</span>nb<span class="token punctuation">,</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token function">alloc_perturb</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> p<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="fast-bin"><a href="#fast-bin" class="headerlink" title="fast bin"></a>fast bin</h5><p>如果申请的 chunk 的大小位于 fastbin 范围内，<strong>需要注意的是这里比较的是无符号整数</strong>。<strong>此外，是从 fastbin 的头结点开始取 chunk</strong>。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">    <span class="token comment">/*
       If the size qualifies as a fastbin, first check corresponding bin.
       This code is safe to execute even if av is not yet initialized, so we
       can try it without checking, which saves some time on this fast path.
     */</span>
<span class="token comment">/*
   如果大小符合快速分配块的条件，首先检查相应的bin。
   即使av(内存管理状态结构体)尚未初始化，这段代码也可以安全执行，因此我们可以在不检查的情况下尝试执行它，
   这在这个快速路径上节省了一些时间。
*/</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">get_max_fast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 得到对应的fastbin的下标</span>
        idx             <span class="token operator">=</span> <span class="token function">fastbin_index</span><span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 得到对应的fastbin的头指针</span>
        mfastbinptr <span class="token operator">*</span>fb <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">fastbin</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mchunkptr    pp <span class="token operator">=</span> <span class="token operator">*</span>fb<span class="token punctuation">;</span>
        <span class="token comment">// 利用fd遍历对应的bin内是否有空闲的chunk块，</span>
        <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
            victim <span class="token operator">=</span> pp<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>victim <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pp <span class="token operator">=</span> <span class="token function">catomic_compare_and_exchange_val_acq</span><span class="token punctuation">(</span>fb<span class="token punctuation">,</span> victim<span class="token operator">-></span>fd<span class="token punctuation">,</span>victim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 存在可以利用的chunk</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>victim <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 检查取到的 chunk 大小是否与相应的 fastbin 索引一致。</span>
            <span class="token comment">// 根据取得的 victim ，利用 chunksize 计算其大小。</span>
            <span class="token comment">// 利用fastbin_index 计算 chunk 的索引。</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span><span class="token punctuation">(</span><span class="token function">fastbin_index</span><span class="token punctuation">(</span><span class="token function">chunksize</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> idx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                errstr <span class="token operator">=</span> <span class="token string">"malloc(): memory corruption (fast)"</span><span class="token punctuation">;</span>
            errout<span class="token operator">:</span>
                <span class="token function">malloc_printerr</span><span class="token punctuation">(</span>check_action<span class="token punctuation">,</span> errstr<span class="token punctuation">,</span> <span class="token function">chunk2mem</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">,</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">// 细致的检查。。只有在 DEBUG 的时候有用</span>
            <span class="token function">check_remalloced_chunk</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 将获取的到chunk转换为mem模式</span>
            <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将内存块的起始地址转换为指向实际可用内存的指针</span>
            <span class="token comment">// 如果设置了perturb_type, 则将获取到的chunk初始化为 perturb_type ^ 0xff</span>
            <span class="token function">alloc_perturb</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//对内存块进行初始化</span>
            <span class="token keyword">return</span> p<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="small-bin"><a href="#small-bin" class="headerlink" title="small bin"></a>small bin</h5><p>如果获取的内存块的范围处于 small bin 的范围，那么执行如下流程</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">    <span class="token comment">/*
       If a small request, check regular bin.  Since these "smallbins" hold one size each, no searching within bins is necessary.
       (For a large request, we need to wait until unsorted chunks are
       processed to find best fit. But for small ones, fits are exact
       anyway, so we can check now, which is faster.)
     */</span>
<span class="token comment">/*
   如果是小的内存请求，检查常规的空闲块链表。由于这些"smallbins"只包含一种大小的内存块，所以不需要在链表中进行搜索。
   （对于大的内存请求，我们需要等待未排序的内存块被处理以找到最佳匹配。但对于小的请求，匹配是精确的，所以我们可以立即检查，这样更快。）
*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_smallbin_range</span><span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 获取 small bin 的索引</span>
        idx <span class="token operator">=</span> <span class="token function">smallbin_index</span><span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取对应 small bin 中的 chunk 指针</span>
        bin <span class="token operator">=</span> <span class="token function">bin_at</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 先执行 victim = last(bin)，获取 small bin 的最后一个 chunk</span>
        <span class="token comment">// 如果 victim = bin ，那说明该 bin 为空。//自循环</span>
        <span class="token comment">// 如果不相等，那么会有两种情况</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>victim <span class="token operator">=</span> <span class="token function">last</span><span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> bin<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 第一种情况，small bin 还没有初始化。</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>victim <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">/* initialization check */</span>
                <span class="token comment">// 执行初始化，将 fast bins 中的 chunk 进行合并</span>
                <span class="token function">malloc_consolidate</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 第二种情况，small bin 中存在空闲的 chunk</span>
            <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 获取 small bin 中倒数第二个 chunk 。</span>
                bck <span class="token operator">=</span> victim<span class="token operator">-></span>bk<span class="token punctuation">;</span>
                <span class="token comment">// 检查 bck->fd 是不是 victim，防止伪造</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span><span class="token punctuation">(</span>bck<span class="token operator">-></span>fd <span class="token operator">!=</span> victim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    errstr <span class="token operator">=</span> <span class="token string">"malloc(): smallbin double linked list corrupted"</span><span class="token punctuation">;</span>
                    <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token comment">// 设置 victim 对应的 inuse 位</span>
                <span class="token function">set_inuse_bit_at_offset</span><span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 修改 small bin 链表，将 small bin 的最后一个 chunk 取出来</span>
                bin<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
                bck<span class="token operator">-></span>fd <span class="token operator">=</span> bin<span class="token punctuation">;</span>
                <span class="token comment">// 如果不是 main_arena，设置对应的标志</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span> <span class="token function">set_non_main_arena</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 细致的检查，非调试状态没有作用</span>
                <span class="token function">check_malloced_chunk</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 将申请到的 chunk 转化为对应的 mem 状态</span>
                <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 如果设置了 perturb_type , 则将获取到的chunk初始化为 perturb_type ^ 0xff</span>
                <span class="token function">alloc_perturb</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> p<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="large-bin"><a href="#large-bin" class="headerlink" title="large bin"></a>large bin</h5><p>当 fast bin、small bin 中的 chunk 都不能满足用户请求 chunk 大小时，就会考虑是不是 large bin。但是，其实在 large bin 中并没有直接去扫描对应 bin 中的 chunk，而是先利用 malloc_consolidate（参见 malloc_state 相关函数） 函数处理 fast bin 中的 chunk，将有可能能够合并的 chunk 先进行合并后放到 unsorted bin 中，不能够合并的就直接放到 unsorted bin 中，然后再在下面的大循环中进行相应的处理。<strong>为什么不直接从相应的 bin 中取出 large chunk 呢？这是 ptmalloc 的机制，它会在分配 large chunk 之前对堆中碎片 chunk 进行合并，以便减少堆中的碎片。</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">    <span class="token comment">/*
       If this is a large request, consolidate fastbins before continuing.
       While it might look excessive to kill all fastbins before
       even seeing if there is space available, this avoids
       fragmentation problems normally associated with fastbins.
       Also, in practice, programs tend to have runs of either small or
       large requests, but less often mixtures, so consolidation is not
       invoked all that often in most programs. And the programs that
       it is called frequently in otherwise tend to fragment.
     */</span>
<span class="token comment">/*
   如果这是一个大的内存请求，在继续之前先合并 fastbins。
   尽管在查看是否有可用空间之前杀死所有 fastbins 看起来可能有些过度，
   但这样可以避免通常与 fastbins 相关的碎片化问题。
   此外，在实践中，程序往往会有连续的小内存请求或大内存请求的运行，
   但很少有混合请求，因此在大多数程序中不经常调用合并操作。
   而对于频繁调用合并操作的程序，通常会发生碎片化问题。
*/</span>
    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 获取large bin的下标。</span>
        idx <span class="token operator">=</span> <span class="token function">largebin_index</span><span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果存在fastbin的话，会处理 fastbin</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">have_fastchunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">malloc_consolidate</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>bk是前驱节点，fd是后继节点，别记错了咩</strong></p>
<h5 id="大循环-遍历-unsorted-bin"><a href="#大循环-遍历-unsorted-bin" class="headerlink" title="大循环 - 遍历 unsorted bin"></a>大循环 - 遍历 unsorted bin</h5><p><strong>如果程序执行到了这里，那么说明 与 chunk 大小正好一致的 bin (fast bin， small bin) 中没有 chunk 可以直接满足需求 ，但是 large chunk 则是在这个大循环中处理</strong>。</p>
<p>在接下来的这个循环中，主要做了以下的操作</p>
<ul>
<li>按照 FIFO 的方式逐个将 unsorted bin 中的 chunk 取出来<ul>
<li>如果是 small request，则考虑是不是恰好满足，是的话，直接返回。</li>
<li>如果不是的话，放到对应的 bin 中。</li>
</ul>
</li>
<li>尝试从 large bin 中分配用户所需的内存</li>
</ul>
<p>该部分是一个大循环，这是<strong>为了尝试重新分配 small bin chunk</strong>，这是因为我们虽然会首先使用 large bin，top chunk 来尝试满足用户的请求，但是如果没有满足的话，由于我们在上面没有分配成功 small bin，我们并没有对 fast bin 中的 chunk 进行合并，所以<strong>这里会进行 fast bin chunk 的合并</strong>，进而<strong>使用一个大循环来尝试再次分配 small bin chunk</strong>。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">    <span class="token comment">/*
       Process recently freed or remaindered chunks, taking one only if
       it is exact fit, or, if this a small request, the chunk is remainder from
       the most recent non-exact fit.  Place other traversed chunks in
       bins.  Note that this step is the only place in any routine where
       chunks are placed in bins.

       The outer loop here is needed because we might not realize until
       near the end of malloc that we should have consolidated, so must
       do so and retry. This happens at most once, and only when we would
       otherwise need to expand memory to service a "small" request.
     */</span>
<span class="token comment">/*
   处理最近释放或剩余的内存块，只有在精确匹配时才取一个块，或者如果这是一个小的请求，并且该块是最近一个非精确匹配的剩余块。将其他经过遍历的块放入 bins 中。请注意，这一步是任何例程中唯一将块放入 bins 中的地方。

   外部循环在这里是必需的，因为直到接近 malloc 的末尾，我们可能才意识到应该进行合并，所以必须这样做并重试。这最多发生一次，仅当我们否则需要扩展内存来处理一个 "小" 请求时。
*/</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> iters <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="unsorted-bin-遍历"><a href="#unsorted-bin-遍历" class="headerlink" title="unsorted bin 遍历"></a>unsorted bin 遍历</h5><p><strong>先考虑 unsorted bin</strong>，<strong>再考虑 last remainder</strong>(是最近一次非精确匹配的剩余块) ，但是对于 small bin chunk 的请求会有所例外。</p>
<p><strong>注意 unsorted bin 的遍历顺序为 bk。</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 如果 unsorted bin 不为空</span>
<span class="token comment">// First In First Out</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>victim <span class="token operator">=</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-></span>bk<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// victim 为 unsorted bin 的最后一个 chunk</span>
    <span class="token comment">// bck 为 unsorted bin 的倒数第二个 chunk</span>
    bck <span class="token operator">=</span> victim<span class="token operator">-></span>bk<span class="token punctuation">;</span>
    <span class="token comment">// 判断得到的 chunk 是否满足要求，不能过小，也不能过大</span>
    <span class="token comment">// 一般 system_mem 的大小为132K</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span><span class="token punctuation">(</span><span class="token function">chunksize_nomask</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token function">__builtin_expect</span><span class="token punctuation">(</span><span class="token function">chunksize_nomask</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span> <span class="token operator">></span> av<span class="token operator">-></span>system_mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">malloc_printerr</span><span class="token punctuation">(</span>check_action<span class="token punctuation">,</span> <span class="token string">"malloc(): memory corruption"</span><span class="token punctuation">,</span>
                        <span class="token function">chunk2mem</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">,</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 得到victim对应的chunk大小。</span>
    size <span class="token operator">=</span> <span class="token function">chunksize</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="SMALL-REQUEST"><a href="#SMALL-REQUEST" class="headerlink" title="SMALL REQUEST"></a>SMALL REQUEST</h5><p>如果用户的请求为 small bin chunk，那么我们首先考虑 last remainder，如果 last remainder 是 unsorted bin 中的唯一一块的话， 并且 last remainder 的大小分割后还可以作为一个 chunk ，<strong>为什么没有等号</strong>？</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">        <span class="token comment">/*
           If a small request, try to use last remainder if it is the
           only chunk in unsorted bin.  This helps promote locality for
           runs of consecutive small requests. This is the only
           exception to best-fit, and applies only when there is
           no exact fit for a small chunk.
         */</span>
<span class="token comment">/*
	如果是一个小的内存请求，如果未排序的 bin 中只有一个块，并且它是上一个剩余块，尝试使用它。
	这有助于提高连续小内存请求的局部性。这是对最佳适配算法的唯一例外，仅适用于没有完全匹配的小块。
*/</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_smallbin_range</span><span class="token punctuation">(</span>nb<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> bck <span class="token operator">==</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>victim <span class="token operator">==</span> av<span class="token operator">-></span>last_remainder <span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb <span class="token operator">+</span> MINSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token punctuation">&#123;</span>
            <span class="token comment">/* split and reattach remainder */</span>
            <span class="token comment">// 获取新的 remainder 的大小</span>
            remainder_size          <span class="token operator">=</span> size <span class="token operator">-</span> nb<span class="token punctuation">;</span>
            <span class="token comment">// 获取新的 remainder 的位置</span>
            remainder               <span class="token operator">=</span> <span class="token function">chunk_at_offset</span><span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 更新 unsorted bin 的情况</span>
            <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-></span>bk <span class="token operator">=</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-></span>fd <span class="token operator">=</span> remainder<span class="token punctuation">;</span>
            <span class="token comment">// 更新 av 中记录的 last_remainder</span>
            av<span class="token operator">-></span>last_remainder                                <span class="token operator">=</span> remainder<span class="token punctuation">;</span>
            <span class="token comment">// 更新last remainder的指针</span>
            remainder<span class="token operator">-></span>bk <span class="token operator">=</span> remainder<span class="token operator">-></span>fd <span class="token operator">=</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span><span class="token punctuation">(</span>remainder_size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                remainder<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                remainder<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">// 设置victim的头部，</span>
            <span class="token function">set_head</span><span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb <span class="token operator">|</span> PREV_INUSE <span class="token operator">|</span>
                                 <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena <span class="token operator">?</span> NON_MAIN_ARENA <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置 remainder 的头部</span>
            <span class="token function">set_head</span><span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置记录 remainder 大小的 prev_size 字段，因为此时 remainder 处于空闲状态。</span>
            <span class="token function">set_foot</span><span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 细致的检查，非调试状态下没有作用</span>
            <span class="token function">check_malloced_chunk</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 将 victim 从 chunk 模式转化为mem模式</span>
            <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 如果设置了perturb_type, 则将获取到的chunk初始化为 perturb_type ^ 0xff</span>
            <span class="token function">alloc_perturb</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> p<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="初始取出"><a href="#初始取出" class="headerlink" title="初始取出"></a>初始取出</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* remove from unsorted list */</span>
<span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
bck<span class="token operator">-></span>fd                 <span class="token operator">=</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h5 id="EXACT-FIT"><a href="#EXACT-FIT" class="headerlink" title="EXACT FIT"></a>EXACT FIT</h5><p>如果从 unsorted bin 中取出来的 chunk 大小正好合适，就直接使用。这里应该已经把合并后恰好合适的 chunk 给分配出去了。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Take now instead of binning if exact fit */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> nb<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">set_inuse_bit_at_offset</span><span class="token punctuation">(</span>victim<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span> <span class="token function">set_non_main_arena</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">check_malloced_chunk</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">alloc_perturb</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> p<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="PLACE-CHUNK-IN-SMALL-BIN"><a href="#PLACE-CHUNK-IN-SMALL-BIN" class="headerlink" title="PLACE CHUNK IN SMALL BIN"></a>PLACE CHUNK IN SMALL BIN</h5><p>把取出来的 chunk 放到对应的 small bin 中。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* place chunk in bin */</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_smallbin_range</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    victim_index <span class="token operator">=</span> <span class="token function">smallbin_index</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bck          <span class="token operator">=</span> <span class="token function">bin_at</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fwd          <span class="token operator">=</span> bck<span class="token operator">-></span>fd<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="PLACE-CHUNK-IN-LARGE-BIN"><a href="#PLACE-CHUNK-IN-LARGE-BIN" class="headerlink" title="PLACE CHUNK IN LARGE BIN"></a>PLACE CHUNK IN LARGE BIN</h5><p>把取出来的 chunk 放到对应的 large bin 中。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// large bin 范围</span>
    victim_index <span class="token operator">=</span> <span class="token function">largebin_index</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bck          <span class="token operator">=</span> <span class="token function">bin_at</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 当前 large bin 的头部</span>
    fwd          <span class="token operator">=</span> bck<span class="token operator">-></span>fd<span class="token punctuation">;</span>

    <span class="token comment">/* maintain large bins in sorted order */</span>
    <span class="token comment">/* 从这里我们可以总结出，largebin 以 fd_nextsize 递减排序。
       同样大小的 chunk，后来的只会插入到之前同样大小的 chunk 后，
       而不会修改之前相同大小的fd/bk_nextsize，这也很容易理解，
       可以减低开销。此外，bin 头不参与 nextsize 链接。*/</span>
    <span class="token comment">// 如果 large bin 链表不空</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fwd <span class="token operator">!=</span> bck<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/* Or with inuse bit to speed comparisons */</span>
        <span class="token comment">// 加速比较，应该不仅仅有这个考虑，因为链表里的 chunk 都会设置该位。</span>
        size <span class="token operator">|=</span> PREV_INUSE<span class="token punctuation">;</span>
        <span class="token comment">/* if smaller than smallest, bypass loop below */</span>
        <span class="token comment">// bck->bk 存储着相应 large bin 中最小的chunk。</span>
        <span class="token comment">// 如果遍历的 chunk 比当前最小的还要小，那就只需要插入到链表尾部。</span>
        <span class="token comment">// 判断 bck->bk 是不是在 main arena。</span>
      <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bck<span class="token operator">-></span>bk<span class="token operator">-></span>size <span class="token operator">&amp;</span> NON_MAIN_ARENA<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">&lt;</span>
            <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">chunksize_nomask</span><span class="token punctuation">(</span>bck<span class="token operator">-></span>bk<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 令 fwd 指向 large bin 头</span>
            fwd <span class="token operator">=</span> bck<span class="token punctuation">;</span>
            <span class="token comment">// 令 bck 指向 largin bin 尾部 chunk</span>
            bck <span class="token operator">=</span> bck<span class="token operator">-></span>bk<span class="token punctuation">;</span>
            <span class="token comment">// victim 的 fd_nextsize 指向 largin bin 的第一个 chunk</span>
            victim<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> fwd<span class="token operator">-></span>fd<span class="token punctuation">;</span>
            <span class="token comment">// victim 的 bk_nextsize 指向原来链表的第一个 chunk 指向的 bk_nextsize</span>
            victim<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> fwd<span class="token operator">-></span>fd<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>
            <span class="token comment">// 原来链表的第一个 chunk 的 bk_nextsize 指向 victim</span>
            <span class="token comment">// 原来指向链表第一个 chunk 的 fd_nextsize 指向 victim</span>
            fwd<span class="token operator">-></span>fd<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span>
                victim<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 当前要插入的 victim 的大小大于最小的 chunk</span>
            <span class="token comment">// 判断 fwd 是否在 main arena</span>
            <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">chunk_main_arena</span><span class="token punctuation">(</span>fwd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 从链表头部开始找到不比 victim 大的 chunk</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> size <span class="token operator">&lt;</span> <span class="token function">chunksize_nomask</span><span class="token punctuation">(</span>fwd<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                fwd <span class="token operator">=</span> fwd<span class="token operator">-></span>fd_nextsize<span class="token punctuation">;</span>
                <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">chunk_main_arena</span><span class="token punctuation">(</span>fwd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">// 如果找到了一个和 victim 一样大的 chunk，</span>
            <span class="token comment">// 那就直接将 chunk 插入到该chunk的后面，并不修改 nextsize 指针。</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> size <span class="token operator">==</span>
                <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">chunksize_nomask</span><span class="token punctuation">(</span>fwd<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">/* Always insert in the second position.  */</span>
                fwd <span class="token operator">=</span> fwd<span class="token operator">-></span>fd<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 如果找到的chunk和当前victim大小不一样</span>
                <span class="token comment">// 那么就需要构造 nextsize 双向链表了</span>
                victim<span class="token operator">-></span>fd_nextsize              <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
                victim<span class="token operator">-></span>bk_nextsize              <span class="token operator">=</span> fwd<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>
                fwd<span class="token operator">-></span>bk_nextsize                 <span class="token operator">=</span> victim<span class="token punctuation">;</span>
                victim<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            bck <span class="token operator">=</span> fwd<span class="token operator">-></span>bk<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span>
        <span class="token comment">// 如果空的话，直接简单使得 fd_nextsize 与 bk_nextsize 构成一个双向链表即可。</span>
        victim<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> victim<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="最终取出"><a href="#最终取出" class="headerlink" title="最终取出"></a>最终取出</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 放到对应的 bin 中，构成 bck&lt;-->victim&lt;-->fwd。</span>
<span class="token function">mark_bin</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
victim<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
victim<span class="token operator">-></span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
fwd<span class="token operator">-></span>bk    <span class="token operator">=</span> victim<span class="token punctuation">;</span>
bck<span class="token operator">-></span>fd    <span class="token operator">=</span> victim<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="WHILE-迭代次数"><a href="#WHILE-迭代次数" class="headerlink" title="WHILE 迭代次数"></a>WHILE 迭代次数</h5><p>while 最多迭代 10000 次后退出。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">    <span class="token comment">// #define MAX_ITERS 10000</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>iters <span class="token operator">>=</span> MAX_ITERS<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h5 id="large-chunk"><a href="#large-chunk" class="headerlink" title="large chunk"></a>large chunk</h5><p><strong>注： 或许会很奇怪，为什么这里没有先去看 small chunk 是否满足新需求了呢？这是因为 small bin 在循环之前已经判断过了，这里如果有的话，就是合并后的才出现 chunk。但是在大循环外，large chunk 只是单纯地找到其索引，所以觉得在这里直接先判断是合理的，而且也为了下面可以再去找较大的 chunk。</strong></p>
<p>如果请求的 chunk 在 large chunk 范围内，就在对应的 bin 中从小到大进行扫描，找到第一个合适的。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
   If a large request, scan through the chunks of current bin in
   sorted order to find smallest that fits.  Use the skip list for this.
 */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span><span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    bin <span class="token operator">=</span> <span class="token function">bin_at</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* skip scan if empty or largest chunk is too small */</span>
    <span class="token comment">// 如果对应的 bin 为空或者其中的chunk最大的也很小，那就跳过</span>
    <span class="token comment">// first(bin)=bin->fd 表示当前链表中最大的chunk//双向链表的首部是最大的</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>victim <span class="token operator">=</span> <span class="token function">first</span><span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> bin <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">chunksize_nomask</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span> <span class="token operator">>=</span>
            <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 反向遍历链表，直到找到第一个不小于所需chunk大小的chunk</span>
        victim <span class="token operator">=</span> victim<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size <span class="token operator">=</span> <span class="token function">chunksize</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            victim <span class="token operator">=</span> victim<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>

        <span class="token comment">/* Avoid removing the first entry for a size so that the skip
           list does not have to be rerouted.  */</span>
        <span class="token comment">// 如果最终取到的chunk不是该bin中的最后一个chunk，并且该chunk与其前面的chunk</span>
        <span class="token comment">// 的大小相同，那么我们就取其前面的chunk，这样可以避免调整bk_nextsize,fd_nextsize</span>
        <span class="token comment">//  链表。因为大小相同的chunk只有一个会被串在nextsize链上。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>victim <span class="token operator">!=</span> <span class="token function">last</span><span class="token punctuation">(</span>bin<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token function">chunksize_nomask</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">chunksize_nomask</span><span class="token punctuation">(</span>victim<span class="token operator">-></span>fd<span class="token punctuation">)</span><span class="token punctuation">)</span>
            victim <span class="token operator">=</span> victim<span class="token operator">-></span>fd<span class="token punctuation">;</span>
        <span class="token comment">// 计算分配后剩余的大小</span>
        remainder_size <span class="token operator">=</span> size <span class="token operator">-</span> nb<span class="token punctuation">;</span>
        <span class="token comment">// 进行unlink</span>
        <span class="token function">unlink</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> bck<span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* Exhaust */</span>
        <span class="token comment">// 剩下的大小不足以当做一个块</span>
        <span class="token comment">// 很好奇接下来会怎么办？</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>remainder_size <span class="token operator">&lt;</span> MINSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">set_inuse_bit_at_offset</span><span class="token punctuation">(</span>victim<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span> 						     <span class="token function">set_non_main_arena</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">/* Split */</span>
        <span class="token comment">//  剩下的大小还可以作为一个chunk，进行分割。</span>
        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 获取剩下那部分chunk的指针，称为remainder</span>
            remainder <span class="token operator">=</span> <span class="token function">chunk_at_offset</span><span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">/* We cannot assume the unsorted list is empty and therefore
               have to perform a complete insert here.  */</span>
            <span class="token comment">// 插入unsorted bin中</span>
            bck <span class="token operator">=</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
            fwd <span class="token operator">=</span> bck<span class="token operator">-></span>fd<span class="token punctuation">;</span>
            <span class="token comment">// 判断 unsorted bin 是否被破坏。</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span><span class="token punctuation">(</span>fwd<span class="token operator">-></span>bk <span class="token operator">!=</span> bck<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                errstr <span class="token operator">=</span> <span class="token string">"malloc(): corrupted unsorted chunks"</span><span class="token punctuation">;</span>
                <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            remainder<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
            remainder<span class="token operator">-></span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
            bck<span class="token operator">-></span>fd       <span class="token operator">=</span> remainder<span class="token punctuation">;</span>
            fwd<span class="token operator">-></span>bk       <span class="token operator">=</span> remainder<span class="token punctuation">;</span>
            <span class="token comment">// 如果不处于small bin范围内，就设置对应的字段</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span><span class="token punctuation">(</span>remainder_size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                remainder<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                remainder<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">// 设置分配的chunk的标记</span>
            <span class="token function">set_head</span><span class="token punctuation">(</span>victim<span class="token punctuation">,</span>
                     nb <span class="token operator">|</span> PREV_INUSE <span class="token operator">|</span>
                         <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena <span class="token operator">?</span> NON_MAIN_ARENA <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 设置remainder的上一个chunk，即分配出去的chunk的使用状态</span>
            <span class="token comment">// 其余的不用管，直接从上面继承下来了</span>
            <span class="token function">set_head</span><span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置remainder的大小</span>
            <span class="token function">set_foot</span><span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 检查</span>
        <span class="token function">check_malloced_chunk</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 转换为mem状态</span>
        <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果设置了perturb_type, 则将获取到的chunk初始化为 perturb_type ^ 0xff</span>
        <span class="token function">alloc_perturb</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> p<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="寻找较大-chunk"><a href="#寻找较大-chunk" class="headerlink" title="寻找较大 chunk"></a>寻找较大 chunk</h5><p>如果走到了这里，那说明对于用户所需的 chunk，不能直接从其对应的合适的 bin 中获取 chunk，所以我们需要来查找比当前 bin 更大的 fast bin ， small bin 或者 large bin。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">        <span class="token comment">/*
           Search for a chunk by scanning bins, starting with next largest
           bin. This search is strictly by best-fit; i.e., the smallest
           (with ties going to approximately the least recently used) chunk
           that fits is selected.

           The bitmap avoids needing to check that most blocks are nonempty.
           The particular case of skipping all bins during warm-up phases
           when no chunks have been returned yet is faster than it might look.
         */</span>
<span class="token comment">/*
   通过扫描 bin，从下一个更大的 bin 开始，搜索一个块。这个搜索严格按照最佳适配原则进行；
   也就是说，选择适合的最小块（如果有多个相同大小的块，则选择近期最少使用的块）。

   位图的使用避免了需要检查大多数块是否非空的情况。
   在热身阶段（warm-up phases）中，当还没有返回任何块时，跳过所有 bin 的特殊情况比看起来快得多。
*/</span>
        <span class="token operator">++</span>idx<span class="token punctuation">;</span>
        <span class="token comment">// 获取对应的bin</span>
        bin   <span class="token operator">=</span> <span class="token function">bin_at</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取当前索引在binmap中的block索引</span>
        <span class="token comment">// #define idx2block(i) ((i) >> BINMAPSHIFT)  ,BINMAPSHIFT=5</span>
        <span class="token comment">// Binmap按block管理，每个block为一个int，共32个bit，可以表示32个bin中是否有空闲chunk存在</span>
        <span class="token comment">// 所以这里是右移5</span>
        block <span class="token operator">=</span> <span class="token function">idx2block</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取当前块大小对应的映射，这里可以得知相应的bin中是否有空闲块</span>
        map   <span class="token operator">=</span> av<span class="token operator">-></span>binmap<span class="token punctuation">[</span> block <span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// #define idx2bit(i) ((1U &lt;&lt; ((i) &amp; ((1U &lt;&lt; BINMAPSHIFT) - 1))))</span>
        <span class="token comment">// 将idx对应的比特位设置为1，其它位为0</span>
        bit   <span class="token operator">=</span> <span class="token function">idx2bit</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="找到一个合适的-MAP"><a href="#找到一个合适的-MAP" class="headerlink" title="找到一个合适的 MAP"></a>找到一个合适的 MAP</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Skip rest of block if there are no more set bits in this block.
 */</span>
<span class="token comment">// 如果bit>map，则表示该 map 中没有比当前所需要chunk大的空闲块</span>
<span class="token comment">// 如果bit为0，那么说明，上面idx2bit带入的参数为0。</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>bit <span class="token operator">></span> map <span class="token operator">||</span> bit <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 寻找下一个block，直到其对应的map不为0。</span>
        <span class="token comment">// 如果已经不存在的话，那就只能使用top chunk了</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>block <span class="token operator">>=</span> BINMAPSIZE<span class="token punctuation">)</span> <span class="token comment">/* out of bins */</span>
            <span class="token keyword">goto</span> use_top<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>map <span class="token operator">=</span> av<span class="token operator">-></span>binmap<span class="token punctuation">[</span> block <span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取其对应的bin，因为该map中的chunk大小都比所需的chunk大，而且</span>
    <span class="token comment">// map本身不为0，所以必然存在满足需求的chunk。</span>
    bin <span class="token operator">=</span> <span class="token function">bin_at</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> <span class="token punctuation">(</span>block <span class="token operator">&lt;&lt;</span> BINMAPSHIFT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bit <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="找到合适的-BIN"><a href="#找到合适的-BIN" class="headerlink" title="找到合适的 BIN"></a>找到合适的 BIN</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Advance to bin with set bit. There must be one. */</span>
<span class="token comment">// 从当前map的最小的bin一直找，直到找到合适的bin。</span>
<span class="token comment">// 这里是一定存在的</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bit <span class="token operator">&amp;</span> map<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    bin <span class="token operator">=</span> <span class="token function">next_bin</span><span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bit <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>bit <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="简单检查-CHUNK"><a href="#简单检查-CHUNK" class="headerlink" title="简单检查 CHUNK"></a>简单检查 CHUNK</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Inspect the bin. It is likely to be non-empty */</span>
<span class="token comment">// 获取对应的bin</span>
victim <span class="token operator">=</span> <span class="token function">last</span><span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*  If a false alarm (empty bin), clear the bit. */</span>
<span class="token comment">// 如果victim=bin，那么我们就将map对应的位清0，然后获取下一个bin</span>
<span class="token comment">// 这种情况发生的概率应该很小。</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>victim <span class="token operator">==</span> bin<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    av<span class="token operator">-></span>binmap<span class="token punctuation">[</span> block <span class="token punctuation">]</span> <span class="token operator">=</span> map <span class="token operator">&amp;=</span> <span class="token operator">~</span>bit<span class="token punctuation">;</span> <span class="token comment">/* Write through */</span>
    bin                 <span class="token operator">=</span> <span class="token function">next_bin</span><span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bit <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="真正取出-CHUNK"><a href="#真正取出-CHUNK" class="headerlink" title="真正取出 CHUNK"></a>真正取出 CHUNK</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 获取对应victim的大小</span>
    size <span class="token operator">=</span> <span class="token function">chunksize</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*  We know the first chunk in this bin is big enough to use. */</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 计算分割后剩余的大小</span>
    remainder_size <span class="token operator">=</span> size <span class="token operator">-</span> nb<span class="token punctuation">;</span>

    <span class="token comment">/* unlink */</span>
    <span class="token function">unlink</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> bck<span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Exhaust */</span>
    <span class="token comment">// 如果分割后不够一个chunk怎么办？</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>remainder_size <span class="token operator">&lt;</span> MINSIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">set_inuse_bit_at_offset</span><span class="token punctuation">(</span>victim<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span> <span class="token function">set_non_main_arena</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/* Split */</span>
    <span class="token comment">// 如果够，尽管分割</span>
    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 计算剩余的chunk的偏移</span>
        remainder <span class="token operator">=</span> <span class="token function">chunk_at_offset</span><span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* We cannot assume the unsorted list is empty and therefore
           have to perform a complete insert here.  */</span>
        <span class="token comment">// 将剩余的chunk插入到unsorted bin中</span>
        bck <span class="token operator">=</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fwd <span class="token operator">=</span> bck<span class="token operator">-></span>fd<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span><span class="token punctuation">(</span>fwd<span class="token operator">-></span>bk <span class="token operator">!=</span> bck<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            errstr <span class="token operator">=</span> <span class="token string">"malloc(): corrupted unsorted chunks 2"</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        remainder<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
        remainder<span class="token operator">-></span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>
        bck<span class="token operator">-></span>fd       <span class="token operator">=</span> remainder<span class="token punctuation">;</span>
        fwd<span class="token operator">-></span>bk       <span class="token operator">=</span> remainder<span class="token punctuation">;</span>

        <span class="token comment">/* advertise as last remainder */</span>
        <span class="token comment">// 如果在small bin范围内，就将其标记为remainder</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_smallbin_range</span><span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span> av<span class="token operator">-></span>last_remainder <span class="token operator">=</span> remainder<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_smallbin_range</span><span class="token punctuation">(</span>remainder_size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            remainder<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            remainder<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 设置victim的使用状态</span>
        <span class="token function">set_head</span><span class="token punctuation">(</span>victim<span class="token punctuation">,</span>
                 nb <span class="token operator">|</span> PREV_INUSE <span class="token operator">|</span>
                     <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena <span class="token operator">?</span> NON_MAIN_ARENA <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置remainder的使用状态，这里是为什么呢？</span>
        <span class="token function">set_head</span><span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置remainder的大小</span>
        <span class="token function">set_foot</span><span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 检查</span>
    <span class="token function">check_malloced_chunk</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// chunk状态转换到mem状态</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果设置了perturb_type, 则将获取到的chunk初始化为 perturb_type ^ 0xff</span>
    <span class="token function">alloc_perturb</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> p<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="使用-top-chunk"><a href="#使用-top-chunk" class="headerlink" title="使用 top chunk"></a>使用 top chunk</h5><p>如果所有的 bin 中的 chunk 都没有办法直接满足要求（即不合并），或者说都没有空闲的 chunk。那么我们就只能使用 top chunk 了。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">use_top<span class="token operator">:</span>
    <span class="token comment">/*
       If large enough, split off the chunk bordering the end of memory
       (held in av->top). Note that this is in accord with the best-fit
       search rule.  In effect, av->top is treated as larger (and thus
       less well fitting) than any other available chunk since it can
       be extended to be as large as necessary (up to system
       limitations).

       We require that av->top always exists (i.e., has size >=
       MINSIZE) after initialization, so if it would otherwise be
       exhausted by current request, it is replenished. (The main
       reason for ensuring it exists is that we may need MINSIZE space
       to put in fenceposts in sysmalloc.)
     */</span>
<span class="token comment">/*
   如果足够大，将与内存末尾（保存在 av->top 中）相邻的块分割出来。
   注意，这符合最佳适配搜索规则。实际上，av->top 被视为比任何其他可用块都更大（因此更不适配），
   因为它可以扩展到任意大小（受系统限制）。

   我们要求 av->top 在初始化后始终存在（即大小 >= MINSIZE），
   因此如果当前请求会耗尽它，它将被重新补充。
   （确保其存在的主要原因是我们可能需要 MINSIZE 的空间来放置 sysmalloc 中的栅栏。）
*/</span>
    <span class="token comment">// 获取当前的top chunk，并计算其对应的大小</span>
    victim <span class="token operator">=</span> av<span class="token operator">-></span>top<span class="token punctuation">;</span>
    size   <span class="token operator">=</span> <span class="token function">chunksize</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果分割之后，top chunk 大小仍然满足 chunk 的最小大小，那么就可以直接进行分割。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb <span class="token operator">+</span> MINSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        remainder_size <span class="token operator">=</span> size <span class="token operator">-</span> nb<span class="token punctuation">;</span>
        remainder      <span class="token operator">=</span> <span class="token function">chunk_at_offset</span><span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        av<span class="token operator">-></span>top        <span class="token operator">=</span> remainder<span class="token punctuation">;</span>
        <span class="token comment">// 这里设置 PREV_INUSE 是因为 top chunk 前面的 chunk 如果不是 fastbin，就必然会和</span>
        <span class="token comment">// top chunk 合并，所以这里设置了 PREV_INUSE。</span>
        <span class="token function">set_head</span><span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb <span class="token operator">|</span> PREV_INUSE <span class="token operator">|</span>
                             <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena <span class="token operator">?</span> NON_MAIN_ARENA <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">set_head</span><span class="token punctuation">(</span>remainder<span class="token punctuation">,</span> remainder_size <span class="token operator">|</span> PREV_INUSE<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">check_malloced_chunk</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">alloc_perturb</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> p<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 否则，判断是否有 fast chunk</span>
    <span class="token comment">/* When we are using atomic ops to free fast chunks we can get
       here for all block sizes.  */</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">have_fastchunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 先执行一次fast bin的合并</span>
        <span class="token function">malloc_consolidate</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* restore original bin index */</span>
        <span class="token comment">// 判断需要的chunk是在small bin范围内还是large bin范围内</span>
        <span class="token comment">// 并计算对应的索引</span>
        <span class="token comment">// 等待下次再看看是否可以</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_smallbin_range</span><span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span>
            idx <span class="token operator">=</span> <span class="token function">smallbin_index</span><span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            idx <span class="token operator">=</span> <span class="token function">largebin_index</span><span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="堆内存不够"><a href="#堆内存不够" class="headerlink" title="堆内存不够"></a>堆内存不够</h5><p>如果堆内存不够，我们就需要使用 <code>sysmalloc</code> 来申请内存了。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
   Otherwise, relay to handle system-dependent cases
 */</span>
<span class="token comment">// 否则的话，我们就只能从系统中再次申请一点内存了。</span>
<span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">sysmalloc</span><span class="token punctuation">(</span>nb<span class="token punctuation">,</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token function">alloc_perturb</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> p<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="libc-calloc"><a href="#libc-calloc" class="headerlink" title="_libc_calloc"></a>_libc_calloc</h5><p>calloc 也是 libc 中的一种申请内存块的函数。在 <code>libc</code>中的封装为 <code>_libc_calloc</code>，具体介绍如下</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
  calloc(size_t n_elements, size_t element_size);
  Returns a pointer to n_elements * element_size bytes, with all locations
  set to zero.
*/</span>
<span class="token comment">/*
  calloc(size_t n_elements, size_t element_size);
  返回一个指向 n_elements * element_size 字节的指针，其中所有位置都被设置为零。
*/</span>
<span class="token keyword">void</span><span class="token operator">*</span>  <span class="token function">__libc_calloc</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="sysmalloc"><a href="#sysmalloc" class="headerlink" title="sysmalloc"></a>sysmalloc</h5><p>正如该函数头的注释所言，该函数用于当前堆内存不足时，需要向系统申请更多的内存。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
   sysmalloc handles malloc cases requiring more memory from the system.
   On entry, it is assumed that av->top does not have enough
   space to service request for nb bytes, thus requiring that av->top
   be extended or replaced.
 */</span>
<span class="token comment">/*
   sysmalloc 处理需要从系统获取更多内存的 malloc 情况。
   在进入函数时，假设 av->top 没有足够的空间来满足 nb 字节的请求，
   因此需要扩展或替换 av->top。
 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="基本定义"><a href="#基本定义" class="headerlink" title="基本定义"></a>基本定义</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">sysmalloc</span><span class="token punctuation">(</span>INTERNAL_SIZE_T nb<span class="token punctuation">,</span> mstate av<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  mchunkptr old_top<span class="token punctuation">;</span>        <span class="token comment">/* incoming value of av->top */</span>
  INTERNAL_SIZE_T old_size<span class="token punctuation">;</span> <span class="token comment">/* its size */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>old_end<span class="token punctuation">;</span>            <span class="token comment">/* its end address */</span>

  <span class="token keyword">long</span> size<span class="token punctuation">;</span> <span class="token comment">/* arg to first MORECORE or mmap call */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>brk<span class="token punctuation">;</span> <span class="token comment">/* return value from MORECORE */</span>

  <span class="token keyword">long</span> correction<span class="token punctuation">;</span> <span class="token comment">/* arg to 2nd MORECORE call */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>snd_brk<span class="token punctuation">;</span>   <span class="token comment">/* 2nd return val */</span>

  INTERNAL_SIZE_T front_misalign<span class="token punctuation">;</span> <span class="token comment">/* unusable bytes at front of new space */</span>
  INTERNAL_SIZE_T end_misalign<span class="token punctuation">;</span>   <span class="token comment">/* partial page left at end of new space */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>aligned_brk<span class="token punctuation">;</span>              <span class="token comment">/* aligned offset into brk */</span>

  mchunkptr p<span class="token punctuation">;</span>                  <span class="token comment">/* the allocated/returned chunk */</span>
  mchunkptr remainder<span class="token punctuation">;</span>          <span class="token comment">/* remainder frOm allocation */</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> remainder_size<span class="token punctuation">;</span> <span class="token comment">/* its size */</span>

  <span class="token class-name">size_t</span> pagesize <span class="token operator">=</span> <span class="token function">GLRO</span><span class="token punctuation">(</span>dl_pagesize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  bool tried_mmap <span class="token operator">=</span> false<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">sysmalloc</span><span class="token punctuation">(</span>INTERNAL_SIZE_T nb<span class="token punctuation">,</span> mstate av<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  mchunkptr old_top<span class="token punctuation">;</span>        <span class="token comment">/* av->top 的初始值 */</span>
  INTERNAL_SIZE_T old_size<span class="token punctuation">;</span> <span class="token comment">/* 其大小 */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>old_end<span class="token punctuation">;</span>            <span class="token comment">/* 其结束地址 */</span>

  <span class="token keyword">long</span> size<span class="token punctuation">;</span> <span class="token comment">/* 传递给第一次 MORECORE 或 mmap 调用的参数 */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>brk<span class="token punctuation">;</span> <span class="token comment">/* MORECORE 的返回值 */</span>

  <span class="token keyword">long</span> correction<span class="token punctuation">;</span> <span class="token comment">/* 传递给第二次 MORECORE 调用的参数 */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>snd_brk<span class="token punctuation">;</span>   <span class="token comment">/* 第二次 MORECORE 的返回值 */</span>

  INTERNAL_SIZE_T front_misalign<span class="token punctuation">;</span> <span class="token comment">/* 新空间前面不可用的字节数 */</span>
  INTERNAL_SIZE_T end_misalign<span class="token punctuation">;</span>   <span class="token comment">/* 新空间末尾剩余的部分页面 */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>aligned_brk<span class="token punctuation">;</span>              <span class="token comment">/* 对齐后的 brk 偏移量 */</span>

  mchunkptr p<span class="token punctuation">;</span>                  <span class="token comment">/* 分配/返回的块 */</span>
  mchunkptr remainder<span class="token punctuation">;</span>          <span class="token comment">/* 剩余的分配块 */</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> remainder_size<span class="token punctuation">;</span> <span class="token comment">/* 剩余块的大小 */</span>

  <span class="token class-name">size_t</span> pagesize <span class="token operator">=</span> <span class="token function">GLRO</span><span class="token punctuation">(</span>dl_pagesize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  bool tried_mmap <span class="token operator">=</span> false<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们可以主要关注一下 <code>pagesize</code>，其</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">EXEC_PAGESIZE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EXEC_PAGESIZE</span>   <span class="token expression"><span class="token number">4096</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">define</span> <span class="token macro-name function">GLRO</span><span class="token expression"><span class="token punctuation">(</span>name<span class="token punctuation">)</span> _</span><span class="token punctuation">##</span><span class="token expression">name</span></span>
<span class="token class-name">size_t</span> _dl_pagesize <span class="token operator">=</span> EXEC_PAGESIZE<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以，<code>pagesize=4096=0x1000</code>。</p>
<h5 id="考虑-mmap"><a href="#考虑-mmap" class="headerlink" title="考虑 mmap"></a>考虑 mmap</h5><p>正如开头注释所言如果满足如下任何一种条件</p>
<ol>
<li>没有分配堆。</li>
<li>申请的内存大于 <code>mp_.mmap_threshold</code>，并且 mmap 的数量小于最大值，就可以尝试使用 mmap。</li>
</ol>
<p>默认情况下，临界值为</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">malloc_par</span> mp_ <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">.</span>top_pad <span class="token operator">=</span> DEFAULT_TOP_PAD<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>n_mmaps_max <span class="token operator">=</span> DEFAULT_MMAP_MAX<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>mmap_threshold <span class="token operator">=</span> DEFAULT_MMAP_THRESHOLD<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>trim_threshold <span class="token operator">=</span> DEFAULT_TRIM_THRESHOLD<span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">NARENAS_FROM_NCORES</span><span class="token expression"><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
    <span class="token punctuation">.</span>arena_test <span class="token operator">=</span> <span class="token function">NARENAS_FROM_NCORES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_TCACHE</span></span>
        <span class="token punctuation">,</span>
    <span class="token punctuation">.</span>tcache_count <span class="token operator">=</span> TCACHE_FILL_COUNT<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>tcache_bins <span class="token operator">=</span> TCACHE_MAX_BINS<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>tcache_max_bytes <span class="token operator">=</span> <span class="token function">tidx2usize</span><span class="token punctuation">(</span>TCACHE_MAX_BINS <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>tcache_unsorted_limit <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">/* No limit.  */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong><code>DEFAULT_MMAP_THRESHOLD</code> 为 128*1024 字节，即 128 K。</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">DEFAULT_MMAP_THRESHOLD</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_MMAP_THRESHOLD</span> <span class="token expression">DEFAULT_MMAP_THRESHOLD_MIN</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token comment">/*
  MMAP_THRESHOLD_MAX and _MIN are the bounds on the dynamically
  adjusted MMAP_THRESHOLD.
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">DEFAULT_MMAP_THRESHOLD_MIN</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_MMAP_THRESHOLD_MIN</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">128</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">DEFAULT_MMAP_THRESHOLD_MAX</span></span>
<span class="token comment">/* For 32-bit platforms we cannot increase the maximum mmap
   threshold much because it is also the minimum value for the
   maximum heap size and its alignment.  Going above 512k (i.e., 1M
   for new heaps) wastes too much address space.  */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">__WORDSIZE <span class="token operator">==</span> <span class="token number">32</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_MMAP_THRESHOLD_MAX</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">512</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_MMAP_THRESHOLD_MAX</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>下面为这部分代码，目前不是我们关心的重点，<strong>可以暂时跳过</strong>。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
   If have mmap, and the request size meets the mmap threshold, and
   the system supports mmap, and there are few enough currently
   allocated mmapped regions, try to directly map this request
   rather than expanding top.
 */</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>nb<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>mp_<span class="token punctuation">.</span>mmap_threshold<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
     <span class="token punctuation">(</span>mp_<span class="token punctuation">.</span>n_mmaps <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>n_mmaps_max<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>mm<span class="token punctuation">;</span> <span class="token comment">/* return value from mmap call*/</span>

try_mmap<span class="token operator">:</span>
  <span class="token comment">/*
     Round up size to nearest page.  For mmapped chunks, the overhead
     is one SIZE_SZ unit larger than for normal chunks, because there
     is no following chunk whose prev_size field could be used.

     See the front_misalign handling below, for glibc there is no
     need for further alignments unless we have have high alignment.
   */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>MALLOC_ALIGNMENT <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">)</span>
    size <span class="token operator">=</span> <span class="token function">ALIGN_UP</span><span class="token punctuation">(</span>nb <span class="token operator">+</span> SIZE_SZ<span class="token punctuation">,</span> pagesize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    size <span class="token operator">=</span> <span class="token function">ALIGN_UP</span><span class="token punctuation">(</span>nb <span class="token operator">+</span> SIZE_SZ <span class="token operator">+</span> MALLOC_ALIGN_MASK<span class="token punctuation">,</span> pagesize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  tried_mmap <span class="token operator">=</span> true<span class="token punctuation">;</span>

  <span class="token comment">/* Don't try if size wraps around 0 */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    mm <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">MMAP</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mm <span class="token operator">!=</span> MAP_FAILED<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">/*
         The offset to the start of the mmapped region is stored
         in the prev_size field of the chunk. This allows us to adjust
         returned start address to meet alignment requirements here
         and in memalign(), and still be able to compute proper
         address argument for later munmap in free() and realloc().
       */</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>MALLOC_ALIGNMENT <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/* For glibc, chunk2mem increases the address by 2*SIZE_SZ and
           MALLOC_ALIGN_MASK is 2*SIZE_SZ-1.  Each mmap'ed area is page
           aligned and therefore definitely MALLOC_ALIGN_MASK-aligned.  */</span>
        <span class="token function">assert</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>INTERNAL_SIZE_T<span class="token punctuation">)</span><span class="token function">chunk2mem</span><span class="token punctuation">(</span>mm<span class="token punctuation">)</span> <span class="token operator">&amp;</span> MALLOC_ALIGN_MASK<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        front_misalign <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span>
        front_misalign <span class="token operator">=</span> <span class="token punctuation">(</span>INTERNAL_SIZE_T<span class="token punctuation">)</span><span class="token function">chunk2mem</span><span class="token punctuation">(</span>mm<span class="token punctuation">)</span> <span class="token operator">&amp;</span> MALLOC_ALIGN_MASK<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>front_misalign <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        correction <span class="token operator">=</span> MALLOC_ALIGNMENT <span class="token operator">-</span> front_misalign<span class="token punctuation">;</span>
        p <span class="token operator">=</span> <span class="token punctuation">(</span>mchunkptr<span class="token punctuation">)</span><span class="token punctuation">(</span>mm <span class="token operator">+</span> correction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">set_prev_size</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> correction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">set_head</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token punctuation">(</span>size <span class="token operator">-</span> correction<span class="token punctuation">)</span> <span class="token operator">|</span> IS_MMAPPED<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        p <span class="token operator">=</span> <span class="token punctuation">(</span>mchunkptr<span class="token punctuation">)</span>mm<span class="token punctuation">;</span>
        <span class="token function">set_prev_size</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">set_head</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> size <span class="token operator">|</span> IS_MMAPPED<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">/* update statistics */</span>

      <span class="token keyword">int</span> new <span class="token operator">=</span> <span class="token function">atomic_exchange_and_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mp_<span class="token punctuation">.</span>n_mmaps<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token function">atomic_max</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mp_<span class="token punctuation">.</span>max_n_mmaps<span class="token punctuation">,</span> new<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">unsigned</span> <span class="token keyword">long</span> sum<span class="token punctuation">;</span>
      sum <span class="token operator">=</span> <span class="token function">atomic_exchange_and_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mp_<span class="token punctuation">.</span>mmapped_mem<span class="token punctuation">,</span> size<span class="token punctuation">)</span> <span class="token operator">+</span> size<span class="token punctuation">;</span>
      <span class="token function">atomic_max</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mp_<span class="token punctuation">.</span>max_mmapped_mem<span class="token punctuation">,</span> sum<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">check_chunk</span><span class="token punctuation">(</span>av<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token function">chunk2mem</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="mmap-失败或者未分配堆"><a href="#mmap-失败或者未分配堆" class="headerlink" title="mmap 失败或者未分配堆"></a>mmap 失败或者未分配堆</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* There are no usable arenas and mmap also failed.  */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>如果是这两种情况中的任何一种，其实就可以退出了。。</p>
<h5 id="记录旧堆信息"><a href="#记录旧堆信息" class="headerlink" title="记录旧堆信息"></a>记录旧堆信息</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Record incoming configuration of top */</span>
<span class="token comment">/* 记录传入的 top 的配置信息 */</span>
old_top <span class="token operator">=</span> av<span class="token operator">-></span>top<span class="token punctuation">;</span>
old_size <span class="token operator">=</span> <span class="token function">chunksize</span><span class="token punctuation">(</span>old_top<span class="token punctuation">)</span><span class="token punctuation">;</span>
old_end <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">chunk_at_offset</span><span class="token punctuation">(</span>old_top<span class="token punctuation">,</span> old_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

brk <span class="token operator">=</span> snd_brk <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>MORECORE_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="检查旧堆信息-1"><a href="#检查旧堆信息-1" class="headerlink" title="检查旧堆信息 1"></a>检查旧堆信息 1</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*
   If not the first time through, we require old_size to be
   at least MINSIZE and to have prev_inuse set.
 */</span>
 <span class="token comment">/*
   如果不是第一次执行，我们要求 old_size 至少为 MINSIZE，并且设置了 prev_inuse。
 */</span>
<span class="token function">assert</span><span class="token punctuation">(</span><span class="token punctuation">(</span>old_top <span class="token operator">==</span> <span class="token function">initial_top</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> old_size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span>
       <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>old_size<span class="token punctuation">)</span> <span class="token operator">>=</span> MINSIZE <span class="token operator">&amp;&amp;</span> <span class="token function">prev_inuse</span><span class="token punctuation">(</span>old_top<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>old_end <span class="token operator">&amp;</span> <span class="token punctuation">(</span>pagesize <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个检查要求满足其中任何一个条件</p>
<ol>
<li><code>old_top == initial_top(av) &amp;&amp; old_size == 0</code>，即如果是第一次的话，堆的大小需要是 0。</li>
<li>新的堆，那么<ol>
<li><code>(unsigned long)(old_size) &gt;= MINSIZE &amp;&amp; prev_inuse(old_top)</code>，堆的大小应该不小于 <code>MINSIZE</code>，并且前一个堆块应该处于使用中。</li>
<li><code>((unsigned long)old_end &amp; (pagesize - 1)) == 0)</code>，堆的结束地址应该是页对齐的，由于页对齐的大小默认是 0x1000，所以低 12 个比特需要为 0。</li>
</ol>
</li>
</ol>
<h5 id="检查旧堆信息-2"><a href="#检查旧堆信息-2" class="headerlink" title="检查旧堆信息 2"></a>检查旧堆信息 2</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Precondition: not enough current space to satisfy nb request */</span>
<span class="token function">assert</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>old_size<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>nb <span class="token operator">+</span> MINSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>根据 malloc 中的定义</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">_int_malloc</span><span class="token punctuation">(</span>mstate av<span class="token punctuation">,</span> <span class="token class-name">size_t</span> bytes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    INTERNAL_SIZE_T nb<span class="token punctuation">;</span>  <span class="token comment">/* normalized request size */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><code>nb</code> 应该是已经加上 chunk 头部的字节，为什么还要加上 <code>MINSIZE</code>呢？这是因为 top chunk 的大小应该至少预留 MINSIZE 空间，以便于合并。</p>
<h3 id="tcache-gblic-2-26"><a href="#tcache-gblic-2-26" class="headerlink" title="tcache(gblic&gt;&#x3D;2.26)"></a>tcache(gblic&gt;&#x3D;2.26)</h3><p>tcache 是 glibc 2.26 (ubuntu 17.10) 之后引入的一种技术（see <a target="_blank" rel="noopener" href="https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc">commit</a>），目的是提升堆管理的性能。但提升性能的同时舍弃了很多安全检查，也因此有了很多新的利用方式。</p>
<blockquote>
<p>主要参考了 glibc 源码，angelboy 的 slide 以及 tukan.farm，链接都放在最后了。</p>
</blockquote>
<h4 id="相关结构体"><a href="#相关结构体" class="headerlink" title="相关结构体"></a>相关结构体</h4><p>tcache 引入了两个新的结构体，<code>tcache_entry</code> 和 <code>tcache_perthread_struct</code>。</p>
<p>这其实和 fastbin 很像，但又不一样。</p>
<h4 id="tcache-entry"><a href="#tcache-entry" class="headerlink" title="tcache_entry"></a>tcache_entry</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* We overlay this structure on the user-data portion of a chunk when
   the chunk is stored in the per-thread cache.  */</span>
<span class="token comment">/* 当块存储在每个线程的缓存中时，我们将此结构叠加在块的用户数据部分上。 */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">tcache_entry</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">tcache_entry</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> tcache_entry<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>tcache_entry</code> 用于<strong>链接空闲的 chunk 结构体</strong>，其中的 <code>next</code> 指针指向<strong>下一个大小相同</strong>的 chunk。</p>
<p>需要注意的是这里的 next <strong>指向 chunk 的 user data</strong>，而 fastbin 的 fd 指向 chunk 开头的地址。</p>
<p>而且，tcache_entry 会复用空闲 chunk 的 user data 部分。</p>
<h4 id="tcache-perthread-struct"><a href="#tcache-perthread-struct" class="headerlink" title="tcache_perthread_struct"></a>tcache_perthread_struct</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* There is one of these for each thread, which contains the
   per-thread cache (hence "tcache_perthread_struct").  Keeping
   overall size low is mildly important.  Note that COUNTS and ENTRIES
   are redundant (we could have just counted the linked list each
   time), this is for performance reasons.  */</span>
<span class="token comment">/* 
每个线程都有一个这样的结构，其中包含每个线程的缓存（因此称为 "tcache_perthread_struct"）。保持整体大小较小略为重要。请注意，COUNTS 和 ENTRIES 是冗余的（我们每次都可以计算链表的长度），这是出于性能考虑。 
*/</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">tcache_perthread_struct</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> counts<span class="token punctuation">[</span>TCACHE_MAX_BINS<span class="token punctuation">]</span><span class="token punctuation">;</span>
  tcache_entry <span class="token operator">*</span>entries<span class="token punctuation">[</span>TCACHE_MAX_BINS<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> tcache_perthread_struct<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">define</span> <span class="token macro-name">TCACHE_MAX_BINS</span>                <span class="token expression"><span class="token number">64</span></span></span>

<span class="token keyword">static</span> __thread tcache_perthread_struct <span class="token operator">*</span>tcache <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>每个 thread 都会维护一个 <code>tcache_perthread_struct</code>，它是整个 tcache 的管理结构，一共有 <code>TCACHE_MAX_BINS</code> 个计数器和 <code>TCACHE_MAX_BINS</code>项 tcache_entry，其中</p>
<ul>
<li><strong><code>tcache_entry</code> 用单向链表的方式链接了相同大小的处于空闲状态（free 后）的 chunk，这一点上和 fastbin 很像。</strong></li>
<li><strong><code>counts</code> 记录了 <code>tcache_entry</code> 链上空闲 chunk 的数目，每条链上最多可以有 7 个 chunk。</strong>（为了在tcache中保持较小的内存开销和更好的性能，可能在不同libc上有不同的限制，例如较早版本有的4或者8）</li>
</ul>
<p>用图表示大概是：<strong>（next指针存在fd区域）</strong></p>
<img src="file:///C:\Users\Lenovo\Documents\Tencent Files\3025734103\nt_qq\nt_data\Pic\2024-01\Ori\1ede6b8f8429dfb325c1a8233c08766d.jpeg" alt="img" style="zoom: 67%;" />

<h4 id="基本工作方式"><a href="#基本工作方式" class="headerlink" title="基本工作方式"></a>基本工作方式</h4><ul>
<li><strong>第一次 malloc 时，会先 malloc 一块内存用来存放 <code>tcache_perthread_struct</code> 。</strong></li>
<li>free 内存，且 size 小于 small bin size 时</li>
<li>tcache 之前会放到 fastbin 或者 unsorted bin 中</li>
<li>tcache 后：<ul>
<li>先放到对应的 tcache 中，直到 tcache 被填满（默认是 7 个）</li>
<li>tcache 被填满之后，再次 free 的内存和之前一样被放到 fastbin 或者 unsorted bin 中</li>
<li>tcache 中的 chunk 不会合并（不取消 inuse bit）</li>
</ul>
</li>
<li>malloc 内存，且 size 在 tcache 范围内</li>
<li>先从 tcache 取 chunk，直到 tcache 为空</li>
<li>tcache 为空后，从 bin 中找</li>
<li>tcache 为空时，如果 <code>fastbin/smallbin/unsorted bin</code> 中有 size 符合的 chunk，会先把 <code>fastbin/smallbin/unsorted bin</code> 中的 chunk 放到 tcache 中，直到填满。之后再从 tcache 中取；因此 chunk 在 bin 中和 tcache 中的顺序会反过来</li>
</ul>
<h4 id="Tcache的相关知识"><a href="#Tcache的相关知识" class="headerlink" title="Tcache的相关知识"></a>Tcache的相关知识</h4><p>在32位系统中，bin会存放12-512字节的chunk，<strong>在64位系统中bin会存放24-1032字节的chunk</strong>。也就是说<strong>符合这些大小的chunk被释放后不会先加入fastbin</strong>，而是会先放入TcacheBin中。**(和fastbin的存储大小差不多一致)**</p>
<p>TcacheBin以单链表构成</p>
<h5 id="什么时候用到Tcache："><a href="#什么时候用到Tcache：" class="headerlink" title="什么时候用到Tcache："></a>什么时候用到Tcache：</h5><p><strong>free：</strong>在释放chunk的时候，如果chunk符合Tcachebin的大小，并且该bin还没有被装满(没有七个)，则会优先放入TcacheBin中</p>
<p><strong>malloc：</strong></p>
<ol>
<li>当我们使用malloc的时候，返回一个chunk，并且该chunk是从fastbin中返回的，那么该chunk所对应下标的所有chunk都会被放入TcacheBin(当然，前提是Tcachebin没有被装满)，而且由于fastbin和Tcachebin都是先进后出，所以就会导致chunk在移动完以后chunk的顺序和fastbin中的顺序相反。</li>
<li>smallbin中的也一样，返回的一个chunk属于smallbin，那么smallbin中对应的chunk就会全部放入Tcachebin(前提是没有装满)</li>
<li>当出现堆块的合并等其它情况的时候，每一个符合条件的chunk都会优先放入TcacheBin中，而不是直接返回(除非Tcache已满)。寻找结束后Tcache会返回其中一个</li>
</ol>
<p><strong>比较重要的一点，当我们调用malloc的时候，其实是先调用libc_malloc然后调用int_malloc，但是如果我们请求的大小在Tcachebin中有符合的chunk那么就会在libc_malloc中返回该chunk，而不会调用int_malloc</strong></p>
<p><strong>我们在处理chunk的过程中，如果在Tcache中的chunk已满，那么会直接返回最后一个chunk；binning code 结束后，如果没有直接返回（如上），那么如果有至少一个符合要求的 chunk 被找到，则返回最后一个。</strong></p>
<p><strong>tcache 中的 chunk 不会被合并，无论是相邻 chunk，还是 chunk 和 top chunk。因为这些 chunk 会被标记为 inuse。</strong></p>
<h4 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h4><p>接下来从源码的角度分析一下 tcache。</p>
<h5 id="libc-malloc-1"><a href="#libc-malloc-1" class="headerlink" title="__libc_malloc"></a>__libc_malloc</h5><p>第一次 malloc 时，会进入到 <code>MAYBE_INIT_TCACHE ()</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span>
<span class="token function">__libc_malloc</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> bytes<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_TCACHE</span></span>
  <span class="token comment">/* int_free also calls request2size, be careful to not pad twice.  */</span>
  <span class="token comment">/*int_free 函数还会调用 request2size 函数，请注意不要重复进行填充。(提醒开发者在释放内存块时，注意在调用 request2size 函数时避免重复进行填充操作)	*/</span>
  <span class="token class-name">size_t</span> tbytes<span class="token punctuation">;</span>
  <span class="token comment">// 根据 malloc 传入的参数计算 chunk 实际大小，并计算 tcache 对应的下标</span>
  <span class="token function">checked_request2size</span> <span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> tbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//tbytes应该是对应tcache的大小</span>
  <span class="token class-name">size_t</span> tc_idx <span class="token operator">=</span> <span class="token function">csize2tidx</span> <span class="token punctuation">(</span>tbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//计算下标</span>

  <span class="token comment">// 初始化 tcache</span>
  <span class="token function">MAYBE_INIT_TCACHE</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//检查当前线程的 tcache 是否已经初始化，如果没有初始化，则进行初始化</span>
  DIAG_PUSH_NEEDS_COMMENT<span class="token punctuation">;</span>  			<span class="token comment">//在编译器诊断信息中添加一个注释没有实质性作用</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>tc_idx <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>tcache_bins  <span class="token comment">// 根据 size 得到的 idx 在合法的范围内</span>
      <span class="token comment">/*&amp;&amp; tc_idx &lt; TCACHE_MAX_BINS*/</span> <span class="token comment">/* to appease gcc */</span>
      <span class="token operator">&amp;&amp;</span> tcache
      <span class="token operator">&amp;&amp;</span> tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token comment">// tcache->entries[tc_idx] 有 chunk</span>
    <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token function">tcache_get</span> <span class="token punctuation">(</span>tc_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  DIAG_POP_NEEDS_COMMENT<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="tcache-init"><a href="#tcache-init" class="headerlink" title="__tcache_init()"></a>__tcache_init()</h4><p>附:arena是一块连续的内存区域(包括Heap Arena[Small bin and Large bin]和Thread-specific Arena[Fast bin and Tcache])</p>
<p>其中 **<code>MAYBE_INIT_TCACHE ()</code> 在 tcache 为空（即第一次 malloc）时调用了 <code>tcache_init()</code>**，直接查看 <code>tcache_init()</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">tcache_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  mstate ar_ptr<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>victim <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token class-name">size_t</span> bytes <span class="token operator">=</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>tcache_perthread_struct<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>tcache_shutting_down<span class="token punctuation">)</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token function">arena_get</span> <span class="token punctuation">(</span>ar_ptr<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 找到可用的 arena</span>
  victim <span class="token operator">=</span> <span class="token function">_int_malloc</span> <span class="token punctuation">(</span>ar_ptr<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 申请一个 sizeof(tcache_perthread_struct) 大小的 chunk</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>victim <span class="token operator">&amp;&amp;</span> ar_ptr <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>  <span class="token comment">//没有可用的arena或者没有申请chunk成功</span>
    <span class="token punctuation">&#123;</span>
      ar_ptr <span class="token operator">=</span> <span class="token function">arena_get_retry</span> <span class="token punctuation">(</span>ar_ptr<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//重试</span>
      victim <span class="token operator">=</span> <span class="token function">_int_malloc</span> <span class="token punctuation">(</span>ar_ptr<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//重试</span>
    <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ar_ptr <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token function">__libc_lock_unlock</span> <span class="token punctuation">(</span>ar_ptr<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//解锁arena</span>
  <span class="token comment">/* In a low memory situation, we may not be able to allocate memory
     - in which case, we just keep trying later.  However, we
     typically do this very early, so either there is sufficient
     memory, or there isn't enough memory to do non-trivial
     allocations anyway.  */</span>
  <span class="token comment">/* 在内存紧张的情况下，我们可能无法分配内存 - 在这种情况下，我们稍后会继续尝试。
   不过，通常我们会在很早的阶段进行这个尝试，
   因此要么有足够的内存，要么根本没有足够的内存来进行非平凡的分配操作。 
  */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span> <span class="token comment">// 初始化 tcache</span>
    <span class="token punctuation">&#123;</span>
      tcache <span class="token operator">=</span> <span class="token punctuation">(</span>tcache_perthread_struct <span class="token operator">*</span><span class="token punctuation">)</span> victim<span class="token punctuation">;</span>
      <span class="token function">memset</span> <span class="token punctuation">(</span>tcache<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>tcache_perthread_struct<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>tcache_init()</code> 成功返回后，<code>tcache_perthread_struct</code> 就被成功建立了。</p>
<h4 id="申请内存"><a href="#申请内存" class="headerlink" title="申请内存"></a>申请内存</h4><p>接下来将进入申请内存的步骤</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">  <span class="token comment">// 从 tcache list 中获取内存</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>tc_idx <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>tcache_bins <span class="token comment">// 由 size 计算的 idx 在合法范围内</span>
      <span class="token comment">/*&amp;&amp; tc_idx &lt; TCACHE_MAX_BINS*/</span> <span class="token comment">/* to appease gcc */</span>
      <span class="token operator">&amp;&amp;</span> tcache
      <span class="token operator">&amp;&amp;</span> tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token comment">// 该条 tcache 链不为空</span>
    <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token function">tcache_get</span> <span class="token punctuation">(</span>tc_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  DIAG_POP_NEEDS_COMMENT<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
  <span class="token comment">// 进入与无 tcache 时类似的流程</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>SINGLE_THREAD_P<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      victim <span class="token operator">=</span> <span class="token function">_int_malloc</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>main_arena<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//tcache为空就直接_int_malloc</span>
      <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token operator">!</span>victim <span class="token operator">||</span> <span class="token function">chunk_is_mmapped</span> <span class="token punctuation">(</span><span class="token function">mem2chunk</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
              <span class="token operator">&amp;</span>main_arena <span class="token operator">==</span> <span class="token function">arena_for_chunk</span> <span class="token punctuation">(</span><span class="token function">mem2chunk</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> victim<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在 <code>tcache-&gt;entries</code> 不为空时，将进入 <code>tcache_get()</code> 的流程获取 chunk，否则与 tcache 机制前的流程类似，这里主要分析第一种 <code>tcache_get()</code>。这里也可以看出 tcache 的优先级很高，比 fastbin 还要高（ fastbin 的申请在没进入 tcache 的流程中）。</p>
<h4 id="tcache-get"><a href="#tcache-get" class="headerlink" title="tcache_get()"></a>tcache_get()</h4><p>看一下 <code>tcache_get()</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Caller must ensure that we know tc_idx is valid and there's
   available chunks to remove.  */</span>
<span class="token keyword">static</span> __always_inline <span class="token keyword">void</span> <span class="token operator">*</span>
<span class="token function">tcache_get</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> tc_idx<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  tcache_entry <span class="token operator">*</span>e <span class="token operator">=</span> tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">assert</span> <span class="token punctuation">(</span>tc_idx <span class="token operator">&lt;</span> TCACHE_MAX_BINS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span> <span class="token punctuation">(</span>tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token operator">-></span>next<span class="token punctuation">;</span>
  <span class="token operator">--</span><span class="token punctuation">(</span>tcache<span class="token operator">-></span>counts<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获得一个 chunk，counts 减一</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> e<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>tcache_get()</code> 就是获得 chunk 的过程了。可以看出这个过程还是很简单的，从 <code>tcache-&gt;entries[tc_idx]</code> 中获得第一个 chunk，<code>tcache-&gt;counts</code> 减一，<strong>几乎没有任何保护。</strong></p>
<h4 id="libc-free"><a href="#libc-free" class="headerlink" title="__libc_free()"></a>__libc_free()</h4><p>看完申请，再看看<strong>有 tcache 时的释放</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">__libc_free</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>mem<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token function">MAYBE_INIT_TCACHE</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ar_ptr <span class="token operator">=</span> <span class="token function">arena_for_chunk</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">_int_free</span> <span class="token punctuation">(</span>ar_ptr<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>__libc_free()</code> 没有太多变化，**<code>MAYBE_INIT_TCACHE ()</code> 在 tcache 不为空失去了作用**。</p>
<h4 id="int-free"><a href="#int-free" class="headerlink" title="_int_free()"></a>_int_free()</h4><p>跟进 &#96;_int_free()</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">_int_free</span> <span class="token punctuation">(</span>mstate av<span class="token punctuation">,</span> mchunkptr p<span class="token punctuation">,</span> <span class="token keyword">int</span> have_lock<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_TCACHE</span></span>
  <span class="token punctuation">&#123;</span>
    <span class="token class-name">size_t</span> tc_idx <span class="token operator">=</span> <span class="token function">csize2tidx</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tcache
        <span class="token operator">&amp;&amp;</span> tc_idx <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>tcache_bins <span class="token comment">// 64</span>
        <span class="token operator">&amp;&amp;</span> tcache<span class="token operator">-></span>counts<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>tcache_count<span class="token punctuation">)</span> <span class="token comment">// 7</span>
      <span class="token punctuation">&#123;</span>
        <span class="token function">tcache_put</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> tc_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>判断 <code>tc_idx</code> 合法，<code>tcache-&gt;counts[tc_idx]</code> 在 7 个以内时，就进入 <code>tcache_put()</code>，传递的两个参数是要释放的 chunk 和该 chunk 对应的 size 在 tcache 中的下标。</p>
<h4 id="tcache-put"><a href="#tcache-put" class="headerlink" title="tcache_put()"></a>tcache_put()</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Caller must ensure that we know tc_idx is valid and there's room
   for more chunks.  */</span>
<span class="token comment">/* 调用者必须确保我们知道 tc_idx 是有效的，并且还有足够的空间来存放更多的块。 */</span>
<span class="token keyword">static</span> __always_inline <span class="token keyword">void</span>
<span class="token function">tcache_put</span> <span class="token punctuation">(</span>mchunkptr chunk<span class="token punctuation">,</span> <span class="token class-name">size_t</span> tc_idx<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  tcache_entry <span class="token operator">*</span>e <span class="token operator">=</span> <span class="token punctuation">(</span>tcache_entry <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span> <span class="token punctuation">(</span>tc_idx <span class="token operator">&lt;</span> TCACHE_MAX_BINS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  e<span class="token operator">-></span>next <span class="token operator">=</span> tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">//FIFO</span>
  tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
  <span class="token operator">++</span><span class="token punctuation">(</span>tcache<span class="token operator">-></span>counts<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>tcache_puts()</code> 完成了把释放的 chunk 插入到 <code>tcache-&gt;entries[tc_idx]</code> 链表头部的操作，也几乎没有任何保护。并且 <strong>没有把 p 位置零</strong>。(P位是指前一个内存是否分配)</p>

          <div class="post-tags">
            <!-- 文章tags -->
            
          </div>
          <p class="motto">重拾纯粹的写作</p>
        </article>
        <!-- 评论 -->
        <div id="vcomments"></div>
      </div>
    </main>
    <!-- toc -->
    
    <cosy-drag-box id="toc-drag-box" trigger="left" min-width="220" uid="toc-box">
      <div class="meta-container">
        <div class="toc-wrapper cosy-scrollbar">
          <p class="catalog">
            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24">
              <g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 6h16"></path>
                <path d="M4 12h16"></path>
                <path d="M4 18h12"></path>
              </g>
            </svg>
            <span>目录</span>
          </p>
          <!-- 文章toc -->
          <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A0%86"><span class="toc-number">1.</span> <span class="toc-text">堆</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A0%86%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="toc-number">1.1.</span> <span class="toc-text">堆的基本操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcache-gblic-2-26"><span class="toc-number">1.2.</span> <span class="toc-text">tcache(gblic&gt;&#x3D;2.26)</span></a></li></ol></li></ol>
        </div>
      </div>
    </cosy-drag-box>
    
  </div>

</div>

<script>
  window.page = {
    use: 'valine'
  }
  window.katex = {
    enable: "",
    jsCdn: "//cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.js",
    cssCdn: "//cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.css"
  }
  window.mermaid = {
    enable: "",
    theme: "",
    cdn: "//cdn.jsdelivr.net/npm/mermaid@10.4.0/dist/mermaid.min.js",
  }
  window.valine = {
    enable: "",
    appId: '4Q4EAMdq8elmFDwiIj0R0Z80-gzGzoHsz',
    appKey: 'JRv5ulQZAwmbGgfeetCXRvoW',
    avatar: 'monsterid',
    cdn: '//unpkg.com/valine@latest/dist/Valine.min.js',
    serverURLs: ''
  };
</script>


<script src="/js/0af3d6bb.js"></script>

  </main>
</body>

<script>
  window.theme = {
    color: 'hsl(238,50%,56%)'
  }
</script>


<script src="/js/69a216b6.js"></script>


</html>
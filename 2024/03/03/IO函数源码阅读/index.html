<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    IO函数源码阅读
  </title>
  <meta name="description" content="">
  <meta name="keywords" content="">
  <meta name="author" content="s1nec-1o">
  <link rel="canonical" href="http://example.com/2024/03/03/IO%E5%87%BD%E6%95%B0%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">
  
  
  <link rel="icon" href='/img/favicon.ico'>
  
  
  
<link rel="stylesheet" href="/css/b4c95347.css">

  <script>window.i18n = {"tip-status-done":"完成","tip-status-default":"全部","tip-status-todo":"计划","tip-status-doing":"进行","tip-status-other":"其他","text-select":"选择","text-move":"移动","text-esc":"退出","January":"一月","February":"二月","March":"三月","April":"四月","May":"五月","June":"六月","July":"七月","August":"八月","September":"九月","October":"十月","November":"十一月","December":"十二月"}</script>
<meta name="generator" content="Hexo 7.0.0"></head>

<body id="app">
  <aside id="aside-box" class="left-aside">
    <div class="header">
      
<link rel="stylesheet" href="/css/61875ce9.css">

<div class="profile">
  <a class="badge" href="/">
    <span>Hi</span>
    <span>s1nec-1o</span>
  </a>
  <cosy-tooltip id="left-aside-button" placement="right">
    <span slot="content">
      <span>显示 / 隐藏 左侧导航</span>
      <cosy-short-key>[</cosy-short-key>
    </span>
    <cosy-icon>
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20">
        <g fill="none">
          <path d="M16 4c1.104-.019 2 .896 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h12zm1 2a1 1 0 0 0-1-1h-2.995v10H16a1 1 0 0 0 1-1V6zm-4.995 9V5H4.001a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8.004z" fill="currentColor"></path>
        </g>
      </svg>
    </cosy-icon>
  </cosy-tooltip>
</div>

<script src="/js/a66044b6.js"></script>

      


<cosy-search id="post-search" placeholder="搜索">
  <div slot="short-key">
    <cosy-short-key>⌘</cosy-short-key>
    <cosy-short-key>K</cosy-short-key>
  </div>
</cosy-search>


<script>
  window.algolia = {
    appId: "R34LY1BBPU",
    SearchOnlyAPIKey: "4fd025154505a4b00fb416f52993d700"
  }
</script>


<script src="/js/5f00f278.js"></script>

    </div>
    <div class="aside-category">
      
<link rel="stylesheet" href="/css/db04a759.css">


<nav class="category-nav cosy-scrollbar">
  <ul><li data-path="archives">
        <a href="/archives">
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20"><g fill="none"><path d="M3.5 3A1.5 1.5 0 0 0 2 4.5v4A1.5 1.5 0 0 0 3.5 10h9A1.5 1.5 0 0 0 14 8.5v-4A1.5 1.5 0 0 0 12.5 3h-9zM3 4.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5v-4zm.5 6.5A1.5 1.5 0 0 0 2 12.5v4A1.5 1.5 0 0 0 3.5 18h9a1.5 1.5 0 0 0 1.5-1.5v-4a1.5 1.5 0 0 0-1.5-1.5h-9zM3 12.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5v-4zm14-.063a2.003 2.003 0 0 1-2.5-1.937A2 2 0 0 1 16 8.563a2.005 2.005 0 0 1 1 0a2 2 0 0 1 0 3.874zM16.5 3a.5.5 0 0 1 .5.5v4.041a3.02 3.02 0 0 0-1 0V3.5a.5.5 0 0 1 .5-.5zm0 10.5c-.17 0-.337-.014-.5-.041V17.5a.5.5 0 0 0 1 0v-4.041c-.163.027-.33.041-.5.041z" fill="currentColor"></path></g></svg>
          <div class="ellipsis">归档</div>
        </a>
      </li><li data-path="cosy-roadmap">
        <a href="/cosy-roadmap">
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20"><g fill="none"><path d="M9.384 2a1 1 0 0 0-.966.742L4.616 17H2.5a.5.5 0 0 0 0 1h15a.5.5 0 0 0 0-1h-2.116L11.582 2.742A1 1 0 0 0 10.616 2H9.384zM5.651 17l.8-3H11.5a.5.5 0 0 0 0-1H6.717l.534-2H10.5a.5.5 0 0 0 0-1H7.517l1.867-7h1.232l3.733 14H5.651z" fill="currentColor"></path></g></svg>
          <div class="ellipsis">路线图</div>
        </a>
      </li><li data-path="cosy-resume">
        <a href="/cosy-resume">
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20"><g fill="none"><path d="M8.5 4.498a1.5 1.5 0 1 1 3 0a1.5 1.5 0 0 1-3 0zm1.5-2.5a2.5 2.5 0 0 0-2.43 3.086L5.471 4.15a1.761 1.761 0 0 0-2.317.88c-.4.882-.008 1.917.877 2.31L7 8.662v2.287l-1.877 4.645a1.75 1.75 0 0 0 3.245 1.311l1.556-3.849a.073.073 0 0 1 .028-.038a.086.086 0 0 1 .046-.012c.02 0 .035.005.046.012a.074.074 0 0 1 .028.038l1.555 3.849a1.75 1.75 0 0 0 3.245-1.311L13 10.96V8.662l2.968-1.322a1.74 1.74 0 0 0 .877-2.31a1.761 1.761 0 0 0-2.317-.88l-2.097.934a2.5 2.5 0 0 0-2.43-3.086zM4.065 5.444a.761.761 0 0 1 1-.38l3.918 1.744a2.5 2.5 0 0 0 2.034 0l3.918-1.744a.761.761 0 0 1 1 .38a.739.739 0 0 1-.373.983l-2.969 1.321a1 1 0 0 0-.593.914v2.298a1 1 0 0 0 .073.375l1.872 4.633a.75.75 0 0 1-1.39.562l-1.556-3.849c-.364-.9-1.639-.9-2.003 0l-1.555 3.85a.75.75 0 1 1-1.39-.562l1.876-4.646A1 1 0 0 0 8 10.95V8.662a1 1 0 0 0-.593-.914L4.438 6.427a.739.739 0 0 1-.373-.983z" fill="currentColor"></path></g></svg>
          <div class="ellipsis">简历</div>
        </a>
      </li><li data-path="link">
        <a href="/link">
          <svg t="1705378180027" class="icon" viewBox="-250 -250 1400 1400" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1450" width="200" height="200"><path d="M593.94368 715.648a10.688 10.688 0 0 0-14.976 0L424.21568 870.4c-71.68 71.68-192.576 79.232-271.68 0-79.232-79.232-71.616-200 0-271.616l154.752-154.752a10.688 10.688 0 0 0 0-15.04l-52.992-52.992a10.688 10.688 0 0 0-15.04 0L84.50368 530.688a287.872 287.872 0 0 0 0 407.488 288 288 0 0 0 407.488 0l154.752-154.752a10.688 10.688 0 0 0 0-15.04l-52.736-52.736z m344.384-631.168a288.256 288.256 0 0 1 0 407.616l-154.752 154.752a10.688 10.688 0 0 1-15.04 0l-52.992-52.992a10.688 10.688 0 0 1 0-15.104l154.752-154.688c71.68-71.68 79.232-192.448 0-271.68-79.104-79.232-200-71.68-271.68 0L443.92768 307.2a10.688 10.688 0 0 1-15.04 0l-52.864-52.864a10.688 10.688 0 0 1 0-15.04l154.88-154.752a287.872 287.872 0 0 1 407.424 0z m-296.32 240.896l52.672 52.736a10.688 10.688 0 0 1 0 15.04l-301.504 301.44a10.688 10.688 0 0 1-15.04 0l-52.736-52.672a10.688 10.688 0 0 1 0-15.04l301.632-301.504a10.688 10.688 0 0 1 15.04 0z" fill="currentColor" p-id="1451"></path></svg>
          <div class="ellipsis">友链</div>
        </a>
      </li></ul>
  <ul><li class="">
        <a href="/categories/2024ROIS%E5%86%AC%E4%BB%A4%E8%90%A5/">
          
          <div class="ellipsis">
            <span>2024ROIS冬令营</span>
          </div>
        </a>
      </li><li class="active">
        <a href="/categories/Pwn%E7%9F%A5%E8%AF%86/">
          
          <div class="ellipsis">
            <span>Pwn知识</span>
          </div>
        </a>
      </li><li class="">
        <a href="/categories/%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/">
          
          <div class="ellipsis">
            <span>做题记录</span>
          </div>
        </a>
      </li><li class="">
        <a href="/categories/%E5%B0%8F%E6%AF%94%E8%B5%9B/">
          
          <div class="ellipsis">
            <span>小比赛</span>
          </div>
        </a>
      </li><li class="">
        <a href="/categories/%E6%80%BB%E7%BB%93/">
          
          <div class="ellipsis">
            <span>总结</span>
          </div>
        </a>
      </li></ul>
</nav>


<script src="/js/118098c2.js"></script>

    </div>
    <div class="bottom">
      <cosy-tooltip id="button-preference" placement="right">
        <span slot="content">
          <span>偏好</span>
          <cosy-short-key>⌘</cosy-short-key>
          <cosy-short-key>p</cosy-short-key>
        </span>
        <cosy-icon bordered id="button-about-cosy-theme">
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 16 16">
            <g fill="none">
              <path d="M8 6a2 2 0 1 0 0 4a2 2 0 0 0 0-4zM7 8a1 1 0 1 1 2 0a1 1 0 0 1-2 0zm3.618-3.602a.708.708 0 0 1-.824-.567l-.26-1.416a.354.354 0 0 0-.275-.282a6.072 6.072 0 0 0-2.519 0a.354.354 0 0 0-.275.282l-.259 1.416a.71.71 0 0 1-.936.538l-1.359-.484a.355.355 0 0 0-.382.095c-.569.627-1 1.367-1.262 2.173a.352.352 0 0 0 .108.378l1.102.931a.704.704 0 0 1 0 1.076l-1.102.931a.352.352 0 0 0-.108.378A5.986 5.986 0 0 0 3.53 12.02a.355.355 0 0 0 .382.095l1.36-.484a.708.708 0 0 1 .936.538l.258 1.416c.026.14.135.252.275.281a6.075 6.075 0 0 0 2.52 0a.353.353 0 0 0 .274-.281l.26-1.416a.71.71 0 0 1 .936-.538l1.359.484c.135.048.286.01.382-.095c.569-.627 1-1.367 1.262-2.173a.352.352 0 0 0-.108-.378l-1.102-.931a.703.703 0 0 1 0-1.076l1.102-.931a.352.352 0 0 0 .108-.378A5.985 5.985 0 0 0 12.47 3.98a.355.355 0 0 0-.382-.095l-1.36.484a.71.71 0 0 1-.111.03zm-6.62.58l.937.333a1.71 1.71 0 0 0 2.255-1.3l.177-.97a5.105 5.105 0 0 1 1.265 0l.178.97a1.708 1.708 0 0 0 2.255 1.3L12 4.977c.255.334.467.698.63 1.084l-.754.637a1.704 1.704 0 0 0 0 2.604l.755.637a4.99 4.99 0 0 1-.63 1.084l-.937-.334a1.71 1.71 0 0 0-2.255 1.3l-.178.97a5.099 5.099 0 0 1-1.265 0l-.177-.97a1.708 1.708 0 0 0-2.255-1.3L4 11.023a4.987 4.987 0 0 1-.63-1.084l.754-.638a1.704 1.704 0 0 0 0-2.603l-.755-.637c.164-.386.376-.75.63-1.084z" fill="currentColor"></path>
            </g>
          </svg>
        </cosy-icon>
      </cosy-tooltip>
    </div>
  </aside>
  <main>
    
<link rel="stylesheet" href="/css/9bb9a539.css">


<div class="post-container">
  <header>
    <div class="left">
      
<link rel="stylesheet" href="/css/7d333f9e.css">

<nav class="breadcrumb">
  <section>
    <cosy-tooltip placement="bottom-left">
      <span slot="content"><span>首页</span>
        <cosy-short-key>⌘</cosy-short-key>
        <cosy-short-key>H</cosy-short-key>
      </span>
      <cosy-icon href="/">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20">
          <g fill="none">
            <path d="M8.998 2.388a1.5 1.5 0 0 1 2.005 0l5.5 4.942A1.5 1.5 0 0 1 17 8.445V15.5a1.5 1.5 0 0 1-1.5 1.5H13a1.5 1.5 0 0 1-1.5-1.5V12a.5.5 0 0 0-.5-.5H9a.5.5 0 0 0-.5.5v3.5A1.5 1.5 0 0 1 7 17H4.5A1.5 1.5 0 0 1 3 15.5V8.445c0-.425.18-.83.498-1.115l5.5-4.942zm1.336.744a.5.5 0 0 0-.668 0l-5.5 4.942A.5.5 0 0 0 4 8.445V15.5a.5.5 0 0 0 .5.5H7a.5.5 0 0 0 .5-.5V12A1.5 1.5 0 0 1 9 10.5h2a1.5 1.5 0 0 1 1.5 1.5v3.5a.5.5 0 0 0 .5.5h2.5a.5.5 0 0 0 .5-.5V8.445a.5.5 0 0 0-.166-.371l-5.5-4.942z" fill="currentColor"></path>
          </g>
        </svg>
      </cosy-icon>
    </cosy-tooltip>
    
    
    <svg class="arrow" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20">
      <g fill="none">
        <path d="M7.733 4.207a.75.75 0 0 1 1.06.026l5.001 5.25a.75.75 0 0 1 0 1.035l-5 5.25a.75.75 0 1 1-1.087-1.034L12.216 10l-4.51-4.734a.75.75 0 0 1 .027-1.06z" fill="currentColor"></path>
      </g>
    </svg>
    <a class="ellipsis" href="/categories/Pwn%E7%9F%A5%E8%AF%86/">
      Pwn知识
    </a>
    
    
    
    <svg class="arrow" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20">
      <g fill="none">
        <path d="M7.733 4.207a.75.75 0 0 1 1.06.026l5.001 5.25a.75.75 0 0 1 0 1.035l-5 5.25a.75.75 0 1 1-1.087-1.034L12.216 10l-4.51-4.734a.75.75 0 0 1 .027-1.06z" fill="currentColor"></path>
      </g>
    </svg>
    <span class="ellipsis">
      IO函数源码阅读
    </span>
    
  </section>
</nav>


<script src="/js/31d6cfe0.js"></script>

    </div>
    <div class="right">
      
      <cosy-tooltip id="toc-show-button" placement="left">
        <span slot="content">
          <span>显示 / 隐藏 文章目录</span>
          <cosy-short-key>]</cosy-short-key>
        </span>
        <cosy-icon>
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20">
            <g fill="none">
              <path d="M4 4c-1.104-.019-2 .896-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2H4zM3 6a1 1 0 0 1 1-1h2.995v10H4a1 1 0 0 1-1-1V6zm4.995 9V5h8.004a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H7.995z" fill="currentColor"></path>
            </g>
          </svg>
        </cosy-icon>
      </cosy-tooltip>
      
    </div>
  </header>
  <div class="content">
    <main class="cosy-scrollbar">
      <div class="article-container">
        <!-- 渲染文章内容 -->
        <article>
          <!-- 文章标题 -->
          <h1 class="post-title">IO函数源码阅读</h1>
          <div class="last-updated">
            上次更新: 2024-03-13 21:01:54
          </div>
          <!-- 文章 -->
          <h1 id="IO函数详解"><a href="#IO函数详解" class="headerlink" title="IO函数详解"></a>IO函数详解</h1><p>该版本为libc-2.31</p>
<h2 id="fopen"><a href="#fopen" class="headerlink" title="fopen"></a>fopen</h2><h3 id="IO-new-fopen"><a href="#IO-new-fopen" class="headerlink" title="_IO_new_fopen"></a>_IO_new_fopen</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">FILE <span class="token operator">*</span>
<span class="token function">_IO_new_fopen</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>mode<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token function">__fopen_internal</span> <span class="token punctuation">(</span>filename<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>调用<code>__fopen_internal</code>函数</p>
<h3 id="fopen-internal"><a href="#fopen-internal" class="headerlink" title="__fopen_internal"></a>__fopen_internal</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">FILE <span class="token operator">*</span>
<span class="token function">__fopen_internal</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>mode<span class="token punctuation">,</span> <span class="token keyword">int</span> is32<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">locked_FILE</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">_IO_FILE_plus</span> fp<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_IO_MTSAFE_IO   </span><span class="token comment">//没执行</span></span>
    _IO_lock_t lock<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token keyword">struct</span> <span class="token class-name">_IO_wide_data</span> wd<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token operator">*</span>new_f <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">locked_FILE</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">locked_FILE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//first:分配空间</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>new_f <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_IO_MTSAFE_IO   </span><span class="token comment">//没执行</span></span>
  new_f<span class="token operator">-></span>fp<span class="token punctuation">.</span>file<span class="token punctuation">.</span>_lock <span class="token operator">=</span> <span class="token operator">&amp;</span>new_f<span class="token operator">-></span>lock<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
  <span class="token function">_IO_no_init</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>new_f<span class="token operator">-></span>fp<span class="token punctuation">.</span>file<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>new_f<span class="token operator">-></span>wd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_IO_wfile_jumps<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//second：初始化</span>
  <span class="token function">_IO_JUMPS</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>new_f<span class="token operator">-></span>fp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>_IO_file_jumps<span class="token punctuation">;</span>                    <span class="token comment">//说明所有的_io_file_jump都是同一个vtable</span>
  <span class="token function">_IO_new_file_init_internal</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>new_f<span class="token operator">-></span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">//third：将file链接到_IO_list_all</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_file_fopen</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span><span class="token punctuation">)</span> new_f<span class="token punctuation">,</span> filename<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> is32<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>   <span class="token comment">//forth：打开文件</span>
    <span class="token keyword">return</span> <span class="token function">__fopen_maybe_mmap</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>new_f<span class="token operator">-></span>fp<span class="token punctuation">.</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">_IO_un_link</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>new_f<span class="token operator">-></span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">free</span> <span class="token punctuation">(</span>new_f<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="分配空间部分"><a href="#分配空间部分" class="headerlink" title="分配空间部分"></a>分配空间部分</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">  <span class="token keyword">struct</span> <span class="token class-name">locked_FILE</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">_IO_FILE_plus</span> fp<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_IO_MTSAFE_IO   </span><span class="token comment">//没执行</span></span>
    _IO_lock_t lock<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token keyword">struct</span> <span class="token class-name">_IO_wide_data</span> wd<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token operator">*</span>new_f <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">locked_FILE</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">locked_FILE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>主要是<code>locked_FILE</code>结构体，而其中包含了两个结构体一个<code>_IO_FILE_plus</code>，一个<code>_IO_wide_data</code>，而<code>_IO_FILE_plus</code>又包含<code>FILE</code>和<code>_IO_jump_t</code>，<code>_IO_jump_t</code>即vtable</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">_IO_wide_data</span>
<span class="token punctuation">&#123;</span>
  <span class="token class-name">wchar_t</span> <span class="token operator">*</span>_IO_read_ptr<span class="token punctuation">;</span>	<span class="token comment">/* Current read pointer */</span>  <span class="token comment">//unsigned short</span>
  <span class="token class-name">wchar_t</span> <span class="token operator">*</span>_IO_read_end<span class="token punctuation">;</span>	<span class="token comment">/* End of get area. */</span>
  <span class="token class-name">wchar_t</span> <span class="token operator">*</span>_IO_read_base<span class="token punctuation">;</span>	<span class="token comment">/* Start of putback+get area. */</span>
  <span class="token class-name">wchar_t</span> <span class="token operator">*</span>_IO_write_base<span class="token punctuation">;</span>	<span class="token comment">/* Start of put area. */</span>
  <span class="token class-name">wchar_t</span> <span class="token operator">*</span>_IO_write_ptr<span class="token punctuation">;</span>	<span class="token comment">/* Current put pointer. */</span>
  <span class="token class-name">wchar_t</span> <span class="token operator">*</span>_IO_write_end<span class="token punctuation">;</span>	<span class="token comment">/* End of put area. */</span>
  <span class="token class-name">wchar_t</span> <span class="token operator">*</span>_IO_buf_base<span class="token punctuation">;</span>	<span class="token comment">/* Start of reserve area. */</span>
  <span class="token class-name">wchar_t</span> <span class="token operator">*</span>_IO_buf_end<span class="token punctuation">;</span>		<span class="token comment">/* End of reserve area. */</span>
  <span class="token comment">/* The following fields are used to support backing up and undo. */</span>
  <span class="token class-name">wchar_t</span> <span class="token operator">*</span>_IO_save_base<span class="token punctuation">;</span>	<span class="token comment">/* Pointer to start of non-current get area. */</span>
  <span class="token class-name">wchar_t</span> <span class="token operator">*</span>_IO_backup_base<span class="token punctuation">;</span>	<span class="token comment">/* Pointer to first valid character of
				   backup area */</span>
  <span class="token class-name">wchar_t</span> <span class="token operator">*</span>_IO_save_end<span class="token punctuation">;</span>	<span class="token comment">/* Pointer to end of non-current get area. */</span>

  __mbstate_t _IO_state<span class="token punctuation">;</span>
  __mbstate_t _IO_last_state<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">_IO_codecvt</span> _codecvt<span class="token punctuation">;</span>

  <span class="token class-name">wchar_t</span> _shortbuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">_IO_jump_t</span> <span class="token operator">*</span>_wide_vtable<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>_IO_wide_data</code>是用于处理宽字符的输入和输出的，只有在调用 glibc 提供的宽字符输入输出函数（如 <code>fgetwc()</code>、<code>fputwc()</code> 等）时，会使用 <code>_IO_wide_data</code> 结构体中的字段来处理宽字符数据的读取和写入。</p>
<p>至于<code>FILE</code>则是在<code>./libio/bits/types/FILE.h:typedef struct _IO_FILE FILE;</code>被赋为<code>_IO_FILE</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">_IO_FILE</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> _flags<span class="token punctuation">;</span>		<span class="token comment">/* High-order word is _IO_MAGIC; rest is flags. */</span>

  <span class="token comment">/* The following pointers correspond to the C++ streambuf protocol. */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_read_ptr<span class="token punctuation">;</span>	<span class="token comment">/* Current read pointer */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_read_end<span class="token punctuation">;</span>	<span class="token comment">/* End of get area. */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_read_base<span class="token punctuation">;</span>	<span class="token comment">/* Start of putback+get area. */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_write_base<span class="token punctuation">;</span>	<span class="token comment">/* Start of put area. */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_write_ptr<span class="token punctuation">;</span>	<span class="token comment">/* Current put pointer. */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_write_end<span class="token punctuation">;</span>	<span class="token comment">/* End of put area. */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_buf_base<span class="token punctuation">;</span>	<span class="token comment">/* Start of reserve area. */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_buf_end<span class="token punctuation">;</span>	<span class="token comment">/* End of reserve area. */</span>

  <span class="token comment">/* The following fields are used to support backing up and undo. */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_save_base<span class="token punctuation">;</span> <span class="token comment">/* Pointer to start of non-current get area. */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_backup_base<span class="token punctuation">;</span>  <span class="token comment">/* Pointer to first valid character of backup area */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_save_end<span class="token punctuation">;</span> <span class="token comment">/* Pointer to end of non-current get area. */</span>

  <span class="token keyword">struct</span> <span class="token class-name">_IO_marker</span> <span class="token operator">*</span>_markers<span class="token punctuation">;</span>

  <span class="token keyword">struct</span> <span class="token class-name">_IO_FILE</span> <span class="token operator">*</span>_chain<span class="token punctuation">;</span>

  <span class="token keyword">int</span> _fileno<span class="token punctuation">;</span>
  <span class="token keyword">int</span> _flags2<span class="token punctuation">;</span>
  __off_t _old_offset<span class="token punctuation">;</span> <span class="token comment">/* This used to be _offset but it's too small.  */</span>

  <span class="token comment">/* 1+column number of pbase(); 0 is unknown. */</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">short</span> _cur_column<span class="token punctuation">;</span>
  <span class="token keyword">signed</span> <span class="token keyword">char</span> _vtable_offset<span class="token punctuation">;</span>
  <span class="token keyword">char</span> _shortbuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  _IO_lock_t <span class="token operator">*</span>_lock<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_IO_USE_OLD_IO_FILE</span></span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="初始化部分"><a href="#初始化部分" class="headerlink" title="初始化部分"></a>初始化部分</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">_IO_no_init</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>new_f<span class="token operator">-></span>fp<span class="token punctuation">.</span>file<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>new_f<span class="token operator">-></span>wd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_IO_wfile_jumps<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//second：初始化</span>
<span class="token function">_IO_JUMPS</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>new_f<span class="token operator">-></span>fp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>_IO_file_jumps<span class="token punctuation">;</span>                    <span class="token comment">//说明所有的_io_file_jump都是同一个vtable</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>主要是其中的<code>_IO_no_init</code>，至于下一个语句就比较好理解，只要是同一种vtable类型，那么vtable就在libc.so段上，不能改，但是能改指向vtable的指针，就不过多缀叙了</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">_IO_no_init</span> <span class="token punctuation">(</span>FILE <span class="token operator">*</span>fp<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> orientation<span class="token punctuation">,</span>
	     <span class="token keyword">struct</span> <span class="token class-name">_IO_wide_data</span> <span class="token operator">*</span>wd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">_IO_jump_t</span> <span class="token operator">*</span>jmp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">_IO_old_init</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_mode <span class="token operator">=</span> orientation<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>orientation <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      fp<span class="token operator">-></span>_wide_data <span class="token operator">=</span> wd<span class="token punctuation">;</span>
      fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_buf_base <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_buf_end <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_read_base <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_read_ptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_read_end <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_write_base <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_write_ptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_write_end <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_save_base <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_backup_base <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_save_end <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

      fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_wide_vtable <span class="token operator">=</span> jmp<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span>
    <span class="token comment">/* Cause predictable crash when a wide function is called on a byte
       stream.  */</span>
    fp<span class="token operator">-></span>_wide_data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">_IO_wide_data</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_freeres_list <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到这个主要部分都被NULL掉了</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">_IO_old_init</span> <span class="token punctuation">(</span>FILE <span class="token operator">*</span>fp<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  fp<span class="token operator">-></span>_flags <span class="token operator">=</span> _IO_MAGIC<span class="token operator">|</span>flags<span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_flags2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>stdio_needs_locking<span class="token punctuation">)</span>
    fp<span class="token operator">-></span>_flags2 <span class="token operator">|=</span> _IO_FLAGS2_NEED_LOCK<span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_IO_buf_base <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_IO_buf_end <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_IO_read_base <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_IO_read_ptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_IO_read_end <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_IO_write_base <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_IO_write_ptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_IO_write_end <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_chain <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">/* Not necessary. */</span>

  fp<span class="token operator">-></span>_IO_save_base <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_IO_backup_base <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_IO_save_end <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_markers <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_cur_column <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">_IO_JUMPS_OFFSET</span></span>
  fp<span class="token operator">-></span>_vtable_offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_IO_MTSAFE_IO</span></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_lock <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token function">_IO_lock_init</span> <span class="token punctuation">(</span><span class="token operator">*</span>fp<span class="token operator">-></span>_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202403132101139.png" alt="image-20240301235011497" style="zoom:50%;" />

<p>这张图非常好的描述了初始化后的情况</p>
<h3 id="链接file部分"><a href="#链接file部分" class="headerlink" title="链接file部分"></a>链接file部分</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">_IO_new_file_init_internal</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>new_f<span class="token operator">-></span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">//third：将file链接到_IO_list_all</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>跟进</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">_IO_new_file_init_internal</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">_IO_FILE_plus</span> <span class="token operator">*</span>fp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">/* POSIX.1 allows another file handle to be used to change the position
     of our file descriptor.  Hence we actually don't know the actual
     position before we do the first fseek (and until a following fflush). */</span>
  fp<span class="token operator">-></span>file<span class="token punctuation">.</span>_offset <span class="token operator">=</span> _IO_pos_BAD<span class="token punctuation">;</span>
  fp<span class="token operator">-></span>file<span class="token punctuation">.</span>_flags <span class="token operator">|=</span> CLOSED_FILEBUF_FLAGS<span class="token punctuation">;</span>   

  <span class="token function">_IO_link_in</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>file<span class="token punctuation">.</span>_fileno <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>   <span class="token comment">//设置_fileno -1</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>主要的作用是调用<code>_IO_link_in</code>和设置<code>_fileno</code>为-1</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">_IO_link_in</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">_IO_FILE_plus</span> <span class="token operator">*</span>fp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fp<span class="token operator">-></span>file<span class="token punctuation">.</span>_flags <span class="token operator">&amp;</span> _IO_LINKED<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      fp<span class="token operator">-></span>file<span class="token punctuation">.</span>_flags <span class="token operator">|=</span> _IO_LINKED<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_IO_MTSAFE_IO</span></span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
      fp<span class="token operator">-></span>file<span class="token punctuation">.</span>_chain <span class="token operator">=</span> <span class="token punctuation">(</span>FILE <span class="token operator">*</span><span class="token punctuation">)</span> _IO_list_all<span class="token punctuation">;</span>
      _IO_list_all <span class="token operator">=</span> fp<span class="token punctuation">;</span>    <span class="token comment">//通过_IO_list_all来赋值chain</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_IO_MTSAFE_IO</span></span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>_IO_link_in<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>主要是通过<code>_IO_list_all</code>来赋值<code>chain</code>以此链接<code>file</code>链</p>
<h3 id="IO-file-fopen打开文件句柄部分"><a href="#IO-file-fopen打开文件句柄部分" class="headerlink" title="_IO_file_fopen打开文件句柄部分"></a>_IO_file_fopen打开文件句柄部分</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_file_fopen</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span><span class="token punctuation">)</span> new_f<span class="token punctuation">,</span> filename<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> is32<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token function">__fopen_maybe_mmap</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>new_f<span class="token operator">-></span>fp<span class="token punctuation">.</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">_IO_un_link</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>new_f<span class="token operator">-></span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">free</span> <span class="token punctuation">(</span>new_f<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>先是调用<code>_IO_file_fopen</code>函数来打开文件，之后又再次调用<code>_IO_un_link</code>函数，之后free掉new_f？</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">_IO_FILE <span class="token operator">*</span>
<span class="token function">_IO_new_file_fopen</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span>fp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>mode<span class="token punctuation">,</span>
            <span class="token keyword">int</span> is32not64<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token comment">// 检查文件是否以打开，打开则返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_file_is_open</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// 设置文件打开模式</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token operator">*</span>mode<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
    <span class="token keyword">case</span> <span class="token char">'r'</span><span class="token operator">:</span>
      omode <span class="token operator">=</span> O_RDONLY<span class="token punctuation">;</span>
      read_write <span class="token operator">=</span> _IO_NO_WRITES<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    
     <span class="token punctuation">&#125;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token comment">// 调用_IO_file_open函数</span>
  result <span class="token operator">=</span> <span class="token function">_IO_file_open</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> filename<span class="token punctuation">,</span> omode<span class="token operator">|</span>oflags<span class="token punctuation">,</span> oprot<span class="token punctuation">,</span> read_write<span class="token punctuation">,</span>
              is32not64<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span>
<span class="token function">libc_hidden_ver</span> <span class="token punctuation">(</span>_IO_new_file_fopen<span class="token punctuation">,</span> _IO_file_fopen<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c">FILE <span class="token operator">*</span>
<span class="token function">_IO_file_open</span> <span class="token punctuation">(</span>FILE <span class="token operator">*</span>fp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token keyword">int</span> posix_mode<span class="token punctuation">,</span> <span class="token keyword">int</span> prot<span class="token punctuation">,</span>
	       <span class="token keyword">int</span> read_write<span class="token punctuation">,</span> <span class="token keyword">int</span> is32not64<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> fdesc<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_flags2 <span class="token operator">&amp;</span> _IO_FLAGS2_NOTCANCEL<span class="token punctuation">)</span><span class="token punctuation">)</span>
    fdesc <span class="token operator">=</span> <span class="token function">__open_nocancel</span> <span class="token punctuation">(</span>filename<span class="token punctuation">,</span>
			     posix_mode <span class="token operator">|</span> <span class="token punctuation">(</span>is32not64 <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> O_LARGEFILE<span class="token punctuation">)</span><span class="token punctuation">,</span> prot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    fdesc <span class="token operator">=</span> <span class="token function">__open</span> <span class="token punctuation">(</span>filename<span class="token punctuation">,</span> posix_mode <span class="token operator">|</span> <span class="token punctuation">(</span>is32not64 <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> O_LARGEFILE<span class="token punctuation">)</span><span class="token punctuation">,</span> prot<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//系统调用open</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fdesc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> 
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_fileno <span class="token operator">=</span> fdesc<span class="token punctuation">;</span>            <span class="token comment">//将文件描述符设置到fileno上</span>
  <span class="token function">_IO_mask_flags</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> read_write<span class="token punctuation">,</span>_IO_NO_READS<span class="token operator">+</span>_IO_NO_WRITES<span class="token operator">+</span>_IO_IS_APPENDING<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* For append mode, send the file offset to the end of the file.  Don't
     update the offset cache though, since the file handle is not active.  */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>read_write <span class="token operator">&amp;</span> <span class="token punctuation">(</span>_IO_IS_APPENDING <span class="token operator">|</span> _IO_NO_READS<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token operator">==</span> <span class="token punctuation">(</span>_IO_IS_APPENDING <span class="token operator">|</span> _IO_NO_READS<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token class-name">off64_t</span> new_pos <span class="token operator">=</span> <span class="token function">_IO_SYSSEEK</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> _IO_seek_end<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>new_pos <span class="token operator">==</span> _IO_pos_BAD <span class="token operator">&amp;&amp;</span> errno <span class="token operator">!=</span> ESPIPE<span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
	  <span class="token function">__close_nocancel</span> <span class="token punctuation">(</span>fdesc<span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token function">_IO_link_in</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">_IO_FILE_plus</span> <span class="token operator">*</span><span class="token punctuation">)</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//再次执行_IO_link_in</span>
  <span class="token keyword">return</span> fp<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>函数的主要功能就是执行系统调用<code>open</code>打开文件，并将文件描述符赋值给FILE结构体的<code>_fileno</code>字段，最后再次调用<code>_IO_link_in</code>函数，确保该结构体被链接进入<code>_IO_list_all</code>链表。</p>
<p>执行完<code>_IO_new_file_fopen</code>函数后，FILE结构体为：</p>
<img src="https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202403132101140.png" alt="image-20240302003003453" style="zoom:50%;" />

<p>该函数执行完后，程序返回FILE结构体指针</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>看完代码后，可以将fopen整体的流程可以归纳为：</p>
<ol>
<li><code>malloc</code>分配内存空间。</li>
<li><code>_IO_no_init</code> 对file结构体进行<code>null</code>初始化。</li>
<li><code>_IO_file_init</code>将结构体链接进<code>_IO_list_all</code>链表。</li>
<li><code>_IO_file_fopen</code>执行系统调用打开文件。</li>
</ol>
<p>整个流程还是比较简单的，fopen返回之后<code>_IO_list_all</code>链表指向返回的FILE结构体，且FILE结构体的_chain字段指向之前的结构体（没有其他额外打开文件的话，将是指向<code>stderr</code>），同时其他的字段大多都是默认的null值，<code>vtable</code>存储的是<code>__GI__IO_file_jumps</code>函数表</p>
<img src="https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202403132101141.png" alt="image-20240302003126840" style="zoom:50%;" />

<h2 id="fread"><a href="#fread" class="headerlink" title="fread"></a>fread</h2><p>大致的流程如下</p>
<img src="https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202403132101143.png" alt="image-20240302135632361" style="zoom:50%;" />

<h3 id="IO-fread"><a href="#IO-fread" class="headerlink" title="_IO_fread"></a>_IO_fread</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">size_t</span>
<span class="token function">_IO_fread</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> FILE <span class="token operator">*</span>fp<span class="token punctuation">)</span>   <span class="token comment">//buf：缓冲区，fp：要读取的文件</span>
<span class="token punctuation">&#123;</span>
  <span class="token class-name">size_t</span> bytes_requested <span class="token operator">=</span> size <span class="token operator">*</span> count<span class="token punctuation">;</span>
  <span class="token class-name">size_t</span> bytes_read<span class="token punctuation">;</span>
  <span class="token function">CHECK_FILE</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes_requested <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">_IO_acquire_lock</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  bytes_read <span class="token operator">=</span> <span class="token function">_IO_sgetn</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> buf<span class="token punctuation">,</span> bytes_requested<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">_IO_release_lock</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> bytes_requested <span class="token operator">==</span> bytes_read <span class="token operator">?</span> count <span class="token operator">:</span> bytes_read <span class="token operator">/</span> size<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>_IO_fread<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>主要是调用<code>_IO_sgetn</code>函数</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">size_t</span>
<span class="token function">_IO_sgetn</span> <span class="token punctuation">(</span>FILE <span class="token operator">*</span>fp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token class-name">size_t</span> n<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">/* FIXME handle putback buffer here! */</span>
  <span class="token keyword">return</span> <span class="token function">_IO_XSGETN</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> data<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>_IO_sgetn<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>而其中调用了<code>_IO_XSGETN</code>其中又<code>#define _IO_XSGETN(FP, DATA, N) JUMP2 (__xsgetn, FP, DATA, N)</code>宏定义了为<code>_IO_file_xsgetn</code></p>
<h3 id="IO-file-xsgetn"><a href="#IO-file-xsgetn" class="headerlink" title="_IO_file_xsgetn"></a>_IO_file_xsgetn</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">size_t</span>
<span class="token function">_IO_file_xsgetn</span> <span class="token punctuation">(</span>FILE <span class="token operator">*</span>fp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token class-name">size_t</span> n<span class="token punctuation">)</span><span class="token comment">/*fp：指向要读取数据的文件流的指针。data：指向用户缓冲区的指针。n：要读取的数据的数量。*/</span>
<span class="token punctuation">&#123;</span>
  <span class="token class-name">size_t</span> want<span class="token punctuation">,</span> have<span class="token punctuation">;</span>
  <span class="token class-name">ssize_t</span> count<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>s <span class="token operator">=</span> data<span class="token punctuation">;</span>       <span class="token comment">//s是用户缓冲区</span>

  want <span class="token operator">=</span> n<span class="token punctuation">;</span>         <span class="token comment">//want是要存储数据的数量</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_buf_base <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token comment">/* Maybe we already have a push back pointer.  */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_save_base <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
	  <span class="token function">free</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_save_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
	  fp<span class="token operator">-></span>_flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>_IO_IN_BACKUP<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
      <span class="token function">_IO_doallocbuf</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//first：如果未创建缓冲区则调用_IO_doallocbuf创建</span>
    <span class="token punctuation">&#125;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>want <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      have <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_read_end <span class="token operator">-</span> fp<span class="token operator">-></span>_IO_read_ptr<span class="token punctuation">;</span>   <span class="token comment">//输入缓冲区的数据</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>want <span class="token operator">&lt;=</span> have<span class="token punctuation">)</span>       
	<span class="token punctuation">&#123;</span>
	  <span class="token function">memcpy</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> fp<span class="token operator">-></span>_IO_read_ptr<span class="token punctuation">,</span> want<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//second：如果输入缓冲区有data，则拷贝输入缓冲区</span>
	  fp<span class="token operator">-></span>_IO_read_ptr <span class="token operator">+=</span> want<span class="token punctuation">;</span>          
	  want <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
      <span class="token keyword">else</span>          <span class="token comment">//third：如果输入缓冲区为0或不满足需求</span>
	<span class="token punctuation">&#123;</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span>have <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
	    <span class="token punctuation">&#123;</span>
	      s <span class="token operator">=</span> <span class="token function">__mempcpy</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> fp<span class="token operator">-></span>_IO_read_ptr<span class="token punctuation">,</span> have<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//先将能拷贝的拷贝到用户缓冲区</span>
	      want <span class="token operator">-=</span> have<span class="token punctuation">;</span>
	      fp<span class="token operator">-></span>_IO_read_ptr <span class="token operator">+=</span> have<span class="token punctuation">;</span>
	    <span class="token punctuation">&#125;</span>

	  <span class="token comment">/* Check for backup and repeat */</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_in_backup</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">)</span>              <span class="token comment">//_IO_IN_BACKUP 标志位用于指示文件流是否有一个输入缓冲区的备份</span>
	    <span class="token punctuation">&#123;</span>
	      <span class="token function">_IO_switch_to_main_get_area</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//切换文件流的输入缓冲区为主要区域</span>
	      <span class="token keyword">continue</span><span class="token punctuation">;</span>
	    <span class="token punctuation">&#125;</span>

	  <span class="token comment">/* If we now want less than a buffer, underflow and repeat
	     the copy.  Otherwise, _IO_SYSREAD directly to
	     the user buffer. */</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_buf_base
	      <span class="token operator">&amp;&amp;</span> want <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_buf_end <span class="token operator">-</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
	    <span class="token punctuation">&#123;</span>
	      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__underflow</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>

	      <span class="token keyword">continue</span><span class="token punctuation">;</span>
	    <span class="token punctuation">&#125;</span>

	  <span class="token comment">/* These must be set before the sysread as we might longjmp out
	     waiting for input. */</span>
	  <span class="token function">_IO_setg</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">,</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">,</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token function">_IO_setp</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">,</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">)</span><span class="token punctuation">;</span>

	  <span class="token comment">/* Try to maintain alignment: read a whole number of blocks.  */</span>
	  count <span class="token operator">=</span> want<span class="token punctuation">;</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">)</span>
	    <span class="token punctuation">&#123;</span>
	      <span class="token class-name">size_t</span> block_size <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_buf_end <span class="token operator">-</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">;</span>
	      <span class="token keyword">if</span> <span class="token punctuation">(</span>block_size <span class="token operator">>=</span> <span class="token number">128</span><span class="token punctuation">)</span>
		count <span class="token operator">-=</span> want <span class="token operator">%</span> block_size<span class="token punctuation">;</span>
	    <span class="token punctuation">&#125;</span>

	  count <span class="token operator">=</span> <span class="token function">_IO_SYSREAD</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> s<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
	    <span class="token punctuation">&#123;</span>
	      <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		fp<span class="token operator">-></span>_flags <span class="token operator">|=</span> _IO_EOF_SEEN<span class="token punctuation">;</span>
	      <span class="token keyword">else</span>
		fp<span class="token operator">-></span>_flags <span class="token operator">|=</span> _IO_ERR_SEEN<span class="token punctuation">;</span>

	      <span class="token keyword">break</span><span class="token punctuation">;</span>
	    <span class="token punctuation">&#125;</span>

	  s <span class="token operator">+=</span> count<span class="token punctuation">;</span>
	  want <span class="token operator">-=</span> count<span class="token punctuation">;</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_offset <span class="token operator">!=</span> _IO_pos_BAD<span class="token punctuation">)</span>
	    <span class="token function">_IO_pos_adjust</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_offset<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

  <span class="token keyword">return</span> n <span class="token operator">-</span> want<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>_IO_file_xsgetn<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该file虚表函数分为三个部分：</p>
<ul>
<li>首先是判断是否存在输入缓冲区，如果没有则调用<code>_IO_doallocbuf</code>来初始化输入缓冲区；</li>
<li>然后再判断输入缓冲区是否有足够的数据空间，如果有则直接拷贝到用户缓冲区；</li>
<li>如果没有则调用<code>__underflow</code>扩大输入缓冲区，再拷贝至用户缓冲区</li>
</ul>
<h3 id="初始化部分-1"><a href="#初始化部分-1" class="headerlink" title="初始化部分"></a>初始化部分</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"> <span class="token class-name">size_t</span> want<span class="token punctuation">,</span> have<span class="token punctuation">;</span>
 <span class="token class-name">ssize_t</span> count<span class="token punctuation">;</span>
 <span class="token keyword">char</span> <span class="token operator">*</span>s <span class="token operator">=</span> data<span class="token punctuation">;</span>       <span class="token comment">//s是用户缓冲区</span>

 want <span class="token operator">=</span> n<span class="token punctuation">;</span>         <span class="token comment">//want是要存储数据的数量</span>

 <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_buf_base <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
   <span class="token punctuation">&#123;</span>
     <span class="token comment">/* Maybe we already have a push back pointer.  */</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_save_base <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">free</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_save_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>_IO_IN_BACKUP<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
     <span class="token function">_IO_doallocbuf</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//first：如果未创建缓冲区则调用_IO_doallocbuf创建</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>首先会判断是否存在reserve area即<code>fp-&gt;_IO_buf_base == NULL</code>，如果为空的话，就说明resever area还没有被分配出来，则会调用<code>_IO_doallocbuf</code>分配一个reserve area</p>
<h3 id="分配reserve-area"><a href="#分配reserve-area" class="headerlink" title="分配reserve area"></a>分配reserve area</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">_IO_doallocbuf</span> <span class="token punctuation">(</span>FILE <span class="token operator">*</span>fp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">)</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>fp<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> _IO_UNBUFFERED<span class="token punctuation">)</span> <span class="token operator">||</span> fp<span class="token operator">-></span>_mode <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_DOALLOCATE</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token function">_IO_setb</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> fp<span class="token operator">-></span>_shortbuf<span class="token punctuation">,</span> fp<span class="token operator">-></span>_shortbuf<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>_IO_doallocbuf<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中又调用了系统调用<code>_IO_DOALLOCATE</code>，其中调用了<code>IO_file_doallocate</code>，又调用了vtable中的<code>_IO_file_stat</code>函数，而后又执行了系统调用<code>fstat</code>，这个系统调用是来获取文件状态，并且初始化st结构体的。可以看到此时的st_blksize为4096，而这个st_blksize也就是接下来malloc申请的内存大小（也就是reserve area的大小）</p>
<img src="https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202403132101144.png" alt="image-20240302213145338" style="zoom:50%;" />

<p>而后出来之后又调用<code>_IO_setb</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">_IO_setb</span> <span class="token punctuation">(</span>FILE <span class="token operator">*</span>f<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>b<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>eb<span class="token punctuation">,</span> <span class="token keyword">int</span> a<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-></span>_IO_buf_base <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>f<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> _IO_USER_BUF<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">free</span> <span class="token punctuation">(</span>f<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
  f<span class="token operator">-></span>_IO_buf_base <span class="token operator">=</span> b<span class="token punctuation">;</span>
  f<span class="token operator">-></span>_IO_buf_end <span class="token operator">=</span> eb<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span>
    f<span class="token operator">-></span>_flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>_IO_USER_BUF<span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    f<span class="token operator">-></span>_flags <span class="token operator">|=</span> _IO_USER_BUF<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>_IO_setb<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个函数主要就是对<code>_IO_buf_base</code>和<code>_IO_buf_end</code>指针进行赋值。</p>
<p><strong><code>_IO_doallocbuf</code>函数主要是将resever area申请出来(大小为0x1000),并且对<code>_IO_buf_base</code>和<code>_IO_buf_end</code>指针进行赋值</strong>。</p>
<h3 id="从缓冲区拷贝数据部分"><a href="#从缓冲区拷贝数据部分" class="headerlink" title="从缓冲区拷贝数据部分"></a>从缓冲区拷贝数据部分</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"> <span class="token keyword">while</span> <span class="token punctuation">(</span>want <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
   <span class="token punctuation">&#123;</span>
     have <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_read_end <span class="token operator">-</span> fp<span class="token operator">-></span>_IO_read_ptr<span class="token punctuation">;</span>   <span class="token comment">//输入缓冲区的数据</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>want <span class="token operator">&lt;=</span> have<span class="token punctuation">)</span>       
<span class="token punctuation">&#123;</span>
  <span class="token function">memcpy</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> fp<span class="token operator">-></span>_IO_read_ptr<span class="token punctuation">,</span> want<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//second：如果输入缓冲区有data，则拷贝输入缓冲区</span>
  fp<span class="token operator">-></span>_IO_read_ptr <span class="token operator">+=</span> want<span class="token punctuation">;</span>          
  want <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
     <span class="token keyword">else</span>    
<span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>have <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      s <span class="token operator">=</span> <span class="token function">__mempcpy</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> fp<span class="token operator">-></span>_IO_read_ptr<span class="token punctuation">,</span> have<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//先将能拷贝的拷贝到用户缓冲区</span>
      want <span class="token operator">-=</span> have<span class="token punctuation">;</span>
      fp<span class="token operator">-></span>_IO_read_ptr <span class="token operator">+=</span> have<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>结合源码非常好理解</p>
<h3 id="缓冲区缺乏的处理部分"><a href="#缓冲区缺乏的处理部分" class="headerlink" title="缓冲区缺乏的处理部分"></a>缓冲区缺乏的处理部分</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">  <span class="token comment">/* Check for backup and repeat */</span>            <span class="token comment">//third：如果输入缓冲区为0或不满足需求的处理</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_in_backup</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">)</span>              <span class="token comment">//_IO_IN_BACKUP 标志位用于指示文件流是否有一个输入缓冲区的备份</span>
	    <span class="token punctuation">&#123;</span>
	      <span class="token function">_IO_switch_to_main_get_area</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//切换文件流的输入缓冲区为主要区域</span>
	      <span class="token keyword">continue</span><span class="token punctuation">;</span>
	    <span class="token punctuation">&#125;</span>

	  <span class="token comment">/* If we now want less than a buffer, underflow and repeat
	     the copy.  Otherwise, _IO_SYSREAD directly to
	     the user buffer. */</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_buf_base
	      <span class="token operator">&amp;&amp;</span> want <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_buf_end <span class="token operator">-</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
	    <span class="token punctuation">&#123;</span>
	      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__underflow</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>

	      <span class="token keyword">continue</span><span class="token punctuation">;</span>
	    <span class="token punctuation">&#125;</span>

	  <span class="token comment">/* These must be set before the sysread as we might longjmp out
	     waiting for input. */</span>
	  <span class="token function">_IO_setg</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">,</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">,</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token function">_IO_setp</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">,</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">)</span><span class="token punctuation">;</span>

	  <span class="token comment">/* Try to maintain alignment: read a whole number of blocks.  */</span>
	  count <span class="token operator">=</span> want<span class="token punctuation">;</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">)</span>
	    <span class="token punctuation">&#123;</span>
	      <span class="token class-name">size_t</span> block_size <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_buf_end <span class="token operator">-</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">;</span>
	      <span class="token keyword">if</span> <span class="token punctuation">(</span>block_size <span class="token operator">>=</span> <span class="token number">128</span><span class="token punctuation">)</span>
		count <span class="token operator">-=</span> want <span class="token operator">%</span> block_size<span class="token punctuation">;</span>
	    <span class="token punctuation">&#125;</span>

	  count <span class="token operator">=</span> <span class="token function">_IO_SYSREAD</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> s<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//直接读取数据到用户缓冲区</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
	    <span class="token punctuation">&#123;</span>
	      <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		fp<span class="token operator">-></span>_flags <span class="token operator">|=</span> _IO_EOF_SEEN<span class="token punctuation">;</span>
	      <span class="token keyword">else</span>
		fp<span class="token operator">-></span>_flags <span class="token operator">|=</span> _IO_ERR_SEEN<span class="token punctuation">;</span>

	      <span class="token keyword">break</span><span class="token punctuation">;</span>
	    <span class="token punctuation">&#125;</span>

	  s <span class="token operator">+=</span> count<span class="token punctuation">;</span>            <span class="token comment">//更新指针和临时数据</span>
	  want <span class="token operator">-=</span> count<span class="token punctuation">;</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_offset <span class="token operator">!=</span> _IO_pos_BAD<span class="token punctuation">)</span>
	    <span class="token function">_IO_pos_adjust</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_offset<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//更新文件流指针</span>
	<span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

  <span class="token keyword">return</span> n <span class="token operator">-</span> want<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>首先先是如果有缓冲区的备份，那么就会切换输入缓冲区为主要区域(这个不明白)，然后如果reserve area区域足够<code>(want &lt; (size_t) (fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base)))</code>且存在，则会调用<code>__underflow</code>，之后出来便是</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token operator">-></span>_IO_read_base <span class="token operator">=</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">)</span>
<span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token operator">-></span>_IO_read_ptr <span class="token operator">=</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">)</span>
<span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token operator">-></span>_IO_read_end <span class="token operator">=</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">)</span>
<span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token operator">-></span>_IO_write_base <span class="token operator">=</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token operator">-></span>_IO_write_ptr <span class="token operator">=</span> fp<span class="token operator">-></span><span class="token function">_IO_buf_base</span>
<span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token operator">-></span>_IO_write_end <span class="token operator">=</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>疯狂赋值都赋值为<code>_IO_buf_base</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"> <span class="token comment">/* Try to maintain alignment: read a whole number of blocks.  */</span>
 count <span class="token operator">=</span> want<span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">)</span>          
   <span class="token punctuation">&#123;</span>
     <span class="token class-name">size_t</span> block_size <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_buf_end <span class="token operator">-</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>block_size <span class="token operator">>=</span> <span class="token number">128</span><span class="token punctuation">)</span>
count <span class="token operator">-=</span> want <span class="token operator">%</span> block_size<span class="token punctuation">;</span>                 
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>接下来的这个是如果缓冲区足够大，大于等于128，就会进行对齐的操作</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"> count <span class="token operator">=</span> <span class="token function">_IO_SYSREAD</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> s<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//直接读取数据到用户缓冲区</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
   <span class="token punctuation">&#123;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
fp<span class="token operator">-></span>_flags <span class="token operator">|=</span> _IO_EOF_SEEN<span class="token punctuation">;</span>
     <span class="token keyword">else</span>
fp<span class="token operator">-></span>_flags <span class="token operator">|=</span> _IO_ERR_SEEN<span class="token punctuation">;</span>

     <span class="token keyword">break</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>之后便是直接调用_IO_SYSREAD直接读取数据到用户缓冲区</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">  s <span class="token operator">+=</span> count<span class="token punctuation">;</span>            <span class="token comment">//更新指针和临时数据</span>
  want <span class="token operator">-=</span> count<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_offset <span class="token operator">!=</span> _IO_pos_BAD<span class="token punctuation">)</span>
    <span class="token function">_IO_pos_adjust</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_offset<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//更新文件流指针</span>
<span class="token punctuation">&#125;</span>
   <span class="token punctuation">&#125;</span>

 <span class="token keyword">return</span> n <span class="token operator">-</span> want<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>搞完一切，就更新文件流的指针，之后直接return就结束了</p>
<h3 id="underflow"><a href="#underflow" class="headerlink" title="__underflow"></a>__underflow</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span>
<span class="token function">__underflow</span> <span class="token punctuation">(</span>FILE <span class="token operator">*</span>fp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_vtable_offset</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">_IO_fwide</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token constant">EOF</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_mode <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token function">_IO_fwide</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_in_put_mode</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_switch_to_get_mode</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token constant">EOF</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_read_ptr <span class="token operator">&lt;</span> fp<span class="token operator">-></span>_IO_read_end<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> fp<span class="token operator">-></span>_IO_read_ptr<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_in_backup</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">_IO_switch_to_main_get_area</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_read_ptr <span class="token operator">&lt;</span> fp<span class="token operator">-></span>_IO_read_end<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> fp<span class="token operator">-></span>_IO_read_ptr<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_have_markers</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">save_for_backup</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> fp<span class="token operator">-></span>_IO_read_end<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token constant">EOF</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_have_backup</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">_IO_free_backup_area</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">_IO_UNDERFLOW</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>__underflow<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里面首先是大量的check，之后return了一个<code>_IO_UNDERFLOW</code>函数，这个是main</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span>
<span class="token function">_IO_new_file_underflow</span> <span class="token punctuation">(</span>FILE <span class="token operator">*</span>fp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token class-name">ssize_t</span> count<span class="token punctuation">;</span>

  <span class="token comment">/* C99 requires EOF to be "sticky".  */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> _IO_EOF_SEEN<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token constant">EOF</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> _IO_NO_READS<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      fp<span class="token operator">-></span>_flags <span class="token operator">|=</span> _IO_ERR_SEEN<span class="token punctuation">;</span>
      <span class="token function">__set_errno</span> <span class="token punctuation">(</span>EBADF<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token constant">EOF</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_read_ptr <span class="token operator">&lt;</span> fp<span class="token operator">-></span>_IO_read_end<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> fp<span class="token operator">-></span>_IO_read_ptr<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_buf_base <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token comment">/* Maybe we already have a push back pointer.  */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_save_base <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
	  <span class="token function">free</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_save_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
	  fp<span class="token operator">-></span>_flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>_IO_IN_BACKUP<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
      <span class="token function">_IO_doallocbuf</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

  <span class="token comment">/* FIXME This can/should be moved to genops ?? */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>_IO_LINE_BUF<span class="token operator">|</span>_IO_UNBUFFERED<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token comment">/* We used to flush all line-buffered stream.  This really isn't
	 required by any standard.  My recollection is that
	 traditional Unix systems did this for stdout.  stderr better
	 not be line buffered.  So we do just that here
	 explicitly.  --drepper */</span>
      <span class="token function">_IO_acquire_lock</span> <span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token operator">-></span>_flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>_IO_LINKED <span class="token operator">|</span> _IO_NO_WRITES <span class="token operator">|</span> _IO_LINE_BUF<span class="token punctuation">)</span><span class="token punctuation">)</span>
	  <span class="token operator">==</span> <span class="token punctuation">(</span>_IO_LINKED <span class="token operator">|</span> _IO_LINE_BUF<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token function">_IO_OVERFLOW</span> <span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token constant">EOF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">_IO_release_lock</span> <span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

  <span class="token function">_IO_switch_to_get_mode</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* This is very tricky. We have to adjust those
     pointers before we call _IO_SYSREAD () since
     we may longjump () out while waiting for
     input. Those pointers may be screwed up. H.J. */</span>
  fp<span class="token operator">-></span>_IO_read_base <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_read_ptr <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_IO_read_end <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_IO_write_base <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_write_ptr <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_write_end
    <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">;</span>

  count <span class="token operator">=</span> <span class="token function">_IO_SYSREAD</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">,</span>
		       fp<span class="token operator">-></span>_IO_buf_end <span class="token operator">-</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
	fp<span class="token operator">-></span>_flags <span class="token operator">|=</span> _IO_EOF_SEEN<span class="token punctuation">;</span>
      <span class="token keyword">else</span>
	fp<span class="token operator">-></span>_flags <span class="token operator">|=</span> _IO_ERR_SEEN<span class="token punctuation">,</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  fp<span class="token operator">-></span>_IO_read_end <span class="token operator">+=</span> count<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token comment">/* If a stream is read to EOF, the calling application may switch active
	 handles.  As a result, our offset cache would no longer be valid, so
	 unset it.  */</span>
      fp<span class="token operator">-></span>_offset <span class="token operator">=</span> _IO_pos_BAD<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token constant">EOF</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_offset <span class="token operator">!=</span> _IO_pos_BAD<span class="token punctuation">)</span>
    <span class="token function">_IO_pos_adjust</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_offset<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> fp<span class="token operator">-></span>_IO_read_ptr<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">libc_hidden_ver</span> <span class="token punctuation">(</span>_IO_new_file_underflow<span class="token punctuation">,</span> _IO_file_underflow<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>首先也先是大量的检查，然后都赋值为<code>_IO_buf_base</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">fp<span class="token operator">-></span>_IO_read_base <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_read_ptr <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">;</span>
fp<span class="token operator">-></span>_IO_read_end <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">;</span>
fp<span class="token operator">-></span>_IO_write_base <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_write_ptr <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_write_end
  <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>之后再次调用_IO_SYSREAD函数来将数据读到输入缓冲区，之后再一些check就return了</p>
<h3 id="IO-SYSREAD"><a href="#IO-SYSREAD" class="headerlink" title="_IO_SYSREAD"></a>_IO_SYSREAD</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">ssize_t</span>
<span class="token function">_IO_file_read</span> <span class="token punctuation">(</span>FILE <span class="token operator">*</span>fp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">ssize_t</span> size<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_flags2 <span class="token operator">&amp;</span> _IO_FLAGS2_NOTCANCEL<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	  <span class="token operator">?</span> <span class="token function">__read_nocancel</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_fileno<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> size<span class="token punctuation">)</span>
	  <span class="token operator">:</span> <span class="token function">__read</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_fileno<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>_IO_file_read<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>一个非常底层的操作，就不过多赘述了，能大致了解功能应该就差不多？</p>
<h3 id="scanf"><a href="#scanf" class="headerlink" title="scanf"></a>scanf</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">read
_IO_new_file_underflow at fileops<span class="token punctuation">.</span>c
__GI__IO_default_uflow at genops<span class="token punctuation">.</span>c
_IO_vfscanf_internal at vfscanf<span class="token punctuation">.</span>c
__isoc99_scanf at  at isoc99_scanf<span class="token punctuation">.</span>c<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>栈回溯</p>
<p>可以看到scanf最终是<strong>调用stdin的vtable中的<code>_IO_new_file_underflow</code>去调用read</strong>的。</p>
<p>不过它并不是由<code>_IO_file_xsgetn</code>调用的，而是使用vtable中的<code>__uflow</code>，源码如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">C
<span class="token keyword">int</span>
<span class="token function">_IO_default_uflow</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span>fp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> ch <span class="token operator">=</span> <span class="token function">_IO_UNDERFLOW</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ch <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token constant">EOF</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> fp<span class="token operator">-></span>_IO_read_ptr<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>_IO_default_uflow<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>__uflow</code>函数首先直接调用<code>_IO_new_file_underflow</code>,因此最终也是<code>_IO_new_file_underflow</code>实现的输入。之后其只返回<code>_IO_read_ptr</code>处的一个字符</p>
<h3 id="gets"><a href="#gets" class="headerlink" title="gets"></a>gets</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">read
__GI__IO_file_underflow
__GI__IO_default_uflow
gets<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>函数调用栈与scanf基本一致：</p>
<h2 id="fwrite"><a href="#fwrite" class="headerlink" title="fwrite"></a>fwrite</h2><h3 id="IO-fwrite"><a href="#IO-fwrite" class="headerlink" title="_IO_fwrite"></a>_IO_fwrite</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">size_t</span>
<span class="token function">_IO_fwrite</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> FILE <span class="token operator">*</span>fp<span class="token punctuation">)</span><span class="token comment">//buf：要写入的数据的地址，fp：要写入的文件流指针</span>
<span class="token punctuation">&#123;</span>
  <span class="token class-name">size_t</span> request <span class="token operator">=</span> size <span class="token operator">*</span> count<span class="token punctuation">;</span>
  <span class="token class-name">size_t</span> written <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">CHECK_FILE</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>request <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">_IO_acquire_lock</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_vtable_offset</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">_IO_fwide</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    written <span class="token operator">=</span> <span class="token function">_IO_sputn</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> buf<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">_IO_release_lock</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* We have written all of the input in case the return value indicates
     this or EOF is returned.  The latter is a special case where we
     simply did not manage to flush the buffer.  But the data is in the
     buffer and therefore written as far as fwrite is concerned.  */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>written <span class="token operator">==</span> request <span class="token operator">||</span> written <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    <span class="token keyword">return</span> written <span class="token operator">/</span> size<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>_IO_fwrite<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>主要是调用<code>_IO_sputn</code></p>
<h3 id="IO-new-file-xsputn"><a href="#IO-new-file-xsputn" class="headerlink" title="_IO_new_file_xsputn"></a>_IO_new_file_xsputn</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">size_t</span>
<span class="token function">_IO_new_file_xsputn</span> <span class="token punctuation">(</span>FILE <span class="token operator">*</span>f<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token class-name">size_t</span> n<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>s <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> data<span class="token punctuation">;</span>       <span class="token comment">//s是用户缓冲区</span>
  <span class="token class-name">size_t</span> to_do <span class="token operator">=</span> n<span class="token punctuation">;</span>
  <span class="token keyword">int</span> must_flush <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token class-name">size_t</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">/* This is an optimized implementation.
     If the amount to be written straddles a block boundary
     (or the filebuf is unbuffered), use sys_write directly. */</span>

  <span class="token comment">/* First figure out how much space is available in the buffer. */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> _IO_LINE_BUF<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>f<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> _IO_CURRENTLY_PUTTING<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">//标志为当前为行缓冲模式且为写入状态</span>
    <span class="token punctuation">&#123;</span>
      count <span class="token operator">=</span> f<span class="token operator">-></span>_IO_buf_end <span class="token operator">-</span> f<span class="token operator">-></span>_IO_write_ptr<span class="token punctuation">;</span>   <span class="token comment">//count是输入缓冲区的大小</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">>=</span> n<span class="token punctuation">)</span>            
	<span class="token punctuation">&#123;</span>
	  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
	  <span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> s <span class="token operator">+</span> n<span class="token punctuation">;</span> p <span class="token operator">></span> s<span class="token punctuation">;</span> <span class="token punctuation">)</span>
	    <span class="token punctuation">&#123;</span>
	      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">--</span>p <span class="token operator">==</span> <span class="token char">'\n'</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#123;</span>
		  count <span class="token operator">=</span> p <span class="token operator">-</span> s <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
		  must_flush <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		  <span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
	    <span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-></span>_IO_write_end <span class="token operator">></span> f<span class="token operator">-></span>_IO_write_ptr<span class="token punctuation">)</span>
    count <span class="token operator">=</span> f<span class="token operator">-></span>_IO_write_end <span class="token operator">-</span> f<span class="token operator">-></span>_IO_write_ptr<span class="token punctuation">;</span> <span class="token comment">/* Space available. */</span>

  <span class="token comment">/* Then fill the buffer. */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> to_do<span class="token punctuation">)</span> 
	count <span class="token operator">=</span> to_do<span class="token punctuation">;</span>
      f<span class="token operator">-></span>_IO_write_ptr <span class="token operator">=</span> <span class="token function">__mempcpy</span> <span class="token punctuation">(</span>f<span class="token operator">-></span>_IO_write_ptr<span class="token punctuation">,</span> s<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//直接拷贝数据(all or partial)</span>
      s <span class="token operator">+=</span> count<span class="token punctuation">;</span>
      to_do <span class="token operator">-=</span> count<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>to_do <span class="token operator">+</span> must_flush <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token class-name">size_t</span> block_size<span class="token punctuation">,</span> do_write<span class="token punctuation">;</span>
      <span class="token comment">/* Next flush the (full) buffer. */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_OVERFLOW</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token constant">EOF</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>                           <span class="token comment">//刷新已满缓冲区</span>
	<span class="token comment">/* If nothing else has to be written we must not signal the
	   caller that everything has been written.  */</span>
	<span class="token keyword">return</span> to_do <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token constant">EOF</span> <span class="token operator">:</span> n <span class="token operator">-</span> to_do<span class="token punctuation">;</span>

      <span class="token comment">/* Try to maintain alignment: write a whole number of blocks.  */</span>
      block_size <span class="token operator">=</span> f<span class="token operator">-></span>_IO_buf_end <span class="token operator">-</span> f<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">;</span>
      do_write <span class="token operator">=</span> to_do <span class="token operator">-</span> <span class="token punctuation">(</span>block_size <span class="token operator">>=</span> <span class="token number">128</span> <span class="token operator">?</span> to_do <span class="token operator">%</span> block_size <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//较大：对齐</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>do_write<span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
	  count <span class="token operator">=</span> <span class="token function">new_do_write</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> s<span class="token punctuation">,</span> do_write<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//调用系统调用读取</span>
	  to_do <span class="token operator">-=</span> count<span class="token punctuation">;</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> do_write<span class="token punctuation">)</span>
	    <span class="token keyword">return</span> n <span class="token operator">-</span> to_do<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

      <span class="token comment">/* Now write out the remainder.  Normally, this will fit in the
	 buffer, but it's somewhat messier for line-buffered files,
	 so we let _IO_default_xsputn handle the general case. */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>to_do<span class="token punctuation">)</span>
	to_do <span class="token operator">-=</span> <span class="token function">_IO_default_xsputn</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> s<span class="token operator">+</span>do_write<span class="token punctuation">,</span> to_do<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//剩余数据的写入：因为行缓冲模式较难实现</span>
    <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> n <span class="token operator">-</span> to_do<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">libc_hidden_ver</span> <span class="token punctuation">(</span>_IO_new_file_xsputn<span class="token punctuation">,</span> _IO_file_xsputn<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我认为这个<code>_IO_new_file_xsputn</code>可以分为三个部分：</p>
<ul>
<li>首先是计算有多少可用空间</li>
<li>然后是填充缓冲区</li>
<li>之后刷新缓冲区，并写入数据</li>
<li>最后是对剩余数据的处理</li>
</ul>
<h3 id="计算可用空间部分"><a href="#计算可用空间部分" class="headerlink" title="计算可用空间部分"></a>计算可用空间部分</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>s <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> data<span class="token punctuation">;</span>       <span class="token comment">//s是用户缓冲区</span>
 <span class="token class-name">size_t</span> to_do <span class="token operator">=</span> n<span class="token punctuation">;</span>
 <span class="token keyword">int</span> must_flush <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token class-name">size_t</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

 <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
   <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token comment">/* This is an optimized implementation.
    If the amount to be written straddles a block boundary
    (or the filebuf is unbuffered), use sys_write directly. */</span>

 <span class="token comment">/* First figure out how much space is available in the buffer. */</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> _IO_LINE_BUF<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>f<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> _IO_CURRENTLY_PUTTING<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">//标志为当前为行缓冲模式且为写入状态</span>
   <span class="token punctuation">&#123;</span>
     count <span class="token operator">=</span> f<span class="token operator">-></span>_IO_buf_end <span class="token operator">-</span> f<span class="token operator">-></span>_IO_write_ptr<span class="token punctuation">;</span>   <span class="token comment">//count是输入缓冲区的大小</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">>=</span> n<span class="token punctuation">)</span>            
<span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> s <span class="token operator">+</span> n<span class="token punctuation">;</span> p <span class="token operator">></span> s<span class="token punctuation">;</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">--</span>p <span class="token operator">==</span> <span class="token char">'\n'</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
	  count <span class="token operator">=</span> p <span class="token operator">-</span> s <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
	  must_flush <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	  <span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
   <span class="token punctuation">&#125;</span>
 <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-></span>_IO_write_end <span class="token operator">></span> f<span class="token operator">-></span>_IO_write_ptr<span class="token punctuation">)</span>
   count <span class="token operator">=</span> f<span class="token operator">-></span>_IO_write_end <span class="token operator">-</span> f<span class="token operator">-></span>_IO_write_ptr<span class="token punctuation">;</span> <span class="token comment">/* Space available. */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中会遍历缓冲区，如果有换行符就会+1，这是因为行缓冲区在遇到换行符或者缓冲区满了之后才会停止，只有+1才能保证换行符前面的数据都被写入，之后还会<code>must_flush</code>赋值为1</p>
<h3 id="填充缓冲区部分"><a href="#填充缓冲区部分" class="headerlink" title="填充缓冲区部分"></a>填充缓冲区部分</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"> <span class="token comment">/* Then fill the buffer. */</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
   <span class="token punctuation">&#123;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> to_do<span class="token punctuation">)</span> 
count <span class="token operator">=</span> to_do<span class="token punctuation">;</span>
     f<span class="token operator">-></span>_IO_write_ptr <span class="token operator">=</span> <span class="token function">__mempcpy</span> <span class="token punctuation">(</span>f<span class="token operator">-></span>_IO_write_ptr<span class="token punctuation">,</span> s<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//直接拷贝数据(all or partial)</span>
     s <span class="token operator">+=</span> count<span class="token punctuation">;</span>
     to_do <span class="token operator">-=</span> count<span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这就很好理解了</p>
<h3 id="刷新缓冲区并写入部分"><a href="#刷新缓冲区并写入部分" class="headerlink" title="刷新缓冲区并写入部分"></a>刷新缓冲区并写入部分</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>to_do <span class="token operator">+</span> must_flush <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
   <span class="token punctuation">&#123;</span>
     <span class="token class-name">size_t</span> block_size<span class="token punctuation">,</span> do_write<span class="token punctuation">;</span>
     <span class="token comment">/* Next flush the (full) buffer. */</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_OVERFLOW</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token constant">EOF</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>                           <span class="token comment">//刷新已满缓冲区</span>
<span class="token comment">/* If nothing else has to be written we must not signal the
   caller that everything has been written.  */</span>
<span class="token keyword">return</span> to_do <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token constant">EOF</span> <span class="token operator">:</span> n <span class="token operator">-</span> to_do<span class="token punctuation">;</span>

     <span class="token comment">/* Try to maintain alignment: write a whole number of blocks.  */</span>
     block_size <span class="token operator">=</span> f<span class="token operator">-></span>_IO_buf_end <span class="token operator">-</span> f<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">;</span>
     do_write <span class="token operator">=</span> to_do <span class="token operator">-</span> <span class="token punctuation">(</span>block_size <span class="token operator">>=</span> <span class="token number">128</span> <span class="token operator">?</span> to_do <span class="token operator">%</span> block_size <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//较大：对齐</span>

     <span class="token keyword">if</span> <span class="token punctuation">(</span>do_write<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  count <span class="token operator">=</span> <span class="token function">new_do_write</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> s<span class="token punctuation">,</span> do_write<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//调用系统调用读取</span>
  to_do <span class="token operator">-=</span> count<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> do_write<span class="token punctuation">)</span>
    <span class="token keyword">return</span> n <span class="token operator">-</span> to_do<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果之前有赋值过<code>must_flush</code>又或者此时还有数据没写入，则会刷新缓冲区，然后如果缓冲区很大，则会对齐设置，之后便是调用<code>new_do_write</code>函数，而这个里面是调用了系统调用<code>_IO_SYSWRITE</code></p>
<h3 id="剩余数据的处理部分"><a href="#剩余数据的处理部分" class="headerlink" title="剩余数据的处理部分"></a>剩余数据的处理部分</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">      <span class="token comment">/* Now write out the remainder.  Normally, this will fit in the
	 buffer, but it's somewhat messier for line-buffered files,
	 so we let _IO_default_xsputn handle the general case. */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>to_do<span class="token punctuation">)</span>
	to_do <span class="token operator">-=</span> <span class="token function">_IO_default_xsputn</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> s<span class="token operator">+</span>do_write<span class="token punctuation">,</span> to_do<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//剩余数据的写入：因为行缓冲模式较难实现</span>
    <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> n <span class="token operator">-</span> to_do<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">libc_hidden_ver</span> <span class="token punctuation">(</span>_IO_new_file_xsputn<span class="token punctuation">,</span> _IO_file_xsputn<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>之后便是读入剩余数据，因为行缓冲区需要遇到换行符或者缓冲区满了才会写入，因此不好读取剩余的数据，就会调用<code>_IO_default_xsputn</code>来读取剩余数据，之后return就结束了</p>
<h3 id="IO-OVERFLOW"><a href="#IO-OVERFLOW" class="headerlink" title="_IO_OVERFLOW"></a>_IO_OVERFLOW</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">_IO_OVERFLOW</span><span class="token expression"><span class="token punctuation">(</span>FP<span class="token punctuation">,</span> CH<span class="token punctuation">)</span> <span class="token function">JUMP1</span> <span class="token punctuation">(</span>__overflow<span class="token punctuation">,</span> FP<span class="token punctuation">,</span> CH<span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="IO-new-file-overflow"><a href="#IO-new-file-overflow" class="headerlink" title="_IO_new_file_overflow"></a>_IO_new_file_overflow</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span>
<span class="token function">_IO_new_file_overflow</span> <span class="token punctuation">(</span>FILE <span class="token operator">*</span>f<span class="token punctuation">,</span> <span class="token keyword">int</span> ch<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> _IO_NO_WRITES<span class="token punctuation">)</span> <span class="token comment">/* SET ERROR */</span>
    <span class="token punctuation">&#123;</span>
      f<span class="token operator">-></span>_flags <span class="token operator">|=</span> _IO_ERR_SEEN<span class="token punctuation">;</span>
      <span class="token function">__set_errno</span> <span class="token punctuation">(</span>EBADF<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token constant">EOF</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token comment">/* If currently reading or no buffer allocated. */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> _IO_CURRENTLY_PUTTING<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> f<span class="token operator">-></span>_IO_write_base <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>   <span class="token comment">//当前没有正在进行写入操作或者没有分配缓冲区</span>
    <span class="token punctuation">&#123;</span>
      <span class="token comment">/* Allocate a buffer if needed. */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-></span>_IO_write_base <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
	  <span class="token function">_IO_doallocbuf</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>                                            <span class="token comment">//初始化缓冲区</span>
	  <span class="token function">_IO_setg</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> f<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">,</span> f<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">,</span> f<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
      <span class="token comment">/* Otherwise must be currently reading.
	 If _IO_read_ptr (and hence also _IO_read_end) is at the buffer end,
	 logically slide the buffer forwards one block (by setting the
	 read pointers to all point at the beginning of the block).  This
	 makes room for subsequent output.
	 Otherwise, set the read pointers to _IO_read_end (leaving that
	 alone, so it can continue to correspond to the external position). */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span><span class="token function">_IO_in_backup</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
	  <span class="token class-name">size_t</span> nbackup <span class="token operator">=</span> f<span class="token operator">-></span>_IO_read_end <span class="token operator">-</span> f<span class="token operator">-></span>_IO_read_ptr<span class="token punctuation">;</span>
	  <span class="token function">_IO_free_backup_area</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
	  f<span class="token operator">-></span>_IO_read_base <span class="token operator">-=</span> <span class="token function">MIN</span> <span class="token punctuation">(</span>nbackup<span class="token punctuation">,</span>
				   f<span class="token operator">-></span>_IO_read_base <span class="token operator">-</span> f<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
	  f<span class="token operator">-></span>_IO_read_ptr <span class="token operator">=</span> f<span class="token operator">-></span>_IO_read_base<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-></span>_IO_read_ptr <span class="token operator">==</span> f<span class="token operator">-></span>_IO_buf_end<span class="token punctuation">)</span>
	f<span class="token operator">-></span>_IO_read_end <span class="token operator">=</span> f<span class="token operator">-></span>_IO_read_ptr <span class="token operator">=</span> f<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">;</span>
      f<span class="token operator">-></span>_IO_write_ptr <span class="token operator">=</span> f<span class="token operator">-></span>_IO_read_ptr<span class="token punctuation">;</span>
      f<span class="token operator">-></span>_IO_write_base <span class="token operator">=</span> f<span class="token operator">-></span>_IO_write_ptr<span class="token punctuation">;</span>
      f<span class="token operator">-></span>_IO_write_end <span class="token operator">=</span> f<span class="token operator">-></span>_IO_buf_end<span class="token punctuation">;</span>
      f<span class="token operator">-></span>_IO_read_base <span class="token operator">=</span> f<span class="token operator">-></span>_IO_read_ptr <span class="token operator">=</span> f<span class="token operator">-></span>_IO_read_end<span class="token punctuation">;</span>

      f<span class="token operator">-></span>_flags <span class="token operator">|=</span> _IO_CURRENTLY_PUTTING<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-></span>_mode <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> f<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>_IO_LINE_BUF <span class="token operator">|</span> _IO_UNBUFFERED<span class="token punctuation">)</span><span class="token punctuation">)</span>
	f<span class="token operator">-></span>_IO_write_end <span class="token operator">=</span> f<span class="token operator">-></span>_IO_write_ptr<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ch <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">_IO_do_write</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> f<span class="token operator">-></span>_IO_write_base<span class="token punctuation">,</span>
			 f<span class="token operator">-></span>_IO_write_ptr <span class="token operator">-</span> f<span class="token operator">-></span>_IO_write_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-></span>_IO_write_ptr <span class="token operator">==</span> f<span class="token operator">-></span>_IO_buf_end <span class="token punctuation">)</span> <span class="token comment">/* Buffer is really full */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_do_flush</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>               <span class="token comment">//缓冲区满了就会刷新</span>
      <span class="token keyword">return</span> <span class="token constant">EOF</span><span class="token punctuation">;</span>
  <span class="token operator">*</span>f<span class="token operator">-></span>_IO_write_ptr<span class="token operator">++</span> <span class="token operator">=</span> ch<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> _IO_UNBUFFERED<span class="token punctuation">)</span>
      <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> _IO_LINE_BUF<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> ch <span class="token operator">==</span> <span class="token char">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_do_write</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> f<span class="token operator">-></span>_IO_write_base<span class="token punctuation">,</span>
		      f<span class="token operator">-></span>_IO_write_ptr <span class="token operator">-</span> f<span class="token operator">-></span>_IO_write_base<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token constant">EOF</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span> ch<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">libc_hidden_ver</span> <span class="token punctuation">(</span>_IO_new_file_overflow<span class="token punctuation">,</span> _IO_file_overflow<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到除了第50行刷新缓冲区的操作外，第11-45行的if操作是在<code>当前没有正在进行写入操作或者没有分配缓冲区</code>的前提下进行的，大概的功能是了解的，就不过多赘述，所以这段的主要功能便是检查加刷新缓冲区</p>
<h3 id="new-do-write"><a href="#new-do-write" class="headerlink" title="new_do_write"></a>new_do_write</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token class-name">size_t</span>
<span class="token function">new_do_write</span> <span class="token punctuation">(</span>FILE <span class="token operator">*</span>fp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token class-name">size_t</span> to_do<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token class-name">size_t</span> count<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> _IO_IS_APPENDING<span class="token punctuation">)</span>                 <span class="token comment">//该文件是追加模式打开</span>
    <span class="token comment">/* On a system without a proper O_APPEND implementation,
       you would need to sys_seek(0, SEEK_END) here, but is
       not needed nor desirable for Unix- or Posix-like systems.
       Instead, just indicate that offset (before and after) is
       unpredictable. */</span> 
    fp<span class="token operator">-></span>_offset <span class="token operator">=</span> _IO_pos_BAD<span class="token punctuation">;</span>       <span class="token comment">//表明偏移不可预测</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_read_end <span class="token operator">!=</span> fp<span class="token operator">-></span>_IO_write_base<span class="token punctuation">)</span>            <span class="token comment">//如果不等，则说明还有数据未读取</span>
    <span class="token punctuation">&#123;</span>
      <span class="token class-name">off64_t</span> new_pos
	<span class="token operator">=</span> <span class="token function">_IO_SYSSEEK</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> fp<span class="token operator">-></span>_IO_write_base <span class="token operator">-</span> fp<span class="token operator">-></span>_IO_read_end<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//使用该调用，能让指针到正确位置，避免覆盖未读取数据</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>new_pos <span class="token operator">==</span> _IO_pos_BAD<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      fp<span class="token operator">-></span>_offset <span class="token operator">=</span> new_pos<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  count <span class="token operator">=</span> <span class="token function">_IO_SYSWRITE</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> data<span class="token punctuation">,</span> to_do<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">//真正读取数据</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_cur_column <span class="token operator">&amp;&amp;</span> count<span class="token punctuation">)</span>
    fp<span class="token operator">-></span>_cur_column <span class="token operator">=</span> <span class="token function">_IO_adjust_column</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_cur_column <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token function">_IO_setg</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">,</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">,</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">//重置读指针的位置</span>
   fp<span class="token operator">-></span>_IO_write_base <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_write_ptr <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_IO_write_end <span class="token operator">=</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_mode <span class="token operator">&lt;=</span> <span class="token number">0</span>
		       <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>_IO_LINE_BUF <span class="token operator">|</span> _IO_UNBUFFERED<span class="token punctuation">)</span><span class="token punctuation">)</span>
		       <span class="token operator">?</span> fp<span class="token operator">-></span>_IO_buf_base <span class="token operator">:</span> fp<span class="token operator">-></span>_IO_buf_end<span class="token punctuation">)</span><span class="token punctuation">;</span>                
  <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>主要调用<code>_IO_SYSWRITE</code></p>
<h3 id="IO-new-file-write"><a href="#IO-new-file-write" class="headerlink" title="_IO_new_file_write"></a>_IO_new_file_write</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">ssize_t</span>
<span class="token function">_IO_new_file_write</span> <span class="token punctuation">(</span>FILE <span class="token operator">*</span>f<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token class-name">ssize_t</span> n<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token class-name">ssize_t</span> to_do <span class="token operator">=</span> n<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>to_do <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token class-name">ssize_t</span> count <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>f<span class="token operator">-></span>_flags2
                                         <span class="token operator">&amp;</span> _IO_FLAGS2_NOTCANCEL<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
			   <span class="token operator">?</span> <span class="token function">__write_nocancel</span> <span class="token punctuation">(</span>f<span class="token operator">-></span>_fileno<span class="token punctuation">,</span> data<span class="token punctuation">,</span> to_do<span class="token punctuation">)</span>
			   <span class="token operator">:</span> <span class="token function">__write</span> <span class="token punctuation">(</span>f<span class="token operator">-></span>_fileno<span class="token punctuation">,</span> data<span class="token punctuation">,</span> to_do<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
	  f<span class="token operator">-></span>_flags <span class="token operator">|=</span> _IO_ERR_SEEN<span class="token punctuation">;</span>
	  <span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
      to_do <span class="token operator">-=</span> count<span class="token punctuation">;</span>
      data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> data <span class="token operator">+</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  n <span class="token operator">-=</span> to_do<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-></span>_offset <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    f<span class="token operator">-></span>_offset <span class="token operator">+=</span> n<span class="token punctuation">;</span>
  <span class="token keyword">return</span> n<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>主要是调用<code>__write_nocancel</code>或<code>__write</code>来读取数据，想要仔细了解就去看源码吧，只能说是很底层的调用了</p>
<h3 id="IO-default-xsputn"><a href="#IO-default-xsputn" class="headerlink" title="_IO_default_xsputn"></a>_IO_default_xsputn</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">size_t</span>
<span class="token function">_IO_default_xsputn</span> <span class="token punctuation">(</span>FILE <span class="token operator">*</span>f<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token class-name">size_t</span> n<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>s <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> data<span class="token punctuation">;</span>
  <span class="token class-name">size_t</span> more <span class="token operator">=</span> n<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>more <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token comment">/* Space available. */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token operator">-></span>_IO_write_ptr <span class="token operator">&lt;</span> f<span class="token operator">-></span>_IO_write_end<span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
	  <span class="token class-name">size_t</span> count <span class="token operator">=</span> f<span class="token operator">-></span>_IO_write_end <span class="token operator">-</span> f<span class="token operator">-></span>_IO_write_ptr<span class="token punctuation">;</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> more<span class="token punctuation">)</span>
	    count <span class="token operator">=</span> more<span class="token punctuation">;</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> <span class="token number">20</span><span class="token punctuation">)</span>
	    <span class="token punctuation">&#123;</span>
	      f<span class="token operator">-></span>_IO_write_ptr <span class="token operator">=</span> <span class="token function">__mempcpy</span> <span class="token punctuation">(</span>f<span class="token operator">-></span>_IO_write_ptr<span class="token punctuation">,</span> s<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
	      s <span class="token operator">+=</span> count<span class="token punctuation">;</span>
	    <span class="token punctuation">&#125;</span>
	  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>count<span class="token punctuation">)</span>
	    <span class="token punctuation">&#123;</span>
	      <span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> f<span class="token operator">-></span>_IO_write_ptr<span class="token punctuation">;</span>
	      <span class="token class-name">ssize_t</span> i<span class="token punctuation">;</span>
	      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> count<span class="token punctuation">;</span> <span class="token operator">--</span>i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">)</span>
		<span class="token operator">*</span>p<span class="token operator">++</span> <span class="token operator">=</span> <span class="token operator">*</span>s<span class="token operator">++</span><span class="token punctuation">;</span>
	      f<span class="token operator">-></span>_IO_write_ptr <span class="token operator">=</span> p<span class="token punctuation">;</span>
	    <span class="token punctuation">&#125;</span>
	  more <span class="token operator">-=</span> count<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>more <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">_IO_OVERFLOW</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token operator">*</span>s<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
	<span class="token keyword">break</span><span class="token punctuation">;</span>
      more<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> n <span class="token operator">-</span> more<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>_IO_default_xsputn<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里有两种读取方式，也是比较好理解的这段源码，应该是为了性能最佳的考虑吧</p>
<h3 id="printf"><a href="#printf" class="headerlink" title="printf"></a>printf</h3><p>调用栈</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">► f <span class="token number">0</span>   <span class="token number">0x7f6117fd43b0</span> write
  f <span class="token number">1</span>   <span class="token number">0x7f6117f55c0f</span> _IO_file_write<span class="token operator">+</span><span class="token number">143</span>
  f <span class="token number">2</span>   <span class="token number">0x7f6117f5639a</span> _IO_file_xsputn<span class="token operator">+</span><span class="token number">426</span>
  f <span class="token number">3</span>   <span class="token number">0x7f6117f2cfa4</span> buffered_vfprintf<span class="token operator">+</span><span class="token number">308</span>
  f <span class="token number">4</span>   <span class="token number">0x7f6117f2a33d</span> vfprintf<span class="token operator">+</span><span class="token number">445</span>
  f <span class="token number">5</span>   <span class="token number">0x7f6117f328a9</span> printf<span class="token operator">+</span><span class="token number">153</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="puts"><a href="#puts" class="headerlink" title="puts"></a>puts</h3><p>调用栈与fwrite大致相同</p>
<p>至于fclose由于本菜鸡懒得写了，参考<a target="_blank" rel="noopener" href="https://ixout.github.io/posts/33400/">file函数学习 | ixout’s blog</a>学长的博客哈哈哈</p>

          <div class="post-tags">
            <!-- 文章tags -->
            
          </div>
          <p class="motto">重拾纯粹的写作</p>
        </article>
        <!-- 评论 -->
        <div id="vcomments"></div>
      </div>
    </main>
    <!-- toc -->
    
    <cosy-drag-box id="toc-drag-box" trigger="left" min-width="220" uid="toc-box">
      <div class="meta-container">
        <div class="toc-wrapper cosy-scrollbar">
          <p class="catalog">
            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24">
              <g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 6h16"></path>
                <path d="M4 12h16"></path>
                <path d="M4 18h12"></path>
              </g>
            </svg>
            <span>目录</span>
          </p>
          <!-- 文章toc -->
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#IO%E5%87%BD%E6%95%B0%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.</span> <span class="toc-text">IO函数详解</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#fopen"><span class="toc-number">1.1.</span> <span class="toc-text">fopen</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#IO-new-fopen"><span class="toc-number">1.1.1.</span> <span class="toc-text">_IO_new_fopen</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fopen-internal"><span class="toc-number">1.1.2.</span> <span class="toc-text">__fopen_internal</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E9%85%8D%E7%A9%BA%E9%97%B4%E9%83%A8%E5%88%86"><span class="toc-number">1.1.3.</span> <span class="toc-text">分配空间部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%83%A8%E5%88%86"><span class="toc-number">1.1.4.</span> <span class="toc-text">初始化部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%93%BE%E6%8E%A5file%E9%83%A8%E5%88%86"><span class="toc-number">1.1.5.</span> <span class="toc-text">链接file部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IO-file-fopen%E6%89%93%E5%BC%80%E6%96%87%E4%BB%B6%E5%8F%A5%E6%9F%84%E9%83%A8%E5%88%86"><span class="toc-number">1.1.6.</span> <span class="toc-text">_IO_file_fopen打开文件句柄部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">1.1.7.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fread"><span class="toc-number">1.2.</span> <span class="toc-text">fread</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#IO-fread"><span class="toc-number">1.2.1.</span> <span class="toc-text">_IO_fread</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IO-file-xsgetn"><span class="toc-number">1.2.2.</span> <span class="toc-text">_IO_file_xsgetn</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%83%A8%E5%88%86-1"><span class="toc-number">1.2.3.</span> <span class="toc-text">初始化部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E9%85%8Dreserve-area"><span class="toc-number">1.2.4.</span> <span class="toc-text">分配reserve area</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8E%E7%BC%93%E5%86%B2%E5%8C%BA%E6%8B%B7%E8%B4%9D%E6%95%B0%E6%8D%AE%E9%83%A8%E5%88%86"><span class="toc-number">1.2.5.</span> <span class="toc-text">从缓冲区拷贝数据部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%86%B2%E5%8C%BA%E7%BC%BA%E4%B9%8F%E7%9A%84%E5%A4%84%E7%90%86%E9%83%A8%E5%88%86"><span class="toc-number">1.2.6.</span> <span class="toc-text">缓冲区缺乏的处理部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#underflow"><span class="toc-number">1.2.7.</span> <span class="toc-text">__underflow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IO-SYSREAD"><span class="toc-number">1.2.8.</span> <span class="toc-text">_IO_SYSREAD</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#scanf"><span class="toc-number">1.2.9.</span> <span class="toc-text">scanf</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gets"><span class="toc-number">1.2.10.</span> <span class="toc-text">gets</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fwrite"><span class="toc-number">1.3.</span> <span class="toc-text">fwrite</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#IO-fwrite"><span class="toc-number">1.3.1.</span> <span class="toc-text">_IO_fwrite</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IO-new-file-xsputn"><span class="toc-number">1.3.2.</span> <span class="toc-text">_IO_new_file_xsputn</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E5%8F%AF%E7%94%A8%E7%A9%BA%E9%97%B4%E9%83%A8%E5%88%86"><span class="toc-number">1.3.3.</span> <span class="toc-text">计算可用空间部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A1%AB%E5%85%85%E7%BC%93%E5%86%B2%E5%8C%BA%E9%83%A8%E5%88%86"><span class="toc-number">1.3.4.</span> <span class="toc-text">填充缓冲区部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%B7%E6%96%B0%E7%BC%93%E5%86%B2%E5%8C%BA%E5%B9%B6%E5%86%99%E5%85%A5%E9%83%A8%E5%88%86"><span class="toc-number">1.3.5.</span> <span class="toc-text">刷新缓冲区并写入部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%A9%E4%BD%99%E6%95%B0%E6%8D%AE%E7%9A%84%E5%A4%84%E7%90%86%E9%83%A8%E5%88%86"><span class="toc-number">1.3.6.</span> <span class="toc-text">剩余数据的处理部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IO-OVERFLOW"><span class="toc-number">1.3.7.</span> <span class="toc-text">_IO_OVERFLOW</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IO-new-file-overflow"><span class="toc-number">1.3.8.</span> <span class="toc-text">_IO_new_file_overflow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#new-do-write"><span class="toc-number">1.3.9.</span> <span class="toc-text">new_do_write</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IO-new-file-write"><span class="toc-number">1.3.10.</span> <span class="toc-text">_IO_new_file_write</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IO-default-xsputn"><span class="toc-number">1.3.11.</span> <span class="toc-text">_IO_default_xsputn</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#printf"><span class="toc-number">1.3.12.</span> <span class="toc-text">printf</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#puts"><span class="toc-number">1.3.13.</span> <span class="toc-text">puts</span></a></li></ol></li></ol></li></ol>
        </div>
      </div>
    </cosy-drag-box>
    
  </div>

</div>

<script>
  window.page = {
    use: 'valine'
  }
  window.katex = {
    enable: "",
    jsCdn: "//cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.js",
    cssCdn: "//cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.css"
  }
  window.mermaid = {
    enable: "",
    theme: "",
    cdn: "//cdn.jsdelivr.net/npm/mermaid@10.4.0/dist/mermaid.min.js",
  }
  window.valine = {
    enable: "",
    appId: '4Q4EAMdq8elmFDwiIj0R0Z80-gzGzoHsz',
    appKey: 'JRv5ulQZAwmbGgfeetCXRvoW',
    avatar: 'monsterid',
    cdn: '//unpkg.com/valine@latest/dist/Valine.min.js',
    serverURLs: ''
  };
</script>


<script src="/js/0af3d6bb.js"></script>

  </main>
</body>

<script>
  window.theme = {
    color: 'hsl(238,50%,56%)'
  }
</script>


<script src="/js/69a216b6.js"></script>


</html>